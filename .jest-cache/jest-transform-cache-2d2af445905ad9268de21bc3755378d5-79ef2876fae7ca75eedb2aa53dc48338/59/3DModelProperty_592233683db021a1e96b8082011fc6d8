a02d09ccfa0cd9ecf1c48762fe7a089a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ThreeDModelProperty = void 0;
const MediaProperty_1 = require("./MediaProperty");
class ThreeDModelProperty extends MediaProperty_1.MediaProperty {
    constructor(name, vault, args = { icon: "box", create: "" }) {
        super(name, vault, args);
        this.type = "3dmodel";
    }
    /**
     * Renders a 3D model using THREE.js
     */
    render3DModel(mediaPath, container) {
        // Check if the file exists in the vault before trying to load it
        const fileExists = this.vault.app.getFile(mediaPath);
        if (!fileExists) {
            const errorDiv = document.createElement("div");
            errorDiv.textContent = `Rendu 3D introuvable. Ouvrir le fichier dans FreeCAD pour le créer.`;
            console.error("3D model file not found:", mediaPath);
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
            return;
        }
        const embed = document.createElement("canvas");
        embed.classList.add("embed-media");
        container.appendChild(embed);
        const renderer = new THREE.WebGLRenderer({ canvas: embed, alpha: true, antialias: true });
        renderer.setSize(300, 300);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);
        // Position the camera directly above, looking down the -Z axis
        camera.position.set(0, 10, 0);
        camera.up.set(0, 0, -1); // Make Z axis "up" for the camera
        camera.lookAt(0, 0, 0);
        // Add multiple directional lights from different directions for even illumination
        const directions = [
            [0, 10, 0], // Top
            [0, -10, 0], // Bottom
            [10, 0, 0], // Right
            [-10, 0, 0], // Left
            [0, 0, 10], // Front
            [0, 0, -10], // Back
        ];
        directions.forEach(dir => {
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(dir[0], dir[1], dir[2]);
            light.target.position.set(0, 0, 0);
            scene.add(light);
            scene.add(light.target);
        });
        // Optionally add a soft ambient light for subtle fill
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);
        const loader = new GLTFLoader();
        let model;
        let animationActive = true; // Track animation state
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Smooth rotation
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.enableRotate = true;
        controls.minPolarAngle = 0; // Permet toutes les rotations verticales
        controls.maxPolarAngle = Math.PI; // Permet toutes les rotations verticales
        controls.target.set(0, 0, 0);
        loader.load(this.vault.app.getAbsolutePath(mediaPath), (gltf) => {
            model = gltf.scene;
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    // Handle both array and single material
                    const materials = Array.isArray(child.material) ? child.material : [child.material];
                    for (const mat of materials) {
                        if (mat.transparent || mat.opacity < 0.5) {
                            // Set mesh to be fully visible (opaque)
                            mat.opacity = 1;
                            mat.transparent = false;
                        }
                    }
                }
            });
            // Automatically center the model
            const box = new THREE.Box3().setFromObject(model);
            const center = new THREE.Vector3();
            const size = new THREE.Vector3();
            box.getCenter(center);
            box.getSize(size);
            // Center the model at the origin
            model.position.sub(center);
            // Scale model to fill 80% of the 300x300 area
            const maxDim = Math.max(size.x, size.y, size.z);
            const targetFill = 0.8;
            const viewHeight = 2 * camera.position.y * Math.tan((camera.fov * Math.PI) / 360);
            const desiredSize = viewHeight * targetFill;
            const scale = desiredSize / maxDim;
            model.scale.setScalar(scale);
            scene.add(model);
            // Animation function
            const animate = () => {
                if (animationActive) {
                    requestAnimationFrame(animate);
                    // Rotate the model
                    if (model) {
                        model.rotation.z += 0.01; // Rotate around Z-axis
                    }
                    controls.update(); // Update camera controls
                    renderer.render(scene, camera);
                }
            };
            animate();
            // Reset model position and rotation after loading
            model.rotation.set(0, 0, 0);
            // Recalculate bounding box after positioning
            const newBox = new THREE.Box3().setFromObject(model);
            const newCenter = new THREE.Vector3();
            newBox.getCenter(newCenter);
            model.position.sub(newCenter);
            controls.update();
        }, undefined, (error) => {
            console.error("Erreur lors du chargement du modèle 3D:", error);
            const errorDiv = document.createElement("div");
            errorDiv.textContent = "Erreur lors du chargement du modèle 3D";
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
        });
        // Add interaction controls
        embed.addEventListener("mouseenter", () => {
            animationActive = false;
        });
        embed.addEventListener("mouseleave", () => {
            animationActive = true;
        });
    }
    fillDisplay(vault, value, update, file = null) {
        this.vault = vault;
        const mediaFile = this.vault.getMediaFromLink(value);
        if (!mediaFile) {
            return super.fillDisplay(value, update, file);
        }
        const mediaPath = mediaFile.path;
        if (!mediaPath) {
            return super.fillDisplay(value, update, file);
        }
        const extension = mediaPath.split('.').pop()?.toLowerCase();
        // Check if it's a 3D model file
        if (['gltf', 'glb'].includes(extension || '')) {
            const container = document.createElement("div");
            container.classList.add("embed-container");
            this.render3DModel(mediaPath, container);
            return container;
        }
        // For non-3D files, use the parent MediaProperty behavior
        return super.fillDisplay(value, update, file);
    }
}
exports.ThreeDModelProperty = ThreeDModelProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXDNETW9kZWxQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBZ0Q7QUFTaEQsTUFBYSxtQkFBb0IsU0FBUSw2QkFBYTtJQUlsRCxZQUFZLElBQVksRUFBRSxLQUFhLEVBQUUsT0FBNEQsRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUM7UUFDMUgsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFIYixTQUFJLEdBQVcsU0FBUyxDQUFDO0lBSXpDLENBQUM7SUFFRDs7T0FFRztJQUNPLGFBQWEsQ0FBQyxTQUFpQixFQUFFLFNBQXlCO1FBQ2hFLGlFQUFpRTtRQUNqRSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2QsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQyxRQUFRLENBQUMsV0FBVyxHQUFHLHFFQUFxRSxDQUFDO1lBQzdGLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDckQsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQ3BDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQztZQUNwQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUM7WUFDOUIsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNoQyxPQUFPO1FBQ1gsQ0FBQztRQUVELE1BQU0s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RCxnQ0FBZ0M7UUFDaEMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDNUMsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoRCxTQUFTLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sU0FBUyxDQUFDO1FBQ3JCLENBQUM7UUFFRCwwREFBMEQ7UUFDMUQsT0FBTyxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDbEQsQ0FBQztDQUNKO0FBdkxELGtEQXVMQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGxlb2R1XFxEb2N1bWVudHNcXDEgLSBQcm9cXFRlc3QgcGx1Z2luIG9ic2lkaWFuXFwub2JzaWRpYW5cXHBsdWdpbnNcXG9ic2lkaWFuLUNSTVxcZHluYW1pYy1maWVsZHNcXHNyY1xccHJvcGVydGllc1xcM0RNb2RlbFByb3BlcnR5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFZhdWx0IH0gZnJvbSBcInZhdWx0L1ZhdWx0XCI7XHJcbmltcG9ydCB7IE1lZGlhUHJvcGVydHkgfSBmcm9tIFwiLi9NZWRpYVByb3BlcnR5XCI7XHJcblxyXG4vLyBEw6ljbGFyYXRpb25zIHRlbXBvcmFpcmVzIHBvdXIgbGVzIGTDqXBlbmRhbmNlcyAzRFxyXG5kZWNsYXJlIGNvbnN0IFRIUkVFOiBhbnk7XHJcbmRlY2xhcmUgY29uc3QgR0xURkxvYWRlcjogYW55O1xyXG5kZWNsYXJlIGNvbnN0IE9yYml0Q29udHJvbHM6IGFueTtcclxuZGVjbGFyZSBjb25zdCBGcmVlY2FkRmlsZTogYW55O1xyXG5kZWNsYXJlIGNvbnN0IHNoZWxsOiBhbnk7XHJcblxyXG5leHBvcnQgY2xhc3MgVGhyZWVETW9kZWxQcm9wZXJ0eSBleHRlbmRzIE1lZGlhUHJvcGVydHkge1xyXG4gICAgXHJcbiAgICBwdWJsaWMgb3ZlcnJpZGUgdHlwZTogc3RyaW5nID0gXCIzZG1vZGVsXCI7XHJcblxyXG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCB2YXVsdCA6IFZhdWx0LCBhcmdzOiB7IGljb24/OiBzdHJpbmc7IGRpc3BsYXk/OiBzdHJpbmc7IGNyZWF0ZT86IHN0cmluZ30gPSB7aWNvbjogXCJib3hcIiwgY3JlYXRlOiBcIlwifSkge1xyXG4gICAgICAgIHN1cGVyKG5hbWUsIHZhdWx0LCBhcmdzKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbmRlcnMgYSAzRCBtb2RlbCB1c2luZyBUSFJFRS5qc1xyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgcmVuZGVyM0RNb2RlbChtZWRpYVBhdGg6IHN0cmluZywgY29udGFpbmVyOiBIVE1MRGl2RWxlbWVudCk6IHZvaWQge1xyXG4gICAgICAgIC8vIENoZWNrIGlmIHRoZSBmaWxlIGV4aXN0cyBpbiB0aGUgdmF1bHQgYmVmb3JlIHRyeWluZyB0byBsb2FkIGl0XHJcbiAgICAgICAgY29uc3QgZmlsZUV4aXN0cyA9IHRoaXMudmF1bHQuYXBwLmdldEZpbGUobWVkaWFQYXRoKTtcclxuICAgICAgICBpZiAoIWZpbGVFeGlzdHMpIHtcclxuICAgICAgICAgICAgY29uc3QgZXJyb3JEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICBlcnJvckRpdi50ZXh0Q29udGVudCA9IGBSZW5kdSAzRCBpbnRyb3V2YWJsZS4gT3V2cmlyIGxlIGZpY2hpZXIgZGFucyBGcmVlQ0FEIHBvdXIgbGUgY3LDqWVyLmA7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCIzRCBtb2RlbCBmaWxlIG5vdCBmb3VuZDpcIiwgbWVkaWFQYXRoKTtcclxuICAgICAgICAgICAgZXJyb3JEaXYuc3R5bGUudGV4dEFsaWduID0gXCJjZW50ZXJcIjtcclxuICAgICAgICAgICAgZXJyb3JEaXYuc3R5bGUubWFyZ2luID0gXCI0MHB4IGF1dG9cIjtcclxuICAgICAgICAgICAgZXJyb3JEaXYuc3R5bGUuY29sb3IgPSBcIiNjMDBcIjtcclxuICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGVycm9yRGl2KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZW1iZWQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xyXG4gICAgICAgIGVtYmVkLmNsYXNzTGlzdC5hZGQoXCJlbWJlZC1tZWRpYVwiKTtcclxuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZW1iZWQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHJlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoeyBjYW52YXM6IGVtYmVkLCBhbHBoYTogdHJ1ZSwgYW50aWFsaWFzOiB0cnVlIH0pO1xyXG4gICAgICAgIHJlbmRlcmVyLnNldFNpemUoMzAwLCAzMDApO1xyXG5cclxuICAgICAgICBjb25zdCBzY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xyXG4gICAgICAgIGNvbnN0IGNhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg3NSwgMSwgMC4xLCAxMDApO1xyXG4gICAgICAgIC8vIFBvc2l0aW9uIHRoZSBjYW1lcmEgZGlyZWN0bHkgYWJvdmUsIGxvb2tpbmcgZG93biB0aGUgLVogYXhpc1xyXG4gICAgICAgIGNhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMTAsIDApO1xyXG4gICAgICAgIGNhbWVyYS51cC5zZXQoMCwgMCwgLTEpOyAvLyBNYWtlIFogYXhpcyBcInVwXCIgZm9yIHRoZSBjYW1lcmFcclxuICAgICAgICBjYW1lcmEubG9va0F0KDAsIDAsIDApO1xyXG5cclxuICAgICAgICAvLyBBZGQgbXVsdGlwbGUgZGlyZWN0aW9uYWwgbGlnaHRzIGZyb20gZGlmZmVyZW50IGRpcmVjdGlvbnMgZm9yIGV2ZW4gaWxsdW1pbmF0aW9uXHJcbiAgICAgICAgY29uc3QgZGlyZWN0aW9ucyA9IFtcclxuICAgICAgICAgICAgWzAsIDEwLCAwXSwgICAgLy8gVG9wXHJcbiAgICAgICAgICAgIFswLCAtMTAsIDBdLCAgIC8vIEJvdHRvbVxyXG4gICAgICAgICAgICBbMTAsIDAsIDBdLCAgICAvLyBSaWdodFxyXG4gICAgICAgICAgICBbLTEwLCAwLCAwXSwgICAvLyBMZWZ0XHJcbiAgICAgICAgICAgIFswLCAwLCAxMF0sICAgIC8vIEZyb250XHJcbiAgICAgICAgICAgIFswLCAwLCAtMTBdLCAgIC8vIEJhY2tcclxuICAgICAgICBdO1xyXG4gICAgICAgIGRpcmVjdGlvbnMuZm9yRWFjaChkaXIgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBsaWdodCA9IG5ldyBUSFJFRS5EaXJlY3Rpb25hbExpZ2h0KDB4ZmZmZmZmLCAxKTtcclxuICAgICAgICAgICAgbGlnaHQucG9zaXRpb24uc2V0KGRpclswXSwgZGlyWzFdLCBkaXJbMl0pO1xyXG4gICAgICAgICAgICBsaWdodC50YXJnZXQucG9zaXRpb24uc2V0KDAsIDAsIDApO1xyXG4gICAgICAgICAgICBzY2VuZS5hZGQobGlnaHQpO1xyXG4gICAgICAgICAgICBzY2VuZS5hZGQobGlnaHQudGFyZ2V0KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBPcHRpb25hbGx5IGFkZCBhIHNvZnQgYW1iaWVudCBsaWdodCBmb3Igc3VidGxlIGZpbGxcclxuICAgICAgICBjb25zdCBhbWJpZW50TGlnaHQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KDB4ZmZmZmZmLCAwLjQpO1xyXG4gICAgICAgIHNjZW5lLmFkZChhbWJpZW50TGlnaHQpO1xyXG5cclxuICAgICAgICBjb25zdCBsb2FkZXIgPSBuZXcgR0xURkxvYWRlcigpO1xyXG4gICAgICAgIGxldCBtb2RlbDogYW55O1xyXG4gICAgICAgIGxldCBhbmltYXRpb25BY3RpdmUgPSB0cnVlOyAvLyBUcmFjayBhbmltYXRpb24gc3RhdGVcclxuICAgICAgICBjb25zdCBjb250cm9scyA9IG5ldyBPcmJpdENvbnRyb2xzKGNhbWVyYSwgcmVuZGVyZXIuZG9tRWxlbWVudCk7XHJcbiAgICAgICAgY29udHJvbHMuZW5hYmxlRGFtcGluZyA9IHRydWU7IC8vIFNtb290aCByb3RhdGlvblxyXG4gICAgICAgIGNvbnRyb2xzLmRhbXBpbmdGYWN0b3IgPSAwLjA1O1xyXG4gICAgICAgIGNvbnRyb2xzLmVuYWJsZVpvb20gPSB0cnVlO1xyXG4gICAgICAgIGNvbnRyb2xzLmVuYWJsZVBhbiA9IHRydWU7XHJcbiAgICAgICAgY29udHJvbHMuZW5hYmxlUm90YXRlID0gdHJ1ZTtcclxuICAgICAgICBjb250cm9scy5taW5Qb2xhckFuZ2xlID0gMDsgLy8gUGVybWV0IHRvdXRlcyBsZXMgcm90YXRpb25zIHZlcnRpY2FsZXNcclxuICAgICAgICBjb250cm9scy5tYXhQb2xhckFuZ2xlID0gTWF0aC5QSTsgLy8gUGVybWV0IHRvdXRlcyBsZXMgcm90YXRpb25zIHZlcnRpY2FsZXNcclxuICAgICAgICBjb250cm9scy50YXJnZXQuc2V0KDAsIDAsIDApO1xyXG5cclxuICAgICAgICBsb2FkZXIubG9hZChcclxuICAgICAgICAgICAgdGhpcy52YXVsdC5hcHAuZ2V0QWJzb2x1dGVQYXRoKG1lZGlhUGF0aCksXHJcbiAgICAgICAgICAgIChnbHRmOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIG1vZGVsID0gZ2x0Zi5zY2VuZTtcclxuICAgICAgICAgICAgICAgIG1vZGVsLnRyYXZlcnNlKChjaGlsZDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzTWVzaCAmJiBjaGlsZC5tYXRlcmlhbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgYm90aCBhcnJheSBhbmQgc2luZ2xlIG1hdGVyaWFsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGVyaWFscyA9IEFycmF5LmlzQXJyYXkoY2hpbGQubWF0ZXJpYWwpID8gY2hpbGQubWF0ZXJpYWwgOiBbY2hpbGQubWF0ZXJpYWxdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG1hdCBvZiBtYXRlcmlhbHMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXQudHJhbnNwYXJlbnQgfHwgbWF0Lm9wYWNpdHkgPCAwLjUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgbWVzaCB0byBiZSBmdWxseSB2aXNpYmxlIChvcGFxdWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Lm9wYWNpdHkgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC50cmFuc3BhcmVudCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQXV0b21hdGljYWxseSBjZW50ZXIgdGhlIG1vZGVsXHJcbiAgICAgICAgICAgICAgICBjb25zdCBib3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QobW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2VudGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSBuZXcgVEhSRUUuVmVjdG9yMygpO1xyXG4gICAgICAgICAgICAgICAgYm94LmdldENlbnRlcihjZW50ZXIpO1xyXG4gICAgICAgICAgICAgICAgYm94LmdldFNpemUoc2l6ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQ2VudGVyIHRoZSBtb2RlbCBhdCB0aGUgb3JpZ2luXHJcbiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zdWIoY2VudGVyKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBTY2FsZSBtb2RlbCB0byBmaWxsIDgwJSBvZiB0aGUgMzAweDMwMCBhcmVhXHJcbiAgICAgICAgICAgICAgICBjb25zdCBtYXhEaW0gPSBNYXRoLm1heChzaXplLngsIHNpemUueSwgc2l6ZS56KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEZpbGwgPSAwLjg7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2aWV3SGVpZ2h0ID0gMiAqIGNhbWVyYS5wb3NpdGlvbi55ICogTWF0aC50YW4oKGNhbWVyYS5mb3YgKiBNYXRoLlBJKSAvIDM2MCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkZXNpcmVkU2l6ZSA9IHZpZXdIZWlnaHQgKiB0YXJnZXRGaWxsO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSBkZXNpcmVkU2l6ZSAvIG1heERpbTtcclxuICAgICAgICAgICAgICAgIG1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgc2NlbmUuYWRkKG1vZGVsKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBBbmltYXRpb24gZnVuY3Rpb25cclxuICAgICAgICAgICAgICAgIGNvbnN0IGFuaW1hdGUgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuaW1hdGlvbkFjdGl2ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJvdGF0ZSB0aGUgbW9kZWxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi56ICs9IDAuMDE7IC8vIFJvdGF0ZSBhcm91bmQgWi1heGlzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbHMudXBkYXRlKCk7IC8vIFVwZGF0ZSBjYW1lcmEgY29udHJvbHNcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXIucmVuZGVyKHNjZW5lLCBjYW1lcmEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBhbmltYXRlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gUmVzZXQgbW9kZWwgcG9zaXRpb24gYW5kIHJvdGF0aW9uIGFmdGVyIGxvYWRpbmdcclxuICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnNldCgwLCAwLCAwKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBSZWNhbGN1bGF0ZSBib3VuZGluZyBib3ggYWZ0ZXIgcG9zaXRpb25pbmdcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0JveCA9IG5ldyBUSFJFRS5Cb3gzKCkuc2V0RnJvbU9iamVjdChtb2RlbCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdDZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpO1xyXG4gICAgICAgICAgICAgICAgbmV3Qm94LmdldENlbnRlcihuZXdDZW50ZXIpO1xyXG4gICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc3ViKG5ld0NlbnRlcik7XHJcblxyXG4gICAgICAgICAgICAgICAgY29udHJvbHMudXBkYXRlKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJldXIgbG9ycyBkdSBjaGFyZ2VtZW50IGR1IG1vZMOobGUgM0Q6XCIsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICAgICAgICAgIGVycm9yRGl2LnRleHRDb250ZW50ID0gXCJFcnJldXIgbG9ycyBkdSBjaGFyZ2VtZW50IGR1IG1vZMOobGUgM0RcIjtcclxuICAgICAgICAgICAgICAgIGVycm9yRGl2LnN0eWxlLnRleHRBbGlnbiA9IFwiY2VudGVyXCI7XHJcbiAgICAgICAgICAgICAgICBlcnJvckRpdi5zdHlsZS5tYXJnaW4gPSBcIjQwcHggYXV0b1wiO1xyXG4gICAgICAgICAgICAgICAgZXJyb3JEaXYuc3R5bGUuY29sb3IgPSBcIiNjMDBcIjtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlcnJvckRpdik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyBBZGQgaW50ZXJhY3Rpb24gY29udHJvbHNcclxuICAgICAgICBlbWJlZC5hZGRFdmVudExpc3RlbmVyKFwibW91c2VlbnRlclwiLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGFuaW1hdGlvbkFjdGl2ZSA9IGZhbHNlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBlbWJlZC5hZGRFdmVudExpc3RlbmVyKFwibW91c2VsZWF2ZVwiLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGFuaW1hdGlvbkFjdGl2ZSA9IHRydWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgZmlsbERpc3BsYXkodmF1bHQ6IGFueSwgdmFsdWU6IGFueSwgdXBkYXRlOiAodmFsdWU6IGFueSkgPT4gUHJvbWlzZTx2b2lkPiwgZmlsZTogYW55ID0gbnVsbCk6IEhUTUxEaXZFbGVtZW50IHtcclxuICAgICAgICB0aGlzLnZhdWx0ID0gdmF1bHQ7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgbWVkaWFGaWxlID0gdGhpcy52YXVsdC5nZXRNZWRpYUZyb21MaW5rKHZhbHVlKTtcclxuICAgICAgICBpZiAoIW1lZGlhRmlsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gc3VwZXIuZmlsbERpc3BsYXkodmFsdWUsIHVwZGF0ZSwgZmlsZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBtZWRpYVBhdGggPSBtZWRpYUZpbGUucGF0aDtcclxuICAgICAgICBpZiAoIW1lZGlhUGF0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gc3VwZXIuZmlsbERpc3BsYXkodmFsdWUsIHVwZGF0ZSwgZmlsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGV4dGVuc2lvbiA9IG1lZGlhUGF0aC5zcGxpdCgnLicpLnBvcCgpPy50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGEgM0QgbW9kZWwgZmlsZVxyXG4gICAgICAgIGlmIChbJ2dsdGYnLCAnZ2xiJ10uaW5jbHVkZXMoZXh0ZW5zaW9uIHx8ICcnKSkge1xyXG4gICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChcImVtYmVkLWNvbnRhaW5lclwiKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIzRE1vZGVsKG1lZGlhUGF0aCwgY29udGFpbmVyKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEZvciBub24tM0QgZmlsZXMsIHVzZSB0aGUgcGFyZW50IE1lZGlhUHJvcGVydHkgYmVoYXZpb3JcclxuICAgICAgICByZXR1cm4gc3VwZXIuZmlsbERpc3BsYXkodmFsdWUsIHVwZGF0ZSwgZmlsZSk7XHJcbiAgICB9XHJcbn0iXSwidmVyc2lvbiI6M30=