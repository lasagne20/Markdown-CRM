608004d038ff6a6dea2960284a7bbe42
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Vault = void 0;
const DynamicClassFactory_1 = require("Config/DynamicClassFactory");
const File_1 = require("./File");
class Vault {
    constructor(app, settings) {
        this.files = {};
        this.app = app;
        this.settings = settings;
        // Initialize the dynamic class factory
        this.initializeDynamicClasses();
    }
    getPath() {
        return this.app.getVaultPath();
    }
    getName() {
        return this.app.getName();
    }
    async initializeDynamicClasses() {
        try {
            const configPath = this.settings.configPath || './config';
            Vault.dynamicClassFactory = new DynamicClassFactory_1.DynamicClassFactory(configPath, this.app);
            // Load available classes and populate the static classes object
            const availableClasses = await Vault.dynamicClassFactory.getAvailableClasses();
            for (const className of availableClasses) {
                const dynamicClass = await Vault.dynamicClassFactory.getClass(className);
                Vault.classes[className] = dynamicClass;
            }
        }
        catch (error) {
            console.error('Failed to initialize dynamic classes:', error);
        }
    }
    getDynamicClassFactory() {
        return Vault.dynamicClassFactory;
    }
    getPersonalName() {
        return this.settings.personalName;
    }
    getClasseFromName(name) {
        return Vault.classes[name];
    }
    readLinkFile(link, path = false) {
        if (!link || typeof link !== "string")
            return "";
        // Match [[file|alias]] or [[file]]
        const match = link.match(/^\[\[([^\|\]]+?)(?:)?(?:\|([^\]]+))?\]\]$/);
        if (match) {
            const fileName = match[1]?.trim();
            const alias = match[2]?.trim();
            if (path) {
                return /\.[^\/\\]+$/.test(fileName) ? fileName : `${fileName}.md`;
            }
            else {
                return alias ? alias : fileName.split("/").pop()?.replace(".md", "") || "";
            }
        }
        // If not a wikilink, just return the trimmed link
        return link.trim();
    }
    async getFromLink(name, log = true) {
        if (!name) {
            return null;
        }
        // Search with the path
        let path = this.readLinkFile(name, true);
        let directfile = (await this.app.listFiles()).find((f) => {
            return f.path.trim() === path.trim();
        });
        if (directfile) {
            if (directfile.path in Object.keys(this.files)) {
                return this.files[directfile.path];
            }
            return await this.createClasse(directfile);
        }
        let fileName = path.split("/").pop() || "";
        const files = (await this.app.listFiles()).filter((f) => f.name === fileName);
        if (files.length > 0) {
            let file = files[0];
            if (files.length > 1) {
                let path = this.readLinkFile(name, true);
                if (path) {
                    // Try to find the best match by walking up the path segments
                    let segments = path.split("/");
                    while (segments.length > 0) {
                        const candidatePath = segments.join("/");
                        const bestMatch = files.find((f) => f.path.endsWith("/" + candidatePath) || f.path === candidatePath);
                        if (bestMatch) {
                            file = bestMatch;
                            break;
                        }
                        segments.shift(); // Remove the first segment and try again
                    }
                }
                else {
                    console.error("Plusieurs fichiers trouvés pour le lien sans chemin : " + name, files);
                }
            }
            if (file.path in Object.keys(this.files)) {
                return this.files[file.path];
            }
            return await this.createClasse(file);
        }
        if (log) {
            console.error("Fichier non trouvé : " + name);
        }
        return null;
    }
    async getMediaFromLink(link) {
        let path = this.readLinkFile(link, true);
        const file = (await this.app.listFiles()).find((f) => {
            return f.path === path;
        });
        if (file) {
            return file;
        }
        // try with the file name
        let fileName = this.readLinkFile(link);
        const files = (await this.app.listFiles()).filter((f) => f.name === fileName);
        if (files.length > 0) {
            let file = files[0];
            if (files.length > 1) {
                console.error("Plusieurs fichiers trouvés pour le lien sans chemin : " + link, files);
            }
            return file;
        }
        console.error("Media non trouvé : " + link);
        return null;
    }
    /*
    getFromFolder(folder: Folder) {
        let name = folder.path.split("/")[folder.path.split("/").length - 1];
        for (let file of folder.children || []) {
            if (this.app.isTFile(file) && file.name.includes(name)) {
                return this.getFromFile(file);
            }
        }
        console.error("Le dossier n'a pas de fichier classe : " + folder.path);
    }*/
    async getFromFile(file) {
        if (this.app.isFolder(file)) {
            let filePath = file.path + "/" + file.name;
            let iFile = await this.app.getFile(filePath);
            if (!iFile) {
                console.error("Le dossier n'a pas de fichier classe : " + file.path);
                return undefined;
            }
        }
        let existingClass = this.files[file.path];
        if (existingClass) {
            return existingClass;
        }
        let classe;
        classe = await this.createClasse(file);
        return classe;
    }
    async createFile(classeType = null, name = "", args = {}) {
        // Create the new file from the className template
        if (!classeType) {
            const dynamicClasses = Object.keys(Vault.classes);
            classeType = await this.app.selectClasse(this, dynamicClasses, "Quelle classe pour ce fichier ?");
            if (!classeType) {
                return;
            }
        }
        console.log("Args ; ", args);
        if (!name) {
            let classe = await this.app.selectFile(this, [classeType.name], { hint: "Entrer un nom pour ce fichier", classeArgs: args });
            // Select File call createFile if the file doesn't exist
            // No need to continue
            return classe?.file;
        }
        let templatePath = this.settings.templateFolder + "/" + classeType.name + ".md";
        const templateFile = await this.app.getFile(templatePath);
        const newFilePath = name.includes(".md") ? name : `${name}.md`;
        let templateContent = "---\nClasse: " + classeType.name + "\n---\n";
        if (templateFile && (await this.app.isFile(templateFile))) {
            templateContent = await this.app.readFile(templateFile);
        }
        else {
            console.warn("Le fichier template n'existe pas :" + templatePath + ". Un fichier vide sera créé.");
        }
        let file = null;
        try {
            file = new File_1.File(this, await this.app.createFile(newFilePath, templateContent));
            console.log("Nouveau fichier créé : " + newFilePath);
        }
        catch (error) {
            // Modifier le fichier s'il existe déjà
            const file = await this.app.getFile(newFilePath);
            if (!file) {
                throw Error("Le fichier n'a pas pu être créé ou modifié : " + newFilePath);
            }
            if (file && this.app.isFile(file)) {
                await this.app.writeFile(file, templateContent);
                console.log("Fichier modifié : " + newFilePath);
            }
            else {
                throw Error("Le fichier n'a pas pu être créé ou modifié : " + newFilePath);
            }
        }
        if (!file) {
            throw Error("Le fichier n'existe pas : " + newFilePath);
        }
        await this.app.waitForFileMetaDataUpdate(file.path, "Classe", async () => {
            await new Promise(resolve => setTimeout(resolve, 200));
            if (!file) {
                return;
            }
            let classe = await this.getFromFile(file);
            if (!classe) {
                console.error("Classe non trouvée pour le fichier : " + file.path);
                return;
            }
            await classe.onCreate();
            await classe.onUpdate();
            console.log("Classe créée : " + classe.name);
        });
        return file;
    }
    async refreshAll() {
        // Move all files 
        let watchedFiles = [];
        for (let file of await this.app.listFiles()) {
            if (watchedFiles.includes(file.name) || file.path.startsWith("Outils")) {
                continue;
            }
            console.log("Refresh : " + file.path);
            const classe = await this.getFromFile(file);
            if (classe) {
                classe.onUpdate();
            }
            // Remove the duplicates
            /*
            for (let file2 of this.app.vault.getFiles()) {
                // Compare the name
                if (file.name === file2.name && file.path != file2.path && this.getFromFile(file)?.getClasse() === this.getFromFile(file2)?.getClasse()) {
                    console.error("Doublon de \n" + file.path + "\n" + file2.path);
                    // Keep the first by default
                    await this.app.vault.delete(file2);
                }
            }*/
            watchedFiles.push(file.name);
        }
        // Remove empty folders 
        for (let folder of await this.app.listFolders()) {
            if (folder.children && folder.children.length === 0) {
                await this.app.delete(folder);
            }
        }
        this.app.sendNotice("Vault refresh");
    }
    async createClasse(file) {
        let fileInstance;
        if (!(file instanceof File_1.File)) {
            fileInstance = new File_1.File(this, file);
        }
        else {
            fileInstance = file;
        }
        const metadata = await this.app.getMetadata(fileInstance);
        if (!metadata) {
            console.error("Pas de metadata");
            return;
        }
        const className = metadata["Classe"];
        if (!className) {
            console.error("Pas de classe définie dans les métadonnées");
            return undefined;
        }
        try {
            // Use the dynamic class factory to get the constructor
            if (Vault.dynamicClassFactory) {
                const constructor = await Vault.dynamicClassFactory.getClass(className);
                if (constructor) {
                    return new constructor(this, fileInstance);
                }
            }
            // Fallback to static classes if dynamic factory is not available
            let constructor = Vault.classes[className];
            if (constructor) {
                return new constructor(this, fileInstance);
            }
            console.error("Type non connue : " + className);
            return undefined;
        }
        catch (error) {
            console.error("Erreur lors de la création de la classe : " + className, error);
            return undefined;
        }
    }
}
exports.Vault = Vault;
Vault.dynamicClassFactory = null;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHZhdWx0XFxWYXVsdC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxvRUFBaUU7QUFJakUsaUNBQXNDO0FBUXRDLE1BQWEsS0FBSztJQVlkLFlBQVksR0FBUyxFQUFFLFFBQWtCO1FBTGxDLFVBQUssR0FBOEIsRUFBRSxDQUFDO1FBTXpDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFTSxPQUFPO1FBQ1YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFTSxPQUFPO1FBQ1YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFHTyxLQUFLLENBQUMsd0JBQXdCO1FBQ2xDLElBQUksQ0FBQztZQUNELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQztZQUMxRCxLQUFLLENBQUMsbUJBQW1CLEdBQUcsSUFBSSx5Q0FBbUIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRTFFLGdFQUFnRTtZQUNoRSxNQUFNLGdCQUFnQixHQUFHLE1BQU0sS0FBSyxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDL0UsS0FBSyxNQUFNLFNBQVMsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDO2dCQUN2QyxNQUFNLFlBQVksR0FBRyxNQUFNLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3pFLEtBQUssQ0FB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Qy9FLE9BQU8sU0FBUyxDQUFDO1FBQ3JCLENBQUM7SUFDTCxDQUFDOztBQTdUTCxzQkE4VEM7QUFwVGtCLHlCQUFtQixHQUErQixJQUFJLEFBQW5DLENBQW9DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFx2YXVsdFxcVmF1bHQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHluYW1pY0NsYXNzRmFjdG9yeSB9IGZyb20gXCJDb25maWcvRHluYW1pY0NsYXNzRmFjdG9yeVwiO1xyXG5pbXBvcnQgeyBDbGFzc2UgfSBmcm9tIFwiLi9DbGFzc2VcIjtcclxuaW1wb3J0IHsgSUFwcCwgSUZpbGUgfSBmcm9tIFwiLi4vaW50ZXJmYWNlcy9JQXBwXCI7XHJcbmltcG9ydCB7IERhdGEgfSBmcm9tIFwiLi9EYXRhXCI7XHJcbmltcG9ydCB7IEZvbGRlciwgRmlsZSB9IGZyb20gXCIuL0ZpbGVcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2V0dGluZ3Mge1xyXG4gIHRlbXBsYXRlRm9sZGVyOiBzdHJpbmc7XHJcbiAgcGVyc29uYWxOYW1lIDogc3RyaW5nO1xyXG4gIGNvbmZpZ1BhdGg/OiBzdHJpbmc7IC8vIFBhdGggdG8gWUFNTCBjb25maWd1cmF0aW9uIGZpbGVzXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBWYXVsdCB7XHJcbiAgICAvKlxyXG4gICAgR2xvYmFsIFZhdWx0LCB3aXRoIGFsbCBpbmZvcm1hdGlvbnNcclxuICAgICovXHJcbiAgICBwdWJsaWMgYXBwOiBJQXBwO1xyXG4gICAgXHJcbiAgICBwdWJsaWMgc2V0dGluZ3M6IFNldHRpbmdzO1xyXG4gICAgcHVibGljIGZpbGVzOiB7IFtrZXk6IHN0cmluZ106IENsYXNzZSB9ID0ge307XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBjbGFzc2VzOiB7IFtrZXk6IHN0cmluZ106IHR5cGVvZiBDbGFzc2UgfTtcclxuICAgIHByaXZhdGUgc3RhdGljIGR5bmFtaWNDbGFzc0ZhY3Rvcnk6IER5bmFtaWNDbGFzc0ZhY3RvcnkgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhcHA6IElBcHAsIHNldHRpbmdzOiBTZXR0aW5ncykge1xyXG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xyXG4gICAgICAgIHRoaXMuc2V0dGluZ3MgPSBzZXR0aW5ncztcclxuICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBkeW5hbWljIGNsYXNzIGZhY3RvcnlcclxuICAgICAgICB0aGlzLmluaXRpYWxpemVEeW5hbWljQ2xhc3NlcygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRQYXRoKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLmdldFZhdWx0UGF0aCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXROYW1lKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLmdldE5hbWUoKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBpbml0aWFsaXplRHluYW1pY0NsYXNzZXMoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlnUGF0aCA9IHRoaXMuc2V0dGluZ3MuY29uZmlnUGF0aCB8fCAnLi9jb25maWcnO1xyXG4gICAgICAgICAgICBWYXVsdC5keW5hbWljQ2xhc3NGYWN0b3J5ID0gbmV3IER5bmFtaWNDbGFzc0ZhY3RvcnkoY29uZmlnUGF0aCwgdGhpcy5hcHApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gTG9hZCBhdmFpbGFibGUgY2xhc3NlcyBhbmQgcG9wdWxhdGUgdGhlIHN0YXRpYyBjbGFzc2VzIG9iamVjdFxyXG4gICAgICAgICAgICBjb25zdCBhdmFpbGFibGVDbGFzc2VzID0gYXdhaXQgVmF1bHQuZHluYW1pY0NsYXNzRmFjdG9yeS5nZXRBdmFpbGFibGVDbGFzc2VzKCk7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgY2xhc3NOYW1lIG9mIGF2YWlsYWJsZUNsYXNzZXMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNDbGFzcyA9IGF3YWl0IFZhdWx0LmR5bmFtaWNDbGFzc0ZhY3RvcnkuZ2V0Q2xhc3MoY2xhc3NOYW1lKTtcclxuICAgICAgICAgICAgICAgIFZhdWx0LmNsYXNzZXNbY2xhc3NOYW1lXSA9IGR5bmFtaWNDbGFzcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBpbml0aWFsaXplIGR5bmFtaWMgY2xhc3NlczonLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldER5bmFtaWNDbGFzc0ZhY3RvcnkoKTogRHluYW1pY0NsYXNzRmFjdG9yeSB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiBWYXVsdC5keW5hbWljQ2xhc3NGYWN0b3J5O1xyXG4gICAgfVxyXG5cclxuICAgIGdldFBlcnNvbmFsTmFtZSgpe1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdzLnBlcnNvbmFsTmFtZVxyXG4gICAgfVxyXG5cclxuICAgIGdldENsYXNzZUZyb21OYW1lKG5hbWU6IHN0cmluZykgOiB0eXBlb2YgQ2xhc3Nle1xyXG4gICAgICAgIHJldHVybiBWYXVsdC5jbGFzc2VzW25hbWVdXHJcbiAgICB9XHJcblxyXG4gICAgcmVhZExpbmtGaWxlKGxpbms6IHN0cmluZywgcGF0aCA9IGZhbHNlKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoIWxpbmsgfHwgdHlwZW9mIGxpbmsgIT09IFwic3RyaW5nXCIpIHJldHVybiBcIlwiO1xyXG4gICAgICAgIC8vIE1hdGNoIFtbZmlsZXxhbGlhc11dIG9yIFtbZmlsZV1dXHJcbiAgICAgICAgY29uc3QgbWF0Y2ggPSBsaW5rLm1hdGNoKC9eXFxbXFxbKFteXFx8XFxdXSs/KSg/Oik/KD86XFx8KFteXFxdXSspKT9cXF1cXF0kLyk7XHJcbiAgICAgICAgaWYgKG1hdGNoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbGVOYW1lID0gbWF0Y2hbMV0/LnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgYWxpYXMgPSBtYXRjaFsyXT8udHJpbSgpO1xyXG4gICAgICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIC9cXC5bXlxcL1xcXFxdKyQvLnRlc3QoZmlsZU5hbWUpID8gZmlsZU5hbWUgOiBgJHtmaWxlTmFtZX0ubWRgO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFsaWFzID8gYWxpYXMgOiBmaWxlTmFtZS5zcGxpdChcIi9cIikucG9wKCk/LnJlcGxhY2UoXCIubWRcIixcIlwiKSB8fCBcIlwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIElmIG5vdCBhIHdpa2lsaW5rLCBqdXN0IHJldHVybiB0aGUgdHJpbW1lZCBsaW5rXHJcbiAgICAgICAgcmV0dXJuIGxpbmsudHJpbSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGdldEZyb21MaW5rKG5hbWU6IHN0cmluZywgbG9nPXRydWUpIHtcclxuICAgICAgICBpZiAoIW5hbWUpIHsgcmV0dXJuIG51bGw7IH1cclxuXHJcbiAgICAgICAgLy8gU2VhcmNoIHdpdGggdGhlIHBhdGhcclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMucmVhZExpbmtGaWxlKG5hbWUsIHRydWUpO1xyXG4gICAgICAgIGxldCBkaXJlY3RmaWxlID0gKGF3YWl0IHRoaXMuYXBwLmxpc3RGaWxlcygpKS5maW5kKChmIDogSUZpbGUpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGYucGF0aC50cmltKCkgPT09IHBhdGgudHJpbSgpXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGRpcmVjdGZpbGUpIHtcclxuICAgICAgICAgICAgaWYgKGRpcmVjdGZpbGUucGF0aCBpbiBPYmplY3Qua2V5cyh0aGlzLmZpbGVzKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXNbZGlyZWN0ZmlsZS5wYXRoXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5jcmVhdGVDbGFzc2UoZGlyZWN0ZmlsZSk7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgbGV0IGZpbGVOYW1lID0gcGF0aC5zcGxpdChcIi9cIikucG9wKCkgfHwgXCJcIjtcclxuICAgICAgICBjb25zdCBmaWxlcyA9IChhd2FpdCB0aGlzLmFwcC5saXN0RmlsZXMoKSkuZmlsdGVyKChmIDogSUZpbGUpID0+IGYubmFtZSA9PT0gZmlsZU5hbWUpO1xyXG4gICAgICAgIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGxldCBmaWxlID0gZmlsZXNbMF07XHJcbiAgICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcGF0aCA9IHRoaXMucmVhZExpbmtGaWxlKG5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZmluZCB0aGUgYmVzdCBtYXRjaCBieSB3YWxraW5nIHVwIHRoZSBwYXRoIHNlZ21lbnRzXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNlZ21lbnRzID0gcGF0aC5zcGxpdChcIi9cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHNlZ21lbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FuZGlkYXRlUGF0aCA9IHNlZ21lbnRzLmpvaW4oXCIvXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiZXN0TWF0Y2ggPSBmaWxlcy5maW5kKChmIDogSUZpbGUpID0+IGYucGF0aC5lbmRzV2l0aChcIi9cIiArIGNhbmRpZGF0ZVBhdGgpIHx8IGYucGF0aCA9PT0gY2FuZGlkYXRlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZXN0TWF0Y2gpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUgPSBiZXN0TWF0Y2g7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50cy5zaGlmdCgpOyAvLyBSZW1vdmUgdGhlIGZpcnN0IHNlZ21lbnQgYW5kIHRyeSBhZ2FpblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJQbHVzaWV1cnMgZmljaGllcnMgdHJvdXbDqXMgcG91ciBsZSBsaWVuIHNhbnMgY2hlbWluIDogXCIgKyBuYW1lLCBmaWxlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChmaWxlLnBhdGggaW4gT2JqZWN0LmtleXModGhpcy5maWxlcykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbGVzW2ZpbGUucGF0aF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuY3JlYXRlQ2xhc3NlKGZpbGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobG9nKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJGaWNoaWVyIG5vbiB0cm91dsOpIDogXCIgKyBuYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZ2V0TWVkaWFGcm9tTGluayhsaW5rOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMucmVhZExpbmtGaWxlKGxpbmssIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IGZpbGUgPSAoYXdhaXQgdGhpcy5hcHAubGlzdEZpbGVzKCkpLmZpbmQoKGYgOiBJRmlsZSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZi5wYXRoID09PSBwYXRofSk7XHJcbiAgICAgICAgaWYgKGZpbGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZpbGU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0cnkgd2l0aCB0aGUgZmlsZSBuYW1lXHJcbiAgICAgICAgbGV0IGZpbGVOYW1lID0gdGhpcy5yZWFkTGlua0ZpbGUobGluayk7XHJcbiAgICAgICAgY29uc3QgZmlsZXMgPSAoYXdhaXQgdGhpcy5hcHAubGlzdEZpbGVzKCkpLmZpbHRlcigoZiA6IElGaWxlKSA9PiBmLm5hbWUgPT09IGZpbGVOYW1lKTtcclxuICAgICAgICBpZiAoZmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBsZXQgZmlsZSA9IGZpbGVzWzBdO1xyXG4gICAgICAgICAgICBpZiAoZmlsZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlBsdXNpZXVycyBmaWNoaWVycyB0cm91dsOpcyBwb3VyIGxlIGxpZW4gc2FucyBjaGVtaW4gOiBcIiArIGxpbmssIGZpbGVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmlsZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJNZWRpYSBub24gdHJvdXbDqSA6IFwiICsgbGluayk7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLypcclxuICAgIGdldEZyb21Gb2xkZXIoZm9sZGVyOiBGb2xkZXIpIHtcclxuICAgICAgICBsZXQgbmFtZSA9IGZvbGRlci5wYXRoLnNwbGl0KFwiL1wiKVtmb2xkZXIucGF0aC5zcGxpdChcIi9cIikubGVuZ3RoIC0gMV07XHJcbiAgICAgICAgZm9yIChsZXQgZmlsZSBvZiBmb2xkZXIuY2hpbGRyZW4gfHwgW10pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYXBwLmlzVEZpbGUoZmlsZSkgJiYgZmlsZS5uYW1lLmluY2x1ZGVzKG5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRGcm9tRmlsZShmaWxlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zb2xlLmVycm9yKFwiTGUgZG9zc2llciBuJ2EgcGFzIGRlIGZpY2hpZXIgY2xhc3NlIDogXCIgKyBmb2xkZXIucGF0aCk7XHJcbiAgICB9Ki9cclxuXHJcbiAgICBhc3luYyBnZXRGcm9tRmlsZShmaWxlOiBJRmlsZSk6IFByb21pc2U8Q2xhc3NlIHwgdW5kZWZpbmVkPiB7XHJcbiAgICAgICAgaWYgKHRoaXMuYXBwLmlzRm9sZGVyKGZpbGUpKSB7XHJcbiAgICAgICAgICAgIGxldCBmaWxlUGF0aCA9IGZpbGUucGF0aCArIFwiL1wiICsgZmlsZS5uYW1lO1xyXG4gICAgICAgICAgICBsZXQgaUZpbGUgPSBhd2FpdCB0aGlzLmFwcC5nZXRGaWxlKGZpbGVQYXRoKVxyXG4gICAgICAgICAgICBpZiAoIWlGaWxlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiTGUgZG9zc2llciBuJ2EgcGFzIGRlIGZpY2hpZXIgY2xhc3NlIDogXCIgKyBmaWxlLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGV4aXN0aW5nQ2xhc3MgPSB0aGlzLmZpbGVzW2ZpbGUucGF0aF07XHJcbiAgICAgICAgaWYgKGV4aXN0aW5nQ2xhc3MpIHsgcmV0dXJuIGV4aXN0aW5nQ2xhc3M7IH1cclxuICAgICAgICBcclxuICAgICAgICBsZXQgY2xhc3NlOiBDbGFzc2UgfCB1bmRlZmluZWQ7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY2xhc3NlID0gYXdhaXQgdGhpcy5jcmVhdGVDbGFzc2UoZmlsZSk7XHJcblxyXG4gICAgICAgIHJldHVybiBjbGFzc2U7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGNyZWF0ZUZpbGUoY2xhc3NlVHlwZTogbnVsbCB8IHR5cGVvZiBDbGFzc2UgPSBudWxsLCBuYW1lOiBzdHJpbmcgPSBcIlwiLCBhcmdzOiB7cGFyZW50PyA6IENsYXNzZX0gPSB7fSk6IFByb21pc2U8RmlsZSB8IHVuZGVmaW5lZD4ge1xyXG4gICAgICAgIC8vIENyZWF0ZSB0aGUgbmV3IGZpbGUgZnJvbSB0aGUgY2xhc3NOYW1lIHRlbXBsYXRlXHJcbiAgICAgICAgaWYgKCFjbGFzc2VUeXBlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGR5bmFtaWNDbGFzc2VzID0gT2JqZWN0LmtleXMoVmF1bHQuY2xhc3Nlcyk7XHJcbiAgICAgICAgICAgIGNsYXNzZVR5cGUgPSBhd2FpdCB0aGlzLmFwcC5zZWxlY3RDbGFzc2UodGhpcywgZHluYW1pY0NsYXNzZXMsIFwiUXVlbGxlIGNsYXNzZSBwb3VyIGNlIGZpY2hpZXIgP1wiKTtcclxuICAgICAgICAgICAgaWYgKCFjbGFzc2VUeXBlKSB7IHJldHVybjsgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zb2xlLmxvZyhcIkFyZ3MgOyBcIixhcmdzKVxyXG4gICAgICAgIGlmICghbmFtZSkge1xyXG4gICAgICAgICAgICBsZXQgY2xhc3NlID0gYXdhaXQgdGhpcy5hcHAuc2VsZWN0RmlsZSh0aGlzLCBbY2xhc3NlVHlwZS5uYW1lXSwge2hpbnQ6XCJFbnRyZXIgdW4gbm9tIHBvdXIgY2UgZmljaGllclwiLCBjbGFzc2VBcmdzOiBhcmdzfSk7XHJcbiAgICAgICAgICAgIC8vIFNlbGVjdCBGaWxlIGNhbGwgY3JlYXRlRmlsZSBpZiB0aGUgZmlsZSBkb2Vzbid0IGV4aXN0XHJcbiAgICAgICAgICAgIC8vIE5vIG5lZWQgdG8gY29udGludWVcclxuICAgICAgICAgICAgcmV0dXJuIGNsYXNzZT8uZmlsZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHRlbXBsYXRlUGF0aCA9IHRoaXMuc2V0dGluZ3MudGVtcGxhdGVGb2xkZXIgKyBcIi9cIiArIGNsYXNzZVR5cGUubmFtZSArIFwiLm1kXCI7XHJcbiAgICAgICAgY29uc3QgdGVtcGxhdGVGaWxlID0gYXdhaXQgdGhpcy5hcHAuZ2V0RmlsZSh0ZW1wbGF0ZVBhdGgpO1xyXG4gICAgICAgIGNvbnN0IG5ld0ZpbGVQYXRoID0gbmFtZS5pbmNsdWRlcyhcIi5tZFwiKSA/IG5hbWUgOiBgJHtuYW1lfS5tZGA7XHJcbiAgICAgICAgbGV0IHRlbXBsYXRlQ29udGVudCA9IFwiLS0tXFxuQ2xhc3NlOiBcIiArIGNsYXNzZVR5cGUubmFtZSArIFwiXFxuLS0tXFxuXCI7XHJcblxyXG4gICAgICAgIGlmICh0ZW1wbGF0ZUZpbGUgJiYgKGF3YWl0IHRoaXMuYXBwLmlzRmlsZSh0ZW1wbGF0ZUZpbGUpKSkge1xyXG4gICAgICAgICAgICB0ZW1wbGF0ZUNvbnRlbnQgPSBhd2FpdCB0aGlzLmFwcC5yZWFkRmlsZSh0ZW1wbGF0ZUZpbGUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcIkxlIGZpY2hpZXIgdGVtcGxhdGUgbidleGlzdGUgcGFzIDpcIiArIHRlbXBsYXRlUGF0aCArIFwiLiBVbiBmaWNoaWVyIHZpZGUgc2VyYSBjcsOpw6kuXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgZmlsZTogRmlsZSB8IG51bGwgPSBudWxsO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGZpbGUgPSBuZXcgRmlsZSh0aGlzLCBhd2FpdCB0aGlzLmFwcC5jcmVhdGVGaWxlKG5ld0ZpbGVQYXRoLCB0ZW1wbGF0ZUNvbnRlbnQpKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJOb3V2ZWF1IGZpY2hpZXIgY3LDqcOpIDogXCIgKyBuZXdGaWxlUGF0aCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgLy8gTW9kaWZpZXIgbGUgZmljaGllciBzJ2lsIGV4aXN0ZSBkw6lqw6BcclxuICAgICAgICAgICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuYXBwLmdldEZpbGUobmV3RmlsZVBhdGgpO1xyXG4gICAgICAgICAgICBpZiAoIWZpbGUpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKFwiTGUgZmljaGllciBuJ2EgcGFzIHB1IMOqdHJlIGNyw6nDqSBvdSBtb2RpZmnDqSA6IFwiICsgbmV3RmlsZVBhdGgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChmaWxlICYmIHRoaXMuYXBwLmlzRmlsZShmaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hcHAud3JpdGVGaWxlKGZpbGUsIHRlbXBsYXRlQ29udGVudCk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkZpY2hpZXIgbW9kaWZpw6kgOiBcIiArIG5ld0ZpbGVQYXRoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKFwiTGUgZmljaGllciBuJ2EgcGFzIHB1IMOqdHJlIGNyw6nDqSBvdSBtb2RpZmnDqSA6IFwiICsgbmV3RmlsZVBhdGgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIWZpbGUpIHtcclxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJMZSBmaWNoaWVyIG4nZXhpc3RlIHBhcyA6IFwiICsgbmV3RmlsZVBhdGgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBhd2FpdCB0aGlzLmFwcC53YWl0Rm9yRmlsZU1ldGFEYXRhVXBkYXRlKGZpbGUucGF0aCwgXCJDbGFzc2VcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMjAwKSk7XHJcbiAgICAgICAgICAgIGlmICghZmlsZSkgeyByZXR1cm47IH1cclxuICAgICAgICAgICAgbGV0IGNsYXNzZSA9IGF3YWl0IHRoaXMuZ2V0RnJvbUZpbGUoZmlsZSk7XHJcbiAgICAgICAgICAgIGlmICghY2xhc3NlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiQ2xhc3NlIG5vbiB0cm91dsOpZSBwb3VyIGxlIGZpY2hpZXIgOiBcIiArIGZpbGUucGF0aCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYXdhaXQgY2xhc3NlLm9uQ3JlYXRlKCk7XHJcbiAgICAgICAgICAgIGF3YWl0IGNsYXNzZS5vblVwZGF0ZSgpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNsYXNzZSBjcsOpw6llIDogXCIgKyBjbGFzc2UubmFtZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGZpbGU7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgcmVmcmVzaEFsbCgpIHtcclxuICAgICAgICAvLyBNb3ZlIGFsbCBmaWxlcyBcclxuICAgICAgICBsZXQgd2F0Y2hlZEZpbGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgIGZvciAobGV0IGZpbGUgb2YgYXdhaXQgdGhpcy5hcHAubGlzdEZpbGVzKCkpIHtcclxuICAgICAgICAgICAgaWYgKHdhdGNoZWRGaWxlcy5pbmNsdWRlcyhmaWxlLm5hbWUpIHx8IGZpbGUucGF0aC5zdGFydHNXaXRoKFwiT3V0aWxzXCIpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJlZnJlc2ggOiBcIiArIGZpbGUucGF0aCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsYXNzZSA9IGF3YWl0IHRoaXMuZ2V0RnJvbUZpbGUoZmlsZSk7XHJcbiAgICAgICAgICAgIGlmIChjbGFzc2UpIHtcclxuICAgICAgICAgICAgICAgIGNsYXNzZS5vblVwZGF0ZSgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBSZW1vdmUgdGhlIGR1cGxpY2F0ZXNcclxuICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgZm9yIChsZXQgZmlsZTIgb2YgdGhpcy5hcHAudmF1bHQuZ2V0RmlsZXMoKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gQ29tcGFyZSB0aGUgbmFtZVxyXG4gICAgICAgICAgICAgICAgaWYgKGZpbGUubmFtZSA9PT0gZmlsZTIubmFtZSAmJiBmaWxlLnBhdGggIT0gZmlsZTIucGF0aCAmJiB0aGlzLmdldEZyb21GaWxlKGZpbGUpPy5nZXRDbGFzc2UoKSA9PT0gdGhpcy5nZXRGcm9tRmlsZShmaWxlMik/LmdldENsYXNzZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkRvdWJsb24gZGUgXFxuXCIgKyBmaWxlLnBhdGggKyBcIlxcblwiICsgZmlsZTIucGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gS2VlcCB0aGUgZmlyc3QgYnkgZGVmYXVsdFxyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmRlbGV0ZShmaWxlMik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0qL1xyXG4gICAgICAgICAgICB3YXRjaGVkRmlsZXMucHVzaChmaWxlLm5hbWUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVtb3ZlIGVtcHR5IGZvbGRlcnMgXHJcbiAgICAgICAgZm9yIChsZXQgZm9sZGVyIG9mIGF3YWl0IHRoaXMuYXBwLmxpc3RGb2xkZXJzKCkpIHtcclxuICAgICAgICAgICAgaWYgKGZvbGRlci5jaGlsZHJlbiAmJiBmb2xkZXIuY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC5kZWxldGUoZm9sZGVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5hcHAuc2VuZE5vdGljZShcIlZhdWx0IHJlZnJlc2hcIik7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgY3JlYXRlQ2xhc3NlKGZpbGU6IElGaWxlKSB7XHJcbiAgICAgICAgbGV0IGZpbGVJbnN0YW5jZTogRmlsZTtcclxuICAgICAgICBpZiAoIShmaWxlIGluc3RhbmNlb2YgRmlsZSkpe1xyXG4gICAgICAgICAgICBmaWxlSW5zdGFuY2UgPSBuZXcgRmlsZSh0aGlzLCBmaWxlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmaWxlSW5zdGFuY2UgPSBmaWxlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHRoaXMuYXBwLmdldE1ldGFkYXRhKGZpbGVJbnN0YW5jZSk7XHJcbiAgICAgICAgaWYgKCFtZXRhZGF0YSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiUGFzIGRlIG1ldGFkYXRhXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IG1ldGFkYXRhW1wiQ2xhc3NlXCJdO1xyXG4gICAgICAgIGlmICghY2xhc3NOYW1lKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJQYXMgZGUgY2xhc3NlIGTDqWZpbmllIGRhbnMgbGVzIG3DqXRhZG9ubsOpZXNcIik7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBVc2UgdGhlIGR5bmFtaWMgY2xhc3MgZmFjdG9yeSB0byBnZXQgdGhlIGNvbnN0cnVjdG9yXHJcbiAgICAgICAgICAgIGlmIChWYXVsdC5keW5hbWljQ2xhc3NGYWN0b3J5KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb25zdHJ1Y3RvciA9IGF3YWl0IFZhdWx0LmR5bmFtaWNDbGFzc0ZhY3RvcnkuZ2V0Q2xhc3MoY2xhc3NOYW1lKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb25zdHJ1Y3Rvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgY29uc3RydWN0b3IodGhpcywgZmlsZUluc3RhbmNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gc3RhdGljIGNsYXNzZXMgaWYgZHluYW1pYyBmYWN0b3J5IGlzIG5vdCBhdmFpbGFibGVcclxuICAgICAgICAgICAgbGV0IGNvbnN0cnVjdG9yID0gVmF1bHQuY2xhc3Nlc1tjbGFzc05hbWVdO1xyXG4gICAgICAgICAgICBpZiAoY29uc3RydWN0b3IpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgY29uc3RydWN0b3IodGhpcywgZmlsZUluc3RhbmNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlR5cGUgbm9uIGNvbm51ZSA6IFwiICsgY2xhc3NOYW1lKTtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyZXVyIGxvcnMgZGUgbGEgY3LDqWF0aW9uIGRlIGxhIGNsYXNzZSA6IFwiICsgY2xhc3NOYW1lLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il0sInZlcnNpb24iOjN9