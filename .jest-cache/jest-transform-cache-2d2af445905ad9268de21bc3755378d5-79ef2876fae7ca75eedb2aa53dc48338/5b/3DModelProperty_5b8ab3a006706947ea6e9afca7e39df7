c45ac956d5658bb193c98cbbc73a1141
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ThreeDModelProperty = void 0;
const MediaProperty_1 = require("./MediaProperty");
class ThreeDModelProperty extends MediaProperty_1.MediaProperty {
    constructor(name, args = { icon: "box", create: "" }) {
        super(name, args);
        this.type = "3dmodel";
    }
    /**
     * Renders a 3D model using THREE.js
     */
    render3DModel(mediaPath, container) {
        // Check if the file exists in the vault before trying to load it
        const fileExists = this.vault.app.vault.getFiles().find((f) => f.path === mediaPath);
        if (!fileExists) {
            const errorDiv = document.createElement("div");
            errorDiv.textContent = `Rendu 3D introuvable. Ouvrir le fichier dans FreeCAD pour le créer.`;
            console.error("3D model file not found:", mediaPath);
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
            return;
        }
        const embed = document.createElement("canvas");
        embed.classList.add("embed-media");
        container.appendChild(embed);
        const renderer = new THREE.WebGLRenderer({ canvas: embed, alpha: true, antialias: true });
        renderer.setSize(300, 300);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);
        // Position the camera directly above, looking down the -Z axis
        camera.position.set(0, 10, 0);
        camera.up.set(0, 0, -1); // Make Z axis "up" for the camera
        camera.lookAt(0, 0, 0);
        // Add multiple directional lights from different directions for even illumination
        const directions = [
            [0, 10, 0], // Top
            [0, -10, 0], // Bottom
            [10, 0, 0], // Right
            [-10, 0, 0], // Left
            [0, 0, 10], // Front
            [0, 0, -10], // Back
        ];
        directions.forEach(dir => {
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(dir[0], dir[1], dir[2]);
            light.target.position.set(0, 0, 0);
            scene.add(light);
            scene.add(light.target);
        });
        // Optionally add a soft ambient light for subtle fill
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);
        const loader = new GLTFLoader();
        let model;
        let animationActive = true; // Track animation state
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Smooth rotation
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.enableRotate = true;
        controls.minPolarAngle = 0; // Permet toutes les rotations verticales
        controls.maxPolarAngle = Math.PI; // Permet toutes les rotations verticales
        controls.target.set(0, 0, 0);
        loader.load(this.vault.app.vault.adapter.getResourcePath(mediaPath), (gltf) => {
            model = gltf.scene;
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    // Handle both array and single material
                    const materials = Array.isArray(child.material) ? child.material : [child.material];
                    for (const mat of materials) {
                        if (mat.transparent || mat.opacity < 0.5) {
                            // Set mesh to be fully visible (opaque)
                            mat.opacity = 1;
                            mat.transparent = false;
                        }
                    }
                }
            });
            // Automatically center the model
            const box = new THREE.Box3().setFromObject(model);
            const center = new THREE.Vector3();
            const size = new THREE.Vector3();
            box.getCenter(center);
            box.getSize(size);
            // Center the model at the origin
            model.position.sub(center);
            // Scale model to fill 80% of the 300x300 area
            const maxDim = Math.max(size.x, size.y, size.z);
            const targetFill = 0.8;
            const viewHeight = 2 * camera.position.y * Math.tan((camera.fov * Math.PI) / 360);
            const desiredSize = viewHeight * targetFill;
            const scale = desiredSize / maxDim;
            model.scale.setScalar(scale);
            scene.add(model);
            // Animation function
            const animate = () => {
                if (animationActive) {
                    requestAnimationFrame(animate);
                    // Rotate the model
                    if (model) {
                        model.rotation.z += 0.01; // Rotate around Z-axis
                    }
                    controls.update(); // Update camera controls
                    renderer.render(scene, camera);
                }
            };
            animate();
            // Reset model position and rotation after loading
            model.rotation.set(0, 0, 0);
            // Recalculate bounding box after positioning
            const newBox = new THREE.Box3().setFromObject(model);
            const newCenter = new THREE.Vector3();
            newBox.getCenter(newCenter);
            model.position.sub(newCenter);
            controls.update();
        }, undefined, (error) => {
            console.error("Erreur lors du chargement du modèle 3D:", error);
            const errorDiv = document.createElement("div");
            errorDiv.textContent = "Erreur lors du chargement du modèle 3D";
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
        });
        // Add interaction controls
        embed.addEventListener("mouseenter", () => {
            animationActive = false;
        });
        embed.addEventListener("mouseleave", () => {
            animationActive = true;
        });
    }
    fillDisplay(vault, value, update, file = null) {
        this.vault = vault;
        const mediaFile = this.vault.getMediaFromLink(value);
        if (!mediaFile) {
            return super.fillDisplay(vault, value, update, file);
        }
        const mediaPath = mediaFile.path;
        const extension = mediaPath.split('.').pop()?.toLowerCase();
        // Check if it's a 3D model file
        if (['gltf', 'glb'].includes(extension || '')) {
            const container = document.createElement("div");
            container.classList.add("embed-container");
            this.render3DModel(mediaPath, container);
            return container;
        }
        // For non-3D files, use the parent MediaProperty behavior
        return super.fillDisplay(vault, value, update, file);
    }
}
exports.ThreeDModelProperty = ThreeDModelProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXDNETW9kZWxQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxtREFBZ0Q7QUFTaEQsTUFBYSxtQkFBb0IsU0FBUSw2QkFBYTtJQUlsRCxZQUFZLElBQVksRUFBRSxPQUE0RCxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBQztRQUMzRyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSE4sU0FBSSxHQUFXLFNBQVMsQ0FBQztJQUl6QyxDQUFDO0lBRUQ7O09BRUc7SUFDTyxhQUFhLENBQUMsU0FBaUIsRUFBRSxTQUF5QjtRQUNoRSxpRUFBaUU7UUFDakUsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQztRQUMxRixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDZCxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9DLFFBQVEsQ0FBQyxXQUFXLEdBQUcscUVBQXFFLENBQUM7WUFDN0YsT0FBTyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNyRCxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7WUFDcEMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDO1lBQ3BDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztZQUM5QixTQUFTLENBQUMsV0FBVyxD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QUFNLEVBQUUsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQzVDLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEQsU0FBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUMzQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUN6QyxPQUFPLFNBQVMsQ0FBQztRQUNyQixDQUFDO1FBRUQsMERBQTBEO1FBQzFELE9BQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN6RCxDQUFDO0NBQ0o7QUFwTEQsa0RBb0xDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFxwcm9wZXJ0aWVzXFwzRE1vZGVsUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWVkaWFQcm9wZXJ0eSB9IGZyb20gXCIuL01lZGlhUHJvcGVydHlcIjtcclxuXHJcbi8vIETDqWNsYXJhdGlvbnMgdGVtcG9yYWlyZXMgcG91ciBsZXMgZMOpcGVuZGFuY2VzIDNEXHJcbmRlY2xhcmUgY29uc3QgVEhSRUU6IGFueTtcclxuZGVjbGFyZSBjb25zdCBHTFRGTG9hZGVyOiBhbnk7XHJcbmRlY2xhcmUgY29uc3QgT3JiaXRDb250cm9sczogYW55O1xyXG5kZWNsYXJlIGNvbnN0IEZyZWVjYWRGaWxlOiBhbnk7XHJcbmRlY2xhcmUgY29uc3Qgc2hlbGw6IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBUaHJlZURNb2RlbFByb3BlcnR5IGV4dGVuZHMgTWVkaWFQcm9wZXJ0eSB7XHJcbiAgICBcclxuICAgIHB1YmxpYyBvdmVycmlkZSB0eXBlOiBzdHJpbmcgPSBcIjNkbW9kZWxcIjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIGFyZ3M6IHsgaWNvbj86IHN0cmluZzsgZGlzcGxheT86IHN0cmluZzsgY3JlYXRlPzogc3RyaW5nfSA9IHtpY29uOiBcImJveFwiLCBjcmVhdGU6IFwiXCJ9KSB7XHJcbiAgICAgICAgc3VwZXIobmFtZSwgYXJncyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW5kZXJzIGEgM0QgbW9kZWwgdXNpbmcgVEhSRUUuanNcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIHJlbmRlcjNETW9kZWwobWVkaWFQYXRoOiBzdHJpbmcsIGNvbnRhaW5lcjogSFRNTERpdkVsZW1lbnQpOiB2b2lkIHtcclxuICAgICAgICAvLyBDaGVjayBpZiB0aGUgZmlsZSBleGlzdHMgaW4gdGhlIHZhdWx0IGJlZm9yZSB0cnlpbmcgdG8gbG9hZCBpdFxyXG4gICAgICAgIGNvbnN0IGZpbGVFeGlzdHMgPSB0aGlzLnZhdWx0LmFwcC52YXVsdC5nZXRGaWxlcygpLmZpbmQoKGY6IGFueSkgPT4gZi5wYXRoID09PSBtZWRpYVBhdGgpO1xyXG4gICAgICAgIGlmICghZmlsZUV4aXN0cykge1xyXG4gICAgICAgICAgICBjb25zdCBlcnJvckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgICAgIGVycm9yRGl2LnRleHRDb250ZW50ID0gYFJlbmR1IDNEIGludHJvdXZhYmxlLiBPdXZyaXIgbGUgZmljaGllciBkYW5zIEZyZWVDQUQgcG91ciBsZSBjcsOpZXIuYDtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIjNEIG1vZGVsIGZpbGUgbm90IGZvdW5kOlwiLCBtZWRpYVBhdGgpO1xyXG4gICAgICAgICAgICBlcnJvckRpdi5zdHlsZS50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xyXG4gICAgICAgICAgICBlcnJvckRpdi5zdHlsZS5tYXJnaW4gPSBcIjQwcHggYXV0b1wiO1xyXG4gICAgICAgICAgICBlcnJvckRpdi5zdHlsZS5jb2xvciA9IFwiI2MwMFwiO1xyXG4gICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZXJyb3JEaXYpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBlbWJlZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XHJcbiAgICAgICAgZW1iZWQuY2xhc3NMaXN0LmFkZChcImVtYmVkLW1lZGlhXCIpO1xyXG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlbWJlZCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7IGNhbnZhczogZW1iZWQsIGFscGhhOiB0cnVlLCBhbnRpYWxpYXM6IHRydWUgfSk7XHJcbiAgICAgICAgcmVuZGVyZXIuc2V0U2l6ZSgzMDAsIDMwMCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XHJcbiAgICAgICAgY29uc3QgY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDc1LCAxLCAwLjEsIDEwMCk7XHJcbiAgICAgICAgLy8gUG9zaXRpb24gdGhlIGNhbWVyYSBkaXJlY3RseSBhYm92ZSwgbG9va2luZyBkb3duIHRoZSAtWiBheGlzXHJcbiAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7XHJcbiAgICAgICAgY2FtZXJhLnVwLnNldCgwLCAwLCAtMSk7IC8vIE1ha2UgWiBheGlzIFwidXBcIiBmb3IgdGhlIGNhbWVyYVxyXG4gICAgICAgIGNhbWVyYS5sb29rQXQoMCwgMCwgMCk7XHJcblxyXG4gICAgICAgIC8vIEFkZCBtdWx0aXBsZSBkaXJlY3Rpb25hbCBsaWdodHMgZnJvbSBkaWZmZXJlbnQgZGlyZWN0aW9ucyBmb3IgZXZlbiBpbGx1bWluYXRpb25cclxuICAgICAgICBjb25zdCBkaXJlY3Rpb25zID0gW1xyXG4gICAgICAgICAgICBbMCwgMTAsIDBdLCAgICAvLyBUb3BcclxuICAgICAgICAgICAgWzAsIC0xMCwgMF0sICAgLy8gQm90dG9tXHJcbiAgICAgICAgICAgIFsxMCwgMCwgMF0sICAgIC8vIFJpZ2h0XHJcbiAgICAgICAgICAgIFstMTAsIDAsIDBdLCAgIC8vIExlZnRcclxuICAgICAgICAgICAgWzAsIDAsIDEwXSwgICAgLy8gRnJvbnRcclxuICAgICAgICAgICAgWzAsIDAsIC0xMF0sICAgLy8gQmFja1xyXG4gICAgICAgIF07XHJcbiAgICAgICAgZGlyZWN0aW9ucy5mb3JFYWNoKGRpciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIDEpO1xyXG4gICAgICAgICAgICBsaWdodC5wb3NpdGlvbi5zZXQoZGlyWzBdLCBkaXJbMV0sIGRpclsyXSk7XHJcbiAgICAgICAgICAgIGxpZ2h0LnRhcmdldC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7XHJcbiAgICAgICAgICAgIHNjZW5lLmFkZChsaWdodCk7XHJcbiAgICAgICAgICAgIHNjZW5lLmFkZChsaWdodC50YXJnZXQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIE9wdGlvbmFsbHkgYWRkIGEgc29mdCBhbWJpZW50IGxpZ2h0IGZvciBzdWJ0bGUgZmlsbFxyXG4gICAgICAgIGNvbnN0IGFtYmllbnRMaWdodCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoMHhmZmZmZmYsIDAuNCk7XHJcbiAgICAgICAgc2NlbmUuYWRkKGFtYmllbnRMaWdodCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxvYWRlciA9IG5ldyBHTFRGTG9hZGVyKCk7XHJcbiAgICAgICAgbGV0IG1vZGVsOiBhbnk7XHJcbiAgICAgICAgbGV0IGFuaW1hdGlvbkFjdGl2ZSA9IHRydWU7IC8vIFRyYWNrIGFuaW1hdGlvbiBzdGF0ZVxyXG4gICAgICAgIGNvbnN0IGNvbnRyb2xzID0gbmV3IE9yYml0Q29udHJvbHMoY2FtZXJhLCByZW5kZXJlci5kb21FbGVtZW50KTtcclxuICAgICAgICBjb250cm9scy5lbmFibGVEYW1waW5nID0gdHJ1ZTsgLy8gU21vb3RoIHJvdGF0aW9uXHJcbiAgICAgICAgY29udHJvbHMuZGFtcGluZ0ZhY3RvciA9IDAuMDU7XHJcbiAgICAgICAgY29udHJvbHMuZW5hYmxlWm9vbSA9IHRydWU7XHJcbiAgICAgICAgY29udHJvbHMuZW5hYmxlUGFuID0gdHJ1ZTtcclxuICAgICAgICBjb250cm9scy5lbmFibGVSb3RhdGUgPSB0cnVlO1xyXG4gICAgICAgIGNvbnRyb2xzLm1pblBvbGFyQW5nbGUgPSAwOyAvLyBQZXJtZXQgdG91dGVzIGxlcyByb3RhdGlvbnMgdmVydGljYWxlc1xyXG4gICAgICAgIGNvbnRyb2xzLm1heFBvbGFyQW5nbGUgPSBNYXRoLlBJOyAvLyBQZXJtZXQgdG91dGVzIGxlcyByb3RhdGlvbnMgdmVydGljYWxlc1xyXG4gICAgICAgIGNvbnRyb2xzLnRhcmdldC5zZXQoMCwgMCwgMCk7XHJcblxyXG4gICAgICAgIGxvYWRlci5sb2FkKFxyXG4gICAgICAgICAgICB0aGlzLnZhdWx0LmFwcC52YXVsdC5hZGFwdGVyLmdldFJlc291cmNlUGF0aChtZWRpYVBhdGgpLFxyXG4gICAgICAgICAgICAoZ2x0ZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBtb2RlbCA9IGdsdGYuc2NlbmU7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC50cmF2ZXJzZSgoY2hpbGQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIGJvdGggYXJyYXkgYW5kIHNpbmdsZSBtYXRlcmlhbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlcmlhbHMgPSBBcnJheS5pc0FycmF5KGNoaWxkLm1hdGVyaWFsKSA/IGNoaWxkLm1hdGVyaWFsIDogW2NoaWxkLm1hdGVyaWFsXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBtYXQgb2YgbWF0ZXJpYWxzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0LnRyYW5zcGFyZW50IHx8IG1hdC5vcGFjaXR5IDwgMC41KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IG1lc2ggdG8gYmUgZnVsbHkgdmlzaWJsZSAob3BhcXVlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQudHJhbnNwYXJlbnQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIEF1dG9tYXRpY2FsbHkgY2VudGVyIHRoZSBtb2RlbFxyXG4gICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaXplID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcclxuICAgICAgICAgICAgICAgIGJveC5nZXRDZW50ZXIoY2VudGVyKTtcclxuICAgICAgICAgICAgICAgIGJveC5nZXRTaXplKHNpemUpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIENlbnRlciB0aGUgbW9kZWwgYXQgdGhlIG9yaWdpblxyXG4gICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc3ViKGNlbnRlcik7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gU2NhbGUgbW9kZWwgdG8gZmlsbCA4MCUgb2YgdGhlIDMwMHgzMDAgYXJlYVxyXG4gICAgICAgICAgICAgICAgY29uc3QgbWF4RGltID0gTWF0aC5tYXgoc2l6ZS54LCBzaXplLnksIHNpemUueik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRGaWxsID0gMC44O1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgdmlld0hlaWdodCA9IDIgKiBjYW1lcmEucG9zaXRpb24ueSAqIE1hdGgudGFuKChjYW1lcmEuZm92ICogTWF0aC5QSSkgLyAzNjApO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVzaXJlZFNpemUgPSB2aWV3SGVpZ2h0ICogdGFyZ2V0RmlsbDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gZGVzaXJlZFNpemUgLyBtYXhEaW07XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXRTY2FsYXIoc2NhbGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIHNjZW5lLmFkZChtb2RlbCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIGZ1bmN0aW9uXHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRpb25BY3RpdmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBSb3RhdGUgdGhlIG1vZGVsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24ueiArPSAwLjAxOyAvLyBSb3RhdGUgYXJvdW5kIFotYXhpc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLnVwZGF0ZSgpOyAvLyBVcGRhdGUgY2FtZXJhIGNvbnRyb2xzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgYW5pbWF0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHBvc2l0aW9uIGFuZCByb3RhdGlvbiBhZnRlciBsb2FkaW5nXHJcbiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gUmVjYWxjdWxhdGUgYm91bmRpbmcgYm94IGFmdGVyIHBvc2l0aW9uaW5nXHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdCb3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QobW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3Q2VudGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcclxuICAgICAgICAgICAgICAgIG5ld0JveC5nZXRDZW50ZXIobmV3Q2VudGVyKTtcclxuICAgICAgICAgICAgICAgIG1vZGVsLnBvc2l0aW9uLnN1YihuZXdDZW50ZXIpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnRyb2xzLnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyZXVyIGxvcnMgZHUgY2hhcmdlbWVudCBkdSBtb2TDqGxlIDNEOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgICAgICAgICBlcnJvckRpdi50ZXh0Q29udGVudCA9IFwiRXJyZXVyIGxvcnMgZHUgY2hhcmdlbWVudCBkdSBtb2TDqGxlIDNEXCI7XHJcbiAgICAgICAgICAgICAgICBlcnJvckRpdi5zdHlsZS50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xyXG4gICAgICAgICAgICAgICAgZXJyb3JEaXYuc3R5bGUubWFyZ2luID0gXCI0MHB4IGF1dG9cIjtcclxuICAgICAgICAgICAgICAgIGVycm9yRGl2LnN0eWxlLmNvbG9yID0gXCIjYzAwXCI7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZXJyb3JEaXYpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgLy8gQWRkIGludGVyYWN0aW9uIGNvbnRyb2xzXHJcbiAgICAgICAgZW1iZWQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlZW50ZXJcIiwgKCkgPT4ge1xyXG4gICAgICAgICAgICBhbmltYXRpb25BY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZW1iZWQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbGVhdmVcIiwgKCkgPT4ge1xyXG4gICAgICAgICAgICBhbmltYXRpb25BY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGZpbGxEaXNwbGF5KHZhdWx0OiBhbnksIHZhbHVlOiBhbnksIHVwZGF0ZTogKHZhbHVlOiBhbnkpID0+IFByb21pc2U8dm9pZD4sIGZpbGU6IGFueSA9IG51bGwpOiBIVE1MRGl2RWxlbWVudCB7XHJcbiAgICAgICAgdGhpcy52YXVsdCA9IHZhdWx0O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IG1lZGlhRmlsZSA9IHRoaXMudmF1bHQuZ2V0TWVkaWFGcm9tTGluayh2YWx1ZSk7XHJcbiAgICAgICAgaWYgKCFtZWRpYUZpbGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLmZpbGxEaXNwbGF5KHZhdWx0LCB2YWx1ZSwgdXBkYXRlLCBmaWxlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG1lZGlhUGF0aCA9IG1lZGlhRmlsZS5wYXRoO1xyXG4gICAgICAgIGNvbnN0IGV4dGVuc2lvbiA9IG1lZGlhUGF0aC5zcGxpdCgnLicpLnBvcCgpPy50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGEgM0QgbW9kZWwgZmlsZVxyXG4gICAgICAgIGlmIChbJ2dsdGYnLCAnZ2xiJ10uaW5jbHVkZXMoZXh0ZW5zaW9uIHx8ICcnKSkge1xyXG4gICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChcImVtYmVkLWNvbnRhaW5lclwiKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIzRE1vZGVsKG1lZGlhUGF0aCwgY29udGFpbmVyKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEZvciBub24tM0QgZmlsZXMsIHVzZSB0aGUgcGFyZW50IE1lZGlhUHJvcGVydHkgYmVoYXZpb3JcclxuICAgICAgICByZXR1cm4gc3VwZXIuZmlsbERpc3BsYXkodmF1bHQsIHZhbHVlLCB1cGRhdGUsIGZpbGUpO1xyXG4gICAgfVxyXG59Il0sInZlcnNpb24iOjN9