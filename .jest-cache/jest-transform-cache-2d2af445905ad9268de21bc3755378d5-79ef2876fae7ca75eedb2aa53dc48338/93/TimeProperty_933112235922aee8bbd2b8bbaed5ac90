4f0bc4184d4ca84d25e4b7a81e4d835e
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TimeProperty = void 0;
const flatpickr_1 = __importDefault(require("flatpickr"));
const fr_js_1 = require("flatpickr/dist/l10n/fr.js");
const Property_1 = require("./Property");
class TimeProperty extends Property_1.Property {
    constructor(name, vault, args = { format: "HH:mm" }) {
        super(name, vault, args);
        this.type = "time";
        this.format = args.format || "HH:mm";
    }
    // Affiche le champ temps
    fillDisplay(value, update) {
        const container = document.createElement("div");
        container.classList.add("field-container");
        const link = this.createFieldLink(value);
        const input = this.createFieldTime(value, update, link);
        // Affichage initial
        if (value && this.validate(value)) {
            link.style.display = "block";
            input.style.display = "none";
        }
        else {
            input.style.display = "block";
            link.style.display = "none";
        }
        container.appendChild(link);
        container.appendChild(input);
        return container;
    }
    // Crée un input pour l'heure (hh:mm) avec flatpickr
    createFieldTime(value, update, link) {
        const input = document.createElement("input");
        input.type = "text";
        input.value = value || "";
        input.classList.add("field-input");
        (0, flatpickr_1.default)(input, {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
            defaultDate: value || "",
            locale: fr_js_1.French,
            onChange: async (selectedDates) => {
                const selected = selectedDates[0];
                if (selected) {
                    input.value = this.formatTimeForStorage(selected);
                    await this.updateField(update, input, link);
                }
            },
            onClose: async () => {
                if (!this.validate(input.value))
                    input.value = "";
                await this.updateField(update, input, link);
            }
        });
        return input;
    }
    // Affiche l'heure ou un texte par défaut
    createFieldLink(value) {
        const link = document.createElement("div");
        link.textContent = value ? this.formatTimeForDisplay(value) : "Aucune heure sélectionnée";
        link.classList.add("time-field-link", "field-link");
        link.style.cursor = "pointer";
        link.addEventListener("click", (event) => this.modifyField(event));
        return link;
    }
    // Formate l'heure pour l'affichage : "14:30"
    formatTimeForDisplay(time) {
        if (this.format === "HH:mm") {
            return time || "Aucune heure sélectionnée";
        }
        if (!time)
            return "";
        const parts = time.split(":").map(Number);
        if (parts.length < 2)
            return time;
        const [h, m, s] = [parts[0], parts[1], parts[2] || 0];
        const result = [];
        if (h)
            result.push(`${h}h`);
        if (m)
            result.push(`${m} min`);
        if (s)
            result.push(`${s}s`);
        return result.length ? result.join(" ") : "0 min";
    }
    // Formate l'heure pour le stockage : "HH:mm"
    formatTimeForStorage(date) {
        return date.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit", hour12: false });
    }
    // Validation simple du format "HH:mm"
    validate(value) {
        if (/^\d{2}:\d{2}$/.test(value)) {
            return value;
        }
        return "";
    }
    // Bascule entre input et affichage
    async updateField(update, input, link) {
        let value = this.validate(input.value) ? input.value : "";
        await update(value);
        if (value) {
            input.style.display = "none";
            link.textContent = this.formatTimeForDisplay(value);
            link.style.display = "block";
        }
        else {
            link.textContent = "Aucune heure sélectionnée";
        }
    }
    // Pour afficher l'input à la place du lien
    modifyField(event) {
        const link = event.currentTarget;
        const container = link.parentElement;
        if (!container)
            return;
        const input = container.querySelector("input");
        if (input) {
            link.style.display = "none";
            input.style.display = "block";
            input.focus();
        }
    }
}
exports.TimeProperty = TimeProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFRpbWVQcm9wZXJ0eSAudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsMERBQWtDO0FBQ2xDLHFEQUFtRDtBQUNuRCx5Q0FBc0M7QUFHdEMsTUFBYSxZQUFhLFNBQVEsbUJBQVE7SUFJdEMsWUFBWSxJQUFZLEVBQUUsS0FBWSxFQUFFLE9BQTBDLEVBQUMsTUFBTSxFQUFHLE9BQU8sRUFBQztRQUNoRyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUpwQixTQUFJLEdBQVcsTUFBTSxDQUFDO1FBSzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUM7SUFFekMsQ0FBQztJQUVELHlCQUF5QjtJQUNoQixXQUFXLENBQUMsS0FBVSxFQUFFLE1BQXFDO1FBQ2xFLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDaEQsU0FBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUUzQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUV4RCxvQkFBb0I7UUFDcEIsSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztZQUM3QixLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDakMs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ZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFxwcm9wZXJ0aWVzXFxUaW1lUHJvcGVydHkgLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmbGF0cGlja3IgZnJvbSBcImZsYXRwaWNrclwiO1xyXG5pbXBvcnQgeyBGcmVuY2ggfSBmcm9tIFwiZmxhdHBpY2tyL2Rpc3QvbDEwbi9mci5qc1wiO1xyXG5pbXBvcnQgeyBQcm9wZXJ0eSB9IGZyb20gXCIuL1Byb3BlcnR5XCI7XHJcbmltcG9ydCB7IFZhdWx0IH0gZnJvbSBcIi4uL3ZhdWx0L1ZhdWx0XCI7XHJcblxyXG5leHBvcnQgY2xhc3MgVGltZVByb3BlcnR5IGV4dGVuZHMgUHJvcGVydHkge1xyXG4gICAgb3ZlcnJpZGUgdHlwZTogc3RyaW5nID0gXCJ0aW1lXCI7XHJcbiAgICBwcml2YXRlIGZvcm1hdDogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgdmF1bHQ6IFZhdWx0LCBhcmdzIDoge2Zvcm1hdD86IHN0cmluZywgaWNvbj8gOiBzdHJpbmd9PSB7Zm9ybWF0IDogXCJISDptbVwifSkge1xyXG4gICAgICAgIHN1cGVyKG5hbWUsIHZhdWx0LCBhcmdzKTtcclxuICAgICAgICB0aGlzLmZvcm1hdCA9IGFyZ3MuZm9ybWF0IHx8IFwiSEg6bW1cIjtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWZmaWNoZSBsZSBjaGFtcCB0ZW1wc1xyXG4gICAgb3ZlcnJpZGUgZmlsbERpc3BsYXkodmFsdWU6IGFueSwgdXBkYXRlOiAodmFsdWU6IGFueSkgPT4gUHJvbWlzZTx2b2lkPikge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1jb250YWluZXJcIik7XHJcblxyXG4gICAgICAgIGNvbnN0IGxpbmsgPSB0aGlzLmNyZWF0ZUZpZWxkTGluayh2YWx1ZSk7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSB0aGlzLmNyZWF0ZUZpZWxkVGltZSh2YWx1ZSwgdXBkYXRlLCBsaW5rKTtcclxuXHJcbiAgICAgICAgLy8gQWZmaWNoYWdlIGluaXRpYWxcclxuICAgICAgICBpZiAodmFsdWUgJiYgdGhpcy52YWxpZGF0ZSh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQobGluayk7XHJcbiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGlucHV0KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDcsOpZSB1biBpbnB1dCBwb3VyIGwnaGV1cmUgKGhoOm1tKSBhdmVjIGZsYXRwaWNrclxyXG4gICAgY3JlYXRlRmllbGRUaW1lKHZhbHVlOiBzdHJpbmcsIHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIGxpbms6IEhUTUxFbGVtZW50KSB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiaW5wdXRcIik7XHJcbiAgICAgICAgaW5wdXQudHlwZSA9IFwidGV4dFwiO1xyXG4gICAgICAgIGlucHV0LnZhbHVlID0gdmFsdWUgfHwgXCJcIjtcclxuICAgICAgICBpbnB1dC5jbGFzc0xpc3QuYWRkKFwiZmllbGQtaW5wdXRcIik7XHJcblxyXG4gICAgICAgIGZsYXRwaWNrcihpbnB1dCwge1xyXG4gICAgICAgICAgICBlbmFibGVUaW1lOiB0cnVlLFxyXG4gICAgICAgICAgICBub0NhbGVuZGFyOiB0cnVlLFxyXG4gICAgICAgICAgICBkYXRlRm9ybWF0OiBcIkg6aVwiLFxyXG4gICAgICAgICAgICB0aW1lXzI0aHI6IHRydWUsXHJcbiAgICAgICAgICAgIGRlZmF1bHREYXRlOiB2YWx1ZSB8fCBcIlwiLFxyXG4gICAgICAgICAgICBsb2NhbGU6IEZyZW5jaCxcclxuICAgICAgICAgICAgb25DaGFuZ2U6IGFzeW5jIChzZWxlY3RlZERhdGVzOiBEYXRlW10pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gc2VsZWN0ZWREYXRlc1swXTtcclxuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gdGhpcy5mb3JtYXRUaW1lRm9yU3RvcmFnZShzZWxlY3RlZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVGaWVsZCh1cGRhdGUsIGlucHV0LCBsaW5rKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgb25DbG9zZTogYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZhbGlkYXRlKGlucHV0LnZhbHVlKSkgaW5wdXQudmFsdWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVGaWVsZCh1cGRhdGUsIGlucHV0LCBsaW5rKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWZmaWNoZSBsJ2hldXJlIG91IHVuIHRleHRlIHBhciBkw6lmYXV0XHJcbiAgICBvdmVycmlkZSBjcmVhdGVGaWVsZExpbmsodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSB2YWx1ZSA/IHRoaXMuZm9ybWF0VGltZUZvckRpc3BsYXkodmFsdWUpIDogXCJBdWN1bmUgaGV1cmUgc8OpbGVjdGlvbm7DqWVcIjtcclxuICAgICAgICBsaW5rLmNsYXNzTGlzdC5hZGQoXCJ0aW1lLWZpZWxkLWxpbmtcIiwgXCJmaWVsZC1saW5rXCIpO1xyXG4gICAgICAgIGxpbmsuc3R5bGUuY3Vyc29yID0gXCJwb2ludGVyXCI7XHJcbiAgICAgICAgbGluay5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKGV2ZW50KSA9PiB0aGlzLm1vZGlmeUZpZWxkKGV2ZW50KSk7XHJcbiAgICAgICAgcmV0dXJuIGxpbms7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9ybWF0ZSBsJ2hldXJlIHBvdXIgbCdhZmZpY2hhZ2UgOiBcIjE0OjMwXCJcclxuICAgIGZvcm1hdFRpbWVGb3JEaXNwbGF5KHRpbWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybWF0ID09PSBcIkhIOm1tXCIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRpbWUgfHwgXCJBdWN1bmUgaGV1cmUgc8OpbGVjdGlvbm7DqWVcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aW1lKSByZXR1cm4gXCJcIjtcclxuICAgICAgICBjb25zdCBwYXJ0cyA9IHRpbWUuc3BsaXQoXCI6XCIpLm1hcChOdW1iZXIpO1xyXG4gICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPCAyKSByZXR1cm4gdGltZTtcclxuICAgICAgICBjb25zdCBbaCwgbSwgc10gPSBbcGFydHNbMF0sIHBhcnRzWzFdLCBwYXJ0c1syXSB8fCAwXTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgICAgICBpZiAoaCkgcmVzdWx0LnB1c2goYCR7aH1oYCk7XHJcbiAgICAgICAgaWYgKG0pIHJlc3VsdC5wdXNoKGAke219IG1pbmApO1xyXG4gICAgICAgIGlmIChzKSByZXN1bHQucHVzaChgJHtzfXNgKTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA/IHJlc3VsdC5qb2luKFwiIFwiKSA6IFwiMCBtaW5cIjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGb3JtYXRlIGwnaGV1cmUgcG91ciBsZSBzdG9ja2FnZSA6IFwiSEg6bW1cIlxyXG4gICAgZm9ybWF0VGltZUZvclN0b3JhZ2UoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIGRhdGUudG9Mb2NhbGVUaW1lU3RyaW5nKFwiZnItRlJcIiwgeyBob3VyOiBcIjItZGlnaXRcIiwgbWludXRlOiBcIjItZGlnaXRcIiwgaG91cjEyOiBmYWxzZSB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBWYWxpZGF0aW9uIHNpbXBsZSBkdSBmb3JtYXQgXCJISDptbVwiXHJcbiAgICBvdmVycmlkZSB2YWxpZGF0ZSh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBpZiggL15cXGR7Mn06XFxkezJ9JC8udGVzdCh2YWx1ZSkpe1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEJhc2N1bGUgZW50cmUgaW5wdXQgZXQgYWZmaWNoYWdlXHJcbiAgICBvdmVycmlkZSBhc3luYyB1cGRhdGVGaWVsZCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCBpbnB1dDogSFRNTElucHV0RWxlbWVudCwgbGluazogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnZhbGlkYXRlKGlucHV0LnZhbHVlKSA/IGlucHV0LnZhbHVlIDogXCJcIjtcclxuICAgICAgICBhd2FpdCB1cGRhdGUodmFsdWUpO1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSB0aGlzLmZvcm1hdFRpbWVGb3JEaXNwbGF5KHZhbHVlKTtcclxuICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSBcIkF1Y3VuZSBoZXVyZSBzw6lsZWN0aW9ubsOpZVwiO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBQb3VyIGFmZmljaGVyIGwnaW5wdXQgw6AgbGEgcGxhY2UgZHUgbGllblxyXG4gICAgb3ZlcnJpZGUgbW9kaWZ5RmllbGQoZXZlbnQ6IEV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgbGluayA9IGV2ZW50LmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gbGluay5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgIGlmICghY29udGFpbmVyKSByZXR1cm47XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBjb250YWluZXIucXVlcnlTZWxlY3RvcihcImlucHV0XCIpO1xyXG4gICAgICAgIGlmIChpbnB1dCkge1xyXG4gICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuICAgICAgICAgICAgaW5wdXQuZm9jdXMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9