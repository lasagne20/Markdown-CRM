a30ca273450b6a349eb49c2fa7aa07a7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TextProperty = void 0;
const Property_1 = require("./Property");
class TextProperty extends Property_1.Property {
    constructor(name, vault, args = {}) {
        super(name, vault, args);
        this.type = "text";
    }
    createFieldInput(value) {
        const textarea = document.createElement("textarea");
        textarea.value = value || "";
        textarea.classList.add("field-textarea");
        textarea.rows = 4; // Default number of rows
        textarea.style.resize = "vertical"; // Allow vertical resizing
        // Add autocomplete functionality
        textarea.setAttribute("data-keydown-listener", "false");
        textarea.oninput = async () => await this.handleAutocomplete(textarea);
        return textarea;
    }
    createFieldContainer() {
        const field = document.createElement("div");
        field.classList.add("metadata-textfield");
        return field;
    }
    createFieldLink(value) {
        const link = document.createElement("div");
        link.innerHTML = value
            ? value.replace(/\[\[(.*?)(?:\|(.*?))?\]\]/g, (_, path, alias) => {
                const display = alias || path;
                return `<strong><a href="#">${display}</a></strong>`;
            })
            : "";
        link.classList.add("field-textlink");
        link.style.cursor = this.static ? "default" : "text";
        if (!this.static) {
            link.onclick = (event) => this.modifyField(event);
        }
        // Add click event for links
        link.querySelectorAll("a").forEach(anchor => {
            anchor.onclick = async (event) => {
                event.preventDefault();
                const target = event.target.textContent;
                if (target) {
                    const classe = this.vault.getFromLink(target);
                    if (classe) {
                        let path = classe.getPath();
                        if (path) {
                            await this.vault.app.open(path);
                        }
                    }
                    else {
                        this.vault.app.sendNotice(`Le fichier ${target}.md n'existe pas`);
                    }
                }
            };
        });
        return link;
    }
    modifyField(event) {
        const link = event.target.closest('.metadata-textfield')?.querySelector('.field-textlink');
        const input = event.target.closest('.metadata-textfield')?.querySelector('.field-textarea');
        if (link && input) {
            link.style.display = "none";
            input.style.display = "block";
            input.focus();
        }
    }
    handleFieldInput(update, input, link) {
        input.onblur = async () => {
            if (!input.parentElement?.querySelector(".autocomplete-dropdown")) {
                await this.updateField(update, input, link);
                return;
            }
        };
        input.onkeydown = async (event) => {
            if (event.key === "Escape") {
                event.preventDefault();
                await this.updateField(update, input, link);
            }
        };
    }
    async handleAutocomplete(textarea) {
        let dropdown = textarea.parentElement?.querySelector(".autocomplete-dropdown");
        // Remove existing dropdown if present
        if (dropdown) {
            dropdown.remove();
        }
        dropdown = document.createElement("div");
        dropdown.classList.add("autocomplete-dropdown");
        const cursorPosition = textarea.selectionStart || 0;
        const textBeforeCursor = textarea.value.substring(0, cursorPosition);
        const lastWordMatch = textBeforeCursor.match(/(\S+)$/);
        const query = lastWordMatch ? lastWordMatch[0].toLowerCase() : "";
        if (!query) {
            return; // No query, don't show the dropdown
        }
        /* TODO
        const files = (await this.vault.app.listFiles());
        const suggestions = files.filter((file: File) =>
          file.getName().toLowerCase().includes(query)
        );*/
        const files = await this.vault.app.listFiles();
        const suggestions = files.filter((file) => file.name.toLowerCase().includes(query));
        if (suggestions.length === 0) {
            return; // No suggestions, don't show the dropdown
        }
        // Calculate the position of the word being edited
        const textBeforeWord = textBeforeCursor.substring(0, lastWordMatch?.index || 0);
        const tempSpan = document.createElement("span");
        tempSpan.style.visibility = "hidden";
        tempSpan.style.whiteSpace = "pre-wrap";
        tempSpan.style.position = "absolute";
        tempSpan.style.font = window.getComputedStyle(textarea).font;
        tempSpan.textContent = textBeforeWord;
        document.body.appendChild(tempSpan);
        const rect = tempSpan.getBoundingClientRect();
        const textareaRect = textarea.getBoundingClientRect();
        dropdown.style.top = `${textareaRect.top + rect.height + window.scrollY}px`;
        dropdown.style.left = `${textareaRect.left + rect.width + window.scrollX}px`;
        dropdown.style.width = `${textareaRect.width}px`;
        document.body.removeChild(tempSpan);
        suggestions.forEach((file, index) => {
            const item = document.createElement("div");
            item.classList.add("autocomplete-item");
            item.textContent = file.name;
            item.tabIndex = 0; // Make it focusable
            item.dataset.index = index.toString();
            item.onclick = () => {
                this.insertSuggestion(textarea, `[[${file.path}|${file.name}]]`, lastWordMatch?.index || 0, query.length);
                dropdown.remove();
            };
            dropdown.appendChild(item);
        });
        textarea.parentElement?.appendChild(dropdown);
        // Adjust the parent's style to position the dropdown correctly
        const parent = textarea.parentElement;
        parent.style.position = "flex";
        parent.style.flexDirection = "column";
        let selectedIndex = -1;
        const updateSelection = (newIndex) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (selectedIndex >= 0) {
                items[selectedIndex].classList.remove("selected");
            }
            selectedIndex = newIndex;
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                items[selectedIndex].classList.add("selected");
                items[selectedIndex].scrollIntoView({ block: "nearest" });
            }
        };
        const handleKeyDown = (event) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (event.key === "ArrowDown") {
                event.preventDefault();
                updateSelection((selectedIndex + 1) % items.length);
            }
            else if (event.key === "ArrowUp") {
                event.preventDefault();
                updateSelection((selectedIndex - 1 + items.length) % items.length);
            }
            else if (event.key === "Escape") {
                dropdown.remove();
                textarea.removeEventListener("keydown", handleKeyDown); // Clean up event listener
                textarea.removeEventListener("keydown", handleEnter);
            }
        };
        let isEnterHandled = false;
        const handleEnter = (event) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (event.key === "Enter") {
                if (isEnterHandled)
                    return; // Empêche l'exécution multiple
                isEnterHandled = true;
                textarea.removeEventListener("keydown", handleKeyDown);
                textarea.removeEventListener("keydown", handleEnter);
                dropdown.remove();
                event.preventDefault();
                const items = dropdown.querySelectorAll(".autocomplete-item");
                if (selectedIndex >= 0 && selectedIndex < items.length) {
                    const selectedItem = items[selectedIndex];
                    const suggestion = selectedItem.textContent || "";
                    this.insertSuggestion(textarea, `[[${suggestion}]]`, lastWordMatch?.index || 0, query.length);
                }
            }
        };
        if (!textarea.hasAttribute("data-keydown-listener")) {
            textarea.addEventListener("keydown", handleKeyDown);
            textarea.addEventListener("keydown", handleEnter);
            textarea.setAttribute("data-keydown-listener", "true");
        }
        const removeDropdown = () => {
            dropdown.remove();
            textarea.removeEventListener("keydown", handleKeyDown);
        };
        document.addEventListener("click", (event) => {
            if (!dropdown.contains(event.target) && event.target !== textarea) {
                removeDropdown();
            }
        }, { once: true });
    }
    insertSuggestion(textarea, suggestion, startIndex, queryLength) {
        console.log(textarea, suggestion, startIndex, queryLength);
        const before = textarea.value.substring(0, startIndex);
        const after = textarea.value.substring(startIndex + queryLength);
        textarea.value = `${before}${suggestion}${after}`;
        textarea.setSelectionRange(before.length + suggestion.length, before.length + suggestion.length);
        textarea.focus();
    }
}
exports.TextProperty = TextProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFRleHRQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSx5Q0FBc0M7QUFLdEMsTUFBYSxZQUFhLFNBQVEsbUJBQVE7SUFHeEMsWUFBWSxJQUFZLEVBQUUsS0FBWSxFQUFFLElBQUksR0FBRyxFQUFFO1FBQy9DLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSGxCLFNBQUksR0FBVyxNQUFNLENBQUM7SUFJL0IsQ0FBQztJQUVRLGdCQUFnQixDQUFDLEtBQWE7UUFDckMsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNwRCxRQUFRLENBQUMsS0FBSyxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDN0IsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6QyxRQUFRLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLHlCQUF5QjtRQUM1QyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsQ0FBQywwQkFBMEI7UUFFOUQsaUNBQWlDO1FBQ2pDLFFBQVEsQ0FBQyxZQUFZLENBQUMsdUJBQXVCLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDdkQsUUFBUSxDQUFDLE9BQU8sR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXZFLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFUSxvQkFBb0I7UUFDM0IsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QyxLQUFLLENBQUMsU0FBUyxD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T0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQWMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzFFLGNBQWMsRUFBRSxDQUFDO1lBQ25CLENBQUM7UUFDSCxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNyQixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsUUFBNkIsRUFBRSxVQUFrQixFQUFFLFVBQWtCLEVBQUUsV0FBbUI7UUFDekcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUMzRCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDdkQsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQyxDQUFDO1FBQ2pFLFFBQVEsQ0FBQyxLQUFLLEdBQUcsR0FBRyxNQUFNLEdBQUcsVUFBVSxHQUFHLEtBQUssRUFBRSxDQUFDO1FBQ2xELFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakcsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQTdPRCxvQ0E2T0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFRleHRQcm9wZXJ0eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMaW5rUHJvcGVydHkgfSBmcm9tIFwiLi9MaW5rUHJvcGVydHlcIjtcclxuaW1wb3J0IHsgUHJvcGVydHkgfSBmcm9tIFwiLi9Qcm9wZXJ0eVwiO1xyXG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xyXG5pbXBvcnQgeyBJRmlsZSB9IGZyb20gXCIuLi9pbnRlcmZhY2VzL0lBcHBcIjtcclxuaW1wb3J0IHsgVmF1bHQgfSBmcm9tIFwiLi4vdmF1bHQvVmF1bHRcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBUZXh0UHJvcGVydHkgZXh0ZW5kcyBQcm9wZXJ0eSB7XHJcbiAgb3ZlcnJpZGUgdHlwZTogc3RyaW5nID0gXCJ0ZXh0XCI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgdmF1bHQ6IFZhdWx0LCBhcmdzID0ge30pIHtcclxuICAgIHN1cGVyKG5hbWUsIHZhdWx0LCBhcmdzKTtcclxuICB9XHJcblxyXG4gIG92ZXJyaWRlIGNyZWF0ZUZpZWxkSW5wdXQodmFsdWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgdGV4dGFyZWEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwidGV4dGFyZWFcIik7XHJcbiAgICB0ZXh0YXJlYS52YWx1ZSA9IHZhbHVlIHx8IFwiXCI7XHJcbiAgICB0ZXh0YXJlYS5jbGFzc0xpc3QuYWRkKFwiZmllbGQtdGV4dGFyZWFcIik7XHJcbiAgICB0ZXh0YXJlYS5yb3dzID0gNDsgLy8gRGVmYXVsdCBudW1iZXIgb2Ygcm93c1xyXG4gICAgdGV4dGFyZWEuc3R5bGUucmVzaXplID0gXCJ2ZXJ0aWNhbFwiOyAvLyBBbGxvdyB2ZXJ0aWNhbCByZXNpemluZ1xyXG5cclxuICAgIC8vIEFkZCBhdXRvY29tcGxldGUgZnVuY3Rpb25hbGl0eVxyXG4gICAgdGV4dGFyZWEuc2V0QXR0cmlidXRlKFwiZGF0YS1rZXlkb3duLWxpc3RlbmVyXCIsIFwiZmFsc2VcIilcclxuICAgIHRleHRhcmVhLm9uaW5wdXQgPSBhc3luYyAoKSA9PiBhd2FpdCB0aGlzLmhhbmRsZUF1dG9jb21wbGV0ZSh0ZXh0YXJlYSk7XHJcblxyXG4gICAgcmV0dXJuIHRleHRhcmVhO1xyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgY3JlYXRlRmllbGRDb250YWluZXIoKSB7XHJcbiAgICBjb25zdCBmaWVsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBmaWVsZC5jbGFzc0xpc3QuYWRkKFwibWV0YWRhdGEtdGV4dGZpZWxkXCIpO1xyXG4gICAgcmV0dXJuIGZpZWxkO1xyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgY3JlYXRlRmllbGRMaW5rKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgbGluay5pbm5lckhUTUwgPSB2YWx1ZVxyXG4gICAgICA/IHZhbHVlLnJlcGxhY2UoL1xcW1xcWyguKj8pKD86XFx8KC4qPykpP1xcXVxcXS9nLCAoXywgcGF0aCwgYWxpYXMpID0+IHtcclxuICAgICAgICBjb25zdCBkaXNwbGF5ID0gYWxpYXMgfHwgcGF0aDtcclxuICAgICAgICByZXR1cm4gYDxzdHJvbmc+PGEgaHJlZj1cIiNcIj4ke2Rpc3BsYXl9PC9hPjwvc3Ryb25nPmA7XHJcbiAgICAgIH0pXHJcbiAgICAgIDogXCJcIjtcclxuICAgIGxpbmsuY2xhc3NMaXN0LmFkZChcImZpZWxkLXRleHRsaW5rXCIpO1xyXG4gICAgbGluay5zdHlsZS5jdXJzb3IgPSB0aGlzLnN0YXRpYyA/IFwiZGVmYXVsdFwiIDogXCJ0ZXh0XCI7XHJcbiAgICBpZiAoIXRoaXMuc3RhdGljKSB7XHJcbiAgICAgIGxpbmsub25jbGljayA9IChldmVudCkgPT4gdGhpcy5tb2RpZnlGaWVsZChldmVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWRkIGNsaWNrIGV2ZW50IGZvciBsaW5rc1xyXG4gICAgbGluay5xdWVyeVNlbGVjdG9yQWxsKFwiYVwiKS5mb3JFYWNoKGFuY2hvciA9PiB7XHJcbiAgICAgIGFuY2hvci5vbmNsaWNrID0gYXN5bmMgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBjb25zdCB0YXJnZXQgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS50ZXh0Q29udGVudDtcclxuICAgICAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgICAgICBjb25zdCBjbGFzc2UgPSB0aGlzLnZhdWx0LmdldEZyb21MaW5rKHRhcmdldCk7XHJcbiAgICAgICAgICBpZiAoY2xhc3NlKSB7XHJcbiAgICAgICAgICAgICAgbGV0IHBhdGggPSBjbGFzc2UuZ2V0UGF0aCgpO1xyXG4gICAgICAgICAgICAgIGlmIChwYXRoKXtcclxuICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC5vcGVuKHBhdGgpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudmF1bHQuYXBwLnNlbmROb3RpY2UoYExlIGZpY2hpZXIgJHt0YXJnZXR9Lm1kIG4nZXhpc3RlIHBhc2ApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBsaW5rO1xyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgbW9kaWZ5RmllbGQoZXZlbnQ6IEV2ZW50KSB7XHJcbiAgICBjb25zdCBsaW5rID0gKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuY2xvc2VzdCgnLm1ldGFkYXRhLXRleHRmaWVsZCcpPy5xdWVyeVNlbGVjdG9yKCcuZmllbGQtdGV4dGxpbmsnKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGNvbnN0IGlucHV0ID0gKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuY2xvc2VzdCgnLm1ldGFkYXRhLXRleHRmaWVsZCcpPy5xdWVyeVNlbGVjdG9yKCcuZmllbGQtdGV4dGFyZWEnKSBhcyBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgaWYgKGxpbmsgJiYgaW5wdXQpIHtcclxuICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgIGlucHV0LnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgIGlucHV0LmZvY3VzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBvdmVycmlkZSBoYW5kbGVGaWVsZElucHV0KHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIGlucHV0OiBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTFRleHRBcmVhRWxlbWVudCwgbGluazogSFRNTEVsZW1lbnQpIHtcclxuICAgIGlucHV0Lm9uYmx1ciA9IGFzeW5jICgpID0+IHtcclxuICAgICAgaWYgKCFpbnB1dC5wYXJlbnRFbGVtZW50Py5xdWVyeVNlbGVjdG9yKFwiLmF1dG9jb21wbGV0ZS1kcm9wZG93blwiKSkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlRmllbGQodXBkYXRlLCBpbnB1dCwgbGluayk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGlucHV0Lm9ua2V5ZG93biA9IGFzeW5jIChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiRXNjYXBlXCIpIHtcclxuICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpZWxkKHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuXHJcbiAgYXN5bmMgaGFuZGxlQXV0b2NvbXBsZXRlKHRleHRhcmVhOiBIVE1MVGV4dEFyZWFFbGVtZW50KSB7XHJcbiAgICBsZXQgZHJvcGRvd24gPSB0ZXh0YXJlYS5wYXJlbnRFbGVtZW50Py5xdWVyeVNlbGVjdG9yKFwiLmF1dG9jb21wbGV0ZS1kcm9wZG93blwiKSBhcyBIVE1MRWxlbWVudDtcclxuXHJcbiAgICAvLyBSZW1vdmUgZXhpc3RpbmcgZHJvcGRvd24gaWYgcHJlc2VudFxyXG4gICAgaWYgKGRyb3Bkb3duKSB7XHJcbiAgICAgIGRyb3Bkb3duLnJlbW92ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGRyb3Bkb3duID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgIGRyb3Bkb3duLmNsYXNzTGlzdC5hZGQoXCJhdXRvY29tcGxldGUtZHJvcGRvd25cIik7XHJcblxyXG4gICAgY29uc3QgY3Vyc29yUG9zaXRpb24gPSB0ZXh0YXJlYS5zZWxlY3Rpb25TdGFydCB8fCAwO1xyXG4gICAgY29uc3QgdGV4dEJlZm9yZUN1cnNvciA9IHRleHRhcmVhLnZhbHVlLnN1YnN0cmluZygwLCBjdXJzb3JQb3NpdGlvbik7XHJcbiAgICBjb25zdCBsYXN0V29yZE1hdGNoID0gdGV4dEJlZm9yZUN1cnNvci5tYXRjaCgvKFxcUyspJC8pO1xyXG4gICAgY29uc3QgcXVlcnkgPSBsYXN0V29yZE1hdGNoID8gbGFzdFdvcmRNYXRjaFswXS50b0xvd2VyQ2FzZSgpIDogXCJcIjtcclxuXHJcbiAgICBpZiAoIXF1ZXJ5KSB7XHJcbiAgICAgIHJldHVybjsgLy8gTm8gcXVlcnksIGRvbid0IHNob3cgdGhlIGRyb3Bkb3duXHJcbiAgICB9XHJcblxyXG4gICAgLyogVE9ET1xyXG4gICAgY29uc3QgZmlsZXMgPSAoYXdhaXQgdGhpcy52YXVsdC5hcHAubGlzdEZpbGVzKCkpO1xyXG4gICAgY29uc3Qgc3VnZ2VzdGlvbnMgPSBmaWxlcy5maWx0ZXIoKGZpbGU6IEZpbGUpID0+XHJcbiAgICAgIGZpbGUuZ2V0TmFtZSgpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMocXVlcnkpXHJcbiAgICApOyovXHJcbiAgICBjb25zdCBmaWxlcyA9IGF3YWl0IHRoaXMudmF1bHQuYXBwLmxpc3RGaWxlcygpO1xyXG4gICAgY29uc3Qgc3VnZ2VzdGlvbnMgPSBmaWxlcy5maWx0ZXIoKGZpbGU6IElGaWxlKSA9PlxyXG4gICAgICBmaWxlLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxdWVyeSlcclxuICAgICk7ICBcclxuXHJcbiAgICBpZiAoc3VnZ2VzdGlvbnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybjsgLy8gTm8gc3VnZ2VzdGlvbnMsIGRvbid0IHNob3cgdGhlIGRyb3Bkb3duXHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2FsY3VsYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgd29yZCBiZWluZyBlZGl0ZWRcclxuICAgIGNvbnN0IHRleHRCZWZvcmVXb3JkID0gdGV4dEJlZm9yZUN1cnNvci5zdWJzdHJpbmcoMCwgbGFzdFdvcmRNYXRjaD8uaW5kZXggfHwgMCk7XHJcbiAgICBjb25zdCB0ZW1wU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzcGFuXCIpO1xyXG4gICAgdGVtcFNwYW4uc3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XHJcbiAgICB0ZW1wU3Bhbi5zdHlsZS53aGl0ZVNwYWNlID0gXCJwcmUtd3JhcFwiO1xyXG4gICAgdGVtcFNwYW4uc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XHJcbiAgICB0ZW1wU3Bhbi5zdHlsZS5mb250ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGV4dGFyZWEpLmZvbnQ7XHJcbiAgICB0ZW1wU3Bhbi50ZXh0Q29udGVudCA9IHRleHRCZWZvcmVXb3JkO1xyXG5cclxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGVtcFNwYW4pO1xyXG4gICAgY29uc3QgcmVjdCA9IHRlbXBTcGFuLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgY29uc3QgdGV4dGFyZWFSZWN0ID0gdGV4dGFyZWEuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICBkcm9wZG93bi5zdHlsZS50b3AgPSBgJHt0ZXh0YXJlYVJlY3QudG9wICsgcmVjdC5oZWlnaHQgKyB3aW5kb3cuc2Nyb2xsWX1weGA7XHJcbiAgICBkcm9wZG93bi5zdHlsZS5sZWZ0ID0gYCR7dGV4dGFyZWFSZWN0LmxlZnQgKyByZWN0LndpZHRoICsgd2luZG93LnNjcm9sbFh9cHhgO1xyXG4gICAgZHJvcGRvd24uc3R5bGUud2lkdGggPSBgJHt0ZXh0YXJlYVJlY3Qud2lkdGh9cHhgO1xyXG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZW1wU3Bhbik7XHJcblxyXG4gICAgc3VnZ2VzdGlvbnMuZm9yRWFjaCgoZmlsZTogSUZpbGUsIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgY29uc3QgaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZChcImF1dG9jb21wbGV0ZS1pdGVtXCIpO1xyXG4gICAgICBpdGVtLnRleHRDb250ZW50ID0gZmlsZS5uYW1lO1xyXG4gICAgICBpdGVtLnRhYkluZGV4ID0gMDsgLy8gTWFrZSBpdCBmb2N1c2FibGVcclxuICAgICAgaXRlbS5kYXRhc2V0LmluZGV4ID0gaW5kZXgudG9TdHJpbmcoKTtcclxuXHJcbiAgICAgIGl0ZW0ub25jbGljayA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmluc2VydFN1Z2dlc3Rpb24odGV4dGFyZWEsIGBbWyR7ZmlsZS5wYXRofXwke2ZpbGUubmFtZX1dXWAsIGxhc3RXb3JkTWF0Y2g/LmluZGV4IHx8IDAsIHF1ZXJ5Lmxlbmd0aCk7XHJcbiAgICAgICAgZHJvcGRvd24ucmVtb3ZlKCk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICBkcm9wZG93bi5hcHBlbmRDaGlsZChpdGVtKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRleHRhcmVhLnBhcmVudEVsZW1lbnQ/LmFwcGVuZENoaWxkKGRyb3Bkb3duKTtcclxuICAgIC8vIEFkanVzdCB0aGUgcGFyZW50J3Mgc3R5bGUgdG8gcG9zaXRpb24gdGhlIGRyb3Bkb3duIGNvcnJlY3RseVxyXG4gICAgY29uc3QgcGFyZW50ID0gdGV4dGFyZWEucGFyZW50RWxlbWVudCBhcyBIVE1MRWxlbWVudDtcclxuICAgIHBhcmVudC5zdHlsZS5wb3NpdGlvbiA9IFwiZmxleFwiO1xyXG4gICAgcGFyZW50LnN0eWxlLmZsZXhEaXJlY3Rpb24gPSBcImNvbHVtblwiO1xyXG5cclxuICAgIGxldCBzZWxlY3RlZEluZGV4ID0gLTE7XHJcblxyXG4gICAgY29uc3QgdXBkYXRlU2VsZWN0aW9uID0gKG5ld0luZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgY29uc3QgaXRlbXMgPSBkcm9wZG93bi5xdWVyeVNlbGVjdG9yQWxsKFwiLmF1dG9jb21wbGV0ZS1pdGVtXCIpO1xyXG4gICAgICBpZiAoc2VsZWN0ZWRJbmRleCA+PSAwKSB7XHJcbiAgICAgICAgaXRlbXNbc2VsZWN0ZWRJbmRleF0uY2xhc3NMaXN0LnJlbW92ZShcInNlbGVjdGVkXCIpO1xyXG4gICAgICB9XHJcbiAgICAgIHNlbGVjdGVkSW5kZXggPSBuZXdJbmRleDtcclxuICAgICAgaWYgKHNlbGVjdGVkSW5kZXggPj0gMCAmJiBzZWxlY3RlZEluZGV4IDwgaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgaXRlbXNbc2VsZWN0ZWRJbmRleF0uY2xhc3NMaXN0LmFkZChcInNlbGVjdGVkXCIpO1xyXG4gICAgICAgIGl0ZW1zW3NlbGVjdGVkSW5kZXhdLnNjcm9sbEludG9WaWV3KHsgYmxvY2s6IFwibmVhcmVzdFwiIH0pO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IGhhbmRsZUtleURvd24gPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgY29uc3QgaXRlbXMgPSBkcm9wZG93bi5xdWVyeVNlbGVjdG9yQWxsKFwiLmF1dG9jb21wbGV0ZS1pdGVtXCIpO1xyXG4gICAgICBpZiAoZXZlbnQua2V5ID09PSBcIkFycm93RG93blwiKSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICB1cGRhdGVTZWxlY3Rpb24oKHNlbGVjdGVkSW5kZXggKyAxKSAlIGl0ZW1zLmxlbmd0aCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSBcIkFycm93VXBcIikge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgdXBkYXRlU2VsZWN0aW9uKChzZWxlY3RlZEluZGV4IC0gMSArIGl0ZW1zLmxlbmd0aCkgJSBpdGVtcy5sZW5ndGgpO1xyXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIikge1xyXG4gICAgICAgIGRyb3Bkb3duLnJlbW92ZSgpO1xyXG4gICAgICAgIHRleHRhcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIGhhbmRsZUtleURvd24pOyAvLyBDbGVhbiB1cCBldmVudCBsaXN0ZW5lclxyXG4gICAgICAgIHRleHRhcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIGhhbmRsZUVudGVyKVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgbGV0IGlzRW50ZXJIYW5kbGVkID0gZmFsc2U7XHJcbiAgICBjb25zdCBoYW5kbGVFbnRlciA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtcyA9IGRyb3Bkb3duLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYXV0b2NvbXBsZXRlLWl0ZW1cIik7XHJcbiAgICAgIGlmIChldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xyXG4gICAgICAgIGlmIChpc0VudGVySGFuZGxlZCkgcmV0dXJuOyAvLyBFbXDDqmNoZSBsJ2V4w6ljdXRpb24gbXVsdGlwbGVcclxuICAgICAgICBpc0VudGVySGFuZGxlZCA9IHRydWU7XHJcbiAgICAgICAgdGV4dGFyZWEucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgaGFuZGxlS2V5RG93bilcclxuICAgICAgICB0ZXh0YXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBoYW5kbGVFbnRlcilcclxuICAgICAgICBkcm9wZG93bi5yZW1vdmUoKTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gZHJvcGRvd24ucXVlcnlTZWxlY3RvckFsbChcIi5hdXRvY29tcGxldGUtaXRlbVwiKTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWRJbmRleCA+PSAwICYmIHNlbGVjdGVkSW5kZXggPCBpdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgIGNvbnN0IHNlbGVjdGVkSXRlbSA9IGl0ZW1zW3NlbGVjdGVkSW5kZXhdO1xyXG4gICAgICAgICAgY29uc3Qgc3VnZ2VzdGlvbiA9IHNlbGVjdGVkSXRlbS50ZXh0Q29udGVudCB8fCBcIlwiO1xyXG4gICAgICAgICAgdGhpcy5pbnNlcnRTdWdnZXN0aW9uKHRleHRhcmVhLCBgW1ske3N1Z2dlc3Rpb259XV1gLCBsYXN0V29yZE1hdGNoPy5pbmRleCB8fCAwLCBxdWVyeS5sZW5ndGgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAoIXRleHRhcmVhLmhhc0F0dHJpYnV0ZShcImRhdGEta2V5ZG93bi1saXN0ZW5lclwiKSkge1xyXG4gICAgICB0ZXh0YXJlYS5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBoYW5kbGVLZXlEb3duKTtcclxuICAgICAgdGV4dGFyZWEuYWRkRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgaGFuZGxlRW50ZXIpO1xyXG4gICAgICB0ZXh0YXJlYS5zZXRBdHRyaWJ1dGUoXCJkYXRhLWtleWRvd24tbGlzdGVuZXJcIiwgXCJ0cnVlXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlbW92ZURyb3Bkb3duID0gKCkgPT4ge1xyXG4gICAgICBkcm9wZG93bi5yZW1vdmUoKTtcclxuICAgICAgdGV4dGFyZWEucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgaGFuZGxlS2V5RG93bik7XHJcbiAgICB9O1xyXG5cclxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoZXZlbnQpID0+IHtcclxuICAgICAgaWYgKCFkcm9wZG93bi5jb250YWlucyhldmVudC50YXJnZXQgYXMgTm9kZSkgJiYgZXZlbnQudGFyZ2V0ICE9PSB0ZXh0YXJlYSkge1xyXG4gICAgICAgIHJlbW92ZURyb3Bkb3duKCk7XHJcbiAgICAgIH1cclxuICAgIH0sIHsgb25jZTogdHJ1ZSB9KTtcclxuICB9XHJcblxyXG4gIGluc2VydFN1Z2dlc3Rpb24odGV4dGFyZWE6IEhUTUxUZXh0QXJlYUVsZW1lbnQsIHN1Z2dlc3Rpb246IHN0cmluZywgc3RhcnRJbmRleDogbnVtYmVyLCBxdWVyeUxlbmd0aDogbnVtYmVyKSB7XHJcbiAgICBjb25zb2xlLmxvZyh0ZXh0YXJlYSwgc3VnZ2VzdGlvbiwgc3RhcnRJbmRleCwgcXVlcnlMZW5ndGgpO1xyXG4gICAgY29uc3QgYmVmb3JlID0gdGV4dGFyZWEudmFsdWUuc3Vic3RyaW5nKDAsIHN0YXJ0SW5kZXgpO1xyXG4gICAgY29uc3QgYWZ0ZXIgPSB0ZXh0YXJlYS52YWx1ZS5zdWJzdHJpbmcoc3RhcnRJbmRleCArIHF1ZXJ5TGVuZ3RoKTtcclxuICAgIHRleHRhcmVhLnZhbHVlID0gYCR7YmVmb3JlfSR7c3VnZ2VzdGlvbn0ke2FmdGVyfWA7XHJcbiAgICB0ZXh0YXJlYS5zZXRTZWxlY3Rpb25SYW5nZShiZWZvcmUubGVuZ3RoICsgc3VnZ2VzdGlvbi5sZW5ndGgsIGJlZm9yZS5sZW5ndGggKyBzdWdnZXN0aW9uLmxlbmd0aCk7XHJcbiAgICB0ZXh0YXJlYS5mb2N1cygpO1xyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=