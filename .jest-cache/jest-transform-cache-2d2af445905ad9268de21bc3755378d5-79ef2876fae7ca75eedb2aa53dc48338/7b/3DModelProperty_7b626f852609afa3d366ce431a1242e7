db87cc81301a000e484345d064c79304
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ThreeDModelProperty = void 0;
const MediaProperty_1 = require("./MediaProperty");
class ThreeDModelProperty extends MediaProperty_1.MediaProperty {
    constructor(name, vault, args = { icon: "box", create: "" }) {
        super(name, vault, args);
        this.type = "3dmodel";
    }
    /**
     * Renders a 3D model using THREE.js
     */
    render3DModel(mediaPath, container) {
        // Check if the file exists in the vault before trying to load it
        const fileExists = this.vault.app.getFile(mediaPath);
        if (!fileExists) {
            const errorDiv = document.createElement("div");
            errorDiv.textContent = `Rendu 3D introuvable. Ouvrir le fichier dans FreeCAD pour le créer.`;
            console.error("3D model file not found:", mediaPath);
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
            return;
        }
        const embed = document.createElement("canvas");
        embed.classList.add("embed-media");
        container.appendChild(embed);
        const renderer = new THREE.WebGLRenderer({ canvas: embed, alpha: true, antialias: true });
        renderer.setSize(300, 300);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);
        // Position the camera directly above, looking down the -Z axis
        camera.position.set(0, 10, 0);
        camera.up.set(0, 0, -1); // Make Z axis "up" for the camera
        camera.lookAt(0, 0, 0);
        // Add multiple directional lights from different directions for even illumination
        const directions = [
            [0, 10, 0], // Top
            [0, -10, 0], // Bottom
            [10, 0, 0], // Right
            [-10, 0, 0], // Left
            [0, 0, 10], // Front
            [0, 0, -10], // Back
        ];
        directions.forEach(dir => {
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(dir[0], dir[1], dir[2]);
            light.target.position.set(0, 0, 0);
            scene.add(light);
            scene.add(light.target);
        });
        // Optionally add a soft ambient light for subtle fill
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);
        const loader = new GLTFLoader();
        let model;
        let animationActive = true; // Track animation state
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Smooth rotation
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.enableRotate = true;
        controls.minPolarAngle = 0; // Permet toutes les rotations verticales
        controls.maxPolarAngle = Math.PI; // Permet toutes les rotations verticales
        controls.target.set(0, 0, 0);
        loader.load(this.vault.app.getAbsolutePath(mediaPath), (gltf) => {
            model = gltf.scene;
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    // Handle both array and single material
                    const materials = Array.isArray(child.material) ? child.material : [child.material];
                    for (const mat of materials) {
                        if (mat.transparent || mat.opacity < 0.5) {
                            // Set mesh to be fully visible (opaque)
                            mat.opacity = 1;
                            mat.transparent = false;
                        }
                    }
                }
            });
            // Automatically center the model
            const box = new THREE.Box3().setFromObject(model);
            const center = new THREE.Vector3();
            const size = new THREE.Vector3();
            box.getCenter(center);
            box.getSize(size);
            // Center the model at the origin
            model.position.sub(center);
            // Scale model to fill 80% of the 300x300 area
            const maxDim = Math.max(size.x, size.y, size.z);
            const targetFill = 0.8;
            const viewHeight = 2 * camera.position.y * Math.tan((camera.fov * Math.PI) / 360);
            const desiredSize = viewHeight * targetFill;
            const scale = desiredSize / maxDim;
            model.scale.setScalar(scale);
            scene.add(model);
            // Animation function
            const animate = () => {
                if (animationActive) {
                    requestAnimationFrame(animate);
                    // Rotate the model
                    if (model) {
                        model.rotation.z += 0.01; // Rotate around Z-axis
                    }
                    controls.update(); // Update camera controls
                    renderer.render(scene, camera);
                }
            };
            animate();
            // Reset model position and rotation after loading
            model.rotation.set(0, 0, 0);
            // Recalculate bounding box after positioning
            const newBox = new THREE.Box3().setFromObject(model);
            const newCenter = new THREE.Vector3();
            newBox.getCenter(newCenter);
            model.position.sub(newCenter);
            controls.update();
        }, undefined, (error) => {
            console.error("Erreur lors du chargement du modèle 3D:", error);
            const errorDiv = document.createElement("div");
            errorDiv.textContent = "Erreur lors du chargement du modèle 3D";
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
        });
        // Add interaction controls
        embed.addEventListener("mouseenter", () => {
            animationActive = false;
        });
        embed.addEventListener("mouseleave", () => {
            animationActive = true;
        });
    }
    fillDisplay(value, update, file = null) {
        const mediaFile = this.vault.getMediaFromLink(value);
        if (!mediaFile) {
            return super.fillDisplay(value, update, file);
        }
        const mediaPath = value;
        if (!mediaPath) {
            return super.fillDisplay(value, update, file);
        }
        const extension = mediaPath.split('.').pop()?.toLowerCase();
        // Check if it's a 3D model file
        if (['gltf', 'glb'].includes(extension || '')) {
            const container = document.createElement("div");
            container.classList.add("embed-container");
            this.render3DModel(mediaPath, container);
            return container;
        }
        // For non-3D files, use the parent MediaProperty behavior
        return super.fillDisplay(value, update, file);
    }
}
exports.ThreeDModelProperty = ThreeDModelProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXDNETW9kZWxQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBZ0Q7QUFTaEQsTUFBYSxtQkFBb0IsU0FBUSw2QkFBYTtJQUlsRCxZQUFZLElBQVksRUFBRSxLQUFhLEVBQUUsT0FBNEQsRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUM7UUFDMUgsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFIYixTQUFJLEdBQVcsU0FBUyxDQUFDO0lBSXpDLENBQUM7SUFFRDs7T0FFRztJQUNPLGFBQWEsQ0FBQyxTQUFpQixFQUFFLFNBQXlCO1FBQ2hFLGlFQUFpRTtRQUNqRSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2QsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQyxRQUFRLENBQUMsV0FBVyxHQUFHLHFFQUFxRSxDQUFDO1lBQzdGLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDckQsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQ3BDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQztZQUNwQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUM7WUFDOUIsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNoQyxPQUFPO1FBQ1gsQ0FBQztRQUVELE1BQU0s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QUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQzVDLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEQsU0FBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUMzQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUN6QyxPQUFPLFNBQVMsQ0FBQztRQUNyQixDQUFDO1FBRUQsMERBQTBEO1FBQzFELE9BQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7Q0FDSjtBQXRMRCxrREFzTEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXDNETW9kZWxQcm9wZXJ0eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWYXVsdCB9IGZyb20gXCJ2YXVsdC9WYXVsdFwiO1xyXG5pbXBvcnQgeyBNZWRpYVByb3BlcnR5IH0gZnJvbSBcIi4vTWVkaWFQcm9wZXJ0eVwiO1xyXG5cclxuLy8gRMOpY2xhcmF0aW9ucyB0ZW1wb3JhaXJlcyBwb3VyIGxlcyBkw6lwZW5kYW5jZXMgM0RcclxuZGVjbGFyZSBjb25zdCBUSFJFRTogYW55O1xyXG5kZWNsYXJlIGNvbnN0IEdMVEZMb2FkZXI6IGFueTtcclxuZGVjbGFyZSBjb25zdCBPcmJpdENvbnRyb2xzOiBhbnk7XHJcbmRlY2xhcmUgY29uc3QgRnJlZWNhZEZpbGU6IGFueTtcclxuZGVjbGFyZSBjb25zdCBzaGVsbDogYW55O1xyXG5cclxuZXhwb3J0IGNsYXNzIFRocmVlRE1vZGVsUHJvcGVydHkgZXh0ZW5kcyBNZWRpYVByb3BlcnR5IHtcclxuICAgIFxyXG4gICAgcHVibGljIG92ZXJyaWRlIHR5cGU6IHN0cmluZyA9IFwiM2Rtb2RlbFwiO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgdmF1bHQgOiBWYXVsdCwgYXJnczogeyBpY29uPzogc3RyaW5nOyBkaXNwbGF5Pzogc3RyaW5nOyBjcmVhdGU/OiBzdHJpbmd9ID0ge2ljb246IFwiYm94XCIsIGNyZWF0ZTogXCJcIn0pIHtcclxuICAgICAgICBzdXBlcihuYW1lLCB2YXVsdCwgYXJncyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW5kZXJzIGEgM0QgbW9kZWwgdXNpbmcgVEhSRUUuanNcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIHJlbmRlcjNETW9kZWwobWVkaWFQYXRoOiBzdHJpbmcsIGNvbnRhaW5lcjogSFRNTERpdkVsZW1lbnQpOiB2b2lkIHtcclxuICAgICAgICAvLyBDaGVjayBpZiB0aGUgZmlsZSBleGlzdHMgaW4gdGhlIHZhdWx0IGJlZm9yZSB0cnlpbmcgdG8gbG9hZCBpdFxyXG4gICAgICAgIGNvbnN0IGZpbGVFeGlzdHMgPSB0aGlzLnZhdWx0LmFwcC5nZXRGaWxlKG1lZGlhUGF0aCk7XHJcbiAgICAgICAgaWYgKCFmaWxlRXhpc3RzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVycm9yRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICAgICAgZXJyb3JEaXYudGV4dENvbnRlbnQgPSBgUmVuZHUgM0QgaW50cm91dmFibGUuIE91dnJpciBsZSBmaWNoaWVyIGRhbnMgRnJlZUNBRCBwb3VyIGxlIGNyw6llci5gO1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiM0QgbW9kZWwgZmlsZSBub3QgZm91bmQ6XCIsIG1lZGlhUGF0aCk7XHJcbiAgICAgICAgICAgIGVycm9yRGl2LnN0eWxlLnRleHRBbGlnbiA9IFwiY2VudGVyXCI7XHJcbiAgICAgICAgICAgIGVycm9yRGl2LnN0eWxlLm1hcmdpbiA9IFwiNDBweCBhdXRvXCI7XHJcbiAgICAgICAgICAgIGVycm9yRGl2LnN0eWxlLmNvbG9yID0gXCIjYzAwXCI7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlcnJvckRpdik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGVtYmVkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKTtcclxuICAgICAgICBlbWJlZC5jbGFzc0xpc3QuYWRkKFwiZW1iZWQtbWVkaWFcIik7XHJcbiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGVtYmVkKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCByZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHsgY2FudmFzOiBlbWJlZCwgYWxwaGE6IHRydWUsIGFudGlhbGlhczogdHJ1ZSB9KTtcclxuICAgICAgICByZW5kZXJlci5zZXRTaXplKDMwMCwgMzAwKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcclxuICAgICAgICBjb25zdCBjYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNzUsIDEsIDAuMSwgMTAwKTtcclxuICAgICAgICAvLyBQb3NpdGlvbiB0aGUgY2FtZXJhIGRpcmVjdGx5IGFib3ZlLCBsb29raW5nIGRvd24gdGhlIC1aIGF4aXNcclxuICAgICAgICBjYW1lcmEucG9zaXRpb24uc2V0KDAsIDEwLCAwKTtcclxuICAgICAgICBjYW1lcmEudXAuc2V0KDAsIDAsIC0xKTsgLy8gTWFrZSBaIGF4aXMgXCJ1cFwiIGZvciB0aGUgY2FtZXJhXHJcbiAgICAgICAgY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTtcclxuXHJcbiAgICAgICAgLy8gQWRkIG11bHRpcGxlIGRpcmVjdGlvbmFsIGxpZ2h0cyBmcm9tIGRpZmZlcmVudCBkaXJlY3Rpb25zIGZvciBldmVuIGlsbHVtaW5hdGlvblxyXG4gICAgICAgIGNvbnN0IGRpcmVjdGlvbnMgPSBbXHJcbiAgICAgICAgICAgIFswLCAxMCwgMF0sICAgIC8vIFRvcFxyXG4gICAgICAgICAgICBbMCwgLTEwLCAwXSwgICAvLyBCb3R0b21cclxuICAgICAgICAgICAgWzEwLCAwLCAwXSwgICAgLy8gUmlnaHRcclxuICAgICAgICAgICAgWy0xMCwgMCwgMF0sICAgLy8gTGVmdFxyXG4gICAgICAgICAgICBbMCwgMCwgMTBdLCAgICAvLyBGcm9udFxyXG4gICAgICAgICAgICBbMCwgMCwgLTEwXSwgICAvLyBCYWNrXHJcbiAgICAgICAgXTtcclxuICAgICAgICBkaXJlY3Rpb25zLmZvckVhY2goZGlyID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbGlnaHQgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMSk7XHJcbiAgICAgICAgICAgIGxpZ2h0LnBvc2l0aW9uLnNldChkaXJbMF0sIGRpclsxXSwgZGlyWzJdKTtcclxuICAgICAgICAgICAgbGlnaHQudGFyZ2V0LnBvc2l0aW9uLnNldCgwLCAwLCAwKTtcclxuICAgICAgICAgICAgc2NlbmUuYWRkKGxpZ2h0KTtcclxuICAgICAgICAgICAgc2NlbmUuYWRkKGxpZ2h0LnRhcmdldCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gT3B0aW9uYWxseSBhZGQgYSBzb2Z0IGFtYmllbnQgbGlnaHQgZm9yIHN1YnRsZSBmaWxsXHJcbiAgICAgICAgY29uc3QgYW1iaWVudExpZ2h0ID0gbmV3IFRIUkVFLkFtYmllbnRMaWdodCgweGZmZmZmZiwgMC40KTtcclxuICAgICAgICBzY2VuZS5hZGQoYW1iaWVudExpZ2h0KTtcclxuXHJcbiAgICAgICAgY29uc3QgbG9hZGVyID0gbmV3IEdMVEZMb2FkZXIoKTtcclxuICAgICAgICBsZXQgbW9kZWw6IGFueTtcclxuICAgICAgICBsZXQgYW5pbWF0aW9uQWN0aXZlID0gdHJ1ZTsgLy8gVHJhY2sgYW5pbWF0aW9uIHN0YXRlXHJcbiAgICAgICAgY29uc3QgY29udHJvbHMgPSBuZXcgT3JiaXRDb250cm9scyhjYW1lcmEsIHJlbmRlcmVyLmRvbUVsZW1lbnQpO1xyXG4gICAgICAgIGNvbnRyb2xzLmVuYWJsZURhbXBpbmcgPSB0cnVlOyAvLyBTbW9vdGggcm90YXRpb25cclxuICAgICAgICBjb250cm9scy5kYW1waW5nRmFjdG9yID0gMC4wNTtcclxuICAgICAgICBjb250cm9scy5lbmFibGVab29tID0gdHJ1ZTtcclxuICAgICAgICBjb250cm9scy5lbmFibGVQYW4gPSB0cnVlO1xyXG4gICAgICAgIGNvbnRyb2xzLmVuYWJsZVJvdGF0ZSA9IHRydWU7XHJcbiAgICAgICAgY29udHJvbHMubWluUG9sYXJBbmdsZSA9IDA7IC8vIFBlcm1ldCB0b3V0ZXMgbGVzIHJvdGF0aW9ucyB2ZXJ0aWNhbGVzXHJcbiAgICAgICAgY29udHJvbHMubWF4UG9sYXJBbmdsZSA9IE1hdGguUEk7IC8vIFBlcm1ldCB0b3V0ZXMgbGVzIHJvdGF0aW9ucyB2ZXJ0aWNhbGVzXHJcbiAgICAgICAgY29udHJvbHMudGFyZ2V0LnNldCgwLCAwLCAwKTtcclxuXHJcbiAgICAgICAgbG9hZGVyLmxvYWQoXHJcbiAgICAgICAgICAgIHRoaXMudmF1bHQuYXBwLmdldEFic29sdXRlUGF0aChtZWRpYVBhdGgpLFxyXG4gICAgICAgICAgICAoZ2x0ZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBtb2RlbCA9IGdsdGYuc2NlbmU7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC50cmF2ZXJzZSgoY2hpbGQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5pc01lc2ggJiYgY2hpbGQubWF0ZXJpYWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIGJvdGggYXJyYXkgYW5kIHNpbmdsZSBtYXRlcmlhbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRlcmlhbHMgPSBBcnJheS5pc0FycmF5KGNoaWxkLm1hdGVyaWFsKSA/IGNoaWxkLm1hdGVyaWFsIDogW2NoaWxkLm1hdGVyaWFsXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBtYXQgb2YgbWF0ZXJpYWxzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0LnRyYW5zcGFyZW50IHx8IG1hdC5vcGFjaXR5IDwgMC41KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IG1lc2ggdG8gYmUgZnVsbHkgdmlzaWJsZSAob3BhcXVlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdC5vcGFjaXR5ID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQudHJhbnNwYXJlbnQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIEF1dG9tYXRpY2FsbHkgY2VudGVyIHRoZSBtb2RlbFxyXG4gICAgICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaXplID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcclxuICAgICAgICAgICAgICAgIGJveC5nZXRDZW50ZXIoY2VudGVyKTtcclxuICAgICAgICAgICAgICAgIGJveC5nZXRTaXplKHNpemUpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIENlbnRlciB0aGUgbW9kZWwgYXQgdGhlIG9yaWdpblxyXG4gICAgICAgICAgICAgICAgbW9kZWwucG9zaXRpb24uc3ViKGNlbnRlcik7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gU2NhbGUgbW9kZWwgdG8gZmlsbCA4MCUgb2YgdGhlIDMwMHgzMDAgYXJlYVxyXG4gICAgICAgICAgICAgICAgY29uc3QgbWF4RGltID0gTWF0aC5tYXgoc2l6ZS54LCBzaXplLnksIHNpemUueik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRGaWxsID0gMC44O1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgdmlld0hlaWdodCA9IDIgKiBjYW1lcmEucG9zaXRpb24ueSAqIE1hdGgudGFuKChjYW1lcmEuZm92ICogTWF0aC5QSSkgLyAzNjApO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVzaXJlZFNpemUgPSB2aWV3SGVpZ2h0ICogdGFyZ2V0RmlsbDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gZGVzaXJlZFNpemUgLyBtYXhEaW07XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5zY2FsZS5zZXRTY2FsYXIoc2NhbGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIHNjZW5lLmFkZChtb2RlbCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQW5pbWF0aW9uIGZ1bmN0aW9uXHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbmltYXRlID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRpb25BY3RpdmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBSb3RhdGUgdGhlIG1vZGVsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24ueiArPSAwLjAxOyAvLyBSb3RhdGUgYXJvdW5kIFotYXhpc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLnVwZGF0ZSgpOyAvLyBVcGRhdGUgY2FtZXJhIGNvbnRyb2xzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgYW5pbWF0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1vZGVsIHBvc2l0aW9uIGFuZCByb3RhdGlvbiBhZnRlciBsb2FkaW5nXHJcbiAgICAgICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi5zZXQoMCwgMCwgMCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gUmVjYWxjdWxhdGUgYm91bmRpbmcgYm94IGFmdGVyIHBvc2l0aW9uaW5nXHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdCb3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QobW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3Q2VudGVyID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcclxuICAgICAgICAgICAgICAgIG5ld0JveC5nZXRDZW50ZXIobmV3Q2VudGVyKTtcclxuICAgICAgICAgICAgICAgIG1vZGVsLnBvc2l0aW9uLnN1YihuZXdDZW50ZXIpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnRyb2xzLnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyZXVyIGxvcnMgZHUgY2hhcmdlbWVudCBkdSBtb2TDqGxlIDNEOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgICAgICAgICBlcnJvckRpdi50ZXh0Q29udGVudCA9IFwiRXJyZXVyIGxvcnMgZHUgY2hhcmdlbWVudCBkdSBtb2TDqGxlIDNEXCI7XHJcbiAgICAgICAgICAgICAgICBlcnJvckRpdi5zdHlsZS50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xyXG4gICAgICAgICAgICAgICAgZXJyb3JEaXYuc3R5bGUubWFyZ2luID0gXCI0MHB4IGF1dG9cIjtcclxuICAgICAgICAgICAgICAgIGVycm9yRGl2LnN0eWxlLmNvbG9yID0gXCIjYzAwXCI7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZXJyb3JEaXYpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgLy8gQWRkIGludGVyYWN0aW9uIGNvbnRyb2xzXHJcbiAgICAgICAgZW1iZWQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlZW50ZXJcIiwgKCkgPT4ge1xyXG4gICAgICAgICAgICBhbmltYXRpb25BY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZW1iZWQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbGVhdmVcIiwgKCkgPT4ge1xyXG4gICAgICAgICAgICBhbmltYXRpb25BY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGZpbGxEaXNwbGF5KHZhbHVlOiBhbnksIHVwZGF0ZTogKHZhbHVlOiBhbnkpID0+IFByb21pc2U8dm9pZD4sIGZpbGU6IGFueSA9IG51bGwpOiBIVE1MRGl2RWxlbWVudCB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgbWVkaWFGaWxlID0gdGhpcy52YXVsdC5nZXRNZWRpYUZyb21MaW5rKHZhbHVlKTtcclxuICAgICAgICBpZiAoIW1lZGlhRmlsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gc3VwZXIuZmlsbERpc3BsYXkodmFsdWUsIHVwZGF0ZSwgZmlsZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBtZWRpYVBhdGggPSB2YWx1ZTtcclxuICAgICAgICBpZiAoIW1lZGlhUGF0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gc3VwZXIuZmlsbERpc3BsYXkodmFsdWUsIHVwZGF0ZSwgZmlsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGV4dGVuc2lvbiA9IG1lZGlhUGF0aC5zcGxpdCgnLicpLnBvcCgpPy50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGEgM0QgbW9kZWwgZmlsZVxyXG4gICAgICAgIGlmIChbJ2dsdGYnLCAnZ2xiJ10uaW5jbHVkZXMoZXh0ZW5zaW9uIHx8ICcnKSkge1xyXG4gICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChcImVtYmVkLWNvbnRhaW5lclwiKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIzRE1vZGVsKG1lZGlhUGF0aCwgY29udGFpbmVyKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEZvciBub24tM0QgZmlsZXMsIHVzZSB0aGUgcGFyZW50IE1lZGlhUHJvcGVydHkgYmVoYXZpb3JcclxuICAgICAgICByZXR1cm4gc3VwZXIuZmlsbERpc3BsYXkodmFsdWUsIHVwZGF0ZSwgZmlsZSk7XHJcbiAgICB9XHJcbn0iXSwidmVyc2lvbiI6M30=