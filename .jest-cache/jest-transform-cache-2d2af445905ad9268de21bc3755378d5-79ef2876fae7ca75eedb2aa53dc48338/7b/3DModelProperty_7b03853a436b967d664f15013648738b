39c6fb296a3b2b228fe937e9dd4e614b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ThreeDModelProperty = void 0;
const MediaProperty_1 = require("./MediaProperty");
class ThreeDModelProperty extends MediaProperty_1.MediaProperty {
    constructor(name, vault, args = { icon: "box", create: "" }) {
        super(name, vault, args);
        this.type = "3dmodel";
    }
    /**
     * Renders a 3D model using THREE.js
     */
    render3DModel(mediaPath, container) {
        // Check if the file exists in the vault before trying to load it
        const fileExists = this.vault.app.getFile(mediaPath);
        if (!fileExists) {
            const errorDiv = document.createElement("div");
            errorDiv.textContent = `Rendu 3D introuvable. Ouvrir le fichier dans FreeCAD pour le créer.`;
            console.error("3D model file not found:", mediaPath);
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
            return;
        }
        const embed = document.createElement("canvas");
        embed.classList.add("embed-media");
        container.appendChild(embed);
        const renderer = new THREE.WebGLRenderer({ canvas: embed, alpha: true, antialias: true });
        renderer.setSize(300, 300);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);
        // Position the camera directly above, looking down the -Z axis
        camera.position.set(0, 10, 0);
        camera.up.set(0, 0, -1); // Make Z axis "up" for the camera
        camera.lookAt(0, 0, 0);
        // Add multiple directional lights from different directions for even illumination
        const directions = [
            [0, 10, 0], // Top
            [0, -10, 0], // Bottom
            [10, 0, 0], // Right
            [-10, 0, 0], // Left
            [0, 0, 10], // Front
            [0, 0, -10], // Back
        ];
        directions.forEach(dir => {
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(dir[0], dir[1], dir[2]);
            light.target.position.set(0, 0, 0);
            scene.add(light);
            scene.add(light.target);
        });
        // Optionally add a soft ambient light for subtle fill
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);
        const loader = new GLTFLoader();
        let model;
        let animationActive = true; // Track animation state
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Smooth rotation
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.enableRotate = true;
        controls.minPolarAngle = 0; // Permet toutes les rotations verticales
        controls.maxPolarAngle = Math.PI; // Permet toutes les rotations verticales
        controls.target.set(0, 0, 0);
        loader.load(this.vault.app.getAbsolutePath(mediaPath), (gltf) => {
            model = gltf.scene;
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    // Handle both array and single material
                    const materials = Array.isArray(child.material) ? child.material : [child.material];
                    for (const mat of materials) {
                        if (mat.transparent || mat.opacity < 0.5) {
                            // Set mesh to be fully visible (opaque)
                            mat.opacity = 1;
                            mat.transparent = false;
                        }
                    }
                }
            });
            // Automatically center the model
            const box = new THREE.Box3().setFromObject(model);
            const center = new THREE.Vector3();
            const size = new THREE.Vector3();
            box.getCenter(center);
            box.getSize(size);
            // Center the model at the origin
            model.position.sub(center);
            // Scale model to fill 80% of the 300x300 area
            const maxDim = Math.max(size.x, size.y, size.z);
            const targetFill = 0.8;
            const viewHeight = 2 * camera.position.y * Math.tan((camera.fov * Math.PI) / 360);
            const desiredSize = viewHeight * targetFill;
            const scale = desiredSize / maxDim;
            model.scale.setScalar(scale);
            scene.add(model);
            // Animation function
            const animate = () => {
                if (animationActive) {
                    requestAnimationFrame(animate);
                    // Rotate the model
                    if (model) {
                        model.rotation.z += 0.01; // Rotate around Z-axis
                    }
                    controls.update(); // Update camera controls
                    renderer.render(scene, camera);
                }
            };
            animate();
            // Reset model position and rotation after loading
            model.rotation.set(0, 0, 0);
            // Recalculate bounding box after positioning
            const newBox = new THREE.Box3().setFromObject(model);
            const newCenter = new THREE.Vector3();
            newBox.getCenter(newCenter);
            model.position.sub(newCenter);
            controls.update();
        }, undefined, (error) => {
            console.error("Erreur lors du chargement du modèle 3D:", error);
            const errorDiv = document.createElement("div");
            errorDiv.textContent = "Erreur lors du chargement du modèle 3D";
            errorDiv.style.textAlign = "center";
            errorDiv.style.margin = "40px auto";
            errorDiv.style.color = "#c00";
            container.appendChild(errorDiv);
        });
        // Add interaction controls
        embed.addEventListener("mouseenter", () => {
            animationActive = false;
        });
        embed.addEventListener("mouseleave", () => {
            animationActive = true;
        });
    }
    fillDisplay(value, update, file = null) {
        const mediaFile = this.vault.getMediaFromLink(value);
        if (!mediaFile) {
            return super.fillDisplay(value, update, file);
        }
        const mediaPath = mediaFile.path;
        if (!mediaPath) {
            return super.fillDisplay(value, update, file);
        }
        const extension = mediaPath.split('.').pop()?.toLowerCase();
        // Check if it's a 3D model file
        if (['gltf', 'glb'].includes(extension || '')) {
            const container = document.createElement("div");
            container.classList.add("embed-container");
            this.render3DModel(mediaPath, container);
            return container;
        }
        // For non-3D files, use the parent MediaProperty behavior
        return super.fillDisplay(value, update, file);
    }
}
exports.ThreeDModelProperty = ThreeDModelProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXDNETW9kZWxQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSxtREFBZ0Q7QUFTaEQsTUFBYSxtQkFBb0IsU0FBUSw2QkFBYTtJQUlsRCxZQUFZLElBQVksRUFBRSxLQUFhLEVBQUUsT0FBNEQsRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUM7UUFDMUgsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFIYixTQUFJLEdBQVcsU0FBUyxDQUFDO0lBSXpDLENBQUM7SUFFRDs7T0FFRztJQUNPLGFBQWEsQ0FBQyxTQUFpQixFQUFFLFNBQXlCO1FBQ2hFLGlFQUFpRTtRQUNqRSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2QsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQyxRQUFRLENBQUMsV0FBVyxHQUFHLHFFQUFxRSxDQUFDO1lBQzdGLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDckQsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQ3BDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQztZQUNwQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUM7WUFDOUIsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNoQyxPQUFPO1FBQ1gsQ0FBQztRQUVELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0MsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbkMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3QixNQUFNLFFBQVEsR0FBRyxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDMUYsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFM0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDNUQsK0RBQStEO1FBQy9ELE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDOUIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsa0NBQWtDO1FBQzNELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUV2QixrRkFBa0Y7UUFDbEYsTUFBTSxVQUFVLEdBQUc7WUFDZixDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUssTUFBTTtZQUNyQixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBSSxTQUFTO1lBQ3hCLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBSyxRQUFRO1lBQ3ZCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFJLE9BQU87WUFDdEIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFLLFFBQVE7WUFDdkIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUksT0FBTztTQUN6QixDQUFDO1FBQ0YsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNyQixNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDdEQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNuQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pCLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsc0RBQXNEO1FBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDM0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUV4QixNQUFNLE1BQU0sR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2hDLElBQUksS0FBVSxDQUFDO1FBQ2YsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDLENBQUMsd0JBQXdCO1FBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUksYUFBYSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDaEUsUUFBUSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsQ0FBQyxrQkFBa0I7UUFDakQsUUFBUSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7UUFDOUIsUUFBUSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDM0IsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDMUIsUUFBUSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDN0IsUUFBUSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQyx5Q0FBeUM7UUFDckUsUUFBUSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMseUNBQXlDO1FBQzNFLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFN0IsTUFBTSxDQUFDLElBQUksQ0FDUCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLEVBQ3pDLENBQUMsSUFBUyxFQUFFLEVBQUU7WUFDVixLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNuQixLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBVSxFQUFFLEVBQUU7Z0JBQzFCLElBQUksS0FBSyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQ2pDLHdDQUF3QztvQkFDeEMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO29CQUNwRixLQUFLLE1BQU0sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO3dCQUMxQixJQUFJLEdBQUcsQ0FBQyxXQUFXLElBQUksR0FBRyxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUUsQ0FBQzs0QkFDdkMsd0NBQXdDOzRCQUN4QyxHQUFHLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQzs0QkFDaEIsR0FBRyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7d0JBQzVCLENBQUM7b0JBQ0wsQ0FBQztnQkFDTCxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7WUFFSCxpQ0FBaUM7WUFDakMsTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xELE1BQU0sTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ25DLE1BQU0sSUFBSSxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2pDLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdEIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVsQixpQ0FBaUM7WUFDakMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFM0IsOENBQThDO1lBQzlDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoRCxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUM7WUFDdkIsTUFBTSxVQUFVLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztZQUNsRixNQUFNLFdBQVcsR0FBRyxVQUFVLEdBQUcsVUFBVSxDQUFDO1lBQzVDLE1BQU0sS0FBSyxHQUFHLFdBQVcsR0FBRyxNQUFNLENBQUM7WUFDbkMsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFN0IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVqQixxQkFBcUI7WUFDckIsTUFBTSxPQUFPLEdBQUcsR0FBRyxFQUFFO2dCQUNqQixJQUFJLGVBQWUsRUFBRSxDQUFDO29CQUNsQixxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDL0IsbUJBQW1CO29CQUNuQixJQUFJLEtBQUssRUFBRSxDQUFDO3dCQUNSLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLHVCQUF1QjtvQkFDckQsQ0FBQztvQkFDRCxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyx5QkFBeUI7b0JBQzVDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUNuQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDO1lBQ0YsT0FBTyxFQUFFLENBQUM7WUFFVixrREFBa0Q7WUFDbEQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUU1Qiw2Q0FBNkM7WUFDN0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3JELE1BQU0sU0FBUyxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3RDLE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDNUIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFOUIsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3RCLENBQUMsRUFDRCxTQUFTLEVBQ1QsQ0FBQyxLQUFVLEVBQUUsRUFBRTtZQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMseUNBQXlDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEUsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQyxRQUFRLENBQUMsV0FBVyxHQUFHLHdDQUF3QyxDQUFDO1lBQ2hFLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztZQUNwQyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUM7WUFDcEMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1lBQzlCLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUNKLENBQUM7UUFFRiwyQkFBMkI7UUFDM0IsS0FBSyxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7WUFDdEMsZUFBZSxHQUFHLEtBQUssQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztRQUVILEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO1lBQ3RDLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRVEsV0FBVyxDQUFDLEtBQVUsRUFBRSxNQUFxQyxFQUFFLE9BQVksSUFBSTtRQUVwRixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNiLE9BQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNiLE9BQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFDRCxNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDO1FBRTVELGdDQUFnQztRQUNoQyxJQUFJLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUM1QyxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2hELFNBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDM0MsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDekMsT0FBTyxTQUFTLENBQUM7UUFDckIsQ0FBQztRQUVELDBEQUEwRDtRQUMxRCxPQUFPLEtBQUssQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBQ0o7QUF0TEQsa0RBc0xDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFxwcm9wZXJ0aWVzXFwzRE1vZGVsUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmF1bHQgfSBmcm9tIFwidmF1bHQvVmF1bHRcIjtcclxuaW1wb3J0IHsgTWVkaWFQcm9wZXJ0eSB9IGZyb20gXCIuL01lZGlhUHJvcGVydHlcIjtcclxuXHJcbi8vIETDqWNsYXJhdGlvbnMgdGVtcG9yYWlyZXMgcG91ciBsZXMgZMOpcGVuZGFuY2VzIDNEXHJcbmRlY2xhcmUgY29uc3QgVEhSRUU6IGFueTtcclxuZGVjbGFyZSBjb25zdCBHTFRGTG9hZGVyOiBhbnk7XHJcbmRlY2xhcmUgY29uc3QgT3JiaXRDb250cm9sczogYW55O1xyXG5kZWNsYXJlIGNvbnN0IEZyZWVjYWRGaWxlOiBhbnk7XHJcbmRlY2xhcmUgY29uc3Qgc2hlbGw6IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBUaHJlZURNb2RlbFByb3BlcnR5IGV4dGVuZHMgTWVkaWFQcm9wZXJ0eSB7XHJcbiAgICBcclxuICAgIHB1YmxpYyBvdmVycmlkZSB0eXBlOiBzdHJpbmcgPSBcIjNkbW9kZWxcIjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIHZhdWx0IDogVmF1bHQsIGFyZ3M6IHsgaWNvbj86IHN0cmluZzsgZGlzcGxheT86IHN0cmluZzsgY3JlYXRlPzogc3RyaW5nfSA9IHtpY29uOiBcImJveFwiLCBjcmVhdGU6IFwiXCJ9KSB7XHJcbiAgICAgICAgc3VwZXIobmFtZSwgdmF1bHQsIGFyZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVuZGVycyBhIDNEIG1vZGVsIHVzaW5nIFRIUkVFLmpzXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCByZW5kZXIzRE1vZGVsKG1lZGlhUGF0aDogc3RyaW5nLCBjb250YWluZXI6IEhUTUxEaXZFbGVtZW50KTogdm9pZCB7XHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGZpbGUgZXhpc3RzIGluIHRoZSB2YXVsdCBiZWZvcmUgdHJ5aW5nIHRvIGxvYWQgaXRcclxuICAgICAgICBjb25zdCBmaWxlRXhpc3RzID0gdGhpcy52YXVsdC5hcHAuZ2V0RmlsZShtZWRpYVBhdGgpO1xyXG4gICAgICAgIGlmICghZmlsZUV4aXN0cykge1xyXG4gICAgICAgICAgICBjb25zdCBlcnJvckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgICAgIGVycm9yRGl2LnRleHRDb250ZW50ID0gYFJlbmR1IDNEIGludHJvdXZhYmxlLiBPdXZyaXIgbGUgZmljaGllciBkYW5zIEZyZWVDQUQgcG91ciBsZSBjcsOpZXIuYDtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIjNEIG1vZGVsIGZpbGUgbm90IGZvdW5kOlwiLCBtZWRpYVBhdGgpO1xyXG4gICAgICAgICAgICBlcnJvckRpdi5zdHlsZS50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xyXG4gICAgICAgICAgICBlcnJvckRpdi5zdHlsZS5tYXJnaW4gPSBcIjQwcHggYXV0b1wiO1xyXG4gICAgICAgICAgICBlcnJvckRpdi5zdHlsZS5jb2xvciA9IFwiI2MwMFwiO1xyXG4gICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZXJyb3JEaXYpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBlbWJlZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XHJcbiAgICAgICAgZW1iZWQuY2xhc3NMaXN0LmFkZChcImVtYmVkLW1lZGlhXCIpO1xyXG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlbWJlZCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7IGNhbnZhczogZW1iZWQsIGFscGhhOiB0cnVlLCBhbnRpYWxpYXM6IHRydWUgfSk7XHJcbiAgICAgICAgcmVuZGVyZXIuc2V0U2l6ZSgzMDAsIDMwMCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XHJcbiAgICAgICAgY29uc3QgY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDc1LCAxLCAwLjEsIDEwMCk7XHJcbiAgICAgICAgLy8gUG9zaXRpb24gdGhlIGNhbWVyYSBkaXJlY3RseSBhYm92ZSwgbG9va2luZyBkb3duIHRoZSAtWiBheGlzXHJcbiAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAxMCwgMCk7XHJcbiAgICAgICAgY2FtZXJhLnVwLnNldCgwLCAwLCAtMSk7IC8vIE1ha2UgWiBheGlzIFwidXBcIiBmb3IgdGhlIGNhbWVyYVxyXG4gICAgICAgIGNhbWVyYS5sb29rQXQoMCwgMCwgMCk7XHJcblxyXG4gICAgICAgIC8vIEFkZCBtdWx0aXBsZSBkaXJlY3Rpb25hbCBsaWdodHMgZnJvbSBkaWZmZXJlbnQgZGlyZWN0aW9ucyBmb3IgZXZlbiBpbGx1bWluYXRpb25cclxuICAgICAgICBjb25zdCBkaXJlY3Rpb25zID0gW1xyXG4gICAgICAgICAgICBbMCwgMTAsIDBdLCAgICAvLyBUb3BcclxuICAgICAgICAgICAgWzAsIC0xMCwgMF0sICAgLy8gQm90dG9tXHJcbiAgICAgICAgICAgIFsxMCwgMCwgMF0sICAgIC8vIFJpZ2h0XHJcbiAgICAgICAgICAgIFstMTAsIDAsIDBdLCAgIC8vIExlZnRcclxuICAgICAgICAgICAgWzAsIDAsIDEwXSwgICAgLy8gRnJvbnRcclxuICAgICAgICAgICAgWzAsIDAsIC0xMF0sICAgLy8gQmFja1xyXG4gICAgICAgIF07XHJcbiAgICAgICAgZGlyZWN0aW9ucy5mb3JFYWNoKGRpciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpZ2h0ID0gbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIDEpO1xyXG4gICAgICAgICAgICBsaWdodC5wb3NpdGlvbi5zZXQoZGlyWzBdLCBkaXJbMV0sIGRpclsyXSk7XHJcbiAgICAgICAgICAgIGxpZ2h0LnRhcmdldC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7XHJcbiAgICAgICAgICAgIHNjZW5lLmFkZChsaWdodCk7XHJcbiAgICAgICAgICAgIHNjZW5lLmFkZChsaWdodC50YXJnZXQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIE9wdGlvbmFsbHkgYWRkIGEgc29mdCBhbWJpZW50IGxpZ2h0IGZvciBzdWJ0bGUgZmlsbFxyXG4gICAgICAgIGNvbnN0IGFtYmllbnRMaWdodCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoMHhmZmZmZmYsIDAuNCk7XHJcbiAgICAgICAgc2NlbmUuYWRkKGFtYmllbnRMaWdodCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxvYWRlciA9IG5ldyBHTFRGTG9hZGVyKCk7XHJcbiAgICAgICAgbGV0IG1vZGVsOiBhbnk7XHJcbiAgICAgICAgbGV0IGFuaW1hdGlvbkFjdGl2ZSA9IHRydWU7IC8vIFRyYWNrIGFuaW1hdGlvbiBzdGF0ZVxyXG4gICAgICAgIGNvbnN0IGNvbnRyb2xzID0gbmV3IE9yYml0Q29udHJvbHMoY2FtZXJhLCByZW5kZXJlci5kb21FbGVtZW50KTtcclxuICAgICAgICBjb250cm9scy5lbmFibGVEYW1waW5nID0gdHJ1ZTsgLy8gU21vb3RoIHJvdGF0aW9uXHJcbiAgICAgICAgY29udHJvbHMuZGFtcGluZ0ZhY3RvciA9IDAuMDU7XHJcbiAgICAgICAgY29udHJvbHMuZW5hYmxlWm9vbSA9IHRydWU7XHJcbiAgICAgICAgY29udHJvbHMuZW5hYmxlUGFuID0gdHJ1ZTtcclxuICAgICAgICBjb250cm9scy5lbmFibGVSb3RhdGUgPSB0cnVlO1xyXG4gICAgICAgIGNvbnRyb2xzLm1pblBvbGFyQW5nbGUgPSAwOyAvLyBQZXJtZXQgdG91dGVzIGxlcyByb3RhdGlvbnMgdmVydGljYWxlc1xyXG4gICAgICAgIGNvbnRyb2xzLm1heFBvbGFyQW5nbGUgPSBNYXRoLlBJOyAvLyBQZXJtZXQgdG91dGVzIGxlcyByb3RhdGlvbnMgdmVydGljYWxlc1xyXG4gICAgICAgIGNvbnRyb2xzLnRhcmdldC5zZXQoMCwgMCwgMCk7XHJcblxyXG4gICAgICAgIGxvYWRlci5sb2FkKFxyXG4gICAgICAgICAgICB0aGlzLnZhdWx0LmFwcC5nZXRBYnNvbHV0ZVBhdGgobWVkaWFQYXRoKSxcclxuICAgICAgICAgICAgKGdsdGY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbW9kZWwgPSBnbHRmLnNjZW5lO1xyXG4gICAgICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoKGNoaWxkOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuaXNNZXNoICYmIGNoaWxkLm1hdGVyaWFsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBib3RoIGFycmF5IGFuZCBzaW5nbGUgbWF0ZXJpYWxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0ZXJpYWxzID0gQXJyYXkuaXNBcnJheShjaGlsZC5tYXRlcmlhbCkgPyBjaGlsZC5tYXRlcmlhbCA6IFtjaGlsZC5tYXRlcmlhbF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbWF0IG9mIG1hdGVyaWFscykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdC50cmFuc3BhcmVudCB8fCBtYXQub3BhY2l0eSA8IDAuNSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCBtZXNoIHRvIGJlIGZ1bGx5IHZpc2libGUgKG9wYXF1ZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXQub3BhY2l0eSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0LnRyYW5zcGFyZW50ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBBdXRvbWF0aWNhbGx5IGNlbnRlciB0aGUgbW9kZWxcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9IG5ldyBUSFJFRS5Cb3gzKCkuc2V0RnJvbU9iamVjdChtb2RlbCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjZW50ZXIgPSBuZXcgVEhSRUUuVmVjdG9yMygpO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XHJcbiAgICAgICAgICAgICAgICBib3guZ2V0Q2VudGVyKGNlbnRlcik7XHJcbiAgICAgICAgICAgICAgICBib3guZ2V0U2l6ZShzaXplKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgdGhlIG1vZGVsIGF0IHRoZSBvcmlnaW5cclxuICAgICAgICAgICAgICAgIG1vZGVsLnBvc2l0aW9uLnN1YihjZW50ZXIpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIFNjYWxlIG1vZGVsIHRvIGZpbGwgODAlIG9mIHRoZSAzMDB4MzAwIGFyZWFcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KHNpemUueCwgc2l6ZS55LCBzaXplLnopO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0RmlsbCA9IDAuODtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZpZXdIZWlnaHQgPSAyICogY2FtZXJhLnBvc2l0aW9uLnkgKiBNYXRoLnRhbigoY2FtZXJhLmZvdiAqIE1hdGguUEkpIC8gMzYwKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlc2lyZWRTaXplID0gdmlld0hlaWdodCAqIHRhcmdldEZpbGw7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZSA9IGRlc2lyZWRTaXplIC8gbWF4RGltO1xyXG4gICAgICAgICAgICAgICAgbW9kZWwuc2NhbGUuc2V0U2NhbGFyKHNjYWxlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBzY2VuZS5hZGQobW9kZWwpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIEFuaW1hdGlvbiBmdW5jdGlvblxyXG4gICAgICAgICAgICAgICAgY29uc3QgYW5pbWF0ZSA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYW5pbWF0aW9uQWN0aXZlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUm90YXRlIHRoZSBtb2RlbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnogKz0gMC4wMTsgLy8gUm90YXRlIGFyb3VuZCBaLWF4aXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9scy51cGRhdGUoKTsgLy8gVXBkYXRlIGNhbWVyYSBjb250cm9sc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlci5yZW5kZXIoc2NlbmUsIGNhbWVyYSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGFuaW1hdGUoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBSZXNldCBtb2RlbCBwb3NpdGlvbiBhbmQgcm90YXRpb24gYWZ0ZXIgbG9hZGluZ1xyXG4gICAgICAgICAgICAgICAgbW9kZWwucm90YXRpb24uc2V0KDAsIDAsIDApO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIFJlY2FsY3VsYXRlIGJvdW5kaW5nIGJveCBhZnRlciBwb3NpdGlvbmluZ1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3Qm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0NlbnRlciA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XHJcbiAgICAgICAgICAgICAgICBuZXdCb3guZ2V0Q2VudGVyKG5ld0NlbnRlcik7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5wb3NpdGlvbi5zdWIobmV3Q2VudGVyKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb250cm9scy51cGRhdGUoKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycmV1ciBsb3JzIGR1IGNoYXJnZW1lbnQgZHUgbW9kw6hsZSAzRDpcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICAgICAgZXJyb3JEaXYudGV4dENvbnRlbnQgPSBcIkVycmV1ciBsb3JzIGR1IGNoYXJnZW1lbnQgZHUgbW9kw6hsZSAzRFwiO1xyXG4gICAgICAgICAgICAgICAgZXJyb3JEaXYuc3R5bGUudGV4dEFsaWduID0gXCJjZW50ZXJcIjtcclxuICAgICAgICAgICAgICAgIGVycm9yRGl2LnN0eWxlLm1hcmdpbiA9IFwiNDBweCBhdXRvXCI7XHJcbiAgICAgICAgICAgICAgICBlcnJvckRpdi5zdHlsZS5jb2xvciA9IFwiI2MwMFwiO1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGVycm9yRGl2KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIC8vIEFkZCBpbnRlcmFjdGlvbiBjb250cm9sc1xyXG4gICAgICAgIGVtYmVkLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWVudGVyXCIsICgpID0+IHtcclxuICAgICAgICAgICAgYW5pbWF0aW9uQWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGVtYmVkLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWxlYXZlXCIsICgpID0+IHtcclxuICAgICAgICAgICAgYW5pbWF0aW9uQWN0aXZlID0gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSBmaWxsRGlzcGxheSh2YWx1ZTogYW55LCB1cGRhdGU6ICh2YWx1ZTogYW55KSA9PiBQcm9taXNlPHZvaWQ+LCBmaWxlOiBhbnkgPSBudWxsKTogSFRNTERpdkVsZW1lbnQge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IG1lZGlhRmlsZSA9IHRoaXMudmF1bHQuZ2V0TWVkaWFGcm9tTGluayh2YWx1ZSk7XHJcbiAgICAgICAgaWYgKCFtZWRpYUZpbGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLmZpbGxEaXNwbGF5KHZhbHVlLCB1cGRhdGUsIGZpbGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbWVkaWFQYXRoID0gbWVkaWFGaWxlLnBhdGg7XHJcbiAgICAgICAgaWYgKCFtZWRpYVBhdGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLmZpbGxEaXNwbGF5KHZhbHVlLCB1cGRhdGUsIGZpbGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBleHRlbnNpb24gPSBtZWRpYVBhdGguc3BsaXQoJy4nKS5wb3AoKT8udG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIDNEIG1vZGVsIGZpbGVcclxuICAgICAgICBpZiAoWydnbHRmJywgJ2dsYiddLmluY2x1ZGVzKGV4dGVuc2lvbiB8fCAnJykpIHtcclxuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJlbWJlZC1jb250YWluZXJcIik7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyM0RNb2RlbChtZWRpYVBhdGgsIGNvbnRhaW5lcik7XHJcbiAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBGb3Igbm9uLTNEIGZpbGVzLCB1c2UgdGhlIHBhcmVudCBNZWRpYVByb3BlcnR5IGJlaGF2aW9yXHJcbiAgICAgICAgcmV0dXJuIHN1cGVyLmZpbGxEaXNwbGF5KHZhbHVlLCB1cGRhdGUsIGZpbGUpO1xyXG4gICAgfVxyXG59Il0sInZlcnNpb24iOjN9