51805d8b8c411ce5b0b953c6939c0471
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Classe = void 0;
class Classe {
    constructor(vault, file, data) {
        this.vault = vault;
        this.properties = [];
        this.name = '';
        this.icon = '';
        this.data = null;
        this.displayConfig = {};
        if (file) {
            this.setFile(file);
        }
        if (data) {
            this.data = data;
        }
    }
    getName() {
        return this.name;
    }
    // Property management
    addProperty(property) {
        this.properties.push(property);
    }
    getProperty(name) {
        return this.properties.find(p => p.name === name);
    }
    getProperties() {
        return [...this.properties];
    }
    // File operations
    setFile(file) {
        this.file = file;
    }
    getFile() {
        return this.file;
    }
    getPath() {
        return this.file?.getPath();
    }
    async update() {
        if (!this.file)
            return;
        // Update metadata
        await this.updateAllPropertiesMetadata();
    }
    async validate() {
        // Validate all properties
        for (const property of this.properties) {
            const value = await this.getPropertyValue(property.name);
            if (!property.validate(value)) {
                return false;
            }
        }
        return true;
    }
    // Content generation helpers
    async generateFrontMatter() {
        const metadata = await this.getMetadata();
        const lines = ['---'];
        // Add class-specific metadata
        if (this.name)
            metadata.type = this.name;
        if (this.icon)
            metadata.icon = this.icon;
        // Add property values
        for (const property of this.properties) {
            const value = await this.getPropertyValue(property.name);
            if (value !== undefined && value !== '') {
                metadata[property.name] = value;
            }
        }
        // Convert to YAML
        for (const [key, value] of Object.entries(metadata)) {
            if (Array.isArray(value)) {
                lines.push(`${key}:`);
                value.forEach(item => lines.push(`  - ${item}`));
            }
            else if (typeof value === 'object' && value !== null) {
                lines.push(`${key}:`);
                for (const [subKey, subValue] of Object.entries(value)) {
                    lines.push(`  ${subKey}: ${subValue}`);
                }
            }
            else {
                lines.push(`${key}: ${value}`);
            }
        }
        lines.push('---\n');
        return lines.join('\n');
    }
    async generateTemplateContent() {
        if (!this.template)
            return '';
        try {
            return await this.vault.app.getTemplateContent(this.template);
        }
        catch (error) {
            console.warn(`Template ${this.template} not found`);
            return '';
        }
    }
    // Metadata operations
    async getMetadata() {
        if (!this.file)
            return {};
        return await this.vault.app.getMetadata(this.file);
    }
    async updateMetadata(metadata) {
        if (!this.file)
            return;
        await this.vault.app.updateMetadata(this.file, metadata);
    }
    async getPropertyValue(propertyName) {
        const metadata = await this.getMetadata();
        return metadata[propertyName];
    }
    async setPropertyValue(propertyName, value) {
        const metadata = await this.getMetadata();
        metadata[propertyName] = value;
        await this.updateMetadata(metadata);
    }
    async updateAllPropertiesMetadata() {
        const metadata = await this.getMetadata();
        let hasChanges = false;
        for (const property of this.properties) {
            const currentValue = metadata[property.name];
            const validatedValue = property.validate(currentValue);
            if (validatedValue !== currentValue) {
                metadata[property.name] = validatedValue;
                hasChanges = true;
            }
        }
        if (hasChanges) {
            await this.updateMetadata(metadata);
        }
    }
    // Display methods
    async getDisplay() {
        const container = this.vault.app.createDiv('classe-display');
        // Add class header
        const header = this.vault.app.createDiv('classe-header');
        header.textContent = this.getName();
        if (this.icon) {
            this.vault.app.setIcon(header, this.icon);
        }
        container.appendChild(header);
        // Add properties
        for (const property of this.properties) {
            const value = await this.getPropertyValue(property.name);
            const propertyDisplay = await property.getDisplay(this, value);
            container.appendChild(propertyDisplay);
        }
        return container;
    }
    // Factory method for creating instances
    static create(vault) {
        throw new Error('Must implement create method in subclass');
    }
    // Utility methods
    sanitizeFileName(name) {
        return name.replace(/[<>:"/\\|?*]/g, '-').trim();
    }
    async ensureFolder(folderPath) {
        try {
            await this.vault.app.createFolder(folderPath);
        }
        catch (error) {
            // Folder might already exist, which is fine
        }
    }
    // Lifecycle hooks
    async onCreate() {
        // Override in subclasses for post-creation logic
    }
    async onUpdate() {
        // Override in subclasses for post-update logic
    }
    async onDelete() {
        // Override in subclasses for pre-deletion logic
    }
}
exports.Classe = Classe;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHZhdWx0XFxDbGFzc2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBTUEsTUFBYSxNQUFNO0lBU2YsWUFBc0IsS0FBWSxFQUFFLElBQWEsRUFBRSxJQUFhO1FBQTFDLFVBQUssR0FBTCxLQUFLLENBQU87UUFSeEIsZUFBVSxHQUFlLEVBQUUsQ0FBQztRQUUvQixTQUFJLEdBQVcsRUFBRSxDQUFDO1FBQ2xCLFNBQUksR0FBVyxFQUFFLENBQUM7UUFFbEIsU0FBSSxHQUFpQixJQUFJLENBQUM7UUFDMUIsa0JBQWEsR0FBUyxFQUFFLENBQUM7UUFHNUIsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUNQLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkIsQ0FBQztRQUNELElBQUksSUFBSSxFQUFFLENBQUM7WUFDUCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNyQixDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUE7SUFDbEIsQ0FBQztJQUVELHNCQUFzQjtJQUN0QixXQUFXLENBQUMsUUFBa0I7UUFDMUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELFdBQVcsQ0FBQyxJQUFZO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxhQUFhO1FBQ1QsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxrQkFBa0I7SUFDbEIsT0FBTyxDQUFDLElBQVU7UUFD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QVE7UUFDVixpREFBaUQ7SUFDckQsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRO1FBQ1YsK0NBQStDO0lBQ25ELENBQUM7SUFFRCxLQUFLLENBQUMsUUFBUTtRQUNWLGdEQUFnRDtJQUNwRCxDQUFDO0NBQ0o7QUEvTUQsd0JBK01DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFx2YXVsdFxcQ2xhc3NlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElGaWxlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9JQXBwJztcclxuaW1wb3J0IHsgVmF1bHQgfSBmcm9tICcuL1ZhdWx0JztcclxuaW1wb3J0IHsgUHJvcGVydHkgfSBmcm9tICcuLi9wcm9wZXJ0aWVzL1Byb3BlcnR5JztcclxuaW1wb3J0IHsgRmlsZSB9IGZyb20gJy4vRmlsZSc7XHJcbmltcG9ydCB7IERhdGEgfSBmcm9tICcuL0RhdGEnO1xyXG5cclxuZXhwb3J0IGNsYXNzIENsYXNzZSB7XHJcbiAgICBwcm90ZWN0ZWQgcHJvcGVydGllczogUHJvcGVydHlbXSA9IFtdO1xyXG4gICAgcHJvdGVjdGVkIGZpbGU/OiBGaWxlO1xyXG4gICAgcHVibGljIG5hbWU6IHN0cmluZyA9ICcnO1xyXG4gICAgcHVibGljIGljb246IHN0cmluZyA9ICcnO1xyXG4gICAgcHVibGljIHRlbXBsYXRlPzogc3RyaW5nO1xyXG4gICAgcHVibGljIGRhdGEgOiBEYXRhIHwgbnVsbCA9IG51bGw7XHJcbiAgICBwdWJsaWMgZGlzcGxheUNvbmZpZyA6IGFueSA9IHt9O1xyXG4gICAgXHJcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgdmF1bHQ6IFZhdWx0LCBmaWxlID8gOiBGaWxlLCBkYXRhID8gOiBEYXRhKSB7XHJcbiAgICAgICAgaWYgKGZpbGUpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRGaWxlKGZpbGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICB0aGlzLmRhdGEgPSBkYXRhO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXROYW1lKCk6IHN0cmluZ3sgXHJcbiAgICAgIHJldHVybiB0aGlzLm5hbWVcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gUHJvcGVydHkgbWFuYWdlbWVudFxyXG4gICAgYWRkUHJvcGVydHkocHJvcGVydHk6IFByb3BlcnR5KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5wcm9wZXJ0aWVzLnB1c2gocHJvcGVydHkpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBnZXRQcm9wZXJ0eShuYW1lOiBzdHJpbmcpOiBQcm9wZXJ0eSB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcGVydGllcy5maW5kKHAgPT4gcC5uYW1lID09PSBuYW1lKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZ2V0UHJvcGVydGllcygpOiBQcm9wZXJ0eVtdIHtcclxuICAgICAgICByZXR1cm4gWy4uLnRoaXMucHJvcGVydGllc107XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIEZpbGUgb3BlcmF0aW9uc1xyXG4gICAgc2V0RmlsZShmaWxlOiBGaWxlKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5maWxlID0gZmlsZTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZ2V0RmlsZSgpOiBGaWxlIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5maWxlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFBhdGgoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5maWxlPy5nZXRQYXRoKCk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGFzeW5jIHVwZGF0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBpZiAoIXRoaXMuZmlsZSkgcmV0dXJuO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIFVwZGF0ZSBtZXRhZGF0YVxyXG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlQWxsUHJvcGVydGllc01ldGFkYXRhKCk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGFzeW5jIHZhbGlkYXRlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIC8vIFZhbGlkYXRlIGFsbCBwcm9wZXJ0aWVzXHJcbiAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiB0aGlzLnByb3BlcnRpZXMpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkubmFtZSk7XHJcbiAgICAgICAgICAgIGlmICghcHJvcGVydHkudmFsaWRhdGUodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIFxyXG4gICAgLy8gQ29udGVudCBnZW5lcmF0aW9uIGhlbHBlcnNcclxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUZyb250TWF0dGVyKCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCB0aGlzLmdldE1ldGFkYXRhKCk7XHJcbiAgICAgICAgY29uc3QgbGluZXMgPSBbJy0tLSddO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIEFkZCBjbGFzcy1zcGVjaWZpYyBtZXRhZGF0YVxyXG4gICAgICAgIGlmICh0aGlzLm5hbWUpIG1ldGFkYXRhLnR5cGUgPSB0aGlzLm5hbWU7XHJcbiAgICAgICAgaWYgKHRoaXMuaWNvbikgbWV0YWRhdGEuaWNvbiA9IHRoaXMuaWNvbjtcclxuICAgICAgICBcclxuICAgICAgICAvLyBBZGQgcHJvcGVydHkgdmFsdWVzXHJcbiAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiB0aGlzLnByb3BlcnRpZXMpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkubmFtZSk7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSAnJykge1xyXG4gICAgICAgICAgICAgICAgbWV0YWRhdGFbcHJvcGVydHkubmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAvLyBDb252ZXJ0IHRvIFlBTUxcclxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhtZXRhZGF0YSkpIHtcclxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGAke2tleX06YCk7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZS5mb3JFYWNoKGl0ZW0gPT4gbGluZXMucHVzaChgICAtICR7aXRlbX1gKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtrZXl9OmApO1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBbc3ViS2V5LCBzdWJWYWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGluZXMucHVzaChgICAke3N1YktleX06ICR7c3ViVmFsdWV9YCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGAke2tleX06ICR7dmFsdWV9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGluZXMucHVzaCgnLS0tXFxuJyk7XHJcbiAgICAgICAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcbicpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwcm90ZWN0ZWQgYXN5bmMgZ2VuZXJhdGVUZW1wbGF0ZUNvbnRlbnQoKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgICAgICBpZiAoIXRoaXMudGVtcGxhdGUpIHJldHVybiAnJztcclxuICAgICAgICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy52YXVsdC5hcHAuZ2V0VGVtcGxhdGVDb250ZW50KHRoaXMudGVtcGxhdGUpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgVGVtcGxhdGUgJHt0aGlzLnRlbXBsYXRlfSBub3QgZm91bmRgKTtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gTWV0YWRhdGEgb3BlcmF0aW9uc1xyXG4gICAgYXN5bmMgZ2V0TWV0YWRhdGEoKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBhbnk+PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmZpbGUpIHJldHVybiB7fTtcclxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy52YXVsdC5hcHAuZ2V0TWV0YWRhdGEodGhpcy5maWxlKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgYXN5bmMgdXBkYXRlTWV0YWRhdGEobWV0YWRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBpZiAoIXRoaXMuZmlsZSkgcmV0dXJuO1xyXG4gICAgICAgIGF3YWl0IHRoaXMudmF1bHQuYXBwLnVwZGF0ZU1ldGFkYXRhKHRoaXMuZmlsZSwgbWV0YWRhdGEpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyBnZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5TmFtZTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHRoaXMuZ2V0TWV0YWRhdGEoKTtcclxuICAgICAgICByZXR1cm4gbWV0YWRhdGFbcHJvcGVydHlOYW1lXTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgYXN5bmMgc2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgdGhpcy5nZXRNZXRhZGF0YSgpO1xyXG4gICAgICAgIG1ldGFkYXRhW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZU1ldGFkYXRhKG1ldGFkYXRhKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJpdmF0ZSBhc3luYyB1cGRhdGVBbGxQcm9wZXJ0aWVzTWV0YWRhdGEoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCB0aGlzLmdldE1ldGFkYXRhKCk7XHJcbiAgICAgICAgbGV0IGhhc0NoYW5nZXMgPSBmYWxzZTtcclxuICAgICAgICBcclxuICAgICAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHRoaXMucHJvcGVydGllcykge1xyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsdWUgPSBtZXRhZGF0YVtwcm9wZXJ0eS5uYW1lXTtcclxuICAgICAgICAgICAgY29uc3QgdmFsaWRhdGVkVmFsdWUgPSBwcm9wZXJ0eS52YWxpZGF0ZShjdXJyZW50VmFsdWUpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKHZhbGlkYXRlZFZhbHVlICE9PSBjdXJyZW50VmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIG1ldGFkYXRhW3Byb3BlcnR5Lm5hbWVdID0gdmFsaWRhdGVkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICBoYXNDaGFuZ2VzID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAoaGFzQ2hhbmdlcykge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZU1ldGFkYXRhKG1ldGFkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIERpc3BsYXkgbWV0aG9kc1xyXG4gICAgYXN5bmMgZ2V0RGlzcGxheSgpOiBQcm9taXNlPEhUTUxFbGVtZW50PiB7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy52YXVsdC5hcHAuY3JlYXRlRGl2KCdjbGFzc2UtZGlzcGxheScpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIEFkZCBjbGFzcyBoZWFkZXJcclxuICAgICAgICBjb25zdCBoZWFkZXIgPSB0aGlzLnZhdWx0LmFwcC5jcmVhdGVEaXYoJ2NsYXNzZS1oZWFkZXInKTtcclxuICAgICAgICBoZWFkZXIudGV4dENvbnRlbnQgPSB0aGlzLmdldE5hbWUoKTtcclxuICAgICAgICBpZiAodGhpcy5pY29uKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmF1bHQuYXBwLnNldEljb24oaGVhZGVyLCB0aGlzLmljb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaGVhZGVyKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBBZGQgcHJvcGVydGllc1xyXG4gICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgdGhpcy5wcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5nZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5Lm5hbWUpO1xyXG4gICAgICAgICAgICBjb25zdCBwcm9wZXJ0eURpc3BsYXkgPSBhd2FpdCBwcm9wZXJ0eS5nZXREaXNwbGF5KHRoaXMsIHZhbHVlKTtcclxuICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHByb3BlcnR5RGlzcGxheSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBjb250YWluZXI7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBpbnN0YW5jZXNcclxuICAgIHN0YXRpYyBjcmVhdGUodmF1bHQ6IFZhdWx0KTogQ2xhc3NlIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgaW1wbGVtZW50IGNyZWF0ZSBtZXRob2QgaW4gc3ViY2xhc3MnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gVXRpbGl0eSBtZXRob2RzXHJcbiAgICBwcm90ZWN0ZWQgc2FuaXRpemVGaWxlTmFtZShuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UoL1s8PjpcIi9cXFxcfD8qXS9nLCAnLScpLnRyaW0oKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJvdGVjdGVkIGFzeW5jIGVuc3VyZUZvbGRlcihmb2xkZXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC5jcmVhdGVGb2xkZXIoZm9sZGVyUGF0aCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgLy8gRm9sZGVyIG1pZ2h0IGFscmVhZHkgZXhpc3QsIHdoaWNoIGlzIGZpbmVcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIExpZmVjeWNsZSBob29rc1xyXG4gICAgYXN5bmMgb25DcmVhdGUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgLy8gT3ZlcnJpZGUgaW4gc3ViY2xhc3NlcyBmb3IgcG9zdC1jcmVhdGlvbiBsb2dpY1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyBvblVwZGF0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICAvLyBPdmVycmlkZSBpbiBzdWJjbGFzc2VzIGZvciBwb3N0LXVwZGF0ZSBsb2dpY1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyBvbkRlbGV0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICAvLyBPdmVycmlkZSBpbiBzdWJjbGFzc2VzIGZvciBwcmUtZGVsZXRpb24gbG9naWNcclxuICAgIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=