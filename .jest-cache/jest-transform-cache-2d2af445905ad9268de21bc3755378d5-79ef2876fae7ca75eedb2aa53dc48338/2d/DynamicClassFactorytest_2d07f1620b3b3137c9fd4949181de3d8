0d75e1ace4f4ff808744cf7af72f652d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock ClassConfigManager
jest.mock('../../src/Config/ClassConfigManager');
const DynamicClassFactory_1 = require("../../src/Config/DynamicClassFactory");
const ClassConfigManager_1 = require("../../src/Config/ClassConfigManager");
const Classe_1 = require("../../src/vault/Classe");
describe('DynamicClassFactory', () => {
    let factory;
    let mockConfigManager;
    let mockApp;
    beforeEach(() => {
        jest.clearAllMocks();
        mockApp = {
            getVaultPath: jest.fn(() => '/test/vault'),
            getName: jest.fn(() => 'TestVault')
        };
        // Create mock config manager with the correct methods
        mockConfigManager = {
            createDynamicClasse: jest.fn(),
            getClassConfig: jest.fn(),
            getAvailableClasses: jest.fn(),
            clearCache: jest.fn()
        };
        // Mock the constructor
        ClassConfigManager_1.ClassConfigManager.mockImplementation(() => mockConfigManager);
        factory = new DynamicClassFactory_1.DynamicClassFactory('./test-config', mockApp);
    });
    describe('constructor', () => {
        it('should create instance with config manager', () => {
            expect(ClassConfigManager_1.ClassConfigManager).toHaveBeenCalledWith('./test-config', mockApp);
        });
    });
    describe('getClass', () => {
        it('should return cached class if already registered', async () => {
            const MockClass = class extends Classe_1.Classe {
            };
            // First call - should call createDynamicClasse
            mockConfigManager.createDynamicClasse.mockResolvedValue(MockClass);
            const firstResult = await factory.getClass('TestClass');
            expect(firstResult).toBe(MockClass);
            expect(mockConfigManager.createDynamicClasse).toHaveBeenCalledWith('TestClass');
            // Second call - should return cached version
            jest.clearAllMocks();
            const secondResult = await factory.getClass('TestClass');
            expect(secondResult).toBe(MockClass);
            expect(mockConfigManager.createDynamicClasse).not.toHaveBeenCalled();
        });
        it('should create new class if not cached', async () => {
            const MockClass = class extends Classe_1.Classe {
            };
            mockConfigManager.createDynamicClasse.mockResolvedValue(MockClass);
            const result = await factory.getClass('NewClass');
            expect(result).toBe(MockClass);
            expect(mockConfigManager.createDynamicClasse).toHaveBeenCalledWith('NewClass');
        });
    });
    describe('createInstance', () => {
        it('should create instance of dynamic class', async () => {
            const mockVault = { app: mockApp };
            const mockFile = { path: 'test.md' };
            const MockClass = jest.fn();
            MockClass.mockImplementation(function (vault, file) {
                this.vault = vault;
                this.file = file;
                this.displayConfig = undefined;
            });
            mockConfigManager.createDynamicClasse.mockResolvedValue(MockClass);
            mockConfigManager.getClassConfig.mockResolvedValue({ className: 'TestClass' });
            const instance = await factory.createInstance('TestClass', mockApp, mockVault, mockFile);
            expect(MockClass).toHaveBeenCalledWith(mockVault, mockFile);
            expect(instance).toBeInstanceOf(MockClass);
        });
    });
    describe('getAvailableClasses', () => {
        it('should delegate to config manager', async () => {
            const mockClasses = ['Class1', 'Class2', 'Class3'];
            mockConfigManager.getAvailableClasses.mockResolvedValue(mockClasses);
            const result = await factory.getAvailableClasses();
            expect(result).toEqual(mockClasses);
            expect(mockConfigManager.getAvailableClasses).toHaveBeenCalled();
        });
    });
    describe('clearCache', () => {
        it('should clear both config manager and class registry', async () => {
            const MockClass = class extends Classe_1.Classe {
            };
            mockConfigManager.createDynamicClasse.mockResolvedValue(MockClass);
            // Add class to registry
            await factory.getClass('TestClass');
            // Clear cache
            factory.clearCache();
            expect(mockConfigManager.clearCache).toHaveBeenCalled();
            // Should call createDynamicClasse again after clearing
            jest.clearAllMocks();
            await factory.getClass('TestClass');
            expect(mockConfigManager.createDynamicClasse).toHaveBeenCalledWith('TestClass');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxfX3Rlc3RzX19cXENvbmZpZ1xcRHluYW1pY0NsYXNzRmFjdG9yeS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBSUEsMEJBQTBCO0FBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMscUNBQXFDLENBQUMsQ0FBQztBQUxqRCw4RUFBMkU7QUFDM0UsNEVBQXlFO0FBQ3pFLG1EQUFnRDtBQUtoRCxRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO0lBQ2pDLElBQUksT0FBNEIsQ0FBQztJQUNqQyxJQUFJLGlCQUFrRCxDQUFDO0lBQ3ZELElBQUksT0FBWSxDQUFDO0lBRWpCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDWixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFckIsT0FBTyxHQUFHO1lBQ04sWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDO1lBQzFDLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQztTQUN0QyxDQUFDO1FBRUYsc0RBQXNEO1FBQ3RELGlCQUFpQixHQUFHO1lBQ2hCLG1CQUFtQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDOUIsY0FBYyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDekIsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUM5QixVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtTQUNqQixDQUFDO1FBRVQsdUJBQXVCO1FBQ3RCLHVDQUFrRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFaEgsT0FBTyxHQUFHLElBQUkseUNBQW1CLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxD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QUFFLENBQUM7WUFFckIsTUFBTSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFeEQsdURBQXVEO1lBQ3ZELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUNyQixNQUFNLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLG1CQUFtQixDQUFDLENBQUMsb0JBQW9CLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDcEYsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcX190ZXN0c19fXFxDb25maWdcXER5bmFtaWNDbGFzc0ZhY3RvcnkudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbWljQ2xhc3NGYWN0b3J5IH0gZnJvbSAnLi4vLi4vc3JjL0NvbmZpZy9EeW5hbWljQ2xhc3NGYWN0b3J5JztcclxuaW1wb3J0IHsgQ2xhc3NDb25maWdNYW5hZ2VyIH0gZnJvbSAnLi4vLi4vc3JjL0NvbmZpZy9DbGFzc0NvbmZpZ01hbmFnZXInO1xyXG5pbXBvcnQgeyBDbGFzc2UgfSBmcm9tICcuLi8uLi9zcmMvdmF1bHQvQ2xhc3NlJztcclxuXHJcbi8vIE1vY2sgQ2xhc3NDb25maWdNYW5hZ2VyXHJcbmplc3QubW9jaygnLi4vLi4vc3JjL0NvbmZpZy9DbGFzc0NvbmZpZ01hbmFnZXInKTtcclxuXHJcbmRlc2NyaWJlKCdEeW5hbWljQ2xhc3NGYWN0b3J5JywgKCkgPT4ge1xyXG4gICAgbGV0IGZhY3Rvcnk6IER5bmFtaWNDbGFzc0ZhY3Rvcnk7XHJcbiAgICBsZXQgbW9ja0NvbmZpZ01hbmFnZXI6IGplc3QuTW9ja2VkPENsYXNzQ29uZmlnTWFuYWdlcj47XHJcbiAgICBsZXQgbW9ja0FwcDogYW55O1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIG1vY2tBcHAgPSB7XHJcbiAgICAgICAgICAgIGdldFZhdWx0UGF0aDogamVzdC5mbigoKSA9PiAnL3Rlc3QvdmF1bHQnKSxcclxuICAgICAgICAgICAgZ2V0TmFtZTogamVzdC5mbigoKSA9PiAnVGVzdFZhdWx0JylcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyBDcmVhdGUgbW9jayBjb25maWcgbWFuYWdlciB3aXRoIHRoZSBjb3JyZWN0IG1ldGhvZHNcclxuICAgICAgICBtb2NrQ29uZmlnTWFuYWdlciA9IHtcclxuICAgICAgICAgICAgY3JlYXRlRHluYW1pY0NsYXNzZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBnZXRDbGFzc0NvbmZpZzogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBnZXRBdmFpbGFibGVDbGFzc2VzOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIGNsZWFyQ2FjaGU6IGplc3QuZm4oKVxyXG4gICAgICAgIH0gYXMgYW55O1xyXG5cclxuICAgICAgICAvLyBNb2NrIHRoZSBjb25zdHJ1Y3RvclxyXG4gICAgICAgIChDbGFzc0NvbmZpZ01hbmFnZXIgYXMgamVzdC5Nb2NrZWRDbGFzczx0eXBlb2YgQ2xhc3NDb25maWdNYW5hZ2VyPikubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tDb25maWdNYW5hZ2VyKTtcclxuICAgICAgICBcclxuICAgICAgICBmYWN0b3J5ID0gbmV3IER5bmFtaWNDbGFzc0ZhY3RvcnkoJy4vdGVzdC1jb25maWcnLCBtb2NrQXBwKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdjb25zdHJ1Y3RvcicsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGNyZWF0ZSBpbnN0YW5jZSB3aXRoIGNvbmZpZyBtYW5hZ2VyJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBleHBlY3QoQ2xhc3NDb25maWdNYW5hZ2VyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnLi90ZXN0LWNvbmZpZycsIG1vY2tBcHApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ2dldENsYXNzJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGNhY2hlZCBjbGFzcyBpZiBhbHJlYWR5IHJlZ2lzdGVyZWQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IE1vY2tDbGFzcyA9IGNsYXNzIGV4dGVuZHMgQ2xhc3NlIHt9IGFzIGFueTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIEZpcnN0IGNhbGwgLSBzaG91bGQgY2FsbCBjcmVhdGVEeW5hbWljQ2xhc3NlXHJcbiAgICAgICAgICAgIG1vY2tDb25maWdNYW5hZ2VyLmNyZWF0ZUR5bmFtaWNDbGFzc2UubW9ja1Jlc29sdmVkVmFsdWUoTW9ja0NsYXNzKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0UmVzdWx0ID0gYXdhaXQgZmFjdG9yeS5nZXRDbGFzcygnVGVzdENsYXNzJyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChmaXJzdFJlc3VsdCkudG9CZShNb2NrQ2xhc3MpO1xyXG4gICAgICAgICAgICBleHBlY3QobW9ja0NvbmZpZ01hbmFnZXIuY3JlYXRlRHluYW1pY0NsYXNzZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1Rlc3RDbGFzcycpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gU2Vjb25kIGNhbGwgLSBzaG91bGQgcmV0dXJuIGNhY2hlZCB2ZXJzaW9uXHJcbiAgICAgICAgICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgICAgICAgICBjb25zdCBzZWNvbmRSZXN1bHQgPSBhd2FpdCBmYWN0b3J5LmdldENsYXNzKCdUZXN0Q2xhc3MnKTtcclxuICAgICAgICAgICAgZXhwZWN0KHNlY29uZFJlc3VsdCkudG9CZShNb2NrQ2xhc3MpO1xyXG4gICAgICAgICAgICBleHBlY3QobW9ja0NvbmZpZ01hbmFnZXIuY3JlYXRlRHluYW1pY0NsYXNzZSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBjcmVhdGUgbmV3IGNsYXNzIGlmIG5vdCBjYWNoZWQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IE1vY2tDbGFzcyA9IGNsYXNzIGV4dGVuZHMgQ2xhc3NlIHt9IGFzIGFueTtcclxuICAgICAgICAgICAgbW9ja0NvbmZpZ01hbmFnZXIuY3JlYXRlRHluYW1pY0NsYXNzZS5tb2NrUmVzb2x2ZWRWYWx1ZShNb2NrQ2xhc3MpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmFjdG9yeS5nZXRDbGFzcygnTmV3Q2xhc3MnKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoTW9ja0NsYXNzKTtcclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tDb25maWdNYW5hZ2VyLmNyZWF0ZUR5bmFtaWNDbGFzc2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdOZXdDbGFzcycpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ2NyZWF0ZUluc3RhbmNlJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGluc3RhbmNlIG9mIGR5bmFtaWMgY2xhc3MnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tWYXVsdCA9IHsgYXBwOiBtb2NrQXBwIH0gYXMgYW55O1xyXG4gICAgICAgICAgICBjb25zdCBtb2NrRmlsZSA9IHsgcGF0aDogJ3Rlc3QubWQnIH0gYXMgYW55O1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgTW9ja0NsYXNzID0gamVzdC5mbigpO1xyXG4gICAgICAgICAgICBNb2NrQ2xhc3MubW9ja0ltcGxlbWVudGF0aW9uKGZ1bmN0aW9uKHRoaXM6IGFueSwgdmF1bHQ6IGFueSwgZmlsZTogYW55KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZhdWx0ID0gdmF1bHQ7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpbGUgPSBmaWxlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwbGF5Q29uZmlnID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIG1vY2tDb25maWdNYW5hZ2VyLmNyZWF0ZUR5bmFtaWNDbGFzc2UubW9ja1Jlc29sdmVkVmFsdWUoTW9ja0NsYXNzIGFzIGFueSk7XHJcbiAgICAgICAgICAgIG1vY2tDb25maWdNYW5hZ2VyLmdldENsYXNzQ29uZmlnLm1vY2tSZXNvbHZlZFZhbHVlKHsgY2xhc3NOYW1lOiAnVGVzdENsYXNzJyB9IGFzIGFueSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGF3YWl0IGZhY3RvcnkuY3JlYXRlSW5zdGFuY2UoJ1Rlc3RDbGFzcycsIG1vY2tBcHAsIG1vY2tWYXVsdCwgbW9ja0ZpbGUpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZXhwZWN0KE1vY2tDbGFzcykudG9IYXZlQmVlbkNhbGxlZFdpdGgobW9ja1ZhdWx0LCBtb2NrRmlsZSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChpbnN0YW5jZSkudG9CZUluc3RhbmNlT2YoTW9ja0NsYXNzKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdnZXRBdmFpbGFibGVDbGFzc2VzJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgZGVsZWdhdGUgdG8gY29uZmlnIG1hbmFnZXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tDbGFzc2VzID0gWydDbGFzczEnLCAnQ2xhc3MyJywgJ0NsYXNzMyddO1xyXG4gICAgICAgICAgICBtb2NrQ29uZmlnTWFuYWdlci5nZXRBdmFpbGFibGVDbGFzc2VzLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tDbGFzc2VzKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZhY3RvcnkuZ2V0QXZhaWxhYmxlQ2xhc3NlcygpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrQ2xhc3Nlcyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQ29uZmlnTWFuYWdlci5nZXRBdmFpbGFibGVDbGFzc2VzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnY2xlYXJDYWNoZScsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGNsZWFyIGJvdGggY29uZmlnIG1hbmFnZXIgYW5kIGNsYXNzIHJlZ2lzdHJ5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBNb2NrQ2xhc3MgPSBjbGFzcyBleHRlbmRzIENsYXNzZSB7fSBhcyBhbnk7XHJcbiAgICAgICAgICAgIG1vY2tDb25maWdNYW5hZ2VyLmNyZWF0ZUR5bmFtaWNDbGFzc2UubW9ja1Jlc29sdmVkVmFsdWUoTW9ja0NsYXNzKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIEFkZCBjbGFzcyB0byByZWdpc3RyeVxyXG4gICAgICAgICAgICBhd2FpdCBmYWN0b3J5LmdldENsYXNzKCdUZXN0Q2xhc3MnKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENsZWFyIGNhY2hlXHJcbiAgICAgICAgICAgIGZhY3RvcnkuY2xlYXJDYWNoZSgpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tDb25maWdNYW5hZ2VyLmNsZWFyQ2FjaGUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFNob3VsZCBjYWxsIGNyZWF0ZUR5bmFtaWNDbGFzc2UgYWdhaW4gYWZ0ZXIgY2xlYXJpbmdcclxuICAgICAgICAgICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcbiAgICAgICAgICAgIGF3YWl0IGZhY3RvcnkuZ2V0Q2xhc3MoJ1Rlc3RDbGFzcycpO1xyXG4gICAgICAgICAgICBleHBlY3QobW9ja0NvbmZpZ01hbmFnZXIuY3JlYXRlRHluYW1pY0NsYXNzZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1Rlc3RDbGFzcycpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==