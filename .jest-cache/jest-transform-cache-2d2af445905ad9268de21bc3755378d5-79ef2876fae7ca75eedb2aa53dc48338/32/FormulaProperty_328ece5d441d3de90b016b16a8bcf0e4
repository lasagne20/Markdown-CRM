76cbd611481afb4e1585059697115b4a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FormulaProperty = void 0;
const LinkProperty_1 = require("./LinkProperty");
class FormulaProperty extends LinkProperty_1.LinkProperty {
    constructor(name, vault, formula, args = { icon: "", static: true, write: false }) {
        super(name, vault, args);
        this.type = "formula";
        this.write = false;
        this.formula = formula;
        this.write = args.write ?? false;
    }
    validate(value) {
        return value;
    }
    read(file) {
        // Get all properties from the file
        const allFileProperties = file.getAllProperties() || {};
        // Convert properties to their actual values
        const allProperties = {};
        for (const [key, prop] of Object.entries(allFileProperties)) {
            if (key !== this.name) { // Exclude self to avoid circular reference
                allProperties[key] = file.getMetadataValue(key);
            }
        }
        try {
            const sanitizedProperties = Object.keys(allProperties).reduce((acc, key) => {
                const sanitizedKey = key.replace(/\s+/g, "");
                acc[sanitizedKey] = allProperties[key];
                return acc;
            }, {});
            const formulaContent = `
                    const properties = ${JSON.stringify(sanitizedProperties)};
                    const name = "${file.getName(false)}";
                    const { ${Object.keys(sanitizedProperties).join(", ")} } = properties;
                    ${this.formula.includes("return") ? "" : "return "}${this.formula};
                `;
            const formulaFunction = new Function("vault", "file", formulaContent);
            let value = formulaFunction(file.vault, file);
            if (this.write) {
                let currentValue = file.getMetadataValue(this.name);
                if (currentValue !== value) {
                    file.updateMetadata(this.name, value);
                }
            }
            return value;
        }
        catch (error) {
            if (error instanceof ReferenceError) {
                console.error("Formula error : " + this.formula + "\n\n"
                    + error
                    + "\n\nThis is all the properties available : ", Object.keys(allProperties).join(", "));
            }
            else {
                console.error("Formula error : " + this.formula + "\n\n" + error);
            }
            return null;
        }
    }
    getPretty(value) {
        if (!value)
            return value;
        if (typeof value !== "string") {
            console.error("Value is not a string:", value);
            return value;
        }
        // Check if it's a date
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/; // Matches "YYYY-MM-DD"
        if (dateRegex.test(value)) {
            const parsedDate = new Date(value);
            return parsedDate.toLocaleDateString("fr-FR", {
                day: "numeric",
                month: "long",
                year: "numeric"
            });
        }
        if (!isNaN(Number(value)) && Number.isInteger(Number(value))) {
            return Number(value).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        return value.replace(/^https?:\/\//, "").replace("[[", "").replace("]]", "");
    }
    getLink(value) {
        if (!value)
            return value;
        // Check if it's an email
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (emailRegex.test(value)) {
            return `mailto:${value}`;
        }
        // Check if it's an Obsidian link [[...]]
        const obsidianLinkRegex = /\[\[([^\]]+)\]\]/;
        try {
            const match = value.match(obsidianLinkRegex);
            if (match && match[1]) {
                return `obsidian://open?vault=${this.vault.getName()}&file=${encodeURIComponent(this.vault.readLinkFile(match[1], true)[1])}`;
            }
            // Check if it's a valid URL
            const urlRegex = /^(https?:\/\/)?([a-zA-Z0-9_-]+\.)+[a-zA-Z]{2,6}(\/[a-zA-Z0-9_-]+)*\/?$/;
            if (urlRegex.test(value)) {
                return value.startsWith("http") ? value : `http://${value}`;
            }
        }
        catch (error) {
            console.error(`Error parsing link for ${value}:`, error);
        }
        return value;
    }
}
exports.FormulaProperty = FormulaProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXEZvcm11bGFQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSxpREFBOEM7QUFHOUMsTUFBYSxlQUFnQixTQUFRLDJCQUFZO0lBTTdDLFlBQVksSUFBYSxFQUFFLEtBQVksRUFBRSxPQUFlLEVBQUUsT0FBMkQsRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBQztRQUN2SixLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUpiLFNBQUksR0FBWSxTQUFTLENBQUM7UUFDbkMsVUFBSyxHQUFhLEtBQUssQ0FBQztRQUkzQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDO0lBQ3JDLENBQUM7SUFFUSxRQUFRLENBQUMsS0FBYTtRQUMzQixPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRVEsSUFBSSxDQUFDLElBQVU7UUFDcEIsbUNBQW1DO1FBQ25DLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3hELDRDQUE0QztRQUM1QyxNQUFNLGFBQWEsR0FBd0IsRUFBRSxDQUFDO1FBRTlDLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztZQUMxRCxJQUFJLEdBQUcsS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQywyQ0FBMkM7Z0JBQ2hFLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJ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LFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ2xJLENBQUM7WUFFRCw0QkFBNEI7WUFDNUIsTUFBTSxRQUFRLEdBQUcsd0VBQXdFLENBQUM7WUFDMUYsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZCLE9BQU8sS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxVQUFVLEtBQUssRUFBRSxDQUFDO1lBQ2hFLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEtBQUssR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdELENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0NBRUo7QUF4SEQsMENBd0hDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFxwcm9wZXJ0aWVzXFxGb3JtdWxhUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmlsZSB9IGZyb20gJy4uL3ZhdWx0L0ZpbGUnO1xyXG5pbXBvcnQgeyBMaW5rUHJvcGVydHkgfSBmcm9tICcuL0xpbmtQcm9wZXJ0eSc7XHJcbmltcG9ydCB7IFZhdWx0IH0gZnJvbSAnLi4vdmF1bHQvVmF1bHQnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEZvcm11bGFQcm9wZXJ0eSBleHRlbmRzIExpbmtQcm9wZXJ0eSB7XHJcblxyXG4gICAgcHVibGljIGZvcm11bGEgOiBzdHJpbmc7XHJcbiAgICBwdWJsaWMgb3ZlcnJpZGUgdHlwZSA6IHN0cmluZyA9IFwiZm9ybXVsYVwiO1xyXG4gICAgcHVibGljIHdyaXRlIDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG5hbWUgOiBzdHJpbmcsIHZhdWx0OiBWYXVsdCwgZm9ybXVsYTogc3RyaW5nLCBhcmdzIDoge2ljb246IHN0cmluZywgc3RhdGljPzogYm9vbGVhbiwgd3JpdGU/OiBib29sZWFufSA9IHtpY29uOiBcIlwiLCBzdGF0aWM6IHRydWUsIHdyaXRlOiBmYWxzZX0pIHtcclxuICAgICAgICBzdXBlcihuYW1lLCB2YXVsdCwgYXJncyk7XHJcbiAgICAgICAgdGhpcy5mb3JtdWxhID0gZm9ybXVsYTtcclxuICAgICAgICB0aGlzLndyaXRlID0gYXJncy53cml0ZSA/PyBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSB2YWxpZGF0ZSh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgcmVhZChmaWxlOiBGaWxlKSA6IGFueSB7XHJcbiAgICAgICAgLy8gR2V0IGFsbCBwcm9wZXJ0aWVzIGZyb20gdGhlIGZpbGVcclxuICAgICAgICBjb25zdCBhbGxGaWxlUHJvcGVydGllcyA9IGZpbGUuZ2V0QWxsUHJvcGVydGllcygpIHx8IHt9O1xyXG4gICAgICAgIC8vIENvbnZlcnQgcHJvcGVydGllcyB0byB0aGVpciBhY3R1YWwgdmFsdWVzXHJcbiAgICAgICAgY29uc3QgYWxsUHJvcGVydGllczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGZvciAoY29uc3QgW2tleSwgcHJvcF0gb2YgT2JqZWN0LmVudHJpZXMoYWxsRmlsZVByb3BlcnRpZXMpKSB7XHJcbiAgICAgICAgICAgIGlmIChrZXkgIT09IHRoaXMubmFtZSkgeyAvLyBFeGNsdWRlIHNlbGYgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlXHJcbiAgICAgICAgICAgICAgICBhbGxQcm9wZXJ0aWVzW2tleV0gPSBmaWxlLmdldE1ldGFkYXRhVmFsdWUoa2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBzYW5pdGl6ZWRQcm9wZXJ0aWVzID0gT2JqZWN0LmtleXMoYWxsUHJvcGVydGllcykucmVkdWNlKChhY2M6IFJlY29yZDxzdHJpbmcsIGFueT4sIGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2FuaXRpemVkS2V5OiBzdHJpbmcgPSBrZXkucmVwbGFjZSgvXFxzKy9nLCBcIlwiKTtcclxuICAgICAgICAgICAgICAgIGFjY1tzYW5pdGl6ZWRLZXldID0gYWxsUHJvcGVydGllc1trZXldO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcclxuICAgICAgICAgICAgfSwge30gYXMgUmVjb3JkPHN0cmluZywgYW55Pik7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBmb3JtdWxhQ29udGVudCA9IFxyXG4gICAgICAgICAgICAgICAgYFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSAke0pTT04uc3RyaW5naWZ5KHNhbml0aXplZFByb3BlcnRpZXMpfTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gXCIke2ZpbGUuZ2V0TmFtZShmYWxzZSl9XCI7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyAke09iamVjdC5rZXlzKHNhbml0aXplZFByb3BlcnRpZXMpLmpvaW4oXCIsIFwiKX0gfSA9IHByb3BlcnRpZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgJHt0aGlzLmZvcm11bGEuaW5jbHVkZXMoXCJyZXR1cm5cIikgPyBcIlwiIDogXCJyZXR1cm4gXCJ9JHt0aGlzLmZvcm11bGF9O1xyXG4gICAgICAgICAgICAgICAgYDtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm11bGFGdW5jdGlvbiA9IG5ldyBGdW5jdGlvbihcInZhdWx0XCIsIFwiZmlsZVwiLCBmb3JtdWxhQ29udGVudCk7XHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IGZvcm11bGFGdW5jdGlvbihmaWxlLnZhdWx0LCBmaWxlKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMud3JpdGUpIHtcclxuICAgICAgICAgICAgICAgIGxldCBjdXJyZW50VmFsdWUgPSBmaWxlLmdldE1ldGFkYXRhVmFsdWUodGhpcy5uYW1lKTtcclxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgIT09IHZhbHVlKXtcclxuICAgICAgICAgICAgICAgICAgICBmaWxlLnVwZGF0ZU1ldGFkYXRhKHRoaXMubmFtZSwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgUmVmZXJlbmNlRXJyb3Ipe1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkZvcm11bGEgZXJyb3IgOiBcIiArIHRoaXMuZm9ybXVsYSArIFwiXFxuXFxuXCJcclxuICAgICAgICAgICAgICAgICAgICArIGVycm9yIFxyXG4gICAgICAgICAgICAgICAgICAgICsgXCJcXG5cXG5UaGlzIGlzIGFsbCB0aGUgcHJvcGVydGllcyBhdmFpbGFibGUgOiBcIiwgT2JqZWN0LmtleXMoYWxsUHJvcGVydGllcykuam9pbihcIiwgXCIpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJGb3JtdWxhIGVycm9yIDogXCIgKyB0aGlzLmZvcm11bGEgKyBcIlxcblxcblwiICsgZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIG92ZXJyaWRlIGdldFByZXR0eSh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCF2YWx1ZSkgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlZhbHVlIGlzIG5vdCBhIHN0cmluZzpcIiwgdmFsdWUpO1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGEgZGF0ZVxyXG4gICAgICAgIGNvbnN0IGRhdGVSZWdleCA9IC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLzsgLy8gTWF0Y2hlcyBcIllZWVktTU0tRERcIlxyXG4gICAgICAgIGlmIChkYXRlUmVnZXgudGVzdCh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgY29uc3QgcGFyc2VkRGF0ZSA9IG5ldyBEYXRlKHZhbHVlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHBhcnNlZERhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKFwiZnItRlJcIiwge1xyXG4gICAgICAgICAgICAgICAgZGF5OiBcIm51bWVyaWNcIixcclxuICAgICAgICAgICAgICAgIG1vbnRoOiBcImxvbmdcIixcclxuICAgICAgICAgICAgICAgIHllYXI6IFwibnVtZXJpY1wiXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFpc05hTihOdW1iZXIodmFsdWUpKSAmJiBOdW1iZXIuaXNJbnRlZ2VyKE51bWJlcih2YWx1ZSkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpLnRvTG9jYWxlU3RyaW5nKFwiZnItRlJcIix7IG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMiwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAyIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoL15odHRwcz86XFwvXFwvLywgXCJcIikucmVwbGFjZShcIltbXCIsIFwiXCIpLnJlcGxhY2UoXCJdXVwiLCBcIlwiKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgZ2V0TGluayh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoIXZhbHVlKSByZXR1cm4gdmFsdWU7XHJcblxyXG4gICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYW4gZW1haWxcclxuICAgICAgICBjb25zdCBlbWFpbFJlZ2V4ID0gL15bYS16QS1aMC05Ll8lKy1dK0BbYS16QS1aMC05Li1dK1xcLlthLXpBLVpdezIsfSQvO1xyXG4gICAgICAgIGlmIChlbWFpbFJlZ2V4LnRlc3QodmFsdWUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBgbWFpbHRvOiR7dmFsdWV9YDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYW4gT2JzaWRpYW4gbGluayBbWy4uLl1dXHJcbiAgICAgICAgY29uc3Qgb2JzaWRpYW5MaW5rUmVnZXggPSAvXFxbXFxbKFteXFxdXSspXFxdXFxdLztcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBtYXRjaCA9IHZhbHVlLm1hdGNoKG9ic2lkaWFuTGlua1JlZ2V4KTtcclxuICAgICAgICAgICAgaWYgKG1hdGNoICYmIG1hdGNoWzFdKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYG9ic2lkaWFuOi8vb3Blbj92YXVsdD0ke3RoaXMudmF1bHQuZ2V0TmFtZSgpfSZmaWxlPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMudmF1bHQucmVhZExpbmtGaWxlKG1hdGNoWzFdLCB0cnVlKVsxXSl9YDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIHZhbGlkIFVSTFxyXG4gICAgICAgICAgICBjb25zdCB1cmxSZWdleCA9IC9eKGh0dHBzPzpcXC9cXC8pPyhbYS16QS1aMC05Xy1dK1xcLikrW2EtekEtWl17Miw2fShcXC9bYS16QS1aMC05Xy1dKykqXFwvPyQvO1xyXG4gICAgICAgICAgICBpZiAodXJsUmVnZXgudGVzdCh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zdGFydHNXaXRoKFwiaHR0cFwiKSA/IHZhbHVlIDogYGh0dHA6Ly8ke3ZhbHVlfWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBwYXJzaW5nIGxpbmsgZm9yICR7dmFsdWV9OmAsIGVycm9yKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbn0iXSwidmVyc2lvbiI6M30=