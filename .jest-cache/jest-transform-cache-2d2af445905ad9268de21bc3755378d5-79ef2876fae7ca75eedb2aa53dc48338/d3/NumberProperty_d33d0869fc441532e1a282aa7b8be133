ae8f75041521c77a7c442246a65d571d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NumberProperty = void 0;
const FormulaProperty_1 = require("./FormulaProperty");
const Property_1 = require("./Property");
class NumberProperty extends Property_1.Property {
    constructor(name, vault, unit = "", args = { icon: "", static: true }) {
        super(name, vault, args);
        this.unit = "";
        this.type = "number";
        this.formulaProperty = null;
        if (args.formula) {
            this.formulaProperty = new FormulaProperty_1.FormulaProperty(name, vault, args.formula, { icon: args.icon, static: args.static, write: true });
        }
        this.unit = unit;
    }
    validate(value) {
        // Handle null/undefined
        if (value == null) {
            return "";
        }
        // Convert to string if not already
        const stringValue = String(value);
        // Trim whitespace
        const trimmedValue = stringValue.trim();
        // Return empty string for empty or whitespace-only input
        if (!trimmedValue) {
            return "";
        }
        // Check if the entire string is a valid number (not just the beginning)
        const numberValue = parseFloat(trimmedValue);
        if (isNaN(numberValue)) {
            return "";
        }
        // Check if it's a valid number format (including scientific notation)
        if (!/^-?\d*\.?\d+(e[+-]?\d+)?$/i.test(trimmedValue) &&
            trimmedValue !== numberValue.toString()) {
            return "";
        }
        return numberValue.toString();
    }
    getDisplay(file, args = { staticMode: false, title: "" }) {
        this.static = args.staticMode ? true : this.static;
        this.title = args.title ? args.title : "";
        let value = this.read(file);
        if (!value && this.formulaProperty) {
            value = this.formulaProperty.read(file);
        }
        return this.fillDisplay(file.vault, value, async (value) => await file.updateMetadata(this.name, value));
    }
    fillDisplay(vault, value, update) {
        this.vault = vault;
        const field = this.createFieldContainer();
        if (this.title) {
            const title = document.createElement("div");
            title.textContent = this.title;
            title.classList.add("metadata-title");
            field.appendChild(title);
        }
        const iconContainer = this.createIconContainer(update);
        const fieldContainer = this.createFieldContainerContent(update, value);
        field.appendChild(iconContainer);
        field.appendChild(fieldContainer);
        return field;
    }
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        const currentField = value;
        const input = this.createFieldInput(currentField);
        const link = this.createFieldLink(currentField);
        if (this.static) {
            link.style.display = "block";
            input.style.display = "none";
        }
        else {
            if (currentField && this.validate(value)) {
                link.style.display = "block";
                input.style.display = "none";
            }
            else {
                input.style.display = "block";
                link.style.display = "none";
            }
        }
        fieldContainer.appendChild(link);
        fieldContainer.appendChild(input);
        if (!this.static) {
            this.handleFieldInput(update, input, link);
        }
        return fieldContainer;
    }
    createFieldLink(value) {
        const link = document.createElement("div");
        link.textContent = value ? `${value} ${this.unit}` : "";
        link.classList.add("field-link");
        link.style.cursor = this.static ? "default" : "text";
        if (!this.static) {
            link.onclick = (event) => this.modifyField(event);
        }
        return link;
    }
    async updateField(update, input, link) {
        let value = input.value;
        if (value) {
            await update(value);
            input.style.display = "none";
            link.textContent = value ? `${value} ${this.unit}` : "";
            link.style.display = "block";
        }
        else {
            await update(input.value);
        }
    }
    createFieldInput(value) {
        const input = document.createElement("input");
        input.type = "number";
        input.value = value || "";
        input.classList.add("field-input");
        return input;
    }
}
exports.NumberProperty = NumberProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXE51bWJlclByb3BlcnR5LnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHVEQUFvRDtBQUNwRCx5Q0FBc0M7QUFHdEMsTUFBYSxjQUFlLFNBQVEsbUJBQVE7SUFNeEMsWUFBWSxJQUFZLEVBQUUsS0FBWSxFQUFFLE9BQWUsRUFBRSxFQUFFLE9BQTZELEVBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFDO1FBQzVJLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBTHRCLFNBQUksR0FBVyxFQUFFLENBQUM7UUFDVCxTQUFJLEdBQVksUUFBUSxDQUFDO1FBQ2xDLG9CQUFlLEdBQTRCLElBQUksQ0FBQztRQUluRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxpQ0FBZSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO1FBQy9ILENBQUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBRVEsUUFBUSxDQUFDLEtBQWE7UUFDM0Isd0JBQXdCO1FBQ3hCLElBQUksS0FBSyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ2hCLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUVELG1DQUFtQztRQUNuQyxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEMsa0JBQWtCO1FBQ2xCLE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUV4Qyx5REFBeUQ7UUFDekQsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ2hCLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUVELHdFQUF3RTtRQUN4RSxNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDN0MsSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztZQUNyQixPQUFPLEVBQUUsQ0FBQztRQUNkLENBQUM7UUFFRCxzRUFBc0U7UUFDdEUsSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7WUFDaEQsWUFBWSxLQUFLLFdBQVcsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDO1lBQzFDLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUVELE9BQU8sV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFUSxVQUFVLENBQUMsSUFBUyxFQUFFLE9BQWlELEVBQUMsVUFBVSxFQUFHLEtBQUssRUFBRSxLQUFLLEVBQUMsRUFBRSxFQUFDO1FBQzFHLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ25ELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzFDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDakMsS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVDLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUM3RyxDQUFDO0lBRVEsV0FBVyxDQUFDLEtBQVcsRUFBRSxLQUFVLEVBQUUsTUFBcUM7UUFDL0UsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFFMUMsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDYixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzVDLEtBQUssQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUMvQixLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3RDLEtBQUssQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsMkJBQTJCLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXZFLEtBQUssQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDakMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUVsQyxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRVEsMkJBQTJCLENBQUMsTUFBd0MsRUFBRSxLQUFhO1FBQ3hGLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckQsY0FBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUVoRCxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDM0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2xELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFaEQsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDZCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7WUFDN0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ2pDLENBQUM7YUFBTSxDQUFDO1lBQ0osSUFBSSxZQUFZLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7Z0JBQzdCLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztZQUNqQyxDQUFDO2lCQUFNLENBQUM7Z0JBQ0osS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO2dCQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7WUFDaEMsQ0FBQztRQUNMLENBQUM7UUFFRCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pDLGNBQWMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQy9DLENBQUM7UUFFRCxPQUFPLGNBQWMsQ0FBQztJQUMxQixDQUFDO0lBRVEsZUFBZSxDQUFDLEtBQWE7UUFDbEMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDeEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDckQsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFUSxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQXdDLEVBQUUsS0FBdUIsRUFBRSxJQUFpQjtRQUMzRyxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO1FBQ3hCLElBQUksS0FBSyxFQUFFLENBQUM7WUFDUixNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNwQixLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7WUFDN0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3hELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUNqQyxDQUFDO2FBQU0sQ0FBQztZQUNKLE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0wsQ0FBQztJQUVRLGdCQUFnQixDQUFDLEtBQWE7UUFDbkMsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QyxLQUFLLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQztRQUN0QixLQUFLLENBQUMsS0FBSyxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDMUIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbkMsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUNKO0FBeklELHdDQXlJQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGxlb2R1XFxEb2N1bWVudHNcXDEgLSBQcm9cXFRlc3QgcGx1Z2luIG9ic2lkaWFuXFwub2JzaWRpYW5cXHBsdWdpbnNcXG9ic2lkaWFuLUNSTVxcZHluYW1pYy1maWVsZHNcXHNyY1xccHJvcGVydGllc1xcTnVtYmVyUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybXVsYVByb3BlcnR5IH0gZnJvbSBcIi4vRm9ybXVsYVByb3BlcnR5XCI7XHJcbmltcG9ydCB7IFByb3BlcnR5IH0gZnJvbSBcIi4vUHJvcGVydHlcIjtcclxuaW1wb3J0IHsgVmF1bHQgfSBmcm9tIFwiLi4vdmF1bHQvVmF1bHRcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBOdW1iZXJQcm9wZXJ0eSBleHRlbmRzIFByb3BlcnR5IHtcclxuXHJcbiAgICBwdWJsaWMgdW5pdDogc3RyaW5nID0gXCJcIjtcclxuICAgIHB1YmxpYyBvdmVycmlkZSB0eXBlIDogc3RyaW5nID0gXCJudW1iZXJcIjtcclxuICAgIHB1YmxpYyBmb3JtdWxhUHJvcGVydHkgOiBGb3JtdWxhUHJvcGVydHkgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIHZhdWx0OiBWYXVsdCwgdW5pdDogc3RyaW5nID0gXCJcIiwgYXJncyA6IHtpY29uOiBzdHJpbmcsIHN0YXRpYz86IGJvb2xlYW4sIGZvcm11bGE/IDogc3RyaW5nfSA9IHtpY29uOiBcIlwiLCBzdGF0aWM6IHRydWV9KSB7XHJcbiAgICAgICAgc3VwZXIobmFtZSwgdmF1bHQsIGFyZ3MpO1xyXG4gICAgICAgIGlmIChhcmdzLmZvcm11bGEpIHtcclxuICAgICAgICAgICAgdGhpcy5mb3JtdWxhUHJvcGVydHkgPSBuZXcgRm9ybXVsYVByb3BlcnR5KG5hbWUsIHZhdWx0LCBhcmdzLmZvcm11bGEsIHtpY29uOiBhcmdzLmljb24sIHN0YXRpYzogYXJncy5zdGF0aWMsIHdyaXRlOiB0cnVlfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudW5pdCA9IHVuaXQ7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgdmFsaWRhdGUodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgLy8gSGFuZGxlIG51bGwvdW5kZWZpbmVkXHJcbiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIENvbnZlcnQgdG8gc3RyaW5nIGlmIG5vdCBhbHJlYWR5XHJcbiAgICAgICAgY29uc3Qgc3RyaW5nVmFsdWUgPSBTdHJpbmcodmFsdWUpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIFRyaW0gd2hpdGVzcGFjZVxyXG4gICAgICAgIGNvbnN0IHRyaW1tZWRWYWx1ZSA9IHN0cmluZ1ZhbHVlLnRyaW0oKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBSZXR1cm4gZW1wdHkgc3RyaW5nIGZvciBlbXB0eSBvciB3aGl0ZXNwYWNlLW9ubHkgaW5wdXRcclxuICAgICAgICBpZiAoIXRyaW1tZWRWYWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGVudGlyZSBzdHJpbmcgaXMgYSB2YWxpZCBudW1iZXIgKG5vdCBqdXN0IHRoZSBiZWdpbm5pbmcpXHJcbiAgICAgICAgY29uc3QgbnVtYmVyVmFsdWUgPSBwYXJzZUZsb2F0KHRyaW1tZWRWYWx1ZSk7XHJcbiAgICAgICAgaWYgKGlzTmFOKG51bWJlclZhbHVlKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIHZhbGlkIG51bWJlciBmb3JtYXQgKGluY2x1ZGluZyBzY2llbnRpZmljIG5vdGF0aW9uKVxyXG4gICAgICAgIGlmICghL14tP1xcZCpcXC4/XFxkKyhlWystXT9cXGQrKT8kL2kudGVzdCh0cmltbWVkVmFsdWUpICYmIFxyXG4gICAgICAgICAgICB0cmltbWVkVmFsdWUgIT09IG51bWJlclZhbHVlLnRvU3RyaW5nKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBudW1iZXJWYWx1ZS50b1N0cmluZygpO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGdldERpc3BsYXkoZmlsZTogYW55LCBhcmdzIDoge3N0YXRpY01vZGU/IDogYm9vbGVhbiwgdGl0bGU/OiBzdHJpbmd9ID0ge3N0YXRpY01vZGUgOiBmYWxzZSwgdGl0bGU6XCJcIn0pIHtcclxuICAgICAgICB0aGlzLnN0YXRpYyA9IGFyZ3Muc3RhdGljTW9kZSA/IHRydWUgOiB0aGlzLnN0YXRpYztcclxuICAgICAgICB0aGlzLnRpdGxlID0gYXJncy50aXRsZSA/IGFyZ3MudGl0bGUgOiBcIlwiO1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IHRoaXMucmVhZChmaWxlKTtcclxuICAgICAgICBpZiAoIXZhbHVlICYmIHRoaXMuZm9ybXVsYVByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5mb3JtdWxhUHJvcGVydHkucmVhZChmaWxlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsbERpc3BsYXkoZmlsZS52YXVsdCwgdmFsdWUsIGFzeW5jICh2YWx1ZSkgPT4gYXdhaXQgZmlsZS51cGRhdGVNZXRhZGF0YSh0aGlzLm5hbWUsIHZhbHVlKSk7XHJcbiAgICB9IFxyXG5cclxuICAgIG92ZXJyaWRlIGZpbGxEaXNwbGF5KHZhdWx0IDogYW55LCB2YWx1ZTogYW55LCB1cGRhdGU6ICh2YWx1ZTogYW55KSA9PiBQcm9taXNlPHZvaWQ+KSB7XHJcbiAgICAgICAgdGhpcy52YXVsdCA9IHZhdWx0O1xyXG4gICAgICAgIGNvbnN0IGZpZWxkID0gdGhpcy5jcmVhdGVGaWVsZENvbnRhaW5lcigpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy50aXRsZSkge1xyXG4gICAgICAgICAgICBjb25zdCB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0gdGhpcy50aXRsZTtcclxuICAgICAgICAgICAgdGl0bGUuY2xhc3NMaXN0LmFkZChcIm1ldGFkYXRhLXRpdGxlXCIpO1xyXG4gICAgICAgICAgICBmaWVsZC5hcHBlbmRDaGlsZCh0aXRsZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpY29uQ29udGFpbmVyID0gdGhpcy5jcmVhdGVJY29uQ29udGFpbmVyKHVwZGF0ZSk7XHJcbiAgICAgICAgY29uc3QgZmllbGRDb250YWluZXIgPSB0aGlzLmNyZWF0ZUZpZWxkQ29udGFpbmVyQ29udGVudCh1cGRhdGUsIHZhbHVlKTtcclxuXHJcbiAgICAgICAgZmllbGQuYXBwZW5kQ2hpbGQoaWNvbkNvbnRhaW5lcik7XHJcbiAgICAgICAgZmllbGQuYXBwZW5kQ2hpbGQoZmllbGRDb250YWluZXIpO1xyXG5cclxuICAgICAgICByZXR1cm4gZmllbGQ7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgY3JlYXRlRmllbGRDb250YWluZXJDb250ZW50KHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIHZhbHVlOiBzdHJpbmcpOiBIVE1MRGl2RWxlbWVudCB7XHJcbiAgICAgICAgY29uc3QgZmllbGRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1jb250YWluZXJcIik7XHJcblxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGaWVsZCA9IHZhbHVlO1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gdGhpcy5jcmVhdGVGaWVsZElucHV0KGN1cnJlbnRGaWVsZCk7XHJcbiAgICAgICAgY29uc3QgbGluayA9IHRoaXMuY3JlYXRlRmllbGRMaW5rKGN1cnJlbnRGaWVsZCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnN0YXRpYykge1xyXG4gICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgICAgICAgIGlucHV0LnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoY3VycmVudEZpZWxkICYmIHRoaXMudmFsaWRhdGUodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmFwcGVuZENoaWxkKGxpbmspO1xyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmFwcGVuZENoaWxkKGlucHV0KTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRpYykge1xyXG4gICAgICAgICAgICB0aGlzLmhhbmRsZUZpZWxkSW5wdXQodXBkYXRlLCBpbnB1dCwgbGluayk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZmllbGRDb250YWluZXI7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgY3JlYXRlRmllbGRMaW5rKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gdmFsdWUgPyBgJHt2YWx1ZX0gJHt0aGlzLnVuaXR9YCA6IFwiXCI7XHJcbiAgICAgICAgbGluay5jbGFzc0xpc3QuYWRkKFwiZmllbGQtbGlua1wiKTtcclxuICAgICAgICBsaW5rLnN0eWxlLmN1cnNvciA9IHRoaXMuc3RhdGljID8gXCJkZWZhdWx0XCIgOiBcInRleHRcIjtcclxuICAgICAgICBpZiAoIXRoaXMuc3RhdGljKSB7XHJcbiAgICAgICAgICAgIGxpbmsub25jbGljayA9IChldmVudCkgPT4gdGhpcy5tb2RpZnlGaWVsZChldmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBsaW5rO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGFzeW5jIHVwZGF0ZUZpZWxkKHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIGlucHV0OiBIVE1MSW5wdXRFbGVtZW50LCBsaW5rOiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IGlucHV0LnZhbHVlO1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBhd2FpdCB1cGRhdGUodmFsdWUpO1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSB2YWx1ZSA/IGAke3ZhbHVlfSAke3RoaXMudW5pdH1gIDogXCJcIjtcclxuICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHVwZGF0ZShpbnB1dC52YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGNyZWF0ZUZpZWxkSW5wdXQodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImlucHV0XCIpO1xyXG4gICAgICAgIGlucHV0LnR5cGUgPSBcIm51bWJlclwiO1xyXG4gICAgICAgIGlucHV0LnZhbHVlID0gdmFsdWUgfHwgXCJcIjtcclxuICAgICAgICBpbnB1dC5jbGFzc0xpc3QuYWRkKFwiZmllbGQtaW5wdXRcIik7XHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfVxyXG59Il0sInZlcnNpb24iOjN9