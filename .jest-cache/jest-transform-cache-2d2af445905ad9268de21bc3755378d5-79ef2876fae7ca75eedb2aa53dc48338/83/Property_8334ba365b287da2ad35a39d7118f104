17a4ba0023910dfdc7d3011d5464f4e1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Property = void 0;
/**
 * Base class for all properties in the dynamic field system.
 * Represents an editable property with a dynamic user interface.
 *
 * This class provides the base behavior for:
 * - Displaying metadata fields
 * - Inline editing of values
 * - User input validation
 * - Vault interaction
 */
class Property {
    /**
     * Property constructor.
     * Initializes a property with its name, vault, and configuration options.
     *
     * @param name - Unique property name (used to identify the property in metadata)
     * @param vault - Vault instance for data operations
     * @param options - Optional property configuration
     * @param options.icon - Lucide icon to display next to the property (default: "align-left")
     * @param options.staticProperty - If true, the property is static and doesn't change (default: false)
     * @param options.flexSpan - Relative width of the property in the display (default: 1)
     * @param options.defaultValue - Default value of the property (default: "")
     */
    constructor(name, vault, options = {}) {
        this.title = "";
        this.flexSpan = 0;
        this.type = "text";
        const { icon = "align-left", staticProperty = false, flexSpan = 1, defaultValue = "", ...additionalOptions } = options;
        this.flexSpan = flexSpan;
        this.name = name;
        this.vault = vault;
        this.icon = icon;
        this.default = defaultValue;
        this.static = staticProperty;
        // Assign additional options to the instance
        Object.assign(this, additionalOptions);
    }
    /**
     * Gets the default value of the property.
     * Handles special default values like "personalName" that require
     * dynamic resolution via the vault.
     *
     * @returns The resolved default value of the property
     */
    getDefaultValue() {
        // TODO use a dictionary for special default values in vault
        if (this.default == "personalName") {
            return this.vault.getPersonalName();
        }
        return this.default;
    }
    /**
     * Reads the property value from the file's metadata.
     * Supports two file types: those with a getMetadataValue method
     * and those with a direct metadata object.
     *
     * @param file - Obsidian file from which to read the property
     * @returns The property value or undefined if it doesn't exist
     */
    async read(file) {
        if (file && typeof file === 'object' && 'readProperty' in file) {
            return file.getMetadataValue(this.name);
        }
        return await file.getMetadataValue(this.name);
    }
    /**
     * Validates and normalizes an input value for this property.
     * The base method returns the value unchanged, but can be
     * overridden by derived classes to perform transformations.
     *
     * @param value - Value to validate and normalize
     * @returns The validated and normalized value
     */
    validate(value) {
        return value;
    }
    /**
     * Generates a link for the property value.
     * Used to create clickable links in the user interface.
     *
     * @param value - Value for which to generate a link
     * @returns The link representation of the value
     */
    getLink(value) {
        return value;
    }
    /**
     * Formats a value for "pretty" display in the interface.
     * Can be overridden for property type-specific formatting.
     *
     * @param value - Value to format for display
     * @returns The formatted value for display
     */
    getPretty(value) {
        return value;
    }
    /**
     * Generates the complete display of the property for a given file.
     * Configures the display mode (static or editable) and title,
     * then delegates DOM creation to fillDisplay.
     *
     * @param file - File for which to generate the display
     * @param args - Display options
     * @param args.staticMode - If true, displays the property in read-only mode
     * @param args.title - Custom title for the property
     * @returns The DOM element representing the property
     */
    getDisplay(file, args = { staticMode: false, title: "" }) {
        this.static = args.staticMode ? true : this.static;
        this.title = args.title ? args.title : "";
        let value = this.read(file);
        return this.fillDisplay(value, async (value) => await file.updateMetadata(this.name, value), args);
    }
    /**
     * Fills and builds the complete DOM display of the property.
     * Creates the HTML structure with optional title, icon and editable content.
     *
     * @param value - Current property value to display
     * @param update - Update function called during changes
     * @param args - Additional arguments for configuration
     * @returns The complete DOM element of the property
     */
    fillDisplay(value, update, args) {
        const field = this.createFieldContainer();
        if (this.title) {
            const title = document.createElement("div");
            title.textContent = this.title;
            title.classList.add("metadata-title");
            field.appendChild(title);
        }
        const iconContainer = this.createIconContainer(update);
        const fieldContainer = this.createFieldContainerContent(update, value);
        field.appendChild(iconContainer);
        field.appendChild(fieldContainer);
        return field;
    }
    /**
     * Creates the main container for the property display.
     * Defines the basic HTML structure with appropriate CSS classes.
     *
     * @returns The main container div element of the property
     */
    createFieldContainer() {
        const field = document.createElement("div");
        field.classList.add("metadata-field");
        return field;
    }
    /**
     * Creates the icon container for the property.
     * Adds a click handler to toggle to edit mode if the property is not static.
     *
     * @param update - Update function to persist changes
     * @returns The icon container element with its events
     */
    createIconContainer(update) {
        const iconContainer = document.createElement("div");
        iconContainer.classList.add("icon-container");
        if (this.icon) {
            const icon = document.createElement("div");
            this.vault.app.setIcon(icon, this.icon);
            iconContainer.appendChild(icon);
            if (!this.static) {
                iconContainer.addEventListener("click", (event) => this.modifyField(event));
            }
        }
        return iconContainer;
    }
    /**
     * Handles switching to edit mode when the user clicks on the icon.
     * Hides the read-only display and shows the input field with focus.
     *
     * @param event - Click event on the icon
     */
    modifyField(event) {
        const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
        const input = event.target.closest('.metadata-field')?.querySelector('.field-input');
        if (link && input) {
            link.style.display = "none";
            input.style.display = "block";
            input.focus();
        }
    }
    /**
     * Creates the field container content with input and link elements.
     * Manages the visibility of edit and display modes based on property state.
     *
     * @param update - Update function to persist changes
     * @param value - Current value to display
     * @returns The field container div with input and link elements
     */
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        const currentField = value;
        const input = this.createFieldInput(currentField);
        const link = this.createFieldLink(currentField);
        if (this.static) {
            link.style.display = "block";
            input.style.display = "none";
        }
        else {
            if (currentField) {
                link.style.display = "block";
                input.style.display = "none";
            }
            else {
                input.style.display = "block";
                link.style.display = "none";
            }
        }
        fieldContainer.appendChild(link);
        fieldContainer.appendChild(input);
        if (!this.static) {
            this.handleFieldInput(update, input, link);
        }
        return fieldContainer;
    }
    /**
     * Creates a clickable link element for displaying the property value.
     * Configures cursor style and click behavior based on static property.
     *
     * @param value - Value to display in the link
     * @returns The configured link div element
     */
    createFieldLink(value) {
        const link = document.createElement("div");
        link.textContent = this.getPretty(value) || "";
        link.classList.add("field-link");
        link.style.cursor = this.static ? "default" : "text";
        if (!this.static) {
            link.addEventListener("click", (event) => this.modifyField(event));
        }
        return link;
    }
    /**
     * Handles input field events for editing functionality.
     * Sets up blur and keyboard event listeners to save changes.
     *
     * @param update - Update function to persist changes
     * @param input - Input element to handle
     * @param link - Link element to show after editing
     */
    handleFieldInput(update, input, link) {
        input.addEventListener("blur", async () => {
            await this.updateField(update, input, link);
        });
        input.addEventListener("keydown", async (event) => {
            if (event.key === "Enter" || event.key === "Escape") {
                event.preventDefault();
                await this.updateField(update, input, link);
            }
        });
    }
    /**
     * Creates an input field for editing the property value.
     * Base implementation creates a text input, can be overridden for specific input types.
     *
     * @param value - Initial value for the input field
     * @returns The configured input element (input or textarea)
     */
    createFieldInput(value) {
        const input = document.createElement("input");
        input.type = "text";
        input.value = value || "";
        input.classList.add("field-input");
        return input;
    }
    /**
     * Updates the field value and switches back to display mode.
     * Validates the input, updates the backend, and refreshes the UI.
     *
     * @param update - Update function to persist the changes
     * @param input - Input element containing the new value
     * @param link - Link element to update and show
     */
    async updateField(update, input, link) {
        let value = this.validate(input.value);
        if (value) {
            await update(value);
            input.style.display = "none";
            link.textContent = value;
            if (link.href) {
                link.href = this.getLink(value);
            }
            link.style.display = "block";
        }
        else {
            await update(input.value);
        }
    }
    /**
     * Reloads the dynamic content of the property field from the file.
     * Updates both the display link and input field with the current file value.
     *
     * @param file - File from which to reload the property value
     */
    async reloadDynamicContent(file) {
        const field = document.querySelector('.metadata-field');
        if (field) {
            const newValue = await this.read(file);
            const link = field.querySelector('.field-link');
            const input = field.querySelector('.field-input');
            if (link && input) {
                link.textContent = newValue;
                input.value = newValue;
            }
        }
    }
}
exports.Property = Property;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFByb3BlcnR5LnRzIiwibWFwcGluZ3MiOiI7OztBQUlBOzs7Ozs7Ozs7R0FTRztBQUNILE1BQWEsUUFBUTtJQVdqQjs7Ozs7Ozs7Ozs7T0FXRztJQUNILFlBQVksSUFBWSxFQUFFLEtBQVksRUFBRSxVQU1wQyxFQUFFO1FBeEJDLFVBQUssR0FBVyxFQUFFLENBQUM7UUFDbkIsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUdiLFNBQUksR0FBWSxNQUFNLENBQUM7UUFxQjFCLE1BQU0sRUFBRSxJQUFJLEdBQUcsWUFBWSxFQUFFLGNBQWMsR0FBRyxLQUFLLEVBQUUsUUFBUSxHQUFHLENBQUMsRUFBRSxZQUFZLEdBQUcsRUFBRSxFQUFFLEdBQUcsaUJBQWlCLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDdkgsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUM7UUFFN0IsNENBQTRDO1FBQzVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILGVBQWU7UUFDWCw0REFBNEQ7UUFDNUQsSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLGNBQWMsRUFBQyxDQUFDO1lBQ2hDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN4QyxDQUFDO1FB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QUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQVU7UUFDakMsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3hELElBQUksS0FBSyxFQUFFLENBQUM7WUFDUixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQWdCLENBQUM7WUFDL0QsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQXFCLENBQUM7WUFDdEUsSUFBSSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7Z0JBQ2hCLElBQUksQ0FBQyxXQUFXLEdBQUcsUUFBUSxDQUFDO2dCQUM1QixLQUFLLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQztZQUMzQixDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7Q0FDSjtBQS9VRCw0QkErVUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFByb3BlcnR5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZpbGUgfSBmcm9tIFwiLi4vdmF1bHQvRmlsZVwiO1xyXG5pbXBvcnQgeyBJQXBwIH0gZnJvbSBcIi4uL2ludGVyZmFjZXMvSUFwcFwiO1xyXG5pbXBvcnQgeyBWYXVsdCB9IGZyb20gXCIuLi92YXVsdC9WYXVsdFwiO1xyXG5cclxuLyoqXHJcbiAqIEJhc2UgY2xhc3MgZm9yIGFsbCBwcm9wZXJ0aWVzIGluIHRoZSBkeW5hbWljIGZpZWxkIHN5c3RlbS5cclxuICogUmVwcmVzZW50cyBhbiBlZGl0YWJsZSBwcm9wZXJ0eSB3aXRoIGEgZHluYW1pYyB1c2VyIGludGVyZmFjZS5cclxuICogXHJcbiAqIFRoaXMgY2xhc3MgcHJvdmlkZXMgdGhlIGJhc2UgYmVoYXZpb3IgZm9yOlxyXG4gKiAtIERpc3BsYXlpbmcgbWV0YWRhdGEgZmllbGRzXHJcbiAqIC0gSW5saW5lIGVkaXRpbmcgb2YgdmFsdWVzXHJcbiAqIC0gVXNlciBpbnB1dCB2YWxpZGF0aW9uXHJcbiAqIC0gVmF1bHQgaW50ZXJhY3Rpb25cclxuICovXHJcbmV4cG9ydCBjbGFzcyBQcm9wZXJ0eSB7XHJcbiAgICBwdWJsaWMgbmFtZTogc3RyaW5nO1xyXG4gICAgcHVibGljIGljb246IHN0cmluZztcclxuICAgIHB1YmxpYyB2YXVsdDogVmF1bHQ7XHJcbiAgICBwdWJsaWMgc3RhdGljOiBib29sZWFuO1xyXG4gICAgcHVibGljIHRpdGxlOiBzdHJpbmcgPSBcIlwiO1xyXG4gICAgcHVibGljIGZsZXhTcGFuID0gMDtcclxuICAgIHB1YmxpYyBkZWZhdWx0OiBhbnk7XHJcblxyXG4gICAgcHVibGljIHR5cGUgOiBzdHJpbmcgPSBcInRleHRcIjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIFByb3BlcnR5IGNvbnN0cnVjdG9yLlxyXG4gICAgICogSW5pdGlhbGl6ZXMgYSBwcm9wZXJ0eSB3aXRoIGl0cyBuYW1lLCB2YXVsdCwgYW5kIGNvbmZpZ3VyYXRpb24gb3B0aW9ucy5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIG5hbWUgLSBVbmlxdWUgcHJvcGVydHkgbmFtZSAodXNlZCB0byBpZGVudGlmeSB0aGUgcHJvcGVydHkgaW4gbWV0YWRhdGEpXHJcbiAgICAgKiBAcGFyYW0gdmF1bHQgLSBWYXVsdCBpbnN0YW5jZSBmb3IgZGF0YSBvcGVyYXRpb25zXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyAtIE9wdGlvbmFsIHByb3BlcnR5IGNvbmZpZ3VyYXRpb25cclxuICAgICAqIEBwYXJhbSBvcHRpb25zLmljb24gLSBMdWNpZGUgaWNvbiB0byBkaXNwbGF5IG5leHQgdG8gdGhlIHByb3BlcnR5IChkZWZhdWx0OiBcImFsaWduLWxlZnRcIilcclxuICAgICAqIEBwYXJhbSBvcHRpb25zLnN0YXRpY1Byb3BlcnR5IC0gSWYgdHJ1ZSwgdGhlIHByb3BlcnR5IGlzIHN0YXRpYyBhbmQgZG9lc24ndCBjaGFuZ2UgKGRlZmF1bHQ6IGZhbHNlKVxyXG4gICAgICogQHBhcmFtIG9wdGlvbnMuZmxleFNwYW4gLSBSZWxhdGl2ZSB3aWR0aCBvZiB0aGUgcHJvcGVydHkgaW4gdGhlIGRpc3BsYXkgKGRlZmF1bHQ6IDEpXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucy5kZWZhdWx0VmFsdWUgLSBEZWZhdWx0IHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSAoZGVmYXVsdDogXCJcIilcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCB2YXVsdDogVmF1bHQsIG9wdGlvbnM6IHsgXHJcbiAgICAgICAgaWNvbj86IHN0cmluZywgXHJcbiAgICAgICAgc3RhdGljUHJvcGVydHk/OiBib29sZWFuLCBcclxuICAgICAgICBmbGV4U3Bhbj86IG51bWJlciwgXHJcbiAgICAgICAgZGVmYXVsdFZhbHVlPzogYW55LCBcclxuICAgICAgICBba2V5OiBzdHJpbmddOiBhbnkgXHJcbiAgICB9ID0ge30pIHtcclxuICAgICAgICBjb25zdCB7IGljb24gPSBcImFsaWduLWxlZnRcIiwgc3RhdGljUHJvcGVydHkgPSBmYWxzZSwgZmxleFNwYW4gPSAxLCBkZWZhdWx0VmFsdWUgPSBcIlwiLCAuLi5hZGRpdGlvbmFsT3B0aW9ucyB9ID0gb3B0aW9ucztcclxuICAgICAgICB0aGlzLmZsZXhTcGFuID0gZmxleFNwYW47XHJcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcclxuICAgICAgICB0aGlzLnZhdWx0ID0gdmF1bHQ7XHJcbiAgICAgICAgdGhpcy5pY29uID0gaWNvbjtcclxuICAgICAgICB0aGlzLmRlZmF1bHQgPSBkZWZhdWx0VmFsdWU7XHJcbiAgICAgICAgdGhpcy5zdGF0aWMgPSBzdGF0aWNQcm9wZXJ0eTtcclxuXHJcbiAgICAgICAgLy8gQXNzaWduIGFkZGl0aW9uYWwgb3B0aW9ucyB0byB0aGUgaW5zdGFuY2VcclxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIGFkZGl0aW9uYWxPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldHMgdGhlIGRlZmF1bHQgdmFsdWUgb2YgdGhlIHByb3BlcnR5LlxyXG4gICAgICogSGFuZGxlcyBzcGVjaWFsIGRlZmF1bHQgdmFsdWVzIGxpa2UgXCJwZXJzb25hbE5hbWVcIiB0aGF0IHJlcXVpcmVcclxuICAgICAqIGR5bmFtaWMgcmVzb2x1dGlvbiB2aWEgdGhlIHZhdWx0LlxyXG4gICAgICogXHJcbiAgICAgKiBAcmV0dXJucyBUaGUgcmVzb2x2ZWQgZGVmYXVsdCB2YWx1ZSBvZiB0aGUgcHJvcGVydHlcclxuICAgICAqL1xyXG4gICAgZ2V0RGVmYXVsdFZhbHVlKCl7XHJcbiAgICAgICAgLy8gVE9ETyB1c2UgYSBkaWN0aW9uYXJ5IGZvciBzcGVjaWFsIGRlZmF1bHQgdmFsdWVzIGluIHZhdWx0XHJcbiAgICAgICAgaWYgKHRoaXMuZGVmYXVsdCA9PSBcInBlcnNvbmFsTmFtZVwiKXtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudmF1bHQuZ2V0UGVyc29uYWxOYW1lKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmRlZmF1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZWFkcyB0aGUgcHJvcGVydHkgdmFsdWUgZnJvbSB0aGUgZmlsZSdzIG1ldGFkYXRhLlxyXG4gICAgICogU3VwcG9ydHMgdHdvIGZpbGUgdHlwZXM6IHRob3NlIHdpdGggYSBnZXRNZXRhZGF0YVZhbHVlIG1ldGhvZFxyXG4gICAgICogYW5kIHRob3NlIHdpdGggYSBkaXJlY3QgbWV0YWRhdGEgb2JqZWN0LlxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gZmlsZSAtIE9ic2lkaWFuIGZpbGUgZnJvbSB3aGljaCB0byByZWFkIHRoZSBwcm9wZXJ0eVxyXG4gICAgICogQHJldHVybnMgVGhlIHByb3BlcnR5IHZhbHVlIG9yIHVuZGVmaW5lZCBpZiBpdCBkb2Vzbid0IGV4aXN0XHJcbiAgICAgKi9cclxuICAgIGFzeW5jIHJlYWQoZmlsZTogRmlsZSk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgaWYgKGZpbGUgJiYgdHlwZW9mIGZpbGUgPT09ICdvYmplY3QnICYmICdyZWFkUHJvcGVydHknIGluIGZpbGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZpbGUuZ2V0TWV0YWRhdGFWYWx1ZSh0aGlzLm5hbWUpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBhd2FpdCBmaWxlLmdldE1ldGFkYXRhVmFsdWUodGhpcy5uYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFZhbGlkYXRlcyBhbmQgbm9ybWFsaXplcyBhbiBpbnB1dCB2YWx1ZSBmb3IgdGhpcyBwcm9wZXJ0eS5cclxuICAgICAqIFRoZSBiYXNlIG1ldGhvZCByZXR1cm5zIHRoZSB2YWx1ZSB1bmNoYW5nZWQsIGJ1dCBjYW4gYmUgXHJcbiAgICAgKiBvdmVycmlkZGVuIGJ5IGRlcml2ZWQgY2xhc3NlcyB0byBwZXJmb3JtIHRyYW5zZm9ybWF0aW9ucy5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHZhbHVlIC0gVmFsdWUgdG8gdmFsaWRhdGUgYW5kIG5vcm1hbGl6ZVxyXG4gICAgICogQHJldHVybnMgVGhlIHZhbGlkYXRlZCBhbmQgbm9ybWFsaXplZCB2YWx1ZVxyXG4gICAgICovXHJcbiAgICB2YWxpZGF0ZSh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2VuZXJhdGVzIGEgbGluayBmb3IgdGhlIHByb3BlcnR5IHZhbHVlLlxyXG4gICAgICogVXNlZCB0byBjcmVhdGUgY2xpY2thYmxlIGxpbmtzIGluIHRoZSB1c2VyIGludGVyZmFjZS5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHZhbHVlIC0gVmFsdWUgZm9yIHdoaWNoIHRvIGdlbmVyYXRlIGEgbGlua1xyXG4gICAgICogQHJldHVybnMgVGhlIGxpbmsgcmVwcmVzZW50YXRpb24gb2YgdGhlIHZhbHVlXHJcbiAgICAgKi9cclxuICAgIGdldExpbmsodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEZvcm1hdHMgYSB2YWx1ZSBmb3IgXCJwcmV0dHlcIiBkaXNwbGF5IGluIHRoZSBpbnRlcmZhY2UuXHJcbiAgICAgKiBDYW4gYmUgb3ZlcnJpZGRlbiBmb3IgcHJvcGVydHkgdHlwZS1zcGVjaWZpYyBmb3JtYXR0aW5nLlxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgLSBWYWx1ZSB0byBmb3JtYXQgZm9yIGRpc3BsYXlcclxuICAgICAqIEByZXR1cm5zIFRoZSBmb3JtYXR0ZWQgdmFsdWUgZm9yIGRpc3BsYXlcclxuICAgICAqL1xyXG4gICAgZ2V0UHJldHR5KHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7ICBcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdlbmVyYXRlcyB0aGUgY29tcGxldGUgZGlzcGxheSBvZiB0aGUgcHJvcGVydHkgZm9yIGEgZ2l2ZW4gZmlsZS5cclxuICAgICAqIENvbmZpZ3VyZXMgdGhlIGRpc3BsYXkgbW9kZSAoc3RhdGljIG9yIGVkaXRhYmxlKSBhbmQgdGl0bGUsXHJcbiAgICAgKiB0aGVuIGRlbGVnYXRlcyBET00gY3JlYXRpb24gdG8gZmlsbERpc3BsYXkuXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBmaWxlIC0gRmlsZSBmb3Igd2hpY2ggdG8gZ2VuZXJhdGUgdGhlIGRpc3BsYXlcclxuICAgICAqIEBwYXJhbSBhcmdzIC0gRGlzcGxheSBvcHRpb25zXHJcbiAgICAgKiBAcGFyYW0gYXJncy5zdGF0aWNNb2RlIC0gSWYgdHJ1ZSwgZGlzcGxheXMgdGhlIHByb3BlcnR5IGluIHJlYWQtb25seSBtb2RlXHJcbiAgICAgKiBAcGFyYW0gYXJncy50aXRsZSAtIEN1c3RvbSB0aXRsZSBmb3IgdGhlIHByb3BlcnR5XHJcbiAgICAgKiBAcmV0dXJucyBUaGUgRE9NIGVsZW1lbnQgcmVwcmVzZW50aW5nIHRoZSBwcm9wZXJ0eVxyXG4gICAgICovXHJcbiAgICBnZXREaXNwbGF5KGZpbGU6IGFueSwgYXJncyA6IHtzdGF0aWNNb2RlPyA6IGJvb2xlYW4sIHRpdGxlPzogc3RyaW5nfSA9IHtzdGF0aWNNb2RlIDogZmFsc2UsIHRpdGxlOlwiXCJ9KSB7XHJcbiAgICAgICAgdGhpcy5zdGF0aWMgPSBhcmdzLnN0YXRpY01vZGUgPyB0cnVlIDogdGhpcy5zdGF0aWM7XHJcbiAgICAgICAgdGhpcy50aXRsZSA9IGFyZ3MudGl0bGUgPyBhcmdzLnRpdGxlIDogXCJcIjtcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnJlYWQoZmlsZSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsbERpc3BsYXkodmFsdWUsIGFzeW5jICh2YWx1ZTogYW55KSA9PiBhd2FpdCBmaWxlLnVwZGF0ZU1ldGFkYXRhKHRoaXMubmFtZSwgdmFsdWUpLCBhcmdzKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEZpbGxzIGFuZCBidWlsZHMgdGhlIGNvbXBsZXRlIERPTSBkaXNwbGF5IG9mIHRoZSBwcm9wZXJ0eS5cclxuICAgICAqIENyZWF0ZXMgdGhlIEhUTUwgc3RydWN0dXJlIHdpdGggb3B0aW9uYWwgdGl0bGUsIGljb24gYW5kIGVkaXRhYmxlIGNvbnRlbnQuXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSB2YWx1ZSAtIEN1cnJlbnQgcHJvcGVydHkgdmFsdWUgdG8gZGlzcGxheVxyXG4gICAgICogQHBhcmFtIHVwZGF0ZSAtIFVwZGF0ZSBmdW5jdGlvbiBjYWxsZWQgZHVyaW5nIGNoYW5nZXNcclxuICAgICAqIEBwYXJhbSBhcmdzIC0gQWRkaXRpb25hbCBhcmd1bWVudHMgZm9yIGNvbmZpZ3VyYXRpb25cclxuICAgICAqIEByZXR1cm5zIFRoZSBjb21wbGV0ZSBET00gZWxlbWVudCBvZiB0aGUgcHJvcGVydHlcclxuICAgICAqL1xyXG4gICAgZmlsbERpc3BsYXkodmFsdWU6IGFueSwgdXBkYXRlOiAodmFsdWU6IGFueSkgPT4gUHJvbWlzZTx2b2lkPiwgYXJncz8gOiB7fSkge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkID0gdGhpcy5jcmVhdGVGaWVsZENvbnRhaW5lcigpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy50aXRsZSkge1xyXG4gICAgICAgICAgICBjb25zdCB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0gdGhpcy50aXRsZTtcclxuICAgICAgICAgICAgdGl0bGUuY2xhc3NMaXN0LmFkZChcIm1ldGFkYXRhLXRpdGxlXCIpO1xyXG4gICAgICAgICAgICBmaWVsZC5hcHBlbmRDaGlsZCh0aXRsZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpY29uQ29udGFpbmVyID0gdGhpcy5jcmVhdGVJY29uQ29udGFpbmVyKHVwZGF0ZSk7XHJcbiAgICAgICAgY29uc3QgZmllbGRDb250YWluZXIgPSB0aGlzLmNyZWF0ZUZpZWxkQ29udGFpbmVyQ29udGVudCh1cGRhdGUsIHZhbHVlKTtcclxuXHJcbiAgICAgICAgZmllbGQuYXBwZW5kQ2hpbGQoaWNvbkNvbnRhaW5lcik7XHJcbiAgICAgICAgZmllbGQuYXBwZW5kQ2hpbGQoZmllbGRDb250YWluZXIpO1xyXG5cclxuICAgICAgICByZXR1cm4gZmllbGQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDcmVhdGVzIHRoZSBtYWluIGNvbnRhaW5lciBmb3IgdGhlIHByb3BlcnR5IGRpc3BsYXkuXHJcbiAgICAgKiBEZWZpbmVzIHRoZSBiYXNpYyBIVE1MIHN0cnVjdHVyZSB3aXRoIGFwcHJvcHJpYXRlIENTUyBjbGFzc2VzLlxyXG4gICAgICogXHJcbiAgICAgKiBAcmV0dXJucyBUaGUgbWFpbiBjb250YWluZXIgZGl2IGVsZW1lbnQgb2YgdGhlIHByb3BlcnR5XHJcbiAgICAgKi9cclxuICAgIGNyZWF0ZUZpZWxkQ29udGFpbmVyKCkge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBmaWVsZC5jbGFzc0xpc3QuYWRkKFwibWV0YWRhdGEtZmllbGRcIik7XHJcbiAgICAgICAgcmV0dXJuIGZpZWxkO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ3JlYXRlcyB0aGUgaWNvbiBjb250YWluZXIgZm9yIHRoZSBwcm9wZXJ0eS5cclxuICAgICAqIEFkZHMgYSBjbGljayBoYW5kbGVyIHRvIHRvZ2dsZSB0byBlZGl0IG1vZGUgaWYgdGhlIHByb3BlcnR5IGlzIG5vdCBzdGF0aWMuXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSB1cGRhdGUgLSBVcGRhdGUgZnVuY3Rpb24gdG8gcGVyc2lzdCBjaGFuZ2VzXHJcbiAgICAgKiBAcmV0dXJucyBUaGUgaWNvbiBjb250YWluZXIgZWxlbWVudCB3aXRoIGl0cyBldmVudHNcclxuICAgICAqL1xyXG4gICAgY3JlYXRlSWNvbkNvbnRhaW5lcih1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+KSB7XHJcbiAgICAgICAgY29uc3QgaWNvbkNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgaWNvbkNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwiaWNvbi1jb250YWluZXJcIik7XHJcbiAgICAgICAgaWYgKHRoaXMuaWNvbikge1xyXG4gICAgICAgICAgICBjb25zdCBpY29uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICAgICAgdGhpcy52YXVsdC5hcHAuc2V0SWNvbihpY29uLCB0aGlzLmljb24pO1xyXG4gICAgICAgICAgICBpY29uQ29udGFpbmVyLmFwcGVuZENoaWxkKGljb24pO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuc3RhdGljKSB7XHJcbiAgICAgICAgICAgICAgICBpY29uQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoZXZlbnQpID0+IHRoaXMubW9kaWZ5RmllbGQoZXZlbnQpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaWNvbkNvbnRhaW5lcjtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEhhbmRsZXMgc3dpdGNoaW5nIHRvIGVkaXQgbW9kZSB3aGVuIHRoZSB1c2VyIGNsaWNrcyBvbiB0aGUgaWNvbi5cclxuICAgICAqIEhpZGVzIHRoZSByZWFkLW9ubHkgZGlzcGxheSBhbmQgc2hvd3MgdGhlIGlucHV0IGZpZWxkIHdpdGggZm9jdXMuXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBldmVudCAtIENsaWNrIGV2ZW50IG9uIHRoZSBpY29uXHJcbiAgICAgKi9cclxuICAgIG1vZGlmeUZpZWxkKGV2ZW50OiBFdmVudCkge1xyXG4gICAgICAgIGNvbnN0IGxpbmsgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5jbG9zZXN0KCcubWV0YWRhdGEtZmllbGQnKT8ucXVlcnlTZWxlY3RvcignLmZpZWxkLWxpbmsnKSBhcyBIVE1MRWxlbWVudDtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmNsb3Nlc3QoJy5tZXRhZGF0YS1maWVsZCcpPy5xdWVyeVNlbGVjdG9yKCcuZmllbGQtaW5wdXQnKSBhcyBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgICAgIGlmIChsaW5rICYmIGlucHV0KSB7XHJcbiAgICAgICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICBpbnB1dC5mb2N1cygpOyBcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDcmVhdGVzIHRoZSBmaWVsZCBjb250YWluZXIgY29udGVudCB3aXRoIGlucHV0IGFuZCBsaW5rIGVsZW1lbnRzLlxyXG4gICAgICogTWFuYWdlcyB0aGUgdmlzaWJpbGl0eSBvZiBlZGl0IGFuZCBkaXNwbGF5IG1vZGVzIGJhc2VkIG9uIHByb3BlcnR5IHN0YXRlLlxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gdXBkYXRlIC0gVXBkYXRlIGZ1bmN0aW9uIHRvIHBlcnNpc3QgY2hhbmdlc1xyXG4gICAgICogQHBhcmFtIHZhbHVlIC0gQ3VycmVudCB2YWx1ZSB0byBkaXNwbGF5XHJcbiAgICAgKiBAcmV0dXJucyBUaGUgZmllbGQgY29udGFpbmVyIGRpdiB3aXRoIGlucHV0IGFuZCBsaW5rIGVsZW1lbnRzXHJcbiAgICAgKi9cclxuICAgIGNyZWF0ZUZpZWxkQ29udGFpbmVyQ29udGVudCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCB2YWx1ZTogc3RyaW5nKTogSFRNTERpdkVsZW1lbnQge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBmaWVsZENvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwiZmllbGQtY29udGFpbmVyXCIpO1xyXG5cclxuICAgICAgICBjb25zdCBjdXJyZW50RmllbGQgPSB2YWx1ZTtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHRoaXMuY3JlYXRlRmllbGRJbnB1dChjdXJyZW50RmllbGQpO1xyXG4gICAgICAgIGNvbnN0IGxpbmsgPSB0aGlzLmNyZWF0ZUZpZWxkTGluayhjdXJyZW50RmllbGQpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5zdGF0aWMpIHtcclxuICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnRGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuICAgICAgICAgICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmaWVsZENvbnRhaW5lci5hcHBlbmRDaGlsZChsaW5rKTtcclxuICAgICAgICBmaWVsZENvbnRhaW5lci5hcHBlbmRDaGlsZChpbnB1dCk7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5zdGF0aWMpIHtcclxuICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWVsZElucHV0KHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZpZWxkQ29udGFpbmVyO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ3JlYXRlcyBhIGNsaWNrYWJsZSBsaW5rIGVsZW1lbnQgZm9yIGRpc3BsYXlpbmcgdGhlIHByb3BlcnR5IHZhbHVlLlxyXG4gICAgICogQ29uZmlndXJlcyBjdXJzb3Igc3R5bGUgYW5kIGNsaWNrIGJlaGF2aW9yIGJhc2VkIG9uIHN0YXRpYyBwcm9wZXJ0eS5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHZhbHVlIC0gVmFsdWUgdG8gZGlzcGxheSBpbiB0aGUgbGlua1xyXG4gICAgICogQHJldHVybnMgVGhlIGNvbmZpZ3VyZWQgbGluayBkaXYgZWxlbWVudFxyXG4gICAgICovXHJcbiAgICBjcmVhdGVGaWVsZExpbmsodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSB0aGlzLmdldFByZXR0eSh2YWx1ZSkgfHwgXCJcIjtcclxuICAgICAgICBsaW5rLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1saW5rXCIpO1xyXG4gICAgICAgIGxpbmsuc3R5bGUuY3Vyc29yID0gdGhpcy5zdGF0aWMgPyBcImRlZmF1bHRcIiA6IFwidGV4dFwiO1xyXG4gICAgICAgIGlmICghdGhpcy5zdGF0aWMpIHtcclxuICAgICAgICAgICAgbGluay5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKGV2ZW50KSA9PiB0aGlzLm1vZGlmeUZpZWxkKGV2ZW50KSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBsaW5rO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyBpbnB1dCBmaWVsZCBldmVudHMgZm9yIGVkaXRpbmcgZnVuY3Rpb25hbGl0eS5cclxuICAgICAqIFNldHMgdXAgYmx1ciBhbmQga2V5Ym9hcmQgZXZlbnQgbGlzdGVuZXJzIHRvIHNhdmUgY2hhbmdlcy5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHVwZGF0ZSAtIFVwZGF0ZSBmdW5jdGlvbiB0byBwZXJzaXN0IGNoYW5nZXNcclxuICAgICAqIEBwYXJhbSBpbnB1dCAtIElucHV0IGVsZW1lbnQgdG8gaGFuZGxlXHJcbiAgICAgKiBAcGFyYW0gbGluayAtIExpbmsgZWxlbWVudCB0byBzaG93IGFmdGVyIGVkaXRpbmdcclxuICAgICAqL1xyXG4gICAgaGFuZGxlRmllbGRJbnB1dCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCBpbnB1dDogSFRNTElucHV0RWxlbWVudCB8IEhUTUxUZXh0QXJlYUVsZW1lbnQsIGxpbms6IEhUTUxFbGVtZW50KSB7XHJcbiAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcihcImJsdXJcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpZWxkKHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBhc3luYyAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgaWYgKChldmVudCBhcyBLZXlib2FyZEV2ZW50KS5rZXkgPT09IFwiRW50ZXJcIiB8fCAoZXZlbnQgYXMgS2V5Ym9hcmRFdmVudCkua2V5ID09PSBcIkVzY2FwZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpZWxkKHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDcmVhdGVzIGFuIGlucHV0IGZpZWxkIGZvciBlZGl0aW5nIHRoZSBwcm9wZXJ0eSB2YWx1ZS5cclxuICAgICAqIEJhc2UgaW1wbGVtZW50YXRpb24gY3JlYXRlcyBhIHRleHQgaW5wdXQsIGNhbiBiZSBvdmVycmlkZGVuIGZvciBzcGVjaWZpYyBpbnB1dCB0eXBlcy5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHZhbHVlIC0gSW5pdGlhbCB2YWx1ZSBmb3IgdGhlIGlucHV0IGZpZWxkXHJcbiAgICAgKiBAcmV0dXJucyBUaGUgY29uZmlndXJlZCBpbnB1dCBlbGVtZW50IChpbnB1dCBvciB0ZXh0YXJlYSlcclxuICAgICAqL1xyXG4gICAgY3JlYXRlRmllbGRJbnB1dCh2YWx1ZTogc3RyaW5nKSA6IEhUTUxJbnB1dEVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50IHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpbnB1dFwiKTtcclxuICAgICAgICBpbnB1dC50eXBlID0gXCJ0ZXh0XCI7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZSB8fCBcIlwiO1xyXG4gICAgICAgIGlucHV0LmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1pbnB1dFwiKTtcclxuICAgICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVcGRhdGVzIHRoZSBmaWVsZCB2YWx1ZSBhbmQgc3dpdGNoZXMgYmFjayB0byBkaXNwbGF5IG1vZGUuXHJcbiAgICAgKiBWYWxpZGF0ZXMgdGhlIGlucHV0LCB1cGRhdGVzIHRoZSBiYWNrZW5kLCBhbmQgcmVmcmVzaGVzIHRoZSBVSS5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHVwZGF0ZSAtIFVwZGF0ZSBmdW5jdGlvbiB0byBwZXJzaXN0IHRoZSBjaGFuZ2VzXHJcbiAgICAgKiBAcGFyYW0gaW5wdXQgLSBJbnB1dCBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5ldyB2YWx1ZVxyXG4gICAgICogQHBhcmFtIGxpbmsgLSBMaW5rIGVsZW1lbnQgdG8gdXBkYXRlIGFuZCBzaG93XHJcbiAgICAgKi9cclxuICAgIGFzeW5jIHVwZGF0ZUZpZWxkKHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIGlucHV0OiBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTFRleHRBcmVhRWxlbWVudCwgbGluazogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnZhbGlkYXRlKGlucHV0LnZhbHVlKTtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgYXdhaXQgdXBkYXRlKHZhbHVlKTtcclxuICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gdmFsdWU7XHJcbiAgICAgICAgICAgIGlmICgobGluayBhcyBIVE1MQW5jaG9yRWxlbWVudCkuaHJlZil7XHJcbiAgICAgICAgICAgICAgICAobGluayBhcyBIVE1MQW5jaG9yRWxlbWVudCkuaHJlZiA9IHRoaXMuZ2V0TGluayh2YWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHVwZGF0ZShpbnB1dC52YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVsb2FkcyB0aGUgZHluYW1pYyBjb250ZW50IG9mIHRoZSBwcm9wZXJ0eSBmaWVsZCBmcm9tIHRoZSBmaWxlLlxyXG4gICAgICogVXBkYXRlcyBib3RoIHRoZSBkaXNwbGF5IGxpbmsgYW5kIGlucHV0IGZpZWxkIHdpdGggdGhlIGN1cnJlbnQgZmlsZSB2YWx1ZS5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIGZpbGUgLSBGaWxlIGZyb20gd2hpY2ggdG8gcmVsb2FkIHRoZSBwcm9wZXJ0eSB2YWx1ZVxyXG4gICAgICovXHJcbiAgICBhc3luYyByZWxvYWREeW5hbWljQ29udGVudChmaWxlOiBGaWxlKSB7XHJcbiAgICAgICAgY29uc3QgZmllbGQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubWV0YWRhdGEtZmllbGQnKTtcclxuICAgICAgICBpZiAoZmllbGQpIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBhd2FpdCB0aGlzLnJlYWQoZmlsZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpbmsgPSBmaWVsZC5xdWVyeVNlbGVjdG9yKCcuZmllbGQtbGluaycpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IGZpZWxkLnF1ZXJ5U2VsZWN0b3IoJy5maWVsZC1pbnB1dCcpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmIChsaW5rICYmIGlucHV0KSB7XHJcbiAgICAgICAgICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gbmV3VmFsdWU7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4iXSwidmVyc2lvbiI6M30=