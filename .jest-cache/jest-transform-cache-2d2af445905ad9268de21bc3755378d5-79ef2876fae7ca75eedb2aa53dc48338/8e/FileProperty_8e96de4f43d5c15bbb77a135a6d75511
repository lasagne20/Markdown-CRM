c75d89a629822d9fde73f940be7d78a3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileProperty = void 0;
const LinkProperty_1 = require("./LinkProperty");
class FileProperty extends LinkProperty_1.LinkProperty {
    // Used for property with a single file
    constructor(name, vault, classes, args = {}) {
        super(name, vault, args);
        this.type = "file";
        this.classes = classes;
    }
    getClasses() {
        return this.classes;
    }
    getPretty(value) {
        return this.vault.readLinkFile(value);
    }
    getClasse(file) {
        let link = this.read(file);
        if (link) {
            let classe = this.vault.getFromLink(link);
            if (classe) {
                return classe;
            }
        }
        return undefined;
    }
    validate(value) {
        // Expression régulière pour détecter les liens Obsidian au format [[...]]
        const regex = /\[\[([^\]]+)\]\]/;
        const match = value.match(regex);
        if (match && match[1]) {
            return `[[${match[1]}]]`;
        }
        return "";
    }
    getLink(value, vault) {
        if (vault) {
            this.vault = vault;
        }
        const vaultName = this.vault.app.vault.getName();
        const filePath = this.vault.readLinkFile(value, true);
        // If readLinkFile returned a path and the file exists in the vault, use it.
        if (filePath && this.vault.app.vault.getAbstractFileByPath(filePath)) {
            return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(filePath)}`;
        }
        // Fallback: extract the name only from the link
        const nameOnly = this.vault.readLinkFile(value);
        return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(nameOnly)}`;
    }
    createIconContainer(update) {
        const iconContainer = document.createElement("div");
        iconContainer.classList.add("icon-container");
        const icon = document.createElement("div");
        this.vault.app.setIcon(icon, this.icon);
        iconContainer.appendChild(icon);
        if (!this.static) {
            icon.style.cursor = "pointer";
            iconContainer.addEventListener("click", async (event) => await this.handleIconClick(update, event));
        }
        return iconContainer;
    }
    // Fonction pour gérer le clic sur l'icône
    async handleIconClick(update, event) {
        let selectedFileObj = await this.vault.app.selectFile(this.vault, this.classes, { hint: "Choisissez un fichier " + this.getClasses().join(" ou ") });
        if (selectedFileObj) {
            const selectedFile = selectedFileObj.getLink();
            await update(selectedFile);
            const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
            if (link) {
                link.textContent = selectedFile.slice(2, -2);
            }
        }
    }
    // Fonction pour gérer le clic sur l'icône
    async modifyField(event) {
        const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
        let currentField = link.textContent;
        if (!currentField) {
            return;
        }
        event.preventDefault();
        const classe = this.vault.getFromLink(currentField);
        if (classe) {
            await this.vault.app.open(classe.getPath());
        }
        else {
            console.error(`Le fichier ${currentField}.md n'existe pas`); // TODO: Use Notice when available
        }
    }
    // Fonction pour créer le conteneur principal pour l'field
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        const currentField = this.getPretty(value);
        const link = document.createElement("a");
        link.href = this.getLink(value);
        link.textContent = currentField || "";
        link.classList.add("field-link");
        link.style.display = "block";
        fieldContainer.appendChild(link);
        return fieldContainer;
    }
}
exports.FileProperty = FileProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXEZpbGVQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQSxpREFBOEM7QUFLOUMsTUFBYSxZQUFhLFNBQVEsMkJBQVk7SUFJMUMsdUNBQXVDO0lBQ3ZDLFlBQVksSUFBYSxFQUFFLEtBQVksRUFBRSxPQUFpQixFQUFFLElBQUksR0FBRSxFQUFFO1FBQ2xFLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSFgsU0FBSSxHQUFZLE1BQU0sQ0FBQztRQUlyQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUN6QixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQTtJQUNyQixDQUFDO0lBRVEsU0FBUyxDQUFDLEtBQWE7UUFDOUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0lBRUQsU0FBUyxDQUFDLElBQVc7UUFDbkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQixJQUFJLElBQUksRUFBRSxDQUFDO1lBQ1QsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDWCxPQUFPLE1BQU0sQ0FBQztZQUNoQixDQUFDO1FBQ0gsQ0FBQztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFUSxRQUFRLENBQUMsS0FBYTtRQUM3QiwwRUFBMEU7UUFDMUUsTUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUM7UUFDakMsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFD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QUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsV0FBVyxHQUFHLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBQzVCLGNBQWMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakMsT0FBTyxjQUFjLENBQUM7SUFDMUIsQ0FBQztDQUVKO0FBbEhELG9DQWtIQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGxlb2R1XFxEb2N1bWVudHNcXDEgLSBQcm9cXFRlc3QgcGx1Z2luIG9ic2lkaWFuXFwub2JzaWRpYW5cXHBsdWdpbnNcXG9ic2lkaWFuLUNSTVxcZHluYW1pYy1maWVsZHNcXHNyY1xccHJvcGVydGllc1xcRmlsZVByb3BlcnR5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZpbGUgfSBmcm9tIFwiLi4vdmF1bHQvRmlsZVwiO1xyXG5pbXBvcnQgeyBQcm9wZXJ0eSB9IGZyb20gXCIuL1Byb3BlcnR5XCI7XHJcbmltcG9ydCB7IENsYXNzZSB9IGZyb20gXCIuLi92YXVsdC9DbGFzc2VcIjtcclxuaW1wb3J0IHsgTGlua1Byb3BlcnR5IH0gZnJvbSBcIi4vTGlua1Byb3BlcnR5XCI7XHJcbmltcG9ydCB7IHZhbCB9IGZyb20gXCJjaGVlcmlvL2Rpc3QvY29tbW9uanMvYXBpL2F0dHJpYnV0ZXNcIjtcclxuaW1wb3J0IHsgVmF1bHQgfSBmcm9tIFwiLi4vdmF1bHQvVmF1bHRcIjtcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgRmlsZVByb3BlcnR5IGV4dGVuZHMgTGlua1Byb3BlcnR5e1xyXG5cclxuICAgIHB1YmxpYyBjbGFzc2VzIDogc3RyaW5nW107XHJcbiAgICBwdWJsaWMgb3ZlcnJpZGUgdHlwZSA6IHN0cmluZyA9IFwiZmlsZVwiO1xyXG4gICAgLy8gVXNlZCBmb3IgcHJvcGVydHkgd2l0aCBhIHNpbmdsZSBmaWxlXHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lIDogc3RyaW5nLCB2YXVsdDogVmF1bHQsIGNsYXNzZXM6IHN0cmluZ1tdLCBhcmdzPSB7fSl7XHJcbiAgICAgIHN1cGVyKG5hbWUsIHZhdWx0LCBhcmdzKTtcclxuICAgICAgdGhpcy5jbGFzc2VzID0gY2xhc3NlcztcclxuICAgIH1cclxuXHJcbiAgICBnZXRDbGFzc2VzKCkgOiBzdHJpbmdbXSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNsYXNzZXNcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSBnZXRQcmV0dHkodmFsdWU6IHN0cmluZykge1xyXG4gICAgICByZXR1cm4gdGhpcy52YXVsdC5yZWFkTGlua0ZpbGUodmFsdWUpXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q2xhc3NlKGZpbGUgOiBGaWxlKTogQ2xhc3NlIHwgdW5kZWZpbmVke1xyXG4gICAgICBsZXQgbGluayA9IHRoaXMucmVhZChmaWxlKTtcclxuICAgICAgaWYgKGxpbmspIHtcclxuICAgICAgICBsZXQgY2xhc3NlID0gdGhpcy52YXVsdC5nZXRGcm9tTGluayhsaW5rKTtcclxuICAgICAgICBpZiAoY2xhc3NlKSB7XHJcbiAgICAgICAgICByZXR1cm4gY2xhc3NlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIHZhbGlkYXRlKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAvLyBFeHByZXNzaW9uIHLDqWd1bGnDqHJlIHBvdXIgZMOpdGVjdGVyIGxlcyBsaWVucyBPYnNpZGlhbiBhdSBmb3JtYXQgW1suLi5dXVxyXG4gICAgICBjb25zdCByZWdleCA9IC9cXFtcXFsoW15cXF1dKylcXF1cXF0vO1xyXG4gICAgICBjb25zdCBtYXRjaCA9IHZhbHVlLm1hdGNoKHJlZ2V4KTtcclxuICAgICAgaWYgKG1hdGNoICYmIG1hdGNoWzFdKSB7XHJcbiAgICAgICAgICByZXR1cm4gYFtbJHttYXRjaFsxXX1dXWA7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgIH1cclxuXHJcbiAgIG92ZXJyaWRlIGdldExpbmsodmFsdWU6IHN0cmluZywgdmF1bHQ/IDogYW55KTogc3RyaW5nIHtcclxuICAgIGlmICh2YXVsdCkge1xyXG4gICAgICB0aGlzLnZhdWx0ID0gdmF1bHQ7XHJcbiAgICB9XHJcbiAgICBjb25zdCB2YXVsdE5hbWUgPSB0aGlzLnZhdWx0LmFwcC52YXVsdC5nZXROYW1lKCk7IFxyXG4gICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLnZhdWx0LnJlYWRMaW5rRmlsZSh2YWx1ZSwgdHJ1ZSk7XHJcblxyXG4gICAgLy8gSWYgcmVhZExpbmtGaWxlIHJldHVybmVkIGEgcGF0aCBhbmQgdGhlIGZpbGUgZXhpc3RzIGluIHRoZSB2YXVsdCwgdXNlIGl0LlxyXG4gICAgaWYgKGZpbGVQYXRoICYmIHRoaXMudmF1bHQuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCkpIHtcclxuICAgICAgcmV0dXJuIGBvYnNpZGlhbjovL29wZW4/dmF1bHQ9JHtlbmNvZGVVUklDb21wb25lbnQodmF1bHROYW1lKX0mZmlsZT0ke2VuY29kZVVSSUNvbXBvbmVudChmaWxlUGF0aCl9YDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGYWxsYmFjazogZXh0cmFjdCB0aGUgbmFtZSBvbmx5IGZyb20gdGhlIGxpbmtcclxuICAgIGNvbnN0IG5hbWVPbmx5ID0gdGhpcy52YXVsdC5yZWFkTGlua0ZpbGUodmFsdWUpO1xyXG4gICAgcmV0dXJuIGBvYnNpZGlhbjovL29wZW4/dmF1bHQ9JHtlbmNvZGVVUklDb21wb25lbnQodmF1bHROYW1lKX0mZmlsZT0ke2VuY29kZVVSSUNvbXBvbmVudChuYW1lT25seSl9YDtcclxuICAgfVxyXG4gIFxyXG4gICBvdmVycmlkZSBjcmVhdGVJY29uQ29udGFpbmVyKHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4pIHtcclxuICAgIGNvbnN0IGljb25Db250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgaWNvbkNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwiaWNvbi1jb250YWluZXJcIik7XHJcblxyXG4gICAgY29uc3QgaWNvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICB0aGlzLnZhdWx0LmFwcC5zZXRJY29uKGljb24sIHRoaXMuaWNvbik7XHJcbiAgICBpY29uQ29udGFpbmVyLmFwcGVuZENoaWxkKGljb24pO1xyXG5cclxuICAgIGlmICghdGhpcy5zdGF0aWMpIHtcclxuICAgICAgaWNvbi5zdHlsZS5jdXJzb3IgPSBcInBvaW50ZXJcIjtcclxuICAgICAgaWNvbkNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgYXN5bmMgKGV2ZW50KSA9PiBhd2FpdCB0aGlzLmhhbmRsZUljb25DbGljayh1cGRhdGUsIGV2ZW50KSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBpY29uQ29udGFpbmVyO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEZvbmN0aW9uIHBvdXIgZ8OpcmVyIGxlIGNsaWMgc3VyIGwnaWPDtG5lXHJcbiAgICBhc3luYyBoYW5kbGVJY29uQ2xpY2sodXBkYXRlOiAodmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiwgZXZlbnQ6IEV2ZW50KSB7XHJcbiAgICAgICAgbGV0IHNlbGVjdGVkRmlsZU9iaiA9IGF3YWl0IHRoaXMudmF1bHQuYXBwLnNlbGVjdEZpbGUodGhpcy52YXVsdCwgdGhpcy5jbGFzc2VzLCB7aGludDpcIkNob2lzaXNzZXogdW4gZmljaGllciBcIiArIHRoaXMuZ2V0Q2xhc3NlcygpLmpvaW4oXCIgb3UgXCIpfSk7XHJcbiAgICAgICAgaWYgKHNlbGVjdGVkRmlsZU9iail7XHJcbiAgICAgICAgICBjb25zdCBzZWxlY3RlZEZpbGUgPSBzZWxlY3RlZEZpbGVPYmouZ2V0TGluaygpO1xyXG4gICAgICAgICAgYXdhaXQgdXBkYXRlKHNlbGVjdGVkRmlsZSlcclxuICAgICAgICAgIGNvbnN0IGxpbmsgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5jbG9zZXN0KCcubWV0YWRhdGEtZmllbGQnKT8ucXVlcnlTZWxlY3RvcignLmZpZWxkLWxpbmsnKSBhcyBIVE1MRWxlbWVudDtcclxuICAgICAgICAgICAgaWYgKGxpbmspIHtcclxuICAgICAgICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gc2VsZWN0ZWRGaWxlLnNsaWNlKDIsIC0yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBGb25jdGlvbiBwb3VyIGfDqXJlciBsZSBjbGljIHN1ciBsJ2ljw7RuZVxyXG4gICAgb3ZlcnJpZGUgYXN5bmMgbW9kaWZ5RmllbGQoZXZlbnQ6IEV2ZW50KSB7XHJcbiAgICAgIGNvbnN0IGxpbmsgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5jbG9zZXN0KCcubWV0YWRhdGEtZmllbGQnKT8ucXVlcnlTZWxlY3RvcignLmZpZWxkLWxpbmsnKSBhcyBIVE1MRWxlbWVudDtcclxuICAgICAgbGV0IGN1cnJlbnRGaWVsZCA9IGxpbmsudGV4dENvbnRlbnRcclxuICAgICAgaWYgKCFjdXJyZW50RmllbGQpe3JldHVybn1cclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICBcclxuICAgICAgY29uc3QgY2xhc3NlID0gdGhpcy52YXVsdC5nZXRGcm9tTGluayhjdXJyZW50RmllbGQpO1xyXG4gICAgICBpZiAoY2xhc3NlKSB7XHJcbiAgICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC5vcGVuKGNsYXNzZS5nZXRQYXRoKCkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYExlIGZpY2hpZXIgJHtjdXJyZW50RmllbGR9Lm1kIG4nZXhpc3RlIHBhc2ApIC8vIFRPRE86IFVzZSBOb3RpY2Ugd2hlbiBhdmFpbGFibGVcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gRm9uY3Rpb24gcG91ciBjcsOpZXIgbGUgY29udGVuZXVyIHByaW5jaXBhbCBwb3VyIGwnZmllbGRcclxuICAgIG92ZXJyaWRlIGNyZWF0ZUZpZWxkQ29udGFpbmVyQ29udGVudCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCB2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgZmllbGRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1jb250YWluZXJcIik7XHJcbiAgICAgICAgY29uc3QgY3VycmVudEZpZWxkID0gdGhpcy5nZXRQcmV0dHkodmFsdWUpO1xyXG4gICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYVwiKTtcclxuICAgICAgICBsaW5rLmhyZWYgPSB0aGlzLmdldExpbmsodmFsdWUpO1xyXG4gICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSBjdXJyZW50RmllbGQgfHwgXCJcIjtcclxuICAgICAgICBsaW5rLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1saW5rXCIpO1xyXG4gICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIlxyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmFwcGVuZENoaWxkKGxpbmspO1xyXG5cclxuICAgICAgICByZXR1cm4gZmllbGRDb250YWluZXI7XHJcbiAgICB9XHJcblxyXG59Il0sInZlcnNpb24iOjN9