cb8e38b5b150a39d24991e729d251109
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TextProperty = void 0;
const Property_1 = require("./Property");
const Utils_1 = require("../vault/Utils");
class TextProperty extends Property_1.Property {
    constructor(name, args = {}) {
        super(name, args);
        this.type = "text";
    }
    createFieldInput(value) {
        const textarea = document.createElement("textarea");
        textarea.value = value || "";
        textarea.classList.add("field-textarea");
        textarea.rows = 4; // Default number of rows
        textarea.style.resize = "vertical"; // Allow vertical resizing
        // Add autocomplete functionality
        textarea.setAttribute("data-keydown-listener", "false");
        textarea.addEventListener("input", () => this.handleAutocomplete(textarea));
        return textarea;
    }
    createFieldContainer() {
        const field = document.createElement("div");
        field.classList.add("metadata-textfield");
        return field;
    }
    createFieldLink(value) {
        const link = document.createElement("div");
        link.innerHTML = value
            ? value.replace(/\[\[(.*?)(?:\|(.*?))?\]\]/g, (_, path, alias) => {
                const display = alias || path;
                return `<strong><a href="#">${display}</a></strong>`;
            })
            : "";
        link.classList.add("field-textlink");
        link.style.cursor = this.static ? "default" : "text";
        if (!this.static) {
            link.onclick = (event) => this.modifyField(event);
        }
        // Add click event for links
        link.querySelectorAll("a").forEach(anchor => {
            anchor.onclick = async (event) => {
                event.preventDefault();
                const target = event.target.textContent;
                if (target) {
                    const classe = this.vault.getFromLink(target);
                    if (classe) {
                        const leaf = this.vault.app.workspace.getLeaf();
                        await leaf.openFile(classe.file);
                    }
                    else {
                        (0, Utils_1.sendNotice)(`Le fichier ${target}.md n'existe pas`);
                    }
                }
            };
        });
        return link;
    }
    modifyField(event) {
        const link = event.target.closest('.metadata-textfield')?.querySelector('.field-textlink');
        const input = event.target.closest('.metadata-textfield')?.querySelector('.field-textarea');
        if (link && input) {
            link.style.display = "none";
            input.style.display = "block";
            input.focus();
        }
    }
    handleFieldInput(update, input, link) {
        input.onblur = async () => {
            if (!input.parentElement?.querySelector(".autocomplete-dropdown")) {
                await this.updateField(update, input, link);
                return;
            }
        };
        input.onkeydown = async (event) => {
            if (event.key === "Escape") {
                event.preventDefault();
                await this.updateField(update, input, link);
            }
        };
    }
    handleAutocomplete(textarea) {
        let dropdown = textarea.parentElement?.querySelector(".autocomplete-dropdown");
        // Remove existing dropdown if present
        if (dropdown) {
            dropdown.remove();
        }
        dropdown = document.createElement("div");
        dropdown.classList.add("autocomplete-dropdown");
        const cursorPosition = textarea.selectionStart || 0;
        const textBeforeCursor = textarea.value.substring(0, cursorPosition);
        const lastWordMatch = textBeforeCursor.match(/(\S+)$/);
        const query = lastWordMatch ? lastWordMatch[0].toLowerCase() : "";
        if (!query) {
            return; // No query, don't show the dropdown
        }
        const files = this.vault.app.vault.getFiles();
        const suggestions = files.filter((file) => file.getName().toLowerCase().includes(query) && this.vault.app.metadataCache.getFileCache(file)?.frontmatter?.Classe);
        if (suggestions.length === 0) {
            return; // No suggestions, don't show the dropdown
        }
        // Calculate the position of the word being edited
        const textBeforeWord = textBeforeCursor.substring(0, lastWordMatch?.index || 0);
        const tempSpan = document.createElement("span");
        tempSpan.style.visibility = "hidden";
        tempSpan.style.whiteSpace = "pre-wrap";
        tempSpan.style.position = "absolute";
        tempSpan.style.font = window.getComputedStyle(textarea).font;
        tempSpan.textContent = textBeforeWord;
        document.body.appendChild(tempSpan);
        const rect = tempSpan.getBoundingClientRect();
        const textareaRect = textarea.getBoundingClientRect();
        dropdown.style.top = `${textareaRect.top + rect.height + window.scrollY}px`;
        dropdown.style.left = `${textareaRect.left + rect.width + window.scrollX}px`;
        dropdown.style.width = `${textareaRect.width}px`;
        document.body.removeChild(tempSpan);
        suggestions.forEach((file, index) => {
            const item = document.createElement("div");
            item.classList.add("autocomplete-item");
            item.textContent = file.getName(false);
            item.tabIndex = 0; // Make it focusable
            item.dataset.index = index.toString();
            item.addEventListener("click", () => {
                this.insertSuggestion(textarea, `[[${file.getFilePath()}|${file.getName()}]]`, lastWordMatch?.index || 0, query.length);
                dropdown.remove();
            });
            dropdown.appendChild(item);
        });
        textarea.parentElement?.appendChild(dropdown);
        // Adjust the parent's style to position the dropdown correctly
        const parent = textarea.parentElement;
        parent.style.position = "flex";
        parent.style.flexDirection = "column";
        let selectedIndex = -1;
        const updateSelection = (newIndex) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (selectedIndex >= 0) {
                items[selectedIndex].classList.remove("selected");
            }
            selectedIndex = newIndex;
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                items[selectedIndex].classList.add("selected");
                items[selectedIndex].scrollIntoView({ block: "nearest" });
            }
        };
        const handleKeyDown = (event) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (event.key === "ArrowDown") {
                event.preventDefault();
                updateSelection((selectedIndex + 1) % items.length);
            }
            else if (event.key === "ArrowUp") {
                event.preventDefault();
                updateSelection((selectedIndex - 1 + items.length) % items.length);
            }
            else if (event.key === "Escape") {
                dropdown.remove();
                textarea.removeEventListener("keydown", handleKeyDown); // Clean up event listener
                textarea.removeEventListener("keydown", handleEnter);
            }
        };
        let isEnterHandled = false;
        const handleEnter = (event) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (event.key === "Enter") {
                if (isEnterHandled)
                    return; // Empêche l'exécution multiple
                isEnterHandled = true;
                textarea.removeEventListener("keydown", handleKeyDown);
                textarea.removeEventListener("keydown", handleEnter);
                dropdown.remove();
                event.preventDefault();
                const items = dropdown.querySelectorAll(".autocomplete-item");
                if (selectedIndex >= 0 && selectedIndex < items.length) {
                    const selectedItem = items[selectedIndex];
                    const suggestion = selectedItem.textContent || "";
                    this.insertSuggestion(textarea, `[[${suggestion}]]`, lastWordMatch?.index || 0, query.length);
                }
            }
        };
        if (!textarea.hasAttribute("data-keydown-listener")) {
            textarea.addEventListener("keydown", handleKeyDown);
            textarea.addEventListener("keydown", handleEnter);
            textarea.setAttribute("data-keydown-listener", "true");
        }
        const removeDropdown = () => {
            dropdown.remove();
            textarea.removeEventListener("keydown", handleKeyDown);
        };
        document.addEventListener("click", (event) => {
            if (!dropdown.contains(event.target) && event.target !== textarea) {
                removeDropdown();
            }
        }, { once: true });
    }
    insertSuggestion(textarea, suggestion, startIndex, queryLength) {
        console.log(textarea, suggestion, startIndex, queryLength);
        const before = textarea.value.substring(0, startIndex);
        const after = textarea.value.substring(startIndex + queryLength);
        textarea.value = `${before}${suggestion}${after}`;
        textarea.setSelectionRange(before.length + suggestion.length, before.length + suggestion.length);
        textarea.focus();
    }
}
exports.TextProperty = TextProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFRleHRQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSx5Q0FBc0M7QUFJdEMsMENBRXlCO0FBQ3pCLE1BQWEsWUFBYSxTQUFRLG1CQUFRO0lBR3hDLFlBQVksSUFBWSxFQUFFLElBQUksR0FBRyxFQUFFO1FBQ2pDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFIWCxTQUFJLEdBQVcsTUFBTSxDQUFDO0lBSS9CLENBQUM7SUFFUSxnQkFBZ0IsQ0FBQyxLQUFhO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDcEQsUUFBUSxDQUFDLEtBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQzdCLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDekMsUUFBUSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyx5QkFBeUI7UUFDNUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLENBQUMsMEJBQTBCO1FBRTlELGlDQUFpQztRQUNqQyxRQUFRLENBQUMsWUFBWSxDQUFDLHVCQUF1QixFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQ3ZELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFNUUsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVRLG9CQUFvQjtRQUMzQixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVDLEtBQUssQ0FBQyxTQUFTLENB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QUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN6RCxDQUFDLENBQUM7UUFFRixRQUFRLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQWMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzFFLGNBQWMsRUFBRSxDQUFDO1lBQ25CLENBQUM7UUFDSCxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNyQixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsUUFBNkIsRUFBRSxVQUFrQixFQUFFLFVBQWtCLEVBQUUsV0FBbUI7UUFDekcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUMzRCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDdkQsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQyxDQUFDO1FBQ2pFLFFBQVEsQ0FBQyxLQUFLLEdBQUcsR0FBRyxNQUFNLEdBQUcsVUFBVSxHQUFHLEtBQUssRUFBRSxDQUFDO1FBQ2xELFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakcsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQXJPRCxvQ0FxT0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFRleHRQcm9wZXJ0eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMaW5rUHJvcGVydHkgfSBmcm9tIFwiLi9MaW5rUHJvcGVydHlcIjtcclxuaW1wb3J0IHsgUHJvcGVydHkgfSBmcm9tIFwiLi9Qcm9wZXJ0eVwiO1xyXG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xyXG5pbXBvcnQgeyBzZXRJY29uIH0gZnJvbSBcIi4uL3ZhdWx0L1V0aWxzXCI7XHJcbmltcG9ydCB7IEZpbGUgfSBmcm9tIFwiLi4vdmF1bHQvRmlsZVwiO1xyXG5pbXBvcnQgeyBzZW5kTm90aWNlXHJcblxyXG4gfSBmcm9tIFwiLi4vdmF1bHQvVXRpbHNcIjtcclxuZXhwb3J0IGNsYXNzIFRleHRQcm9wZXJ0eSBleHRlbmRzIFByb3BlcnR5IHtcclxuICBvdmVycmlkZSB0eXBlOiBzdHJpbmcgPSBcInRleHRcIjtcclxuXHJcbiAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCBhcmdzID0ge30pIHtcclxuICAgIHN1cGVyKG5hbWUsIGFyZ3MpO1xyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgY3JlYXRlRmllbGRJbnB1dCh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB0ZXh0YXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0ZXh0YXJlYVwiKTtcclxuICAgIHRleHRhcmVhLnZhbHVlID0gdmFsdWUgfHwgXCJcIjtcclxuICAgIHRleHRhcmVhLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC10ZXh0YXJlYVwiKTtcclxuICAgIHRleHRhcmVhLnJvd3MgPSA0OyAvLyBEZWZhdWx0IG51bWJlciBvZiByb3dzXHJcbiAgICB0ZXh0YXJlYS5zdHlsZS5yZXNpemUgPSBcInZlcnRpY2FsXCI7IC8vIEFsbG93IHZlcnRpY2FsIHJlc2l6aW5nXHJcblxyXG4gICAgLy8gQWRkIGF1dG9jb21wbGV0ZSBmdW5jdGlvbmFsaXR5XHJcbiAgICB0ZXh0YXJlYS5zZXRBdHRyaWJ1dGUoXCJkYXRhLWtleWRvd24tbGlzdGVuZXJcIiwgXCJmYWxzZVwiKVxyXG4gICAgdGV4dGFyZWEuYWRkRXZlbnRMaXN0ZW5lcihcImlucHV0XCIsICgpID0+IHRoaXMuaGFuZGxlQXV0b2NvbXBsZXRlKHRleHRhcmVhKSk7XHJcblxyXG4gICAgcmV0dXJuIHRleHRhcmVhO1xyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgY3JlYXRlRmllbGRDb250YWluZXIoKSB7XHJcbiAgICBjb25zdCBmaWVsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBmaWVsZC5jbGFzc0xpc3QuYWRkKFwibWV0YWRhdGEtdGV4dGZpZWxkXCIpO1xyXG4gICAgcmV0dXJuIGZpZWxkO1xyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgY3JlYXRlRmllbGRMaW5rKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgbGluay5pbm5lckhUTUwgPSB2YWx1ZVxyXG4gICAgICA/IHZhbHVlLnJlcGxhY2UoL1xcW1xcWyguKj8pKD86XFx8KC4qPykpP1xcXVxcXS9nLCAoXywgcGF0aCwgYWxpYXMpID0+IHtcclxuICAgICAgICBjb25zdCBkaXNwbGF5ID0gYWxpYXMgfHwgcGF0aDtcclxuICAgICAgICByZXR1cm4gYDxzdHJvbmc+PGEgaHJlZj1cIiNcIj4ke2Rpc3BsYXl9PC9hPjwvc3Ryb25nPmA7XHJcbiAgICAgIH0pXHJcbiAgICAgIDogXCJcIjtcclxuICAgIGxpbmsuY2xhc3NMaXN0LmFkZChcImZpZWxkLXRleHRsaW5rXCIpO1xyXG4gICAgbGluay5zdHlsZS5jdXJzb3IgPSB0aGlzLnN0YXRpYyA/IFwiZGVmYXVsdFwiIDogXCJ0ZXh0XCI7XHJcbiAgICBpZiAoIXRoaXMuc3RhdGljKSB7XHJcbiAgICAgIGxpbmsub25jbGljayA9IChldmVudCkgPT4gdGhpcy5tb2RpZnlGaWVsZChldmVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWRkIGNsaWNrIGV2ZW50IGZvciBsaW5rc1xyXG4gICAgbGluay5xdWVyeVNlbGVjdG9yQWxsKFwiYVwiKS5mb3JFYWNoKGFuY2hvciA9PiB7XHJcbiAgICAgIGFuY2hvci5vbmNsaWNrID0gYXN5bmMgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBjb25zdCB0YXJnZXQgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS50ZXh0Q29udGVudDtcclxuICAgICAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgICAgICBjb25zdCBjbGFzc2UgPSB0aGlzLnZhdWx0LmdldEZyb21MaW5rKHRhcmdldCk7XHJcbiAgICAgICAgICBpZiAoY2xhc3NlKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgbGVhZiA9IHRoaXMudmF1bHQuYXBwLndvcmtzcGFjZS5nZXRMZWFmKCk7XHJcbiAgICAgICAgICAgICAgYXdhaXQgbGVhZi5vcGVuRmlsZShjbGFzc2UuZmlsZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzZW5kTm90aWNlKGBMZSBmaWNoaWVyICR7dGFyZ2V0fS5tZCBuJ2V4aXN0ZSBwYXNgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gbGluaztcclxuICB9XHJcblxyXG4gIG92ZXJyaWRlIG1vZGlmeUZpZWxkKGV2ZW50OiBFdmVudCkge1xyXG4gICAgY29uc3QgbGluayA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmNsb3Nlc3QoJy5tZXRhZGF0YS10ZXh0ZmllbGQnKT8ucXVlcnlTZWxlY3RvcignLmZpZWxkLXRleHRsaW5rJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICBjb25zdCBpbnB1dCA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmNsb3Nlc3QoJy5tZXRhZGF0YS10ZXh0ZmllbGQnKT8ucXVlcnlTZWxlY3RvcignLmZpZWxkLXRleHRhcmVhJykgYXMgSFRNTElucHV0RWxlbWVudDtcclxuICAgIGlmIChsaW5rICYmIGlucHV0KSB7XHJcbiAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICBpbnB1dC5mb2N1cygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgaGFuZGxlRmllbGRJbnB1dCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCBpbnB1dDogSFRNTElucHV0RWxlbWVudCB8IEhUTUxUZXh0QXJlYUVsZW1lbnQsIGxpbms6IEhUTUxFbGVtZW50KSB7XHJcbiAgICBpbnB1dC5vbmJsdXIgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGlmICghaW5wdXQucGFyZW50RWxlbWVudD8ucXVlcnlTZWxlY3RvcihcIi5hdXRvY29tcGxldGUtZHJvcGRvd25cIikpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpZWxkKHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBpbnB1dC5vbmtleWRvd24gPSBhc3luYyAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIkVzY2FwZVwiKSB7XHJcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVGaWVsZCh1cGRhdGUsIGlucHV0LCBsaW5rKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcblxyXG4gIGhhbmRsZUF1dG9jb21wbGV0ZSh0ZXh0YXJlYTogSFRNTFRleHRBcmVhRWxlbWVudCkge1xyXG4gICAgbGV0IGRyb3Bkb3duID0gdGV4dGFyZWEucGFyZW50RWxlbWVudD8ucXVlcnlTZWxlY3RvcihcIi5hdXRvY29tcGxldGUtZHJvcGRvd25cIikgYXMgSFRNTEVsZW1lbnQ7XHJcblxyXG4gICAgLy8gUmVtb3ZlIGV4aXN0aW5nIGRyb3Bkb3duIGlmIHByZXNlbnRcclxuICAgIGlmIChkcm9wZG93bikge1xyXG4gICAgICBkcm9wZG93bi5yZW1vdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBkcm9wZG93biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBkcm9wZG93bi5jbGFzc0xpc3QuYWRkKFwiYXV0b2NvbXBsZXRlLWRyb3Bkb3duXCIpO1xyXG5cclxuICAgIGNvbnN0IGN1cnNvclBvc2l0aW9uID0gdGV4dGFyZWEuc2VsZWN0aW9uU3RhcnQgfHwgMDtcclxuICAgIGNvbnN0IHRleHRCZWZvcmVDdXJzb3IgPSB0ZXh0YXJlYS52YWx1ZS5zdWJzdHJpbmcoMCwgY3Vyc29yUG9zaXRpb24pO1xyXG4gICAgY29uc3QgbGFzdFdvcmRNYXRjaCA9IHRleHRCZWZvcmVDdXJzb3IubWF0Y2goLyhcXFMrKSQvKTtcclxuICAgIGNvbnN0IHF1ZXJ5ID0gbGFzdFdvcmRNYXRjaCA/IGxhc3RXb3JkTWF0Y2hbMF0udG9Mb3dlckNhc2UoKSA6IFwiXCI7XHJcblxyXG4gICAgaWYgKCFxdWVyeSkge1xyXG4gICAgICByZXR1cm47IC8vIE5vIHF1ZXJ5LCBkb24ndCBzaG93IHRoZSBkcm9wZG93blxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZpbGVzID0gdGhpcy52YXVsdC5hcHAudmF1bHQuZ2V0RmlsZXMoKTtcclxuICAgIGNvbnN0IHN1Z2dlc3Rpb25zID0gZmlsZXMuZmlsdGVyKChmaWxlOiBGaWxlKSA9PlxyXG4gICAgICBmaWxlLmdldE5hbWUoKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHF1ZXJ5KSAmJiB0aGlzLnZhdWx0LmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKT8uZnJvbnRtYXR0ZXI/LkNsYXNzZSBcclxuICAgICk7XHJcblxyXG4gICAgaWYgKHN1Z2dlc3Rpb25zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm47IC8vIE5vIHN1Z2dlc3Rpb25zLCBkb24ndCBzaG93IHRoZSBkcm9wZG93blxyXG4gICAgfVxyXG5cclxuICAgIC8vIENhbGN1bGF0ZSB0aGUgcG9zaXRpb24gb2YgdGhlIHdvcmQgYmVpbmcgZWRpdGVkXHJcbiAgICBjb25zdCB0ZXh0QmVmb3JlV29yZCA9IHRleHRCZWZvcmVDdXJzb3Iuc3Vic3RyaW5nKDAsIGxhc3RXb3JkTWF0Y2g/LmluZGV4IHx8IDApO1xyXG4gICAgY29uc3QgdGVtcFNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcclxuICAgIHRlbXBTcGFuLnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xyXG4gICAgdGVtcFNwYW4uc3R5bGUud2hpdGVTcGFjZSA9IFwicHJlLXdyYXBcIjtcclxuICAgIHRlbXBTcGFuLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xyXG4gICAgdGVtcFNwYW4uc3R5bGUuZm9udCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRleHRhcmVhKS5mb250O1xyXG4gICAgdGVtcFNwYW4udGV4dENvbnRlbnQgPSB0ZXh0QmVmb3JlV29yZDtcclxuXHJcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRlbXBTcGFuKTtcclxuICAgIGNvbnN0IHJlY3QgPSB0ZW1wU3Bhbi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgIGNvbnN0IHRleHRhcmVhUmVjdCA9IHRleHRhcmVhLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgZHJvcGRvd24uc3R5bGUudG9wID0gYCR7dGV4dGFyZWFSZWN0LnRvcCArIHJlY3QuaGVpZ2h0ICsgd2luZG93LnNjcm9sbFl9cHhgO1xyXG4gICAgZHJvcGRvd24uc3R5bGUubGVmdCA9IGAke3RleHRhcmVhUmVjdC5sZWZ0ICsgcmVjdC53aWR0aCArIHdpbmRvdy5zY3JvbGxYfXB4YDtcclxuICAgIGRyb3Bkb3duLnN0eWxlLndpZHRoID0gYCR7dGV4dGFyZWFSZWN0LndpZHRofXB4YDtcclxuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGVtcFNwYW4pO1xyXG5cclxuICAgIHN1Z2dlc3Rpb25zLmZvckVhY2goKGZpbGU6IEZpbGUsIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgY29uc3QgaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZChcImF1dG9jb21wbGV0ZS1pdGVtXCIpO1xyXG4gICAgICBpdGVtLnRleHRDb250ZW50ID0gZmlsZS5nZXROYW1lKGZhbHNlKTtcclxuICAgICAgaXRlbS50YWJJbmRleCA9IDA7IC8vIE1ha2UgaXQgZm9jdXNhYmxlXHJcbiAgICAgIGl0ZW0uZGF0YXNldC5pbmRleCA9IGluZGV4LnRvU3RyaW5nKCk7XHJcblxyXG4gICAgICBpdGVtLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pbnNlcnRTdWdnZXN0aW9uKHRleHRhcmVhLCBgW1ske2ZpbGUuZ2V0RmlsZVBhdGgoKX18JHtmaWxlLmdldE5hbWUoKX1dXWAsIGxhc3RXb3JkTWF0Y2g/LmluZGV4IHx8IDAsIHF1ZXJ5Lmxlbmd0aCk7XHJcbiAgICAgICAgZHJvcGRvd24ucmVtb3ZlKCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZHJvcGRvd24uYXBwZW5kQ2hpbGQoaXRlbSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0ZXh0YXJlYS5wYXJlbnRFbGVtZW50Py5hcHBlbmRDaGlsZChkcm9wZG93bik7XHJcbiAgICAvLyBBZGp1c3QgdGhlIHBhcmVudCdzIHN0eWxlIHRvIHBvc2l0aW9uIHRoZSBkcm9wZG93biBjb3JyZWN0bHlcclxuICAgIGNvbnN0IHBhcmVudCA9IHRleHRhcmVhLnBhcmVudEVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICBwYXJlbnQuc3R5bGUucG9zaXRpb24gPSBcImZsZXhcIjtcclxuICAgIHBhcmVudC5zdHlsZS5mbGV4RGlyZWN0aW9uID0gXCJjb2x1bW5cIjtcclxuXHJcbiAgICBsZXQgc2VsZWN0ZWRJbmRleCA9IC0xO1xyXG5cclxuICAgIGNvbnN0IHVwZGF0ZVNlbGVjdGlvbiA9IChuZXdJbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW1zID0gZHJvcGRvd24ucXVlcnlTZWxlY3RvckFsbChcIi5hdXRvY29tcGxldGUtaXRlbVwiKTtcclxuICAgICAgaWYgKHNlbGVjdGVkSW5kZXggPj0gMCkge1xyXG4gICAgICAgIGl0ZW1zW3NlbGVjdGVkSW5kZXhdLmNsYXNzTGlzdC5yZW1vdmUoXCJzZWxlY3RlZFwiKTtcclxuICAgICAgfVxyXG4gICAgICBzZWxlY3RlZEluZGV4ID0gbmV3SW5kZXg7XHJcbiAgICAgIGlmIChzZWxlY3RlZEluZGV4ID49IDAgJiYgc2VsZWN0ZWRJbmRleCA8IGl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgIGl0ZW1zW3NlbGVjdGVkSW5kZXhdLmNsYXNzTGlzdC5hZGQoXCJzZWxlY3RlZFwiKTtcclxuICAgICAgICBpdGVtc1tzZWxlY3RlZEluZGV4XS5zY3JvbGxJbnRvVmlldyh7IGJsb2NrOiBcIm5lYXJlc3RcIiB9KTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBoYW5kbGVLZXlEb3duID0gKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW1zID0gZHJvcGRvd24ucXVlcnlTZWxlY3RvckFsbChcIi5hdXRvY29tcGxldGUtaXRlbVwiKTtcclxuICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCJBcnJvd0Rvd25cIikge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgdXBkYXRlU2VsZWN0aW9uKChzZWxlY3RlZEluZGV4ICsgMSkgJSBpdGVtcy5sZW5ndGgpO1xyXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LmtleSA9PT0gXCJBcnJvd1VwXCIpIHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIHVwZGF0ZVNlbGVjdGlvbigoc2VsZWN0ZWRJbmRleCAtIDEgKyBpdGVtcy5sZW5ndGgpICUgaXRlbXMubGVuZ3RoKTtcclxuICAgICAgfSBlbHNlIGlmIChldmVudC5rZXkgPT09IFwiRXNjYXBlXCIpIHtcclxuICAgICAgICBkcm9wZG93bi5yZW1vdmUoKTtcclxuICAgICAgICB0ZXh0YXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBoYW5kbGVLZXlEb3duKTsgLy8gQ2xlYW4gdXAgZXZlbnQgbGlzdGVuZXJcclxuICAgICAgICB0ZXh0YXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBoYW5kbGVFbnRlcilcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIGxldCBpc0VudGVySGFuZGxlZCA9IGZhbHNlO1xyXG4gICAgY29uc3QgaGFuZGxlRW50ZXIgPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgY29uc3QgaXRlbXMgPSBkcm9wZG93bi5xdWVyeVNlbGVjdG9yQWxsKFwiLmF1dG9jb21wbGV0ZS1pdGVtXCIpO1xyXG4gICAgICBpZiAoZXZlbnQua2V5ID09PSBcIkVudGVyXCIpIHtcclxuICAgICAgICBpZiAoaXNFbnRlckhhbmRsZWQpIHJldHVybjsgLy8gRW1ww6pjaGUgbCdleMOpY3V0aW9uIG11bHRpcGxlXHJcbiAgICAgICAgaXNFbnRlckhhbmRsZWQgPSB0cnVlO1xyXG4gICAgICAgIHRleHRhcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIGhhbmRsZUtleURvd24pXHJcbiAgICAgICAgdGV4dGFyZWEucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgaGFuZGxlRW50ZXIpXHJcbiAgICAgICAgZHJvcGRvd24ucmVtb3ZlKCk7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBjb25zdCBpdGVtcyA9IGRyb3Bkb3duLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYXV0b2NvbXBsZXRlLWl0ZW1cIik7XHJcbiAgICAgICAgaWYgKHNlbGVjdGVkSW5kZXggPj0gMCAmJiBzZWxlY3RlZEluZGV4IDwgaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICBjb25zdCBzZWxlY3RlZEl0ZW0gPSBpdGVtc1tzZWxlY3RlZEluZGV4XTtcclxuICAgICAgICAgIGNvbnN0IHN1Z2dlc3Rpb24gPSBzZWxlY3RlZEl0ZW0udGV4dENvbnRlbnQgfHwgXCJcIjtcclxuICAgICAgICAgIHRoaXMuaW5zZXJ0U3VnZ2VzdGlvbih0ZXh0YXJlYSwgYFtbJHtzdWdnZXN0aW9ufV1dYCwgbGFzdFdvcmRNYXRjaD8uaW5kZXggfHwgMCwgcXVlcnkubGVuZ3RoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgaWYgKCF0ZXh0YXJlYS5oYXNBdHRyaWJ1dGUoXCJkYXRhLWtleWRvd24tbGlzdGVuZXJcIikpIHtcclxuICAgICAgdGV4dGFyZWEuYWRkRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgaGFuZGxlS2V5RG93bik7XHJcbiAgICAgIHRleHRhcmVhLmFkZEV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIGhhbmRsZUVudGVyKTtcclxuICAgICAgdGV4dGFyZWEuc2V0QXR0cmlidXRlKFwiZGF0YS1rZXlkb3duLWxpc3RlbmVyXCIsIFwidHJ1ZVwiKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZW1vdmVEcm9wZG93biA9ICgpID0+IHtcclxuICAgICAgZHJvcGRvd24ucmVtb3ZlKCk7XHJcbiAgICAgIHRleHRhcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIGhhbmRsZUtleURvd24pO1xyXG4gICAgfTtcclxuXHJcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKGV2ZW50KSA9PiB7XHJcbiAgICAgIGlmICghZHJvcGRvd24uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpICYmIGV2ZW50LnRhcmdldCAhPT0gdGV4dGFyZWEpIHtcclxuICAgICAgICByZW1vdmVEcm9wZG93bigpO1xyXG4gICAgICB9XHJcbiAgICB9LCB7IG9uY2U6IHRydWUgfSk7XHJcbiAgfVxyXG5cclxuICBpbnNlcnRTdWdnZXN0aW9uKHRleHRhcmVhOiBIVE1MVGV4dEFyZWFFbGVtZW50LCBzdWdnZXN0aW9uOiBzdHJpbmcsIHN0YXJ0SW5kZXg6IG51bWJlciwgcXVlcnlMZW5ndGg6IG51bWJlcikge1xyXG4gICAgY29uc29sZS5sb2codGV4dGFyZWEsIHN1Z2dlc3Rpb24sIHN0YXJ0SW5kZXgsIHF1ZXJ5TGVuZ3RoKTtcclxuICAgIGNvbnN0IGJlZm9yZSA9IHRleHRhcmVhLnZhbHVlLnN1YnN0cmluZygwLCBzdGFydEluZGV4KTtcclxuICAgIGNvbnN0IGFmdGVyID0gdGV4dGFyZWEudmFsdWUuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBxdWVyeUxlbmd0aCk7XHJcbiAgICB0ZXh0YXJlYS52YWx1ZSA9IGAke2JlZm9yZX0ke3N1Z2dlc3Rpb259JHthZnRlcn1gO1xyXG4gICAgdGV4dGFyZWEuc2V0U2VsZWN0aW9uUmFuZ2UoYmVmb3JlLmxlbmd0aCArIHN1Z2dlc3Rpb24ubGVuZ3RoLCBiZWZvcmUubGVuZ3RoICsgc3VnZ2VzdGlvbi5sZW5ndGgpO1xyXG4gICAgdGV4dGFyZWEuZm9jdXMoKTtcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9