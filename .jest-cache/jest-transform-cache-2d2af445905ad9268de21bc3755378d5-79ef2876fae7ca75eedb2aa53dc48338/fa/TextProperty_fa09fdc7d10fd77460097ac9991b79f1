03a8635f584bf2bb2315db24a744a0e7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TextProperty = void 0;
const Property_1 = require("./Property");
class TextProperty extends Property_1.Property {
    constructor(name, vault, args = {}) {
        super(name, vault, args);
        this.type = "text";
    }
    createFieldInput(value) {
        const textarea = document.createElement("textarea");
        textarea.value = value || "";
        textarea.classList.add("field-textarea");
        textarea.rows = 4; // Default number of rows
        textarea.style.resize = "vertical"; // Allow vertical resizing
        // Add autocomplete functionality
        textarea.setAttribute("data-keydown-listener", "false");
        textarea.oninput = async () => await this.handleAutocomplete(textarea);
        return textarea;
    }
    createFieldContainer() {
        const field = document.createElement("div");
        field.classList.add("metadata-textfield");
        return field;
    }
    createFieldLink(value) {
        const link = document.createElement("div");
        link.innerHTML = value
            ? value.replace(/\[\[(.*?)(?:\|(.*?))?\]\]/g, (_, path, alias) => {
                const display = alias || path;
                return `<strong><a href="#">${display}</a></strong>`;
            })
            : "";
        link.classList.add("field-textlink");
        link.style.cursor = this.static ? "default" : "text";
        if (!this.static) {
            link.onclick = (event) => this.modifyField(event);
        }
        // Add click event for links
        link.querySelectorAll("a").forEach(anchor => {
            anchor.onclick = async (event) => {
                event.preventDefault();
                const target = event.target.textContent;
                if (target) {
                    const classe = await this.vault.getFromLink(target);
                    if (classe) {
                        let path = classe.getPath();
                        if (path) {
                            await this.vault.app.open(path);
                        }
                    }
                    else {
                        this.vault.app.sendNotice(`Le fichier ${target}.md n'existe pas`);
                    }
                }
            };
        });
        return link;
    }
    modifyField(event) {
        const link = event.target.closest('.metadata-textfield')?.querySelector('.field-textlink');
        const input = event.target.closest('.metadata-textfield')?.querySelector('.field-textarea');
        if (link && input) {
            link.style.display = "none";
            input.style.display = "block";
            input.focus();
        }
    }
    handleFieldInput(update, input, link) {
        input.onblur = async () => {
            if (!input.parentElement?.querySelector(".autocomplete-dropdown")) {
                await this.updateField(update, input, link);
                return;
            }
        };
        input.onkeydown = async (event) => {
            if (event.key === "Escape") {
                event.preventDefault();
                await this.updateField(update, input, link);
            }
        };
    }
    async handleAutocomplete(textarea) {
        let dropdown = textarea.parentElement?.querySelector(".autocomplete-dropdown");
        // Remove existing dropdown if present
        if (dropdown) {
            dropdown.remove();
        }
        dropdown = document.createElement("div");
        dropdown.classList.add("autocomplete-dropdown");
        const cursorPosition = textarea.selectionStart || 0;
        const textBeforeCursor = textarea.value.substring(0, cursorPosition);
        const lastWordMatch = textBeforeCursor.match(/(\S+)$/);
        const query = lastWordMatch ? lastWordMatch[0].toLowerCase() : "";
        if (!query) {
            return; // No query, don't show the dropdown
        }
        /* TODO
        const files = (await this.vault.app.listFiles());
        const suggestions = files.filter((file: File) =>
          file.getName().toLowerCase().includes(query)
        );*/
        const files = await this.vault.app.listFiles();
        const suggestions = files.filter((file) => file.name.toLowerCase().includes(query));
        if (suggestions.length === 0) {
            return; // No suggestions, don't show the dropdown
        }
        // Calculate the position of the word being edited
        const textBeforeWord = textBeforeCursor.substring(0, lastWordMatch?.index || 0);
        const tempSpan = document.createElement("span");
        tempSpan.style.visibility = "hidden";
        tempSpan.style.whiteSpace = "pre-wrap";
        tempSpan.style.position = "absolute";
        tempSpan.style.font = window.getComputedStyle(textarea).font;
        tempSpan.textContent = textBeforeWord;
        document.body.appendChild(tempSpan);
        const rect = tempSpan.getBoundingClientRect();
        const textareaRect = textarea.getBoundingClientRect();
        dropdown.style.top = `${textareaRect.top + rect.height + window.scrollY}px`;
        dropdown.style.left = `${textareaRect.left + rect.width + window.scrollX}px`;
        dropdown.style.width = `${textareaRect.width}px`;
        document.body.removeChild(tempSpan);
        suggestions.forEach((file, index) => {
            const item = document.createElement("div");
            item.classList.add("autocomplete-item");
            item.textContent = file.name;
            item.tabIndex = 0; // Make it focusable
            item.dataset.index = index.toString();
            item.onclick = () => {
                this.insertSuggestion(textarea, `[[${file.path}|${file.name}]]`, lastWordMatch?.index || 0, query.length);
                dropdown.remove();
            };
            dropdown.appendChild(item);
        });
        textarea.parentElement?.appendChild(dropdown);
        // Adjust the parent's style to position the dropdown correctly
        const parent = textarea.parentElement;
        parent.style.position = "flex";
        parent.style.flexDirection = "column";
        let selectedIndex = -1;
        const updateSelection = (newIndex) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (selectedIndex >= 0) {
                items[selectedIndex].classList.remove("selected");
            }
            selectedIndex = newIndex;
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                items[selectedIndex].classList.add("selected");
                items[selectedIndex].scrollIntoView({ block: "nearest" });
            }
        };
        const handleKeyDown = (event) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (event.key === "ArrowDown") {
                event.preventDefault();
                updateSelection((selectedIndex + 1) % items.length);
            }
            else if (event.key === "ArrowUp") {
                event.preventDefault();
                updateSelection((selectedIndex - 1 + items.length) % items.length);
            }
            else if (event.key === "Escape") {
                dropdown.remove();
                textarea.removeEventListener("keydown", handleKeyDown); // Clean up event listener
                textarea.removeEventListener("keydown", handleEnter);
            }
        };
        let isEnterHandled = false;
        const handleEnter = (event) => {
            const items = dropdown.querySelectorAll(".autocomplete-item");
            if (event.key === "Enter") {
                if (isEnterHandled)
                    return; // Empêche l'exécution multiple
                isEnterHandled = true;
                textarea.removeEventListener("keydown", handleKeyDown);
                textarea.removeEventListener("keydown", handleEnter);
                dropdown.remove();
                event.preventDefault();
                const items = dropdown.querySelectorAll(".autocomplete-item");
                if (selectedIndex >= 0 && selectedIndex < items.length) {
                    const selectedItem = items[selectedIndex];
                    const suggestion = selectedItem.textContent || "";
                    this.insertSuggestion(textarea, `[[${suggestion}]]`, lastWordMatch?.index || 0, query.length);
                }
            }
        };
        if (!textarea.hasAttribute("data-keydown-listener")) {
            textarea.addEventListener("keydown", handleKeyDown);
            textarea.addEventListener("keydown", handleEnter);
            textarea.setAttribute("data-keydown-listener", "true");
        }
        const removeDropdown = () => {
            dropdown.remove();
            textarea.removeEventListener("keydown", handleKeyDown);
        };
        document.addEventListener("click", (event) => {
            if (!dropdown.contains(event.target) && event.target !== textarea) {
                removeDropdown();
            }
        }, { once: true });
    }
    insertSuggestion(textarea, suggestion, startIndex, queryLength) {
        console.log(textarea, suggestion, startIndex, queryLength);
        const before = textarea.value.substring(0, startIndex);
        const after = textarea.value.substring(startIndex + queryLength);
        textarea.value = `${before}${suggestion}${after}`;
        textarea.setSelectionRange(before.length + suggestion.length, before.length + suggestion.length);
        textarea.focus();
    }
}
exports.TextProperty = TextProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFRleHRQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSx5Q0FBc0M7QUFLdEMsTUFBYSxZQUFhLFNBQVEsbUJBQVE7SUFHeEMsWUFBWSxJQUFZLEVBQUUsS0FBWSxFQUFFLElBQUksR0FBRyxFQUFFO1FBQy9DLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSGxCLFNBQUksR0FBVyxNQUFNLENBQUM7SUFJL0IsQ0FBQztJQUVRLGdCQUFnQixDQUFDLEtBQWE7UUFDckMsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNwRCxRQUFRLENBQUMsS0FBSyxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDN0IsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6QyxRQUFRLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLHlCQUF5QjtRQUM1QyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsQ0FBQywwQkFBMEI7UUFFOUQsaUNBQWlDO1FBQ2pDLFFBQVEsQ0FBQyxZQUFZLENBQUMsdUJBQXVCLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDdkQsUUFBUSxDQUFDLE9BQU8sR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXZFLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFUSxvQkFBb0I7UUFDM0IsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QyxLQUFLLENBQUMsU0FBUyxD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Q0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUMzQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBYyxDQUFDLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQUUsQ0FBQztnQkFDMUUsY0FBYyxFQUFFLENBQUM7WUFDbkIsQ0FBQztRQUNILENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxRQUE2QixFQUFFLFVBQWtCLEVBQUUsVUFBa0IsRUFBRSxXQUFtQjtRQUN6RyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQzNELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN2RCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsV0FBVyxDQUFDLENBQUM7UUFDakUsUUFBUSxDQUFDLEtBQUssR0FBRyxHQUFHLE1BQU0sR0FBRyxVQUFVLEdBQUcsS0FBSyxFQUFFLENBQUM7UUFDbEQsUUFBUSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNqRyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBN09ELG9DQTZPQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGxlb2R1XFxEb2N1bWVudHNcXDEgLSBQcm9cXFRlc3QgcGx1Z2luIG9ic2lkaWFuXFwub2JzaWRpYW5cXHBsdWdpbnNcXG9ic2lkaWFuLUNSTVxcZHluYW1pYy1maWVsZHNcXHNyY1xccHJvcGVydGllc1xcVGV4dFByb3BlcnR5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExpbmtQcm9wZXJ0eSB9IGZyb20gXCIuL0xpbmtQcm9wZXJ0eVwiO1xyXG5pbXBvcnQgeyBQcm9wZXJ0eSB9IGZyb20gXCIuL1Byb3BlcnR5XCI7XHJcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XHJcbmltcG9ydCB7IElGaWxlIH0gZnJvbSBcIi4uL2ludGVyZmFjZXMvSUFwcFwiO1xyXG5pbXBvcnQgeyBWYXVsdCB9IGZyb20gXCIuLi92YXVsdC9WYXVsdFwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFRleHRQcm9wZXJ0eSBleHRlbmRzIFByb3BlcnR5IHtcclxuICBvdmVycmlkZSB0eXBlOiBzdHJpbmcgPSBcInRleHRcIjtcclxuXHJcbiAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCB2YXVsdDogVmF1bHQsIGFyZ3MgPSB7fSkge1xyXG4gICAgc3VwZXIobmFtZSwgdmF1bHQsIGFyZ3MpO1xyXG4gIH1cclxuXHJcbiAgb3ZlcnJpZGUgY3JlYXRlRmllbGRJbnB1dCh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB0ZXh0YXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0ZXh0YXJlYVwiKTtcclxuICAgIHRleHRhcmVhLnZhbHVlID0gdmFsdWUgfHwgXCJcIjtcclxuICAgIHRleHRhcmVhLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC10ZXh0YXJlYVwiKTtcclxuICAgIHRleHRhcmVhLnJvd3MgPSA0OyAvLyBEZWZhdWx0IG51bWJlciBvZiByb3dzXHJcbiAgICB0ZXh0YXJlYS5zdHlsZS5yZXNpemUgPSBcInZlcnRpY2FsXCI7IC8vIEFsbG93IHZlcnRpY2FsIHJlc2l6aW5nXHJcblxyXG4gICAgLy8gQWRkIGF1dG9jb21wbGV0ZSBmdW5jdGlvbmFsaXR5XHJcbiAgICB0ZXh0YXJlYS5zZXRBdHRyaWJ1dGUoXCJkYXRhLWtleWRvd24tbGlzdGVuZXJcIiwgXCJmYWxzZVwiKVxyXG4gICAgdGV4dGFyZWEub25pbnB1dCA9IGFzeW5jICgpID0+IGF3YWl0IHRoaXMuaGFuZGxlQXV0b2NvbXBsZXRlKHRleHRhcmVhKTtcclxuXHJcbiAgICByZXR1cm4gdGV4dGFyZWE7XHJcbiAgfVxyXG5cclxuICBvdmVycmlkZSBjcmVhdGVGaWVsZENvbnRhaW5lcigpIHtcclxuICAgIGNvbnN0IGZpZWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgIGZpZWxkLmNsYXNzTGlzdC5hZGQoXCJtZXRhZGF0YS10ZXh0ZmllbGRcIik7XHJcbiAgICByZXR1cm4gZmllbGQ7XHJcbiAgfVxyXG5cclxuICBvdmVycmlkZSBjcmVhdGVGaWVsZExpbmsodmFsdWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBsaW5rLmlubmVySFRNTCA9IHZhbHVlXHJcbiAgICAgID8gdmFsdWUucmVwbGFjZSgvXFxbXFxbKC4qPykoPzpcXHwoLio/KSk/XFxdXFxdL2csIChfLCBwYXRoLCBhbGlhcykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRpc3BsYXkgPSBhbGlhcyB8fCBwYXRoO1xyXG4gICAgICAgIHJldHVybiBgPHN0cm9uZz48YSBocmVmPVwiI1wiPiR7ZGlzcGxheX08L2E+PC9zdHJvbmc+YDtcclxuICAgICAgfSlcclxuICAgICAgOiBcIlwiO1xyXG4gICAgbGluay5jbGFzc0xpc3QuYWRkKFwiZmllbGQtdGV4dGxpbmtcIik7XHJcbiAgICBsaW5rLnN0eWxlLmN1cnNvciA9IHRoaXMuc3RhdGljID8gXCJkZWZhdWx0XCIgOiBcInRleHRcIjtcclxuICAgIGlmICghdGhpcy5zdGF0aWMpIHtcclxuICAgICAgbGluay5vbmNsaWNrID0gKGV2ZW50KSA9PiB0aGlzLm1vZGlmeUZpZWxkKGV2ZW50KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBBZGQgY2xpY2sgZXZlbnQgZm9yIGxpbmtzXHJcbiAgICBsaW5rLnF1ZXJ5U2VsZWN0b3JBbGwoXCJhXCIpLmZvckVhY2goYW5jaG9yID0+IHtcclxuICAgICAgYW5jaG9yLm9uY2xpY2sgPSBhc3luYyAoZXZlbnQpID0+IHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGNvbnN0IHRhcmdldCA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLnRleHRDb250ZW50O1xyXG4gICAgICAgIGlmICh0YXJnZXQpIHtcclxuICAgICAgICAgIGNvbnN0IGNsYXNzZSA9IGF3YWl0IHRoaXMudmF1bHQuZ2V0RnJvbUxpbmsodGFyZ2V0KTtcclxuICAgICAgICAgIGlmIChjbGFzc2UpIHtcclxuICAgICAgICAgICAgICBsZXQgcGF0aCA9IGNsYXNzZS5nZXRQYXRoKCk7XHJcbiAgICAgICAgICAgICAgaWYgKHBhdGgpe1xyXG4gICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudmF1bHQuYXBwLm9wZW4ocGF0aCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIFxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy52YXVsdC5hcHAuc2VuZE5vdGljZShgTGUgZmljaGllciAke3RhcmdldH0ubWQgbidleGlzdGUgcGFzYCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGxpbms7XHJcbiAgfVxyXG5cclxuICBvdmVycmlkZSBtb2RpZnlGaWVsZChldmVudDogRXZlbnQpIHtcclxuICAgIGNvbnN0IGxpbmsgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5jbG9zZXN0KCcubWV0YWRhdGEtdGV4dGZpZWxkJyk/LnF1ZXJ5U2VsZWN0b3IoJy5maWVsZC10ZXh0bGluaycpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgY29uc3QgaW5wdXQgPSAoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5jbG9zZXN0KCcubWV0YWRhdGEtdGV4dGZpZWxkJyk/LnF1ZXJ5U2VsZWN0b3IoJy5maWVsZC10ZXh0YXJlYScpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XHJcbiAgICBpZiAobGluayAmJiBpbnB1dCkge1xyXG4gICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuICAgICAgaW5wdXQuZm9jdXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG92ZXJyaWRlIGhhbmRsZUZpZWxkSW5wdXQodXBkYXRlOiAodmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiwgaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50LCBsaW5rOiBIVE1MRWxlbWVudCkge1xyXG4gICAgaW5wdXQub25ibHVyID0gYXN5bmMgKCkgPT4ge1xyXG4gICAgICBpZiAoIWlucHV0LnBhcmVudEVsZW1lbnQ/LnF1ZXJ5U2VsZWN0b3IoXCIuYXV0b2NvbXBsZXRlLWRyb3Bkb3duXCIpKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVGaWVsZCh1cGRhdGUsIGlucHV0LCBsaW5rKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgaW5wdXQub25rZXlkb3duID0gYXN5bmMgKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIikge1xyXG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlRmllbGQodXBkYXRlLCBpbnB1dCwgbGluayk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICB9XHJcblxyXG5cclxuICBhc3luYyBoYW5kbGVBdXRvY29tcGxldGUodGV4dGFyZWE6IEhUTUxUZXh0QXJlYUVsZW1lbnQpIHtcclxuICAgIGxldCBkcm9wZG93biA9IHRleHRhcmVhLnBhcmVudEVsZW1lbnQ/LnF1ZXJ5U2VsZWN0b3IoXCIuYXV0b2NvbXBsZXRlLWRyb3Bkb3duXCIpIGFzIEhUTUxFbGVtZW50O1xyXG5cclxuICAgIC8vIFJlbW92ZSBleGlzdGluZyBkcm9wZG93biBpZiBwcmVzZW50XHJcbiAgICBpZiAoZHJvcGRvd24pIHtcclxuICAgICAgZHJvcGRvd24ucmVtb3ZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZHJvcGRvd24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgZHJvcGRvd24uY2xhc3NMaXN0LmFkZChcImF1dG9jb21wbGV0ZS1kcm9wZG93blwiKTtcclxuXHJcbiAgICBjb25zdCBjdXJzb3JQb3NpdGlvbiA9IHRleHRhcmVhLnNlbGVjdGlvblN0YXJ0IHx8IDA7XHJcbiAgICBjb25zdCB0ZXh0QmVmb3JlQ3Vyc29yID0gdGV4dGFyZWEudmFsdWUuc3Vic3RyaW5nKDAsIGN1cnNvclBvc2l0aW9uKTtcclxuICAgIGNvbnN0IGxhc3RXb3JkTWF0Y2ggPSB0ZXh0QmVmb3JlQ3Vyc29yLm1hdGNoKC8oXFxTKykkLyk7XHJcbiAgICBjb25zdCBxdWVyeSA9IGxhc3RXb3JkTWF0Y2ggPyBsYXN0V29yZE1hdGNoWzBdLnRvTG93ZXJDYXNlKCkgOiBcIlwiO1xyXG5cclxuICAgIGlmICghcXVlcnkpIHtcclxuICAgICAgcmV0dXJuOyAvLyBObyBxdWVyeSwgZG9uJ3Qgc2hvdyB0aGUgZHJvcGRvd25cclxuICAgIH1cclxuXHJcbiAgICAvKiBUT0RPXHJcbiAgICBjb25zdCBmaWxlcyA9IChhd2FpdCB0aGlzLnZhdWx0LmFwcC5saXN0RmlsZXMoKSk7XHJcbiAgICBjb25zdCBzdWdnZXN0aW9ucyA9IGZpbGVzLmZpbHRlcigoZmlsZTogRmlsZSkgPT5cclxuICAgICAgZmlsZS5nZXROYW1lKCkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxdWVyeSlcclxuICAgICk7Ki9cclxuICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgdGhpcy52YXVsdC5hcHAubGlzdEZpbGVzKCk7XHJcbiAgICBjb25zdCBzdWdnZXN0aW9ucyA9IGZpbGVzLmZpbHRlcigoZmlsZTogSUZpbGUpID0+XHJcbiAgICAgIGZpbGUubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHF1ZXJ5KVxyXG4gICAgKTsgIFxyXG5cclxuICAgIGlmIChzdWdnZXN0aW9ucy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuOyAvLyBObyBzdWdnZXN0aW9ucywgZG9uJ3Qgc2hvdyB0aGUgZHJvcGRvd25cclxuICAgIH1cclxuXHJcbiAgICAvLyBDYWxjdWxhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSB3b3JkIGJlaW5nIGVkaXRlZFxyXG4gICAgY29uc3QgdGV4dEJlZm9yZVdvcmQgPSB0ZXh0QmVmb3JlQ3Vyc29yLnN1YnN0cmluZygwLCBsYXN0V29yZE1hdGNoPy5pbmRleCB8fCAwKTtcclxuICAgIGNvbnN0IHRlbXBTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XHJcbiAgICB0ZW1wU3Bhbi5zdHlsZS52aXNpYmlsaXR5ID0gXCJoaWRkZW5cIjtcclxuICAgIHRlbXBTcGFuLnN0eWxlLndoaXRlU3BhY2UgPSBcInByZS13cmFwXCI7XHJcbiAgICB0ZW1wU3Bhbi5zdHlsZS5wb3NpdGlvbiA9IFwiYWJzb2x1dGVcIjtcclxuICAgIHRlbXBTcGFuLnN0eWxlLmZvbnQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0ZXh0YXJlYSkuZm9udDtcclxuICAgIHRlbXBTcGFuLnRleHRDb250ZW50ID0gdGV4dEJlZm9yZVdvcmQ7XHJcblxyXG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZW1wU3Bhbik7XHJcbiAgICBjb25zdCByZWN0ID0gdGVtcFNwYW4uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICBjb25zdCB0ZXh0YXJlYVJlY3QgPSB0ZXh0YXJlYS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgIGRyb3Bkb3duLnN0eWxlLnRvcCA9IGAke3RleHRhcmVhUmVjdC50b3AgKyByZWN0LmhlaWdodCArIHdpbmRvdy5zY3JvbGxZfXB4YDtcclxuICAgIGRyb3Bkb3duLnN0eWxlLmxlZnQgPSBgJHt0ZXh0YXJlYVJlY3QubGVmdCArIHJlY3Qud2lkdGggKyB3aW5kb3cuc2Nyb2xsWH1weGA7XHJcbiAgICBkcm9wZG93bi5zdHlsZS53aWR0aCA9IGAke3RleHRhcmVhUmVjdC53aWR0aH1weGA7XHJcbiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRlbXBTcGFuKTtcclxuXHJcbiAgICBzdWdnZXN0aW9ucy5mb3JFYWNoKChmaWxlOiBJRmlsZSwgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKFwiYXV0b2NvbXBsZXRlLWl0ZW1cIik7XHJcbiAgICAgIGl0ZW0udGV4dENvbnRlbnQgPSBmaWxlLm5hbWU7XHJcbiAgICAgIGl0ZW0udGFiSW5kZXggPSAwOyAvLyBNYWtlIGl0IGZvY3VzYWJsZVxyXG4gICAgICBpdGVtLmRhdGFzZXQuaW5kZXggPSBpbmRleC50b1N0cmluZygpO1xyXG5cclxuICAgICAgaXRlbS5vbmNsaWNrID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuaW5zZXJ0U3VnZ2VzdGlvbih0ZXh0YXJlYSwgYFtbJHtmaWxlLnBhdGh9fCR7ZmlsZS5uYW1lfV1dYCwgbGFzdFdvcmRNYXRjaD8uaW5kZXggfHwgMCwgcXVlcnkubGVuZ3RoKTtcclxuICAgICAgICBkcm9wZG93bi5yZW1vdmUoKTtcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGRyb3Bkb3duLmFwcGVuZENoaWxkKGl0ZW0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGV4dGFyZWEucGFyZW50RWxlbWVudD8uYXBwZW5kQ2hpbGQoZHJvcGRvd24pO1xyXG4gICAgLy8gQWRqdXN0IHRoZSBwYXJlbnQncyBzdHlsZSB0byBwb3NpdGlvbiB0aGUgZHJvcGRvd24gY29ycmVjdGx5XHJcbiAgICBjb25zdCBwYXJlbnQgPSB0ZXh0YXJlYS5wYXJlbnRFbGVtZW50IGFzIEhUTUxFbGVtZW50O1xyXG4gICAgcGFyZW50LnN0eWxlLnBvc2l0aW9uID0gXCJmbGV4XCI7XHJcbiAgICBwYXJlbnQuc3R5bGUuZmxleERpcmVjdGlvbiA9IFwiY29sdW1uXCI7XHJcblxyXG4gICAgbGV0IHNlbGVjdGVkSW5kZXggPSAtMTtcclxuXHJcbiAgICBjb25zdCB1cGRhdGVTZWxlY3Rpb24gPSAobmV3SW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtcyA9IGRyb3Bkb3duLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYXV0b2NvbXBsZXRlLWl0ZW1cIik7XHJcbiAgICAgIGlmIChzZWxlY3RlZEluZGV4ID49IDApIHtcclxuICAgICAgICBpdGVtc1tzZWxlY3RlZEluZGV4XS5jbGFzc0xpc3QucmVtb3ZlKFwic2VsZWN0ZWRcIik7XHJcbiAgICAgIH1cclxuICAgICAgc2VsZWN0ZWRJbmRleCA9IG5ld0luZGV4O1xyXG4gICAgICBpZiAoc2VsZWN0ZWRJbmRleCA+PSAwICYmIHNlbGVjdGVkSW5kZXggPCBpdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICBpdGVtc1tzZWxlY3RlZEluZGV4XS5jbGFzc0xpc3QuYWRkKFwic2VsZWN0ZWRcIik7XHJcbiAgICAgICAgaXRlbXNbc2VsZWN0ZWRJbmRleF0uc2Nyb2xsSW50b1ZpZXcoeyBibG9jazogXCJuZWFyZXN0XCIgfSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgaGFuZGxlS2V5RG93biA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtcyA9IGRyb3Bkb3duLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYXV0b2NvbXBsZXRlLWl0ZW1cIik7XHJcbiAgICAgIGlmIChldmVudC5rZXkgPT09IFwiQXJyb3dEb3duXCIpIHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIHVwZGF0ZVNlbGVjdGlvbigoc2VsZWN0ZWRJbmRleCArIDEpICUgaXRlbXMubGVuZ3RoKTtcclxuICAgICAgfSBlbHNlIGlmIChldmVudC5rZXkgPT09IFwiQXJyb3dVcFwiKSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICB1cGRhdGVTZWxlY3Rpb24oKHNlbGVjdGVkSW5kZXggLSAxICsgaXRlbXMubGVuZ3RoKSAlIGl0ZW1zLmxlbmd0aCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSBcIkVzY2FwZVwiKSB7XHJcbiAgICAgICAgZHJvcGRvd24ucmVtb3ZlKCk7XHJcbiAgICAgICAgdGV4dGFyZWEucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgaGFuZGxlS2V5RG93bik7IC8vIENsZWFuIHVwIGV2ZW50IGxpc3RlbmVyXHJcbiAgICAgICAgdGV4dGFyZWEucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgaGFuZGxlRW50ZXIpXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBsZXQgaXNFbnRlckhhbmRsZWQgPSBmYWxzZTtcclxuICAgIGNvbnN0IGhhbmRsZUVudGVyID0gKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW1zID0gZHJvcGRvd24ucXVlcnlTZWxlY3RvckFsbChcIi5hdXRvY29tcGxldGUtaXRlbVwiKTtcclxuICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XHJcbiAgICAgICAgaWYgKGlzRW50ZXJIYW5kbGVkKSByZXR1cm47IC8vIEVtcMOqY2hlIGwnZXjDqWN1dGlvbiBtdWx0aXBsZVxyXG4gICAgICAgIGlzRW50ZXJIYW5kbGVkID0gdHJ1ZTtcclxuICAgICAgICB0ZXh0YXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBoYW5kbGVLZXlEb3duKVxyXG4gICAgICAgIHRleHRhcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIGhhbmRsZUVudGVyKVxyXG4gICAgICAgIGRyb3Bkb3duLnJlbW92ZSgpO1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgY29uc3QgaXRlbXMgPSBkcm9wZG93bi5xdWVyeVNlbGVjdG9yQWxsKFwiLmF1dG9jb21wbGV0ZS1pdGVtXCIpO1xyXG4gICAgICAgIGlmIChzZWxlY3RlZEluZGV4ID49IDAgJiYgc2VsZWN0ZWRJbmRleCA8IGl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgY29uc3Qgc2VsZWN0ZWRJdGVtID0gaXRlbXNbc2VsZWN0ZWRJbmRleF07XHJcbiAgICAgICAgICBjb25zdCBzdWdnZXN0aW9uID0gc2VsZWN0ZWRJdGVtLnRleHRDb250ZW50IHx8IFwiXCI7XHJcbiAgICAgICAgICB0aGlzLmluc2VydFN1Z2dlc3Rpb24odGV4dGFyZWEsIGBbWyR7c3VnZ2VzdGlvbn1dXWAsIGxhc3RXb3JkTWF0Y2g/LmluZGV4IHx8IDAsIHF1ZXJ5Lmxlbmd0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGlmICghdGV4dGFyZWEuaGFzQXR0cmlidXRlKFwiZGF0YS1rZXlkb3duLWxpc3RlbmVyXCIpKSB7XHJcbiAgICAgIHRleHRhcmVhLmFkZEV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIGhhbmRsZUtleURvd24pO1xyXG4gICAgICB0ZXh0YXJlYS5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBoYW5kbGVFbnRlcik7XHJcbiAgICAgIHRleHRhcmVhLnNldEF0dHJpYnV0ZShcImRhdGEta2V5ZG93bi1saXN0ZW5lclwiLCBcInRydWVcIik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVtb3ZlRHJvcGRvd24gPSAoKSA9PiB7XHJcbiAgICAgIGRyb3Bkb3duLnJlbW92ZSgpO1xyXG4gICAgICB0ZXh0YXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCBoYW5kbGVLZXlEb3duKTtcclxuICAgIH07XHJcblxyXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIChldmVudCkgPT4ge1xyXG4gICAgICBpZiAoIWRyb3Bkb3duLmNvbnRhaW5zKGV2ZW50LnRhcmdldCBhcyBOb2RlKSAmJiBldmVudC50YXJnZXQgIT09IHRleHRhcmVhKSB7XHJcbiAgICAgICAgcmVtb3ZlRHJvcGRvd24oKTtcclxuICAgICAgfVxyXG4gICAgfSwgeyBvbmNlOiB0cnVlIH0pO1xyXG4gIH1cclxuXHJcbiAgaW5zZXJ0U3VnZ2VzdGlvbih0ZXh0YXJlYTogSFRNTFRleHRBcmVhRWxlbWVudCwgc3VnZ2VzdGlvbjogc3RyaW5nLCBzdGFydEluZGV4OiBudW1iZXIsIHF1ZXJ5TGVuZ3RoOiBudW1iZXIpIHtcclxuICAgIGNvbnNvbGUubG9nKHRleHRhcmVhLCBzdWdnZXN0aW9uLCBzdGFydEluZGV4LCBxdWVyeUxlbmd0aCk7XHJcbiAgICBjb25zdCBiZWZvcmUgPSB0ZXh0YXJlYS52YWx1ZS5zdWJzdHJpbmcoMCwgc3RhcnRJbmRleCk7XHJcbiAgICBjb25zdCBhZnRlciA9IHRleHRhcmVhLnZhbHVlLnN1YnN0cmluZyhzdGFydEluZGV4ICsgcXVlcnlMZW5ndGgpO1xyXG4gICAgdGV4dGFyZWEudmFsdWUgPSBgJHtiZWZvcmV9JHtzdWdnZXN0aW9ufSR7YWZ0ZXJ9YDtcclxuICAgIHRleHRhcmVhLnNldFNlbGVjdGlvblJhbmdlKGJlZm9yZS5sZW5ndGggKyBzdWdnZXN0aW9uLmxlbmd0aCwgYmVmb3JlLmxlbmd0aCArIHN1Z2dlc3Rpb24ubGVuZ3RoKTtcclxuICAgIHRleHRhcmVhLmZvY3VzKCk7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==