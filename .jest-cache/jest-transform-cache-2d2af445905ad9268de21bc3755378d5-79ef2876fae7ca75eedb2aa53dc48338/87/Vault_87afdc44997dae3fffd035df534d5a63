7cca906c83faca8430eb7718b6be8a82
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Vault = void 0;
const DynamicClassFactory_1 = require("../Config/DynamicClassFactory");
const File_1 = require("./File");
class Vault {
    constructor(app, settings) {
        this.files = {};
        this.app = app;
        this.settings = settings;
        // Initialize the dynamic class factory
        this.initializeDynamicClasses();
    }
    getPath() {
        return this.app.getVaultPath();
    }
    getName() {
        return this.app.getName();
    }
    async initializeDynamicClasses() {
        try {
            const configPath = this.settings.configPath || './config';
            Vault.dynamicClassFactory = new DynamicClassFactory_1.DynamicClassFactory(configPath, this);
            // Load available classes and populate the static classes object
            const availableClasses = await Vault.dynamicClassFactory.getAvailableClasses();
            for (const className of availableClasses) {
                const dynamicClass = await Vault.dynamicClassFactory.getClass(className);
                Vault.classes[className] = dynamicClass;
            }
        }
        catch (error) {
            console.error('Failed to initialize dynamic classes:', error);
        }
    }
    getDynamicClassFactory() {
        return Vault.dynamicClassFactory;
    }
    getPersonalName() {
        return this.settings.personalName;
    }
    getClasseFromName(name) {
        return Vault.classes[name];
    }
    readLinkFile(link, path = false) {
        if (!link || typeof link !== "string")
            return "";
        // Match [[file|alias]] or [[file]]
        const match = link.match(/^\[\[([^\|\]]+?)(?:)?(?:\|([^\]]+))?\]\]$/);
        if (match) {
            const fileName = match[1]?.trim();
            const alias = match[2]?.trim();
            if (path) {
                return /\.[^\/\\]+$/.test(fileName) ? fileName : `${fileName}.md`;
            }
            else {
                return alias ? alias : fileName.split("/").pop()?.replace(".md", "") || "";
            }
        }
        // If not a wikilink, just return the trimmed link
        return link.trim();
    }
    async getFromLink(name, log = true) {
        if (!name) {
            return null;
        }
        // Search with the path
        let path = this.readLinkFile(name, true);
        let directfile = (await this.app.listFiles()).find((f) => {
            return f.path.trim() === path.trim();
        });
        if (directfile) {
            if (directfile.path in Object.keys(this.files)) {
                return this.files[directfile.path];
            }
            return await this.createClasse(directfile);
        }
        let fileName = path.split("/").pop() || "";
        const files = (await this.app.listFiles()).filter((f) => f.name === fileName);
        if (files.length > 0) {
            let file = files[0];
            if (files.length > 1) {
                let path = this.readLinkFile(name, true);
                if (path) {
                    // Try to find the best match by walking up the path segments
                    let segments = path.split("/");
                    while (segments.length > 0) {
                        const candidatePath = segments.join("/");
                        const bestMatch = files.find((f) => f.path.endsWith("/" + candidatePath) || f.path === candidatePath);
                        if (bestMatch) {
                            file = bestMatch;
                            break;
                        }
                        segments.shift(); // Remove the first segment and try again
                    }
                }
                else {
                    console.error("Plusieurs fichiers trouvés pour le lien sans chemin : " + name, files);
                }
            }
            if (file.path in Object.keys(this.files)) {
                return this.files[file.path];
            }
            return await this.createClasse(file);
        }
        if (log) {
            console.error("Fichier non trouvé : " + name);
        }
        return null;
    }
    async getMediaFromLink(link) {
        let path = this.readLinkFile(link, true);
        const file = (await this.app.listFiles()).find((f) => {
            return f.path === path;
        });
        if (file) {
            return file;
        }
        // try with the file name
        let fileName = this.readLinkFile(link);
        const files = (await this.app.listFiles()).filter((f) => f.name === fileName);
        if (files.length > 0) {
            let file = files[0];
            if (files.length > 1) {
                console.error("Plusieurs fichiers trouvés pour le lien sans chemin : " + link, files);
            }
            return file;
        }
        console.error("Media non trouvé : " + link);
        return null;
    }
    /*
    getFromFolder(folder: Folder) {
        let name = folder.path.split("/")[folder.path.split("/").length - 1];
        for (let file of folder.children || []) {
            if (this.app.isTFile(file) && file.name.includes(name)) {
                return this.getFromFile(file);
            }
        }
        console.error("Le dossier n'a pas de fichier classe : " + folder.path);
    }*/
    async getFromFile(file) {
        if (this.app.isFolder(file)) {
            let filePath = file.path + "/" + file.name;
            let iFile = await this.app.getFile(filePath);
            if (!iFile) {
                console.error("Le dossier n'a pas de fichier classe : " + file.path);
                return undefined;
            }
        }
        let existingClass = this.files[file.path];
        if (existingClass) {
            return existingClass;
        }
        let classe;
        classe = await this.createClasse(file);
        return classe;
    }
    async createFile(classeType = null, name = "", args = {}) {
        // Create the new file from the className template
        if (!classeType) {
            const dynamicClasses = Object.keys(Vault.classes);
            classeType = await this.app.selectClasse(this, dynamicClasses, "Quelle classe pour ce fichier ?");
            if (!classeType) {
                return;
            }
        }
        console.log("Args ; ", args);
        if (!name) {
            let classe = await this.app.selectFile(this, [classeType.name], { hint: "Entrer un nom pour ce fichier", classeArgs: args });
            // Select File call createFile if the file doesn't exist
            // No need to continue
            return classe?.file;
        }
        let templatePath = this.settings.templateFolder + "/" + classeType.name + ".md";
        const templateFile = await this.app.getFile(templatePath);
        const newFilePath = name.includes(".md") ? name : `${name}.md`;
        let templateContent = "---\nClasse: " + classeType.name + "\n---\n";
        if (templateFile && (await this.app.isFile(templateFile))) {
            templateContent = await this.app.readFile(templateFile);
        }
        else {
            console.warn("Le fichier template n'existe pas :" + templatePath + ". Un fichier vide sera créé.");
        }
        let file = null;
        try {
            file = new File_1.File(this, await this.app.createFile(newFilePath, templateContent));
            console.log("Nouveau fichier créé : " + newFilePath);
        }
        catch (error) {
            // Modifier le fichier s'il existe déjà
            const file = await this.app.getFile(newFilePath);
            if (!file) {
                throw Error("Le fichier n'a pas pu être créé ou modifié : " + newFilePath);
            }
            if (file && this.app.isFile(file)) {
                await this.app.writeFile(file, templateContent);
                console.log("Fichier modifié : " + newFilePath);
            }
            else {
                throw Error("Le fichier n'a pas pu être créé ou modifié : " + newFilePath);
            }
        }
        if (!file) {
            throw Error("Le fichier n'existe pas : " + newFilePath);
        }
        await this.app.waitForFileMetaDataUpdate(file.path, "Classe", async () => {
            await new Promise(resolve => setTimeout(resolve, 200));
            if (!file) {
                return;
            }
            let classe = await this.getFromFile(file);
            if (!classe) {
                console.error("Classe non trouvée pour le fichier : " + file.path);
                return;
            }
            await classe.onCreate();
            await classe.onUpdate();
            console.log("Classe créée : " + classe.name);
        });
        return file;
    }
    async refreshAll() {
        // Move all files 
        let watchedFiles = [];
        for (let file of await this.app.listFiles()) {
            if (watchedFiles.includes(file.name) || file.path.startsWith("Outils")) {
                continue;
            }
            console.log("Refresh : " + file.path);
            const classe = await this.getFromFile(file);
            if (classe) {
                classe.onUpdate();
            }
            // Remove the duplicates
            /*
            for (let file2 of this.app.vault.getFiles()) {
                // Compare the name
                if (file.name === file2.name && file.path != file2.path && this.getFromFile(file)?.getClasse() === this.getFromFile(file2)?.getClasse()) {
                    console.error("Doublon de \n" + file.path + "\n" + file2.path);
                    // Keep the first by default
                    await this.app.vault.delete(file2);
                }
            }*/
            watchedFiles.push(file.name);
        }
        // Remove empty folders 
        for (let folder of await this.app.listFolders()) {
            if (folder.children && folder.children.length === 0) {
                await this.app.delete(folder);
            }
        }
        this.app.sendNotice("Vault refresh");
    }
    async createClasse(file) {
        let fileInstance;
        if (!(file instanceof File_1.File)) {
            fileInstance = new File_1.File(this, file);
        }
        else {
            fileInstance = file;
        }
        const metadata = await this.app.getMetadata(fileInstance);
        if (!metadata) {
            console.error("Pas de metadata");
            return;
        }
        const className = metadata["Classe"];
        if (!className) {
            console.error("Pas de classe définie dans les métadonnées");
            return undefined;
        }
        try {
            // Use the dynamic class factory to get the constructor
            if (Vault.dynamicClassFactory) {
                const constructor = await Vault.dynamicClassFactory.getClass(className);
                if (constructor) {
                    return new constructor(this, fileInstance);
                }
            }
            // Fallback to static classes if dynamic factory is not available
            let constructor = Vault.classes[className];
            if (constructor) {
                return new constructor(this, fileInstance);
            }
            console.error("Type non connue : " + className);
            return undefined;
        }
        catch (error) {
            console.error("Erreur lors de la création de la classe : " + className, error);
            return undefined;
        }
    }
}
exports.Vault = Vault;
Vault.dynamicClassFactory = null;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHZhdWx0XFxWYXVsdC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSx1RUFBb0U7QUFHcEUsaUNBQThCO0FBUTlCLE1BQWEsS0FBSztJQVlkLFlBQVksR0FBUyxFQUFFLFFBQWtCO1FBTGxDLFVBQUssR0FBOEIsRUFBRSxDQUFDO1FBTXpDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFTSxPQUFPO1FBQ1YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFTSxPQUFPO1FBQ1YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFHTyxLQUFLLENBQUMsd0JBQXdCO1FBQ2xDLElBQUksQ0FBQztZQUNELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQztZQUMxRCxLQUFLLENBQUMsbUJBQW1CLEdBQUcsSUFBSSx5Q0FBbUIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFdEUsZ0VBQWdFO1lBQ2hFLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxLQUFLLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUMvRSxLQUFLLE1BQU0sU0FBUyxJQUFJLGdCQUFnQixFQUFFLENBQUM7Z0JBQ3ZDLE1BQU0sWUFBWSxHQUFHLE1BQU0sS0FBSyxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDekUsS0FBSyxDQUFDLE9BQU8sQ0FB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QUFTLENBQUM7UUFDckIsQ0FBQztJQUNMLENBQUM7O0FBN1RMLHNCQThUQztBQXBUa0IseUJBQW1CLEdBQStCLElBQUksQUFBbkMsQ0FBb0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHZhdWx0XFxWYXVsdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbWljQ2xhc3NGYWN0b3J5IH0gZnJvbSBcIi4uL0NvbmZpZy9EeW5hbWljQ2xhc3NGYWN0b3J5XCI7XHJcbmltcG9ydCB7IElBcHAsIElGaWxlIH0gZnJvbSBcIi4uL2ludGVyZmFjZXMvSUFwcFwiO1xyXG5pbXBvcnQgeyBDbGFzc2UgfSBmcm9tIFwiLi9DbGFzc2VcIjtcclxuaW1wb3J0IHsgRmlsZSB9IGZyb20gXCIuL0ZpbGVcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2V0dGluZ3Mge1xyXG4gIHRlbXBsYXRlRm9sZGVyOiBzdHJpbmc7XHJcbiAgcGVyc29uYWxOYW1lIDogc3RyaW5nO1xyXG4gIGNvbmZpZ1BhdGg/OiBzdHJpbmc7IC8vIFBhdGggdG8gWUFNTCBjb25maWd1cmF0aW9uIGZpbGVzXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBWYXVsdCB7XHJcbiAgICAvKlxyXG4gICAgR2xvYmFsIFZhdWx0LCB3aXRoIGFsbCBpbmZvcm1hdGlvbnNcclxuICAgICovXHJcbiAgICBwdWJsaWMgYXBwOiBJQXBwO1xyXG4gICAgXHJcbiAgICBwdWJsaWMgc2V0dGluZ3M6IFNldHRpbmdzO1xyXG4gICAgcHVibGljIGZpbGVzOiB7IFtrZXk6IHN0cmluZ106IENsYXNzZSB9ID0ge307XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBjbGFzc2VzOiB7IFtrZXk6IHN0cmluZ106IHR5cGVvZiBDbGFzc2UgfTtcclxuICAgIHByaXZhdGUgc3RhdGljIGR5bmFtaWNDbGFzc0ZhY3Rvcnk6IER5bmFtaWNDbGFzc0ZhY3RvcnkgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhcHA6IElBcHAsIHNldHRpbmdzOiBTZXR0aW5ncykge1xyXG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xyXG4gICAgICAgIHRoaXMuc2V0dGluZ3MgPSBzZXR0aW5ncztcclxuICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBkeW5hbWljIGNsYXNzIGZhY3RvcnlcclxuICAgICAgICB0aGlzLmluaXRpYWxpemVEeW5hbWljQ2xhc3NlcygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRQYXRoKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLmdldFZhdWx0UGF0aCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXROYW1lKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLmdldE5hbWUoKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBpbml0aWFsaXplRHluYW1pY0NsYXNzZXMoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlnUGF0aCA9IHRoaXMuc2V0dGluZ3MuY29uZmlnUGF0aCB8fCAnLi9jb25maWcnO1xyXG4gICAgICAgICAgICBWYXVsdC5keW5hbWljQ2xhc3NGYWN0b3J5ID0gbmV3IER5bmFtaWNDbGFzc0ZhY3RvcnkoY29uZmlnUGF0aCwgdGhpcyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBMb2FkIGF2YWlsYWJsZSBjbGFzc2VzIGFuZCBwb3B1bGF0ZSB0aGUgc3RhdGljIGNsYXNzZXMgb2JqZWN0XHJcbiAgICAgICAgICAgIGNvbnN0IGF2YWlsYWJsZUNsYXNzZXMgPSBhd2FpdCBWYXVsdC5keW5hbWljQ2xhc3NGYWN0b3J5LmdldEF2YWlsYWJsZUNsYXNzZXMoKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBjbGFzc05hbWUgb2YgYXZhaWxhYmxlQ2xhc3Nlcykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZHluYW1pY0NsYXNzID0gYXdhaXQgVmF1bHQuZHluYW1pY0NsYXNzRmFjdG9yeS5nZXRDbGFzcyhjbGFzc05hbWUpO1xyXG4gICAgICAgICAgICAgICAgVmF1bHQuY2xhc3Nlc1tjbGFzc05hbWVdID0gZHluYW1pY0NsYXNzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgZHluYW1pYyBjbGFzc2VzOicsIGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RHluYW1pY0NsYXNzRmFjdG9yeSgpOiBEeW5hbWljQ2xhc3NGYWN0b3J5IHwgbnVsbCB7XHJcbiAgICAgICAgcmV0dXJuIFZhdWx0LmR5bmFtaWNDbGFzc0ZhY3Rvcnk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGVyc29uYWxOYW1lKCl7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0dGluZ3MucGVyc29uYWxOYW1lXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q2xhc3NlRnJvbU5hbWUobmFtZTogc3RyaW5nKSA6IHR5cGVvZiBDbGFzc2V7XHJcbiAgICAgICAgcmV0dXJuIFZhdWx0LmNsYXNzZXNbbmFtZV1cclxuICAgIH1cclxuXHJcbiAgICByZWFkTGlua0ZpbGUobGluazogc3RyaW5nLCBwYXRoID0gZmFsc2UpOiBzdHJpbmcge1xyXG4gICAgICAgIGlmICghbGluayB8fCB0eXBlb2YgbGluayAhPT0gXCJzdHJpbmdcIikgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgLy8gTWF0Y2ggW1tmaWxlfGFsaWFzXV0gb3IgW1tmaWxlXV1cclxuICAgICAgICBjb25zdCBtYXRjaCA9IGxpbmsubWF0Y2goL15cXFtcXFsoW15cXHxcXF1dKz8pKD86KT8oPzpcXHwoW15cXF1dKykpP1xcXVxcXSQvKTtcclxuICAgICAgICBpZiAobWF0Y2gpIHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBtYXRjaFsxXT8udHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCBhbGlhcyA9IG1hdGNoWzJdPy50cmltKCk7XHJcbiAgICAgICAgICAgIGlmIChwYXRoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gL1xcLlteXFwvXFxcXF0rJC8udGVzdChmaWxlTmFtZSkgPyBmaWxlTmFtZSA6IGAke2ZpbGVOYW1lfS5tZGA7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWxpYXMgPyBhbGlhcyA6IGZpbGVOYW1lLnNwbGl0KFwiL1wiKS5wb3AoKT8ucmVwbGFjZShcIi5tZFwiLFwiXCIpIHx8IFwiXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gSWYgbm90IGEgd2lraWxpbmssIGp1c3QgcmV0dXJuIHRoZSB0cmltbWVkIGxpbmtcclxuICAgICAgICByZXR1cm4gbGluay50cmltKCk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZ2V0RnJvbUxpbmsobmFtZTogc3RyaW5nLCBsb2c9dHJ1ZSkge1xyXG4gICAgICAgIGlmICghbmFtZSkgeyByZXR1cm4gbnVsbDsgfVxyXG5cclxuICAgICAgICAvLyBTZWFyY2ggd2l0aCB0aGUgcGF0aFxyXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy5yZWFkTGlua0ZpbGUobmFtZSwgdHJ1ZSk7XHJcbiAgICAgICAgbGV0IGRpcmVjdGZpbGUgPSAoYXdhaXQgdGhpcy5hcHAubGlzdEZpbGVzKCkpLmZpbmQoKGYgOiBJRmlsZSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZi5wYXRoLnRyaW0oKSA9PT0gcGF0aC50cmltKClcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZGlyZWN0ZmlsZSkge1xyXG4gICAgICAgICAgICBpZiAoZGlyZWN0ZmlsZS5wYXRoIGluIE9iamVjdC5rZXlzKHRoaXMuZmlsZXMpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWxlc1tkaXJlY3RmaWxlLnBhdGhdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNyZWF0ZUNsYXNzZShkaXJlY3RmaWxlKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBsZXQgZmlsZU5hbWUgPSBwYXRoLnNwbGl0KFwiL1wiKS5wb3AoKSB8fCBcIlwiO1xyXG4gICAgICAgIGNvbnN0IGZpbGVzID0gKGF3YWl0IHRoaXMuYXBwLmxpc3RGaWxlcygpKS5maWx0ZXIoKGYgOiBJRmlsZSkgPT4gZi5uYW1lID09PSBmaWxlTmFtZSk7XHJcbiAgICAgICAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgbGV0IGZpbGUgPSBmaWxlc1swXTtcclxuICAgICAgICAgICAgaWYgKGZpbGVzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIGxldCBwYXRoID0gdGhpcy5yZWFkTGlua0ZpbGUobmFtZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBiZXN0IG1hdGNoIGJ5IHdhbGtpbmcgdXAgdGhlIHBhdGggc2VnbWVudHNcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc2VnbWVudHMgPSBwYXRoLnNwbGl0KFwiL1wiKTtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoc2VnbWVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVQYXRoID0gc2VnbWVudHMuam9pbihcIi9cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJlc3RNYXRjaCA9IGZpbGVzLmZpbmQoKGYgOiBJRmlsZSkgPT4gZi5wYXRoLmVuZHNXaXRoKFwiL1wiICsgY2FuZGlkYXRlUGF0aCkgfHwgZi5wYXRoID09PSBjYW5kaWRhdGVQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlc3RNYXRjaCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSA9IGJlc3RNYXRjaDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRzLnNoaWZ0KCk7IC8vIFJlbW92ZSB0aGUgZmlyc3Qgc2VnbWVudCBhbmQgdHJ5IGFnYWluXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlBsdXNpZXVycyBmaWNoaWVycyB0cm91dsOpcyBwb3VyIGxlIGxpZW4gc2FucyBjaGVtaW4gOiBcIiArIG5hbWUsIGZpbGVzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGZpbGUucGF0aCBpbiBPYmplY3Qua2V5cyh0aGlzLmZpbGVzKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXNbZmlsZS5wYXRoXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5jcmVhdGVDbGFzc2UoZmlsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChsb2cpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkZpY2hpZXIgbm9uIHRyb3V2w6kgOiBcIiArIG5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRNZWRpYUZyb21MaW5rKGxpbms6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy5yZWFkTGlua0ZpbGUobGluaywgdHJ1ZSk7XHJcbiAgICAgICAgY29uc3QgZmlsZSA9IChhd2FpdCB0aGlzLmFwcC5saXN0RmlsZXMoKSkuZmluZCgoZiA6IElGaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBmLnBhdGggPT09IHBhdGh9KTtcclxuICAgICAgICBpZiAoZmlsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmlsZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHRyeSB3aXRoIHRoZSBmaWxlIG5hbWVcclxuICAgICAgICBsZXQgZmlsZU5hbWUgPSB0aGlzLnJlYWRMaW5rRmlsZShsaW5rKTtcclxuICAgICAgICBjb25zdCBmaWxlcyA9IChhd2FpdCB0aGlzLmFwcC5saXN0RmlsZXMoKSkuZmlsdGVyKChmIDogSUZpbGUpID0+IGYubmFtZSA9PT0gZmlsZU5hbWUpO1xyXG4gICAgICAgIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGxldCBmaWxlID0gZmlsZXNbMF07XHJcbiAgICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiUGx1c2lldXJzIGZpY2hpZXJzIHRyb3V2w6lzIHBvdXIgbGUgbGllbiBzYW5zIGNoZW1pbiA6IFwiICsgbGluaywgZmlsZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmaWxlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc29sZS5lcnJvcihcIk1lZGlhIG5vbiB0cm91dsOpIDogXCIgKyBsaW5rKTtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvKlxyXG4gICAgZ2V0RnJvbUZvbGRlcihmb2xkZXI6IEZvbGRlcikge1xyXG4gICAgICAgIGxldCBuYW1lID0gZm9sZGVyLnBhdGguc3BsaXQoXCIvXCIpW2ZvbGRlci5wYXRoLnNwbGl0KFwiL1wiKS5sZW5ndGggLSAxXTtcclxuICAgICAgICBmb3IgKGxldCBmaWxlIG9mIGZvbGRlci5jaGlsZHJlbiB8fCBbXSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hcHAuaXNURmlsZShmaWxlKSAmJiBmaWxlLm5hbWUuaW5jbHVkZXMobmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEZyb21GaWxlKGZpbGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJMZSBkb3NzaWVyIG4nYSBwYXMgZGUgZmljaGllciBjbGFzc2UgOiBcIiArIGZvbGRlci5wYXRoKTtcclxuICAgIH0qL1xyXG5cclxuICAgIGFzeW5jIGdldEZyb21GaWxlKGZpbGU6IElGaWxlKTogUHJvbWlzZTxDbGFzc2UgfCB1bmRlZmluZWQ+IHtcclxuICAgICAgICBpZiAodGhpcy5hcHAuaXNGb2xkZXIoZmlsZSkpIHtcclxuICAgICAgICAgICAgbGV0IGZpbGVQYXRoID0gZmlsZS5wYXRoICsgXCIvXCIgKyBmaWxlLm5hbWU7XHJcbiAgICAgICAgICAgIGxldCBpRmlsZSA9IGF3YWl0IHRoaXMuYXBwLmdldEZpbGUoZmlsZVBhdGgpXHJcbiAgICAgICAgICAgIGlmICghaUZpbGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJMZSBkb3NzaWVyIG4nYSBwYXMgZGUgZmljaGllciBjbGFzc2UgOiBcIiArIGZpbGUucGF0aCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgZXhpc3RpbmdDbGFzcyA9IHRoaXMuZmlsZXNbZmlsZS5wYXRoXTtcclxuICAgICAgICBpZiAoZXhpc3RpbmdDbGFzcykgeyByZXR1cm4gZXhpc3RpbmdDbGFzczsgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBjbGFzc2U6IENsYXNzZSB8IHVuZGVmaW5lZDtcclxuICAgICAgICBcclxuICAgICAgICBjbGFzc2UgPSBhd2FpdCB0aGlzLmNyZWF0ZUNsYXNzZShmaWxlKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGNsYXNzZTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgY3JlYXRlRmlsZShjbGFzc2VUeXBlOiBudWxsIHwgdHlwZW9mIENsYXNzZSA9IG51bGwsIG5hbWU6IHN0cmluZyA9IFwiXCIsIGFyZ3M6IHtwYXJlbnQ/IDogQ2xhc3NlfSA9IHt9KTogUHJvbWlzZTxGaWxlIHwgdW5kZWZpbmVkPiB7XHJcbiAgICAgICAgLy8gQ3JlYXRlIHRoZSBuZXcgZmlsZSBmcm9tIHRoZSBjbGFzc05hbWUgdGVtcGxhdGVcclxuICAgICAgICBpZiAoIWNsYXNzZVR5cGUpIHtcclxuICAgICAgICAgICAgY29uc3QgZHluYW1pY0NsYXNzZXMgPSBPYmplY3Qua2V5cyhWYXVsdC5jbGFzc2VzKTtcclxuICAgICAgICAgICAgY2xhc3NlVHlwZSA9IGF3YWl0IHRoaXMuYXBwLnNlbGVjdENsYXNzZSh0aGlzLCBkeW5hbWljQ2xhc3NlcywgXCJRdWVsbGUgY2xhc3NlIHBvdXIgY2UgZmljaGllciA/XCIpO1xyXG4gICAgICAgICAgICBpZiAoIWNsYXNzZVR5cGUpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiQXJncyA7IFwiLGFyZ3MpXHJcbiAgICAgICAgaWYgKCFuYW1lKSB7XHJcbiAgICAgICAgICAgIGxldCBjbGFzc2UgPSBhd2FpdCB0aGlzLmFwcC5zZWxlY3RGaWxlKHRoaXMsIFtjbGFzc2VUeXBlLm5hbWVdLCB7aGludDpcIkVudHJlciB1biBub20gcG91ciBjZSBmaWNoaWVyXCIsIGNsYXNzZUFyZ3M6IGFyZ3N9KTtcclxuICAgICAgICAgICAgLy8gU2VsZWN0IEZpbGUgY2FsbCBjcmVhdGVGaWxlIGlmIHRoZSBmaWxlIGRvZXNuJ3QgZXhpc3RcclxuICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBjb250aW51ZVxyXG4gICAgICAgICAgICByZXR1cm4gY2xhc3NlPy5maWxlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgdGVtcGxhdGVQYXRoID0gdGhpcy5zZXR0aW5ncy50ZW1wbGF0ZUZvbGRlciArIFwiL1wiICsgY2xhc3NlVHlwZS5uYW1lICsgXCIubWRcIjtcclxuICAgICAgICBjb25zdCB0ZW1wbGF0ZUZpbGUgPSBhd2FpdCB0aGlzLmFwcC5nZXRGaWxlKHRlbXBsYXRlUGF0aCk7XHJcbiAgICAgICAgY29uc3QgbmV3RmlsZVBhdGggPSBuYW1lLmluY2x1ZGVzKFwiLm1kXCIpID8gbmFtZSA6IGAke25hbWV9Lm1kYDtcclxuICAgICAgICBsZXQgdGVtcGxhdGVDb250ZW50ID0gXCItLS1cXG5DbGFzc2U6IFwiICsgY2xhc3NlVHlwZS5uYW1lICsgXCJcXG4tLS1cXG5cIjtcclxuXHJcbiAgICAgICAgaWYgKHRlbXBsYXRlRmlsZSAmJiAoYXdhaXQgdGhpcy5hcHAuaXNGaWxlKHRlbXBsYXRlRmlsZSkpKSB7XHJcbiAgICAgICAgICAgIHRlbXBsYXRlQ29udGVudCA9IGF3YWl0IHRoaXMuYXBwLnJlYWRGaWxlKHRlbXBsYXRlRmlsZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiTGUgZmljaGllciB0ZW1wbGF0ZSBuJ2V4aXN0ZSBwYXMgOlwiICsgdGVtcGxhdGVQYXRoICsgXCIuIFVuIGZpY2hpZXIgdmlkZSBzZXJhIGNyw6nDqS5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBmaWxlOiBGaWxlIHwgbnVsbCA9IG51bGw7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZmlsZSA9IG5ldyBGaWxlKHRoaXMsIGF3YWl0IHRoaXMuYXBwLmNyZWF0ZUZpbGUobmV3RmlsZVBhdGgsIHRlbXBsYXRlQ29udGVudCkpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5vdXZlYXUgZmljaGllciBjcsOpw6kgOiBcIiArIG5ld0ZpbGVQYXRoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAvLyBNb2RpZmllciBsZSBmaWNoaWVyIHMnaWwgZXhpc3RlIGTDqWrDoFxyXG4gICAgICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5hcHAuZ2V0RmlsZShuZXdGaWxlUGF0aCk7XHJcbiAgICAgICAgICAgIGlmICghZmlsZSkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJMZSBmaWNoaWVyIG4nYSBwYXMgcHUgw6p0cmUgY3LDqcOpIG91IG1vZGlmacOpIDogXCIgKyBuZXdGaWxlUGF0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGZpbGUgJiYgdGhpcy5hcHAuaXNGaWxlKGZpbGUpKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC53cml0ZUZpbGUoZmlsZSwgdGVtcGxhdGVDb250ZW50KTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRmljaGllciBtb2RpZmnDqSA6IFwiICsgbmV3RmlsZVBhdGgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJMZSBmaWNoaWVyIG4nYSBwYXMgcHUgw6p0cmUgY3LDqcOpIG91IG1vZGlmacOpIDogXCIgKyBuZXdGaWxlUGF0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghZmlsZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBFcnJvcihcIkxlIGZpY2hpZXIgbidleGlzdGUgcGFzIDogXCIgKyBuZXdGaWxlUGF0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGF3YWl0IHRoaXMuYXBwLndhaXRGb3JGaWxlTWV0YURhdGFVcGRhdGUoZmlsZS5wYXRoLCBcIkNsYXNzZVwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDApKTtcclxuICAgICAgICAgICAgaWYgKCFmaWxlKSB7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBsZXQgY2xhc3NlID0gYXdhaXQgdGhpcy5nZXRGcm9tRmlsZShmaWxlKTtcclxuICAgICAgICAgICAgaWYgKCFjbGFzc2UpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJDbGFzc2Ugbm9uIHRyb3V2w6llIHBvdXIgbGUgZmljaGllciA6IFwiICsgZmlsZS5wYXRoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhd2FpdCBjbGFzc2Uub25DcmVhdGUoKTtcclxuICAgICAgICAgICAgYXdhaXQgY2xhc3NlLm9uVXBkYXRlKCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ2xhc3NlIGNyw6nDqWUgOiBcIiArIGNsYXNzZS5uYW1lKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZmlsZTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyByZWZyZXNoQWxsKCkge1xyXG4gICAgICAgIC8vIE1vdmUgYWxsIGZpbGVzIFxyXG4gICAgICAgIGxldCB3YXRjaGVkRmlsZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgZmlsZSBvZiBhd2FpdCB0aGlzLmFwcC5saXN0RmlsZXMoKSkge1xyXG4gICAgICAgICAgICBpZiAod2F0Y2hlZEZpbGVzLmluY2x1ZGVzKGZpbGUubmFtZSkgfHwgZmlsZS5wYXRoLnN0YXJ0c1dpdGgoXCJPdXRpbHNcIikpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUmVmcmVzaCA6IFwiICsgZmlsZS5wYXRoKTtcclxuICAgICAgICAgICAgY29uc3QgY2xhc3NlID0gYXdhaXQgdGhpcy5nZXRGcm9tRmlsZShmaWxlKTtcclxuICAgICAgICAgICAgaWYgKGNsYXNzZSkge1xyXG4gICAgICAgICAgICAgICAgY2xhc3NlLm9uVXBkYXRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgZHVwbGljYXRlc1xyXG4gICAgICAgICAgICAvKlxyXG4gICAgICAgICAgICBmb3IgKGxldCBmaWxlMiBvZiB0aGlzLmFwcC52YXVsdC5nZXRGaWxlcygpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBDb21wYXJlIHRoZSBuYW1lXHJcbiAgICAgICAgICAgICAgICBpZiAoZmlsZS5uYW1lID09PSBmaWxlMi5uYW1lICYmIGZpbGUucGF0aCAhPSBmaWxlMi5wYXRoICYmIHRoaXMuZ2V0RnJvbUZpbGUoZmlsZSk/LmdldENsYXNzZSgpID09PSB0aGlzLmdldEZyb21GaWxlKGZpbGUyKT8uZ2V0Q2xhc3NlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRG91YmxvbiBkZSBcXG5cIiArIGZpbGUucGF0aCArIFwiXFxuXCIgKyBmaWxlMi5wYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBLZWVwIHRoZSBmaXJzdCBieSBkZWZhdWx0XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQuZGVsZXRlKGZpbGUyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSovXHJcbiAgICAgICAgICAgIHdhdGNoZWRGaWxlcy5wdXNoKGZpbGUubmFtZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBSZW1vdmUgZW1wdHkgZm9sZGVycyBcclxuICAgICAgICBmb3IgKGxldCBmb2xkZXIgb2YgYXdhaXQgdGhpcy5hcHAubGlzdEZvbGRlcnMoKSkge1xyXG4gICAgICAgICAgICBpZiAoZm9sZGVyLmNoaWxkcmVuICYmIGZvbGRlci5jaGlsZHJlbi5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLmRlbGV0ZShmb2xkZXIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmFwcC5zZW5kTm90aWNlKFwiVmF1bHQgcmVmcmVzaFwiKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBjcmVhdGVDbGFzc2UoZmlsZTogSUZpbGUpIHtcclxuICAgICAgICBsZXQgZmlsZUluc3RhbmNlOiBGaWxlO1xyXG4gICAgICAgIGlmICghKGZpbGUgaW5zdGFuY2VvZiBGaWxlKSl7XHJcbiAgICAgICAgICAgIGZpbGVJbnN0YW5jZSA9IG5ldyBGaWxlKHRoaXMsIGZpbGUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpbGVJbnN0YW5jZSA9IGZpbGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgdGhpcy5hcHAuZ2V0TWV0YWRhdGEoZmlsZUluc3RhbmNlKTtcclxuICAgICAgICBpZiAoIW1ldGFkYXRhKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJQYXMgZGUgbWV0YWRhdGFcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgY2xhc3NOYW1lID0gbWV0YWRhdGFbXCJDbGFzc2VcIl07XHJcbiAgICAgICAgaWYgKCFjbGFzc05hbWUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIlBhcyBkZSBjbGFzc2UgZMOpZmluaWUgZGFucyBsZXMgbcOpdGFkb25uw6llc1wiKTtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIFVzZSB0aGUgZHluYW1pYyBjbGFzcyBmYWN0b3J5IHRvIGdldCB0aGUgY29uc3RydWN0b3JcclxuICAgICAgICAgICAgaWYgKFZhdWx0LmR5bmFtaWNDbGFzc0ZhY3RvcnkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yID0gYXdhaXQgVmF1bHQuZHluYW1pY0NsYXNzRmFjdG9yeS5nZXRDbGFzcyhjbGFzc05hbWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbnN0cnVjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvcih0aGlzLCBmaWxlSW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBGYWxsYmFjayB0byBzdGF0aWMgY2xhc3NlcyBpZiBkeW5hbWljIGZhY3RvcnkgaXMgbm90IGF2YWlsYWJsZVxyXG4gICAgICAgICAgICBsZXQgY29uc3RydWN0b3IgPSBWYXVsdC5jbGFzc2VzW2NsYXNzTmFtZV07XHJcbiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3Rvcikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvcih0aGlzLCBmaWxlSW5zdGFuY2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiVHlwZSBub24gY29ubnVlIDogXCIgKyBjbGFzc05hbWUpO1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJldXIgbG9ycyBkZSBsYSBjcsOpYXRpb24gZGUgbGEgY2xhc3NlIDogXCIgKyBjbGFzc05hbWUsIGVycm9yKTtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXSwidmVyc2lvbiI6M30=