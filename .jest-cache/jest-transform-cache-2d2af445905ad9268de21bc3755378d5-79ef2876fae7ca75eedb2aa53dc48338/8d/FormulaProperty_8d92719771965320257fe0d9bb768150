e634de8485e5f33e05c8bc1a8d04d76f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FormulaProperty = void 0;
const LinkProperty_1 = require("./LinkProperty");
class FormulaProperty extends LinkProperty_1.LinkProperty {
    constructor(name, formula, args = { icon: "", static: true, write: false }) {
        super(name, args);
        this.type = "formula";
        this.write = false;
        this.formula = formula;
        this.write = args.write ?? false;
    }
    validate(value) {
        return value;
    }
    read(file) {
        // Get all properties from the file
        const allFileProperties = file.getAllProperties() || {};
        // Convert properties to their actual values
        const allProperties = {};
        for (const [key, prop] of Object.entries(allFileProperties)) {
            if (key !== this.name) { // Exclude self to avoid circular reference
                allProperties[key] = file.getMetadataValue(key);
            }
        }
        try {
            const sanitizedProperties = Object.keys(allProperties).reduce((acc, key) => {
                const sanitizedKey = key.replace(/\s+/g, "");
                acc[sanitizedKey] = allProperties[key];
                return acc;
            }, {});
            const formulaContent = `
                    const properties = ${JSON.stringify(sanitizedProperties)};
                    const name = "${file.getName(false)}";
                    const { ${Object.keys(sanitizedProperties).join(", ")} } = properties;
                    ${this.formula.includes("return") ? "" : "return "}${this.formula};
                `;
            const formulaFunction = new Function("vault", "file", formulaContent);
            let value = formulaFunction(file.vault, file);
            if (this.write) {
                let currentValue = file.getMetadataValue(this.name);
                if (currentValue !== value) {
                    file.updateMetadata(this.name, value);
                }
            }
            return value;
        }
        catch (error) {
            if (error instanceof ReferenceError) {
                console.error("Formula error : " + this.formula + "\n\n"
                    + error
                    + "\n\nThis is all the properties available : ", Object.keys(allProperties).join(", "));
            }
            else {
                console.error("Formula error : " + this.formula + "\n\n" + error);
            }
            return null;
        }
    }
    getPretty(value) {
        if (!value)
            return value;
        if (typeof value !== "string") {
            console.error("Value is not a string:", value);
            return value;
        }
        // Check if it's a date
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/; // Matches "YYYY-MM-DD"
        if (dateRegex.test(value)) {
            const parsedDate = new Date(value);
            return parsedDate.toLocaleDateString("fr-FR", {
                day: "numeric",
                month: "long",
                year: "numeric"
            });
        }
        if (!isNaN(Number(value)) && Number.isInteger(Number(value))) {
            return Number(value).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        return value.replace(/^https?:\/\//, "").replace("[[", "").replace("]]", "");
    }
    getLink(value) {
        if (!value)
            return value;
        // Check if it's an email
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (emailRegex.test(value)) {
            return `mailto:${value}`;
        }
        // Check if it's an Obsidian link [[...]]
        const obsidianLinkRegex = /\[\[([^\]]+)\]\]/;
        try {
            const match = value.match(obsidianLinkRegex);
            if (match && match[1]) {
                return `obsidian://open?vault=${this.vault.app.vault.getName()}&file=${encodeURIComponent(this.vault.readLinkFile(match[1], true)[1])}`;
            }
            // Check if it's a valid URL
            const urlRegex = /^(https?:\/\/)?([a-zA-Z0-9_-]+\.)+[a-zA-Z]{2,6}(\/[a-zA-Z0-9_-]+)*\/?$/;
            if (urlRegex.test(value)) {
                return value.startsWith("http") ? value : `http://${value}`;
            }
        }
        catch (error) {
            console.error(`Error parsing link for ${value}:`, error);
        }
        return value;
    }
}
exports.FormulaProperty = FormulaProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXEZvcm11bGFQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFDQSxpREFBOEM7QUFFOUMsTUFBYSxlQUFnQixTQUFRLDJCQUFZO0lBTTdDLFlBQVksSUFBYSxFQUFFLE9BQWUsRUFBRSxPQUEyRCxFQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFDO1FBQ3pJLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFKTixTQUFJLEdBQVksU0FBUyxDQUFDO1FBQ25DLFVBQUssR0FBYSxLQUFLLENBQUM7UUFJM0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQztJQUNyQyxDQUFDO0lBRVEsUUFBUSxDQUFDLEtBQWE7UUFDM0IsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVRLElBQUksQ0FBQyxJQUFVO1FBQ3BCLG1DQUFtQztRQUNuQyxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUN4RCw0Q0FBNEM7UUFDNUMsTUFBTSxhQUFhLEdBQXdCLEVBQUUsQ0FBQztRQUU5QyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7WUFDMUQsSUFBSSxHQUFHLEtBQUssSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsMkNBQTJDO2dCQUNoRSxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdB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LFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzVJLENBQUM7WUFFRCw0QkFBNEI7WUFDNUIsTUFBTSxRQUFRLEdBQUcsd0VBQXdFLENBQUM7WUFDMUYsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZCLE9BQU8sS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxVQUFVLEtBQUssRUFBRSxDQUFDO1lBQ2hFLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEtBQUssR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdELENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0NBRUo7QUF4SEQsMENBd0hDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFxwcm9wZXJ0aWVzXFxGb3JtdWxhUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmlsZSB9IGZyb20gJy4uL3ZhdWx0L0ZpbGUnO1xyXG5pbXBvcnQgeyBMaW5rUHJvcGVydHkgfSBmcm9tICcuL0xpbmtQcm9wZXJ0eSc7XHJcblxyXG5leHBvcnQgY2xhc3MgRm9ybXVsYVByb3BlcnR5IGV4dGVuZHMgTGlua1Byb3BlcnR5IHtcclxuXHJcbiAgICBwdWJsaWMgZm9ybXVsYSA6IHN0cmluZztcclxuICAgIHB1YmxpYyBvdmVycmlkZSB0eXBlIDogc3RyaW5nID0gXCJmb3JtdWxhXCI7XHJcbiAgICBwdWJsaWMgd3JpdGUgOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IobmFtZSA6IHN0cmluZywgZm9ybXVsYTogc3RyaW5nLCBhcmdzIDoge2ljb246IHN0cmluZywgc3RhdGljPzogYm9vbGVhbiwgd3JpdGU/OiBib29sZWFufSA9IHtpY29uOiBcIlwiLCBzdGF0aWM6IHRydWUsIHdyaXRlOiBmYWxzZX0pIHtcclxuICAgICAgICBzdXBlcihuYW1lLCBhcmdzKTtcclxuICAgICAgICB0aGlzLmZvcm11bGEgPSBmb3JtdWxhO1xyXG4gICAgICAgIHRoaXMud3JpdGUgPSBhcmdzLndyaXRlID8/IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIHZhbGlkYXRlKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSByZWFkKGZpbGU6IEZpbGUpIDogYW55IHtcclxuICAgICAgICAvLyBHZXQgYWxsIHByb3BlcnRpZXMgZnJvbSB0aGUgZmlsZVxyXG4gICAgICAgIGNvbnN0IGFsbEZpbGVQcm9wZXJ0aWVzID0gZmlsZS5nZXRBbGxQcm9wZXJ0aWVzKCkgfHwge307XHJcbiAgICAgICAgLy8gQ29udmVydCBwcm9wZXJ0aWVzIHRvIHRoZWlyIGFjdHVhbCB2YWx1ZXNcclxuICAgICAgICBjb25zdCBhbGxQcm9wZXJ0aWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgICAgICAgXHJcbiAgICAgICAgZm9yIChjb25zdCBba2V5LCBwcm9wXSBvZiBPYmplY3QuZW50cmllcyhhbGxGaWxlUHJvcGVydGllcykpIHtcclxuICAgICAgICAgICAgaWYgKGtleSAhPT0gdGhpcy5uYW1lKSB7IC8vIEV4Y2x1ZGUgc2VsZiB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VcclxuICAgICAgICAgICAgICAgIGFsbFByb3BlcnRpZXNba2V5XSA9IGZpbGUuZ2V0TWV0YWRhdGFWYWx1ZShrZXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbml0aXplZFByb3BlcnRpZXMgPSBPYmplY3Qua2V5cyhhbGxQcm9wZXJ0aWVzKS5yZWR1Y2UoKGFjYzogUmVjb3JkPHN0cmluZywgYW55Piwga2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzYW5pdGl6ZWRLZXk6IHN0cmluZyA9IGtleS5yZXBsYWNlKC9cXHMrL2csIFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgYWNjW3Nhbml0aXplZEtleV0gPSBhbGxQcm9wZXJ0aWVzW2tleV07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgICAgICAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm11bGFDb250ZW50ID0gXHJcbiAgICAgICAgICAgICAgICBgXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvcGVydGllcyA9ICR7SlNPTi5zdHJpbmdpZnkoc2FuaXRpemVkUHJvcGVydGllcyl9O1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBcIiR7ZmlsZS5nZXROYW1lKGZhbHNlKX1cIjtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7ICR7T2JqZWN0LmtleXMoc2FuaXRpemVkUHJvcGVydGllcykuam9pbihcIiwgXCIpfSB9ID0gcHJvcGVydGllcztcclxuICAgICAgICAgICAgICAgICAgICAke3RoaXMuZm9ybXVsYS5pbmNsdWRlcyhcInJldHVyblwiKSA/IFwiXCIgOiBcInJldHVybiBcIn0ke3RoaXMuZm9ybXVsYX07XHJcbiAgICAgICAgICAgICAgICBgO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZm9ybXVsYUZ1bmN0aW9uID0gbmV3IEZ1bmN0aW9uKFwidmF1bHRcIiwgXCJmaWxlXCIsIGZvcm11bGFDb250ZW50KTtcclxuICAgICAgICAgICAgbGV0IHZhbHVlID0gZm9ybXVsYUZ1bmN0aW9uKGZpbGUudmF1bHQsIGZpbGUpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy53cml0ZSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGN1cnJlbnRWYWx1ZSA9IGZpbGUuZ2V0TWV0YWRhdGFWYWx1ZSh0aGlzLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSAhPT0gdmFsdWUpe1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGUudXBkYXRlTWV0YWRhdGEodGhpcy5uYW1lLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBSZWZlcmVuY2VFcnJvcil7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRm9ybXVsYSBlcnJvciA6IFwiICsgdGhpcy5mb3JtdWxhICsgXCJcXG5cXG5cIlxyXG4gICAgICAgICAgICAgICAgICAgICsgZXJyb3IgXHJcbiAgICAgICAgICAgICAgICAgICAgKyBcIlxcblxcblRoaXMgaXMgYWxsIHRoZSBwcm9wZXJ0aWVzIGF2YWlsYWJsZSA6IFwiLCBPYmplY3Qua2V5cyhhbGxQcm9wZXJ0aWVzKS5qb2luKFwiLCBcIikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkZvcm11bGEgZXJyb3IgOiBcIiArIHRoaXMuZm9ybXVsYSArIFwiXFxuXFxuXCIgKyBlcnJvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgb3ZlcnJpZGUgZ2V0UHJldHR5KHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoIXZhbHVlKSByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiVmFsdWUgaXMgbm90IGEgc3RyaW5nOlwiLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYSBkYXRlXHJcbiAgICAgICAgY29uc3QgZGF0ZVJlZ2V4ID0gL15cXGR7NH0tXFxkezJ9LVxcZHsyfSQvOyAvLyBNYXRjaGVzIFwiWVlZWS1NTS1ERFwiXHJcbiAgICAgICAgaWYgKGRhdGVSZWdleC50ZXN0KHZhbHVlKSkge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJzZWREYXRlID0gbmV3IERhdGUodmFsdWUpO1xyXG4gICAgICAgICAgICByZXR1cm4gcGFyc2VkRGF0ZS50b0xvY2FsZURhdGVTdHJpbmcoXCJmci1GUlwiLCB7XHJcbiAgICAgICAgICAgICAgICBkYXk6IFwibnVtZXJpY1wiLFxyXG4gICAgICAgICAgICAgICAgbW9udGg6IFwibG9uZ1wiLFxyXG4gICAgICAgICAgICAgICAgeWVhcjogXCJudW1lcmljXCJcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWlzTmFOKE51bWJlcih2YWx1ZSkpICYmIE51bWJlci5pc0ludGVnZXIoTnVtYmVyKHZhbHVlKSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZSkudG9Mb2NhbGVTdHJpbmcoXCJmci1GUlwiLHsgbWluaW11bUZyYWN0aW9uRGlnaXRzOiAyLCBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDIgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvXmh0dHBzPzpcXC9cXC8vLCBcIlwiKS5yZXBsYWNlKFwiW1tcIiwgXCJcIikucmVwbGFjZShcIl1dXCIsIFwiXCIpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSBnZXRMaW5rKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGlmICghdmFsdWUpIHJldHVybiB2YWx1ZTtcclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhbiBlbWFpbFxyXG4gICAgICAgIGNvbnN0IGVtYWlsUmVnZXggPSAvXlthLXpBLVowLTkuXyUrLV0rQFthLXpBLVowLTkuLV0rXFwuW2EtekEtWl17Mix9JC87XHJcbiAgICAgICAgaWYgKGVtYWlsUmVnZXgudGVzdCh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGBtYWlsdG86JHt2YWx1ZX1gO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhbiBPYnNpZGlhbiBsaW5rIFtbLi4uXV1cclxuICAgICAgICBjb25zdCBvYnNpZGlhbkxpbmtSZWdleCA9IC9cXFtcXFsoW15cXF1dKylcXF1cXF0vO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gdmFsdWUubWF0Y2gob2JzaWRpYW5MaW5rUmVnZXgpO1xyXG4gICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMV0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgb2JzaWRpYW46Ly9vcGVuP3ZhdWx0PSR7dGhpcy52YXVsdC5hcHAudmF1bHQuZ2V0TmFtZSgpfSZmaWxlPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMudmF1bHQucmVhZExpbmtGaWxlKG1hdGNoWzFdLCB0cnVlKVsxXSl9YDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIHZhbGlkIFVSTFxyXG4gICAgICAgICAgICBjb25zdCB1cmxSZWdleCA9IC9eKGh0dHBzPzpcXC9cXC8pPyhbYS16QS1aMC05Xy1dK1xcLikrW2EtekEtWl17Miw2fShcXC9bYS16QS1aMC05Xy1dKykqXFwvPyQvO1xyXG4gICAgICAgICAgICBpZiAodXJsUmVnZXgudGVzdCh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zdGFydHNXaXRoKFwiaHR0cFwiKSA/IHZhbHVlIDogYGh0dHA6Ly8ke3ZhbHVlfWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBwYXJzaW5nIGxpbmsgZm9yICR7dmFsdWV9OmAsIGVycm9yKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbn0iXSwidmVyc2lvbiI6M30=