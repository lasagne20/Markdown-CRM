1c4838f25bee63fa2663a51eb635e755
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.File = exports.Folder = void 0;
const js_yaml_1 = require("js-yaml");
class Folder {
}
exports.Folder = Folder;
class File {
    constructor(vault, file) {
        this.linkRegex = /^"?\[\[(.*?)\]\]"?$/;
        this.vault = vault;
        this.file = file;
        this.lock = false;
        this.name = file.name;
        this.path = file.path;
        this.basename = file.basename;
        this.extension = file.extension;
    }
    getFolderPath() {
        return this.file.path.substring(0, this.file.path.lastIndexOf("/"));
    }
    getFile() {
        return this.file;
    }
    isFolderFile() {
        // Return true if the file is also a folder
        return this.file.path.substring(0, this.file.path.lastIndexOf("/")).endsWith(this.getName().replace(".md", ""));
    }
    getFolderFilePath() {
        // Return the folderFile path
        let path = this.getFolderPath();
        if (this.isFolderFile()) {
            return path;
        }
        return path + "/" + this.getName(false);
    }
    getParentFolderPath() {
        let path = this.getFolderPath();
        if (this.isFolderFile()) {
            path = path.substring(0, path.lastIndexOf("/"));
        }
        return path;
    }
    getName(md = true) {
        if (md) {
            return this.file.name;
        }
        return this.file.name.replace(".md", "");
    }
    async getID() {
        let id = (await this.getMetadata())?.Id;
        if (!id) {
            id = require("uuid").v4();
            this.updateMetadata("Id", id);
        }
        return id;
    }
    getPath() {
        // Return the file path
        return this.file.path;
    }
    getLink() {
        return `[[${this.getPath()}|${this.getName(false)}]]`;
    }
    async move(targetFolderPath, targetFileName) {
        if (this.lock) {
            while (this.lock) {
                await new Promise(resolve => setTimeout(resolve, 100));
                console.log("Waiting for lock");
            }
        }
        ;
        this.lock = true;
        if (!targetFileName) {
            targetFileName = this.getName();
        }
        try {
            // Check if the folder of the target pathname exist
            let subtargetPath = targetFolderPath + "/" + targetFileName;
            const folder = await this.vault.app.getFile(subtargetPath);
            if (folder) {
                targetFolderPath = subtargetPath;
            }
            // Check if we need to move the file or the folder
            let moveFile = this.file;
            let newFilePath = `${targetFolderPath}/${targetFileName}`;
            if (this.isFolderFile()) {
                let folder = await this.vault.app.getFile(this.getFolderPath());
                if (folder) {
                    moveFile = folder;
                    newFilePath = newFilePath.replace(".md", "");
                }
            }
            // Vérification si le fichier cible existe déjà
            const existingFile = await this.vault.app.getFile(newFilePath);
            if (existingFile) {
                console.log('Le fichier existe déjà, impossible de déplacer.');
                this.lock = false;
                return;
            }
            try {
                // Essayer de déplacer le fichier
                if (moveFile) {
                    await this.vault.app.renameFile(moveFile, newFilePath);
                    console.log(`Fichier déplacé vers ${newFilePath}`);
                }
            }
            catch (error) {
                console.error('Erreur lors du déplacement du fichier :', error);
            }
        }
        finally {
            this.lock = false;
        }
    }
    getFromLink(name) {
        return this.vault.getFromLink(name);
    }
    async getMetadata() {
        let metadata = await this.vault.app.getMetadata(this.file);
        return metadata;
    }
    async getMetadataValue(key) {
        let metadata = await this.getMetadata();
        return metadata ? metadata[key] : undefined;
    }
    getAllProperties() {
        let metadata = this.getMetadata();
        if (!metadata)
            return {};
        // Return property objects that match the expected format
        const properties = {};
        for (const key in metadata) {
            properties[key] = { name: key };
        }
        return properties;
    }
    async updateMetadata(key, value) {
        if (this.lock) {
            while (this.lock) {
                await new Promise(resolve => setTimeout(resolve, 100));
                console.log("Waiting for lock");
            }
        }
        ;
        this.lock = true;
        try {
            console.log("Update metadata on " + this.getName() + " : " + key + " --> " + value);
            const fileContent = await this.vault.app.readFile(this.file);
            const { body } = this.extractFrontmatter(fileContent);
            const { existingFrontmatter } = this.extractFrontmatter(fileContent);
            if (!existingFrontmatter) {
                this.lock = false;
                return;
            }
            try {
                let frontmatter = (0, js_yaml_1.load)(existingFrontmatter);
                if (!frontmatter) {
                    this.lock = false;
                    return;
                }
                ;
                frontmatter[key] = value;
                const newFrontmatter = (0, js_yaml_1.dump)(frontmatter);
                const newContent = `---\n${newFrontmatter}\n---\n${body}`; //${extraText}
                await this.vault.app.writeFile(this.file, newContent);
                await this.vault.app.waitForFileMetaDataUpdate(this.getPath(), key, async () => { return; });
                console.log("Metdata updated");
            }
            catch (error) {
                console.error("❌ Erreur lors du parsing du frontmatter:", error);
            }
        }
        finally {
            this.lock = false;
        }
    }
    async removeMetadata(key) {
        console.log("Remove metadata " + key);
        const frontmatter = await this.getMetadata();
        if (!frontmatter)
            return;
        delete frontmatter[key];
        await this.saveFrontmatter(frontmatter);
    }
    async reorderMetadata(propertiesOrder) {
        const frontmatter = this.getMetadata();
        if (!frontmatter)
            return;
        propertiesOrder.push("Id");
        if (JSON.stringify(propertiesOrder) === JSON.stringify(Object.keys(frontmatter)))
            return;
        console.log("Re-order metadata");
        // Sort properties and extract extra ones
        const { sortedFrontmatter, extraProperties } = this.sortFrontmatter(frontmatter, propertiesOrder);
        await this.saveFrontmatter(sortedFrontmatter, extraProperties);
    }
    async saveFrontmatter(frontmatter, extraProperties = []) {
        const fileContent = await this.vault.app.readFile(this.file);
        const { body } = this.extractFrontmatter(fileContent);
        // Reformater le frontmatter
        const newFrontmatter = (0, js_yaml_1.dump)(frontmatter);
        const filteredExtraProperties = extraProperties.filter(prop => prop && prop.trim() !== "");
        //const extraText = filteredExtraProperties.length > 0 ? `\n${filteredExtraProperties.join("\n")}` : "";
        // Sauvegarde du fichier
        const newContent = `---\n${newFrontmatter}\n---\n${body}`; //${extraText}
        await this.vault.app.writeFile(this.file, newContent);
        console.log("Updated file");
    }
    // Extraire le frontmatter et le reste du contenu
    extractFrontmatter(content) {
        const frontmatterRegex = /^---\n([\s\S]+?)\n---\n/;
        const match = content.match(frontmatterRegex);
        return {
            existingFrontmatter: match ? match[1] : "",
            body: match ? content.replace(match[0], "") : content,
        };
    }
    // Trier les propriétés et identifier celles en surplus
    // Méthode simple pour les tests
    formatFrontmatter(frontmatter) {
        return (0, js_yaml_1.dump)(frontmatter);
    }
    sortFrontmatter(frontmatter, propertiesOrder) {
        let sortedFrontmatter = {};
        let extraProperties = [];
        propertiesOrder.forEach(prop => {
            if (prop in frontmatter) {
                sortedFrontmatter[prop] = frontmatter[prop];
            }
            else {
                sortedFrontmatter[prop] = null;
            }
        });
        Object.keys(frontmatter).forEach(prop => {
            if (!propertiesOrder.includes(prop)) {
                extraProperties.push(`${prop}: ${JSON.stringify(frontmatter[prop])}`);
            }
        });
        return { sortedFrontmatter, extraProperties };
    }
}
exports.File = File;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHZhdWx0XFxGaWxlLnRzIiwibWFwcGluZ3MiOiI7OztBQUdBLHFDQUFrRDtBQUVsRCxNQUFhLE1BQU07Q0FFbEI7QUFGRCx3QkFFQztBQUVELE1BQWEsSUFBSTtJQWNiLFlBQVksS0FBYSxFQUFFLElBQVc7UUFQL0IsY0FBUyxHQUFHLHFCQUFxQixDQUFDO1FBUXZDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFBO1FBRWpCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzlCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUVsQyxDQUFDO0lBRUQsYUFBYTtRQUNYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNyRSxDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQTtJQUNsQixDQUFDO0lBRUQsWUFBWTtRQUNWLDJDQUEyQztRQUMzQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDakgsQ0FBQztJQUVELGlCQUFpQjtRQUNmLDZCQUE2QjtRQUM3QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDL0IsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUMsQ0FBQztZQUN2QixPQUFPLElBQUksQ0FBQTtRQUNiLENBQUM7UUFDRCxPQUFPLElBQUksR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN6QyxDQUFDO0lBRUQsbUJBQW1CO1FBQ2pCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtRQUMvQixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUUsRUFBQyxDQUFDO1lBQ3ZCLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDakQsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELE9BQU8sQ0FBQyxFQUFFLEdBQUMsSUFBSTtRQUNiLElBQUksRUFBRSxFQUFDLENBQUM7WUFDTixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFBO1FBQ3ZCLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUMsRUFBRSxDQUFDLENBQUE7SUFDekMsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsSUFBSSxFQUFFLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQTtRQUN2QyxJQUFJLENBQUMsRUFBRSxFQUFDLENBQUM7WUFDUCxFQUFFLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFBO1lBQ3pCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQy9CLENBQUM7UUFDRCxPQUFPLEVBQUUsQ0FBQTtJQUNYLENBQUM7SUFFRCxPQUFPO1FBQ0wsdUJBQXVCO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUE7SUFDdkIsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLEtBQUssSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQTtJQUN2RCxDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBd0IsRUFBRSxjQUF1QjtRQUMxRCxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNqQixNQUFNLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUE7WUFDakMsQ0FBQztRQUNILENBQUM7UUFBQSxDQUFDO1FBQ0YsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLGNBQWMsRUFBQyxDQUFDO1lBQ25CLGNBQWMsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbEMsQ0FBQztRQUNELElBQUksQ0FBQztZQUNILG1EQUFtRDtZQUNuRCxJQUFJLGFBQWEsR0FBRyxnQkFBZ0IsR0FBRyxHQUFHLEdBQUcsY0FBYyxDQUFBO1lBQzNELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQzNELElBQUksTUFBTSxFQUFFLENBQUM7Z0JBQ1gsZ0JBQWdCLEdBQUcsYUFBYSxDQUFDO1lBQ25DLENBQUM7WUFFRCxrREFBa0Q7WUFDbEQsSUFBSSxRQUFRLEdBQVMsSUFBSSxDQUFDLElBQUksQ0FBQTtZQUM5QixJQUFJLFdBQVcsR0FBRyxHQUFHLGdCQUFnQixJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQzFELElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFDLENBQUM7Z0JBQ3ZCLElBQUksTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFBO2dCQUMvRCxJQUFJLE1BQU0sRUFBQyxDQUFDO29CQUNWLFFBQVEsR0FBRyxNQUFNLENBQUE7b0JBQ2pCLFdBQVcsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBQyxFQUFFLENBQUMsQ0FBQTtnQkFDN0MsQ0FBQztZQUNILENBQUM7WUFFRCwrQ0FBK0M7WUFDL0MsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDL0QsSUFBSSxZQUFZLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsR0FBRyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7Z0JBQy9ELElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO2dCQUNsQixPQUFPO1lBQ1gsQ0FBQztZQUVELElBQUksQ0FBQztnQkFDRCxpQ0FBaUM7Z0JBQ2pDLElBQUksUUFBUSxFQUFFLENBQUM7b0JBQ1gsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxDQUFDO29CQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUN2RCxDQUFDO1lBQ0wsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNwRSxDQUFDO1FBQ0gsQ0FBQztnQkFDTyxDQUFDO1lBQ0wsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7UUFDdEIsQ0FBQztJQUNMLENBQUM7SUFDRCxXQUFXLENBQUMsSUFBYTtRQUN2QixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFQyxLQUFLLENBQUMsV0FBVztRQUNmLElBQUksUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzRCxPQUFPLFFBQVEsQ0FBQTtJQUNqQixDQUFDO0lBRUQsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQVc7UUFDaEMsSUFBSSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDeEMsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzlDLENBQUM7SUFFRCxnQkFBZ0I7UUFDZCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLFFBQVE7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUN6Qix5REFBeUQ7UUFDekQsTUFBTSxVQUFVLEdBQXdCLEVBQUUsQ0FBQztRQUMzQyxLQUFLLE1BQU0sR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQzNCLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNsQyxDQUFDO1FBQ0QsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUdELEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBVyxFQUFFLEtBQVU7UUFDMUMsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDZCxPQUFPLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDakIsTUFBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDdkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1lBQ2pDLENBQUM7UUFDSCxDQUFDO1FBQUEsQ0FBQztRQUNGLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpCLElBQUksQ0FBQztZQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxHQUFFLEtBQUssR0FBRyxHQUFHLEdBQUcsT0FBTyxHQUFHLEtBQUssQ0FBQyxDQUFBO1lBQ2xGLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3RCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXRELE1BQU0sRUFBRSxtQkFBbUIsRUFBRSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUVyRSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztnQkFBQSxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztnQkFBQyxPQUFPO1lBQUEsQ0FBQztZQUV0RCxJQUFJLENBQUM7Z0JBQ0QsSUFBSSxXQUFXLEdBQUcsSUFBQSxjQUFTLEVBQUMsbUJBQW1CLENBQVEsQ0FBQztnQkFFeEQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUFBLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO29CQUFDLE9BQU87Z0JBQUEsQ0FBQztnQkFBQSxDQUFDO2dCQUMvQyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO2dCQUN6QixNQUFNLGNBQWMsR0FBRyxJQUFBLGNBQUksRUFBQyxXQUFXLENBQUMsQ0FBQztnQkFFekMsTUFBTSxVQUFVLEdBQUcsUUFBUSxjQUFjLFVBQVUsSUFBSSxFQUFFLENBQUMsQ0FBQyxjQUFjO2dCQUN6RSxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQzVGLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtZQUVsQyxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDYixPQUFPLENBQUMsS0FBSyxDQUFDLDBDQUEwQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3JFLENBQUM7UUFDSCxDQUFDO2dCQUNPLENBQUM7WUFDTCxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztRQUN0QixDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBVztRQUM5QixPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixHQUFHLEdBQUcsQ0FBQyxDQUFBO1FBQ3JDLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxXQUFXO1lBQUUsT0FBTztRQUN6QixPQUFPLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUN2QixNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlLENBQUMsZUFBeUI7UUFDM0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxXQUFXO1lBQUUsT0FBTztRQUV6QixlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRTFCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFBRSxPQUFPO1FBRXpGLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNqQyx5Q0FBeUM7UUFDekMsTUFBTSxFQUFFLGlCQUFpQixFQUFFLGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ2xHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBQyxXQUFnQyxFQUFFLGtCQUE0QixFQUFFO1FBQ2xGLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXRELDRCQUE0QjtRQUM1QixNQUFNLGNBQWMsR0FBRyxJQUFBLGNBQUksRUFBQyxXQUFXLENBQUMsQ0FBQztRQUN6QyxNQUFNLHVCQUF1QixHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzNGLHdHQUF3RztRQUd4Ryx3QkFBd0I7UUFDeEIsTUFBTSxVQUFVLEdBQUcsUUFBUSxjQUFjLFVBQVUsSUFBSSxFQUFFLENBQUMsQ0FBQyxjQUFjO1FBQ3pFLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDdEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQTtJQUMvQixDQUFDO0lBR0QsaURBQWlEO0lBQ2pELGtCQUFrQixDQUFDLE9BQWU7UUFDOUIsTUFBTSxnQkFBZ0IsR0FBRyx5QkFBeUIsQ0FBQztRQUNuRCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDOUMsT0FBTztZQUNILG1CQUFtQixFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQzFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPO1NBQ3hELENBQUM7SUFDTixDQUFDO0lBRUQsdURBQXVEO0lBQ3ZELGdDQUFnQztJQUNoQyxpQkFBaUIsQ0FBQyxXQUFnQztRQUM5QyxPQUFPLElBQUEsY0FBSSxFQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFRCxlQUFlLENBQUMsV0FBZ0MsRUFBRSxlQUF5QjtRQUN2RSxJQUFJLGlCQUFpQixHQUF3QixFQUFFLENBQUM7UUFDaEQsSUFBSSxlQUFlLEdBQWEsRUFBRSxDQUFDO1FBRW5DLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsSUFBSSxJQUFJLElBQUksV0FBVyxFQUFFLENBQUM7Z0JBQ3RCLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoRCxDQUFDO2lCQUFNLENBQUM7Z0JBQ0osaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ25DLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQ2xDLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDMUUsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGVBQWUsRUFBRSxDQUFDO0lBQ2xELENBQUM7Q0FDSjtBQWpSRCxvQkFpUkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHZhdWx0XFxGaWxlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElBcHAsIElGaWxlLCBJRm9sZGVyIH0gZnJvbSBcIi4uL2ludGVyZmFjZXMvSUFwcFwiO1xyXG5pbXBvcnQgeyBWYXVsdCB9IGZyb20gXCIuL1ZhdWx0XCI7XHJcbmltcG9ydCB7IHdhaXRGb3JGaWxlTWV0YURhdGFVcGRhdGUsIHdhaXRGb3JNZXRhRGF0YUNhY2hlVXBkYXRlIH0gZnJvbSBcIi4vVXRpbHNcIjtcclxuaW1wb3J0IHsgZHVtcCwgbG9hZCBhcyBwYXJzZVlhbWwgfSBmcm9tICdqcy15YW1sJztcclxuXHJcbmV4cG9ydCBjbGFzcyBGb2xkZXIge1xyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEZpbGUgaW1wbGVtZW50cyBJRmlsZSB7XHJcbiAgICAvKlxyXG4gICAgQWxsb3cgdG8gcXVpY2tseSB1c2UgZmlsZXMgbWV0aG9kc1xyXG4gICAgKi9cclxuICAgIHB1YmxpYyB2YXVsdCA6IFZhdWx0O1xyXG4gICAgcHVibGljIGZpbGU6IGFueTtcclxuICAgIHByaXZhdGUgbG9jayA6IGJvb2xlYW47XHJcbiAgICBwdWJsaWMgbGlua1JlZ2V4ID0gL15cIj9cXFtcXFsoLio/KVxcXVxcXVwiPyQvO1xyXG5cclxuICAgIHB1YmxpYyBuYW1lIDogc3RyaW5nO1xyXG4gICAgcHVibGljIHBhdGggOiBzdHJpbmc7XHJcbiAgICBwdWJsaWMgYmFzZW5hbWUgOiBzdHJpbmc7XHJcbiAgICBwdWJsaWMgZXh0ZW5zaW9uIDogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHZhdWx0IDogVmF1bHQsIGZpbGU6IElGaWxlKSB7XHJcbiAgICAgIHRoaXMudmF1bHQgPSB2YXVsdDtcclxuICAgICAgdGhpcy5maWxlID0gZmlsZTtcclxuICAgICAgdGhpcy5sb2NrID0gZmFsc2VcclxuXHJcbiAgICAgIHRoaXMubmFtZSA9IGZpbGUubmFtZTtcclxuICAgICAgdGhpcy5wYXRoID0gZmlsZS5wYXRoO1xyXG4gICAgICB0aGlzLmJhc2VuYW1lID0gZmlsZS5iYXNlbmFtZTtcclxuICAgICAgdGhpcy5leHRlbnNpb24gPSBmaWxlLmV4dGVuc2lvbjtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Rm9sZGVyUGF0aCgpe1xyXG4gICAgICByZXR1cm4gdGhpcy5maWxlLnBhdGguc3Vic3RyaW5nKDAsIHRoaXMuZmlsZS5wYXRoLmxhc3RJbmRleE9mKFwiL1wiKSlcclxuICAgIH1cclxuXHJcbiAgICBnZXRGaWxlKCl7XHJcbiAgICAgIHJldHVybiB0aGlzLmZpbGVcclxuICAgIH1cclxuXHJcbiAgICBpc0ZvbGRlckZpbGUoKXtcclxuICAgICAgLy8gUmV0dXJuIHRydWUgaWYgdGhlIGZpbGUgaXMgYWxzbyBhIGZvbGRlclxyXG4gICAgICByZXR1cm4gdGhpcy5maWxlLnBhdGguc3Vic3RyaW5nKDAsIHRoaXMuZmlsZS5wYXRoLmxhc3RJbmRleE9mKFwiL1wiKSkuZW5kc1dpdGgodGhpcy5nZXROYW1lKCkucmVwbGFjZShcIi5tZFwiLCBcIlwiKSlcclxuICAgIH1cclxuXHJcbiAgICBnZXRGb2xkZXJGaWxlUGF0aCgpe1xyXG4gICAgICAvLyBSZXR1cm4gdGhlIGZvbGRlckZpbGUgcGF0aFxyXG4gICAgICBsZXQgcGF0aCA9IHRoaXMuZ2V0Rm9sZGVyUGF0aCgpXHJcbiAgICAgIGlmICh0aGlzLmlzRm9sZGVyRmlsZSgpKXtcclxuICAgICAgICByZXR1cm4gcGF0aFxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBwYXRoICsgXCIvXCIgKyB0aGlzLmdldE5hbWUoZmFsc2UpXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGFyZW50Rm9sZGVyUGF0aCgpe1xyXG4gICAgICBsZXQgcGF0aCA9IHRoaXMuZ2V0Rm9sZGVyUGF0aCgpXHJcbiAgICAgIGlmICh0aGlzLmlzRm9sZGVyRmlsZSgpKXtcclxuICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHJpbmcoMCwgcGF0aC5sYXN0SW5kZXhPZihcIi9cIikpXHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHBhdGhcclxuICAgIH1cclxuXHJcbiAgICBnZXROYW1lKG1kPXRydWUpe1xyXG4gICAgICBpZiAobWQpe1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZpbGUubmFtZVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0aGlzLmZpbGUubmFtZS5yZXBsYWNlKFwiLm1kXCIsXCJcIilcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRJRCgpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgICBsZXQgaWQgPSAoYXdhaXQgdGhpcy5nZXRNZXRhZGF0YSgpKT8uSWRcclxuICAgICAgaWYgKCFpZCl7XHJcbiAgICAgICAgaWQgPSByZXF1aXJlKFwidXVpZFwiKS52NCgpXHJcbiAgICAgICAgdGhpcy51cGRhdGVNZXRhZGF0YShcIklkXCIsIGlkKVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBpZFxyXG4gICAgfVxyXG5cclxuICAgIGdldFBhdGgoKXtcclxuICAgICAgLy8gUmV0dXJuIHRoZSBmaWxlIHBhdGhcclxuICAgICAgcmV0dXJuIHRoaXMuZmlsZS5wYXRoXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TGluaygpe1xyXG4gICAgICByZXR1cm4gYFtbJHt0aGlzLmdldFBhdGgoKX18JHt0aGlzLmdldE5hbWUoZmFsc2UpfV1dYFxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIG1vdmUodGFyZ2V0Rm9sZGVyUGF0aDogc3RyaW5nLCB0YXJnZXRGaWxlTmFtZT86IHN0cmluZykge1xyXG4gICAgICBpZiAodGhpcy5sb2NrKSB7XHJcbiAgICAgICAgd2hpbGUgKHRoaXMubG9jaykge1xyXG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMCkpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJXYWl0aW5nIGZvciBsb2NrXCIpXHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLmxvY2sgPSB0cnVlO1xyXG4gICAgICBpZiAoIXRhcmdldEZpbGVOYW1lKXtcclxuICAgICAgICB0YXJnZXRGaWxlTmFtZSA9IHRoaXMuZ2V0TmFtZSgpO1xyXG4gICAgICB9XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGZvbGRlciBvZiB0aGUgdGFyZ2V0IHBhdGhuYW1lIGV4aXN0XHJcbiAgICAgICAgbGV0IHN1YnRhcmdldFBhdGggPSB0YXJnZXRGb2xkZXJQYXRoICsgXCIvXCIgKyB0YXJnZXRGaWxlTmFtZVxyXG4gICAgICAgIGNvbnN0IGZvbGRlciA9IGF3YWl0IHRoaXMudmF1bHQuYXBwLmdldEZpbGUoc3VidGFyZ2V0UGF0aCk7XHJcbiAgICAgICAgaWYgKGZvbGRlcikge1xyXG4gICAgICAgICAgdGFyZ2V0Rm9sZGVyUGF0aCA9IHN1YnRhcmdldFBhdGg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBDaGVjayBpZiB3ZSBuZWVkIHRvIG1vdmUgdGhlIGZpbGUgb3IgdGhlIGZvbGRlclxyXG4gICAgICAgIGxldCBtb3ZlRmlsZSA6IGFueSA9IHRoaXMuZmlsZVxyXG4gICAgICAgIGxldCBuZXdGaWxlUGF0aCA9IGAke3RhcmdldEZvbGRlclBhdGh9LyR7dGFyZ2V0RmlsZU5hbWV9YDtcclxuICAgICAgICBpZiAodGhpcy5pc0ZvbGRlckZpbGUoKSl7XHJcbiAgICAgICAgICBsZXQgZm9sZGVyID0gYXdhaXQgdGhpcy52YXVsdC5hcHAuZ2V0RmlsZSh0aGlzLmdldEZvbGRlclBhdGgoKSlcclxuICAgICAgICAgIGlmIChmb2xkZXIpe1xyXG4gICAgICAgICAgICBtb3ZlRmlsZSA9IGZvbGRlclxyXG4gICAgICAgICAgICBuZXdGaWxlUGF0aCA9IG5ld0ZpbGVQYXRoLnJlcGxhY2UoXCIubWRcIixcIlwiKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVsOpcmlmaWNhdGlvbiBzaSBsZSBmaWNoaWVyIGNpYmxlIGV4aXN0ZSBkw6lqw6BcclxuICAgICAgICBjb25zdCBleGlzdGluZ0ZpbGUgPSBhd2FpdCB0aGlzLnZhdWx0LmFwcC5nZXRGaWxlKG5ld0ZpbGVQYXRoKTtcclxuICAgICAgICBpZiAoZXhpc3RpbmdGaWxlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdMZSBmaWNoaWVyIGV4aXN0ZSBkw6lqw6AsIGltcG9zc2libGUgZGUgZMOpcGxhY2VyLicpO1xyXG4gICAgICAgICAgICB0aGlzLmxvY2sgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIEVzc2F5ZXIgZGUgZMOpcGxhY2VyIGxlIGZpY2hpZXJcclxuICAgICAgICAgICAgaWYgKG1vdmVGaWxlKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC5yZW5hbWVGaWxlKG1vdmVGaWxlLCBuZXdGaWxlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgRmljaGllciBkw6lwbGFjw6kgdmVycyAke25ld0ZpbGVQYXRofWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyZXVyIGxvcnMgZHUgZMOpcGxhY2VtZW50IGR1IGZpY2hpZXIgOicsIGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgZmluYWxseSB7XHJcbiAgICAgICAgICB0aGlzLmxvY2sgPSBmYWxzZTtcclxuICAgICAgfVxyXG4gIH1cclxuICBnZXRGcm9tTGluayhuYW1lOiAgc3RyaW5nKSA6IGFueXtcclxuICAgIHJldHVybiB0aGlzLnZhdWx0LmdldEZyb21MaW5rKG5hbWUpXHJcbiAgfVxyXG5cclxuICAgIGFzeW5jIGdldE1ldGFkYXRhKCkgOiBQcm9taXNlIDxSZWNvcmQ8c3RyaW5nLCBhbnk+PntcclxuICAgICAgbGV0IG1ldGFkYXRhID0gYXdhaXQgdGhpcy52YXVsdC5hcHAuZ2V0TWV0YWRhdGEodGhpcy5maWxlKTtcclxuICAgICAgcmV0dXJuIG1ldGFkYXRhXHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZ2V0TWV0YWRhdGFWYWx1ZShrZXk6IHN0cmluZyl7XHJcbiAgICAgIGxldCBtZXRhZGF0YSA9IGF3YWl0IHRoaXMuZ2V0TWV0YWRhdGEoKTtcclxuICAgICAgcmV0dXJuIG1ldGFkYXRhID8gbWV0YWRhdGFba2V5XSA6IHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRBbGxQcm9wZXJ0aWVzKCl7XHJcbiAgICAgIGxldCBtZXRhZGF0YSA9IHRoaXMuZ2V0TWV0YWRhdGEoKTtcclxuICAgICAgaWYgKCFtZXRhZGF0YSkgcmV0dXJuIHt9O1xyXG4gICAgICAvLyBSZXR1cm4gcHJvcGVydHkgb2JqZWN0cyB0aGF0IG1hdGNoIHRoZSBleHBlY3RlZCBmb3JtYXRcclxuICAgICAgY29uc3QgcHJvcGVydGllczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xyXG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBtZXRhZGF0YSkge1xyXG4gICAgICAgIHByb3BlcnRpZXNba2V5XSA9IHsgbmFtZToga2V5IH07XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHByb3BlcnRpZXM7XHJcbiAgICB9XHJcblxyXG4gIFxyXG4gICAgYXN5bmMgdXBkYXRlTWV0YWRhdGEoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgICAgaWYgKHRoaXMubG9jaykge1xyXG4gICAgICAgIHdoaWxlICh0aGlzLmxvY2spIHtcclxuICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKFwiV2FpdGluZyBmb3IgbG9ja1wiKVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgdGhpcy5sb2NrID0gdHJ1ZTtcclxuICAgICAgXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJVcGRhdGUgbWV0YWRhdGEgb24gXCIgKyB0aGlzLmdldE5hbWUoKSArXCIgOiBcIiArIGtleSArIFwiIC0tPiBcIiArIHZhbHVlKVxyXG4gICAgICAgIGNvbnN0IGZpbGVDb250ZW50ID0gYXdhaXQgdGhpcy52YXVsdC5hcHAucmVhZEZpbGUodGhpcy5maWxlKTtcclxuICAgICAgICBjb25zdCB7IGJvZHkgfSA9IHRoaXMuZXh0cmFjdEZyb250bWF0dGVyKGZpbGVDb250ZW50KTtcclxuICAgICAgXHJcbiAgICAgICAgY29uc3QgeyBleGlzdGluZ0Zyb250bWF0dGVyIH0gPSB0aGlzLmV4dHJhY3RGcm9udG1hdHRlcihmaWxlQ29udGVudCk7XHJcblxyXG4gICAgICAgIGlmICghZXhpc3RpbmdGcm9udG1hdHRlcikge3RoaXMubG9jayA9IGZhbHNlOyByZXR1cm47fVxyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBsZXQgZnJvbnRtYXR0ZXIgPSBwYXJzZVlhbWwoZXhpc3RpbmdGcm9udG1hdHRlcikgYXMgYW55O1xyXG5cclxuICAgICAgICAgICAgaWYgKCFmcm9udG1hdHRlcikge3RoaXMubG9jayA9IGZhbHNlOyByZXR1cm47fTtcclxuICAgICAgICAgICAgZnJvbnRtYXR0ZXJba2V5XSA9IHZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdGcm9udG1hdHRlciA9IGR1bXAoZnJvbnRtYXR0ZXIpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgbmV3Q29udGVudCA9IGAtLS1cXG4ke25ld0Zyb250bWF0dGVyfVxcbi0tLVxcbiR7Ym9keX1gOyAvLyR7ZXh0cmFUZXh0fVxyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC53cml0ZUZpbGUodGhpcy5maWxlLCBuZXdDb250ZW50KTtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy52YXVsdC5hcHAud2FpdEZvckZpbGVNZXRhRGF0YVVwZGF0ZSh0aGlzLmdldFBhdGgoKSwga2V5LCBhc3luYyAoKSA9PiB7IHJldHVybjsgfSlcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJNZXRkYXRhIHVwZGF0ZWRcIilcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBFcnJldXIgbG9ycyBkdSBwYXJzaW5nIGR1IGZyb250bWF0dGVyOlwiLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgdGhpcy5sb2NrID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyByZW1vdmVNZXRhZGF0YShrZXk6IHN0cmluZykge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIlJlbW92ZSBtZXRhZGF0YSBcIiArIGtleSlcclxuICAgICAgY29uc3QgZnJvbnRtYXR0ZXIgPSBhd2FpdCB0aGlzLmdldE1ldGFkYXRhKCk7XHJcbiAgICAgIGlmICghZnJvbnRtYXR0ZXIpIHJldHVybjtcclxuICAgICAgZGVsZXRlIGZyb250bWF0dGVyW2tleV1cclxuICAgICAgYXdhaXQgdGhpcy5zYXZlRnJvbnRtYXR0ZXIoZnJvbnRtYXR0ZXIpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyByZW9yZGVyTWV0YWRhdGEocHJvcGVydGllc09yZGVyOiBzdHJpbmdbXSkge1xyXG4gICAgICAgIGNvbnN0IGZyb250bWF0dGVyID0gdGhpcy5nZXRNZXRhZGF0YSgpO1xyXG4gICAgICAgIGlmICghZnJvbnRtYXR0ZXIpIHJldHVybjtcclxuXHJcbiAgICAgICAgcHJvcGVydGllc09yZGVyLnB1c2goXCJJZFwiKVxyXG5cclxuICAgICAgICBpZiAoSlNPTi5zdHJpbmdpZnkocHJvcGVydGllc09yZGVyKSA9PT0gSlNPTi5zdHJpbmdpZnkoT2JqZWN0LmtleXMoZnJvbnRtYXR0ZXIpKSkgcmV0dXJuO1xyXG5cclxuICAgICAgICBjb25zb2xlLmxvZyhcIlJlLW9yZGVyIG1ldGFkYXRhXCIpO1xyXG4gICAgICAgIC8vIFNvcnQgcHJvcGVydGllcyBhbmQgZXh0cmFjdCBleHRyYSBvbmVzXHJcbiAgICAgICAgY29uc3QgeyBzb3J0ZWRGcm9udG1hdHRlciwgZXh0cmFQcm9wZXJ0aWVzIH0gPSB0aGlzLnNvcnRGcm9udG1hdHRlcihmcm9udG1hdHRlciwgcHJvcGVydGllc09yZGVyKTtcclxuICAgICAgICBhd2FpdCB0aGlzLnNhdmVGcm9udG1hdHRlcihzb3J0ZWRGcm9udG1hdHRlciwgZXh0cmFQcm9wZXJ0aWVzKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgYXN5bmMgc2F2ZUZyb250bWF0dGVyKGZyb250bWF0dGVyOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCBleHRyYVByb3BlcnRpZXM6IHN0cmluZ1tdID0gW10pIHtcclxuICAgICAgICBjb25zdCBmaWxlQ29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQuYXBwLnJlYWRGaWxlKHRoaXMuZmlsZSk7XHJcbiAgICAgICAgY29uc3QgeyBib2R5IH0gPSB0aGlzLmV4dHJhY3RGcm9udG1hdHRlcihmaWxlQ29udGVudCk7XHJcbiAgICBcclxuICAgICAgICAvLyBSZWZvcm1hdGVyIGxlIGZyb250bWF0dGVyXHJcbiAgICAgICAgY29uc3QgbmV3RnJvbnRtYXR0ZXIgPSBkdW1wKGZyb250bWF0dGVyKTtcclxuICAgICAgICBjb25zdCBmaWx0ZXJlZEV4dHJhUHJvcGVydGllcyA9IGV4dHJhUHJvcGVydGllcy5maWx0ZXIocHJvcCA9PiBwcm9wICYmIHByb3AudHJpbSgpICE9PSBcIlwiKTtcclxuICAgICAgICAvL2NvbnN0IGV4dHJhVGV4dCA9IGZpbHRlcmVkRXh0cmFQcm9wZXJ0aWVzLmxlbmd0aCA+IDAgPyBgXFxuJHtmaWx0ZXJlZEV4dHJhUHJvcGVydGllcy5qb2luKFwiXFxuXCIpfWAgOiBcIlwiO1xyXG5cclxuICAgICAgICBcclxuICAgICAgICAvLyBTYXV2ZWdhcmRlIGR1IGZpY2hpZXJcclxuICAgICAgICBjb25zdCBuZXdDb250ZW50ID0gYC0tLVxcbiR7bmV3RnJvbnRtYXR0ZXJ9XFxuLS0tXFxuJHtib2R5fWA7IC8vJHtleHRyYVRleHR9XHJcbiAgICAgICAgYXdhaXQgdGhpcy52YXVsdC5hcHAud3JpdGVGaWxlKHRoaXMuZmlsZSwgbmV3Q29udGVudCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJVcGRhdGVkIGZpbGVcIilcclxuICAgIH1cclxuXHJcbiAgICBcclxuICAgIC8vIEV4dHJhaXJlIGxlIGZyb250bWF0dGVyIGV0IGxlIHJlc3RlIGR1IGNvbnRlbnVcclxuICAgIGV4dHJhY3RGcm9udG1hdHRlcihjb250ZW50OiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBmcm9udG1hdHRlclJlZ2V4ID0gL14tLS1cXG4oW1xcc1xcU10rPylcXG4tLS1cXG4vO1xyXG4gICAgICAgIGNvbnN0IG1hdGNoID0gY29udGVudC5tYXRjaChmcm9udG1hdHRlclJlZ2V4KTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBleGlzdGluZ0Zyb250bWF0dGVyOiBtYXRjaCA/IG1hdGNoWzFdIDogXCJcIixcclxuICAgICAgICAgICAgYm9keTogbWF0Y2ggPyBjb250ZW50LnJlcGxhY2UobWF0Y2hbMF0sIFwiXCIpIDogY29udGVudCxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBUcmllciBsZXMgcHJvcHJpw6l0w6lzIGV0IGlkZW50aWZpZXIgY2VsbGVzIGVuIHN1cnBsdXNcclxuICAgIC8vIE3DqXRob2RlIHNpbXBsZSBwb3VyIGxlcyB0ZXN0c1xyXG4gICAgZm9ybWF0RnJvbnRtYXR0ZXIoZnJvbnRtYXR0ZXI6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBkdW1wKGZyb250bWF0dGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBzb3J0RnJvbnRtYXR0ZXIoZnJvbnRtYXR0ZXI6IFJlY29yZDxzdHJpbmcsIGFueT4sIHByb3BlcnRpZXNPcmRlcjogc3RyaW5nW10pIHtcclxuICAgICAgICBsZXQgc29ydGVkRnJvbnRtYXR0ZXI6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuICAgICAgICBsZXQgZXh0cmFQcm9wZXJ0aWVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHByb3BlcnRpZXNPcmRlci5mb3JFYWNoKHByb3AgPT4ge1xyXG4gICAgICAgICAgICBpZiAocHJvcCBpbiBmcm9udG1hdHRlcikge1xyXG4gICAgICAgICAgICAgICAgc29ydGVkRnJvbnRtYXR0ZXJbcHJvcF0gPSBmcm9udG1hdHRlcltwcm9wXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNvcnRlZEZyb250bWF0dGVyW3Byb3BdID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIE9iamVjdC5rZXlzKGZyb250bWF0dGVyKS5mb3JFYWNoKHByb3AgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXByb3BlcnRpZXNPcmRlci5pbmNsdWRlcyhwcm9wKSkge1xyXG4gICAgICAgICAgICAgICAgZXh0cmFQcm9wZXJ0aWVzLnB1c2goYCR7cHJvcH06ICR7SlNPTi5zdHJpbmdpZnkoZnJvbnRtYXR0ZXJbcHJvcF0pfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHsgc29ydGVkRnJvbnRtYXR0ZXIsIGV4dHJhUHJvcGVydGllcyB9O1xyXG4gICAgfVxyXG59Il0sInZlcnNpb24iOjN9