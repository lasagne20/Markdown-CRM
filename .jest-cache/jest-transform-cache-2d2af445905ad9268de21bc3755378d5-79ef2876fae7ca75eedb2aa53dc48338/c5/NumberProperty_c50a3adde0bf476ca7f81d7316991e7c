445b099924d2572bf473edc197a981ad
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NumberProperty = void 0;
const FormulaProperty_1 = require("./FormulaProperty");
const Property_1 = require("./Property");
class NumberProperty extends Property_1.Property {
    constructor(name, vault, unit = "", args = { icon: "", static: true }) {
        super(name, vault, args);
        this.unit = "";
        this.type = "number";
        this.formulaProperty = null;
        if (args.formula) {
            this.formulaProperty = new FormulaProperty_1.FormulaProperty(name, vault, args.formula, { icon: args.icon, static: args.static, write: true });
        }
        this.unit = unit;
    }
    validate(value) {
        // Handle null/undefined
        if (value == null) {
            return "";
        }
        // Convert to string if not already
        const stringValue = String(value);
        // Trim whitespace
        const trimmedValue = stringValue.trim();
        // Return empty string for empty or whitespace-only input
        if (!trimmedValue) {
            return "";
        }
        // Check if the entire string is a valid number (not just the beginning)
        const numberValue = parseFloat(trimmedValue);
        if (isNaN(numberValue)) {
            return "";
        }
        // Check if it's a valid number format (including scientific notation)
        if (!/^-?\d*\.?\d+(e[+-]?\d+)?$/i.test(trimmedValue) &&
            trimmedValue !== numberValue.toString()) {
            return "";
        }
        return numberValue.toString();
    }
    async getDisplay(file, args = { staticMode: false, title: "" }) {
        this.static = args.staticMode ? true : this.static;
        this.title = args.title ? args.title : "";
        let value = this.read(file);
        if (!value && this.formulaProperty) {
            value = this.formulaProperty.read(file);
        }
        return this.fillDisplay(file.vault, value, async (value) => await file.updateMetadata(this.name, value));
    }
    fillDisplay(vault, value, update) {
        this.vault = vault;
        const field = this.createFieldContainer();
        if (this.title) {
            const title = document.createElement("div");
            title.textContent = this.title;
            title.classList.add("metadata-title");
            field.appendChild(title);
        }
        const iconContainer = this.createIconContainer(update);
        const fieldContainer = this.createFieldContainerContent(update, value);
        field.appendChild(iconContainer);
        field.appendChild(fieldContainer);
        return field;
    }
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        const currentField = value;
        const input = this.createFieldInput(currentField);
        const link = this.createFieldLink(currentField);
        if (this.static) {
            link.style.display = "block";
            input.style.display = "none";
        }
        else {
            if (currentField && this.validate(value)) {
                link.style.display = "block";
                input.style.display = "none";
            }
            else {
                input.style.display = "block";
                link.style.display = "none";
            }
        }
        fieldContainer.appendChild(link);
        fieldContainer.appendChild(input);
        if (!this.static) {
            this.handleFieldInput(update, input, link);
        }
        return fieldContainer;
    }
    createFieldLink(value) {
        const link = document.createElement("div");
        link.textContent = value ? `${value} ${this.unit}` : "";
        link.classList.add("field-link");
        link.style.cursor = this.static ? "default" : "text";
        if (!this.static) {
            link.onclick = (event) => this.modifyField(event);
        }
        return link;
    }
    async updateField(update, input, link) {
        let value = input.value;
        if (value) {
            await update(value);
            input.style.display = "none";
            link.textContent = value ? `${value} ${this.unit}` : "";
            link.style.display = "block";
        }
        else {
            await update(input.value);
        }
    }
    createFieldInput(value) {
        const input = document.createElement("input");
        input.type = "number";
        input.value = value || "";
        input.classList.add("field-input");
        return input;
    }
}
exports.NumberProperty = NumberProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXE51bWJlclByb3BlcnR5LnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHVEQUFvRDtBQUNwRCx5Q0FBc0M7QUFHdEMsTUFBYSxjQUFlLFNBQVEsbUJBQVE7SUFNeEMsWUFBWSxJQUFZLEVBQUUsS0FBWSxFQUFFLE9BQWUsRUFBRSxFQUFFLE9BQTZELEVBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFDO1FBQzVJLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBTHRCLFNBQUksR0FBVyxFQUFFLENBQUM7UUFDVCxTQUFJLEdBQVksUUFBUSxDQUFDO1FBQ2xDLG9CQUFlLEdBQTRCLElBQUksQ0FBQztRQUluRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxpQ0FBZSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO1FBQy9ILENBQUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBRVEsUUFBUSxDQUFDLEtBQWE7UUFDM0Isd0JBQXdCO1FBQ3hCLElBQUksS0FBSyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ2hCLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUVELG1DQUFtQztRQUNuQyxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEMsa0JBQWtCO1FBQ2xCLE1BQU0s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QUMsT0FBTyxDQUFDLENBQUM7UUFDOUMsS0FBSyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7UUFDdEIsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQzFCLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ25DLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQXpJRCx3Q0F5SUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXE51bWJlclByb3BlcnR5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcm11bGFQcm9wZXJ0eSB9IGZyb20gXCIuL0Zvcm11bGFQcm9wZXJ0eVwiO1xyXG5pbXBvcnQgeyBQcm9wZXJ0eSB9IGZyb20gXCIuL1Byb3BlcnR5XCI7XHJcbmltcG9ydCB7IFZhdWx0IH0gZnJvbSBcIi4uL3ZhdWx0L1ZhdWx0XCI7XHJcblxyXG5leHBvcnQgY2xhc3MgTnVtYmVyUHJvcGVydHkgZXh0ZW5kcyBQcm9wZXJ0eSB7XHJcblxyXG4gICAgcHVibGljIHVuaXQ6IHN0cmluZyA9IFwiXCI7XHJcbiAgICBwdWJsaWMgb3ZlcnJpZGUgdHlwZSA6IHN0cmluZyA9IFwibnVtYmVyXCI7XHJcbiAgICBwdWJsaWMgZm9ybXVsYVByb3BlcnR5IDogRm9ybXVsYVByb3BlcnR5IHwgbnVsbCA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCB2YXVsdDogVmF1bHQsIHVuaXQ6IHN0cmluZyA9IFwiXCIsIGFyZ3MgOiB7aWNvbjogc3RyaW5nLCBzdGF0aWM/OiBib29sZWFuLCBmb3JtdWxhPyA6IHN0cmluZ30gPSB7aWNvbjogXCJcIiwgc3RhdGljOiB0cnVlfSkge1xyXG4gICAgICAgIHN1cGVyKG5hbWUsIHZhdWx0LCBhcmdzKTtcclxuICAgICAgICBpZiAoYXJncy5mb3JtdWxhKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybXVsYVByb3BlcnR5ID0gbmV3IEZvcm11bGFQcm9wZXJ0eShuYW1lLCB2YXVsdCwgYXJncy5mb3JtdWxhLCB7aWNvbjogYXJncy5pY29uLCBzdGF0aWM6IGFyZ3Muc3RhdGljLCB3cml0ZTogdHJ1ZX0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnVuaXQgPSB1bml0O1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIHZhbGlkYXRlKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIC8vIEhhbmRsZSBudWxsL3VuZGVmaW5lZFxyXG4gICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAvLyBDb252ZXJ0IHRvIHN0cmluZyBpZiBub3QgYWxyZWFkeVxyXG4gICAgICAgIGNvbnN0IHN0cmluZ1ZhbHVlID0gU3RyaW5nKHZhbHVlKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBUcmltIHdoaXRlc3BhY2VcclxuICAgICAgICBjb25zdCB0cmltbWVkVmFsdWUgPSBzdHJpbmdWYWx1ZS50cmltKCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gUmV0dXJuIGVtcHR5IHN0cmluZyBmb3IgZW1wdHkgb3Igd2hpdGVzcGFjZS1vbmx5IGlucHV0XHJcbiAgICAgICAgaWYgKCF0cmltbWVkVmFsdWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIENoZWNrIGlmIHRoZSBlbnRpcmUgc3RyaW5nIGlzIGEgdmFsaWQgbnVtYmVyIChub3QganVzdCB0aGUgYmVnaW5uaW5nKVxyXG4gICAgICAgIGNvbnN0IG51bWJlclZhbHVlID0gcGFyc2VGbG9hdCh0cmltbWVkVmFsdWUpO1xyXG4gICAgICAgIGlmIChpc05hTihudW1iZXJWYWx1ZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYSB2YWxpZCBudW1iZXIgZm9ybWF0IChpbmNsdWRpbmcgc2NpZW50aWZpYyBub3RhdGlvbilcclxuICAgICAgICBpZiAoIS9eLT9cXGQqXFwuP1xcZCsoZVsrLV0/XFxkKyk/JC9pLnRlc3QodHJpbW1lZFZhbHVlKSAmJiBcclxuICAgICAgICAgICAgdHJpbW1lZFZhbHVlICE9PSBudW1iZXJWYWx1ZS50b1N0cmluZygpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gbnVtYmVyVmFsdWUudG9TdHJpbmcoKTtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSBhc3luYyBnZXREaXNwbGF5KGZpbGU6IGFueSwgYXJncyA6IHtzdGF0aWNNb2RlPyA6IGJvb2xlYW4sIHRpdGxlPzogc3RyaW5nfSA9IHtzdGF0aWNNb2RlIDogZmFsc2UsIHRpdGxlOlwiXCJ9KSB7XHJcbiAgICAgICAgdGhpcy5zdGF0aWMgPSBhcmdzLnN0YXRpY01vZGUgPyB0cnVlIDogdGhpcy5zdGF0aWM7XHJcbiAgICAgICAgdGhpcy50aXRsZSA9IGFyZ3MudGl0bGUgPyBhcmdzLnRpdGxlIDogXCJcIjtcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnJlYWQoZmlsZSk7XHJcbiAgICAgICAgaWYgKCF2YWx1ZSAmJiB0aGlzLmZvcm11bGFQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZm9ybXVsYVByb3BlcnR5LnJlYWQoZmlsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmZpbGxEaXNwbGF5KGZpbGUudmF1bHQsIHZhbHVlLCBhc3luYyAodmFsdWUpID0+IGF3YWl0IGZpbGUudXBkYXRlTWV0YWRhdGEodGhpcy5uYW1lLCB2YWx1ZSkpO1xyXG4gICAgfSBcclxuXHJcbiAgICBvdmVycmlkZSBmaWxsRGlzcGxheSh2YXVsdCA6IGFueSwgdmFsdWU6IGFueSwgdXBkYXRlOiAodmFsdWU6IGFueSkgPT4gUHJvbWlzZTx2b2lkPikge1xyXG4gICAgICAgIHRoaXMudmF1bHQgPSB2YXVsdDtcclxuICAgICAgICBjb25zdCBmaWVsZCA9IHRoaXMuY3JlYXRlRmllbGRDb250YWluZXIoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMudGl0bGUpIHtcclxuICAgICAgICAgICAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICB0aXRsZS50ZXh0Q29udGVudCA9IHRoaXMudGl0bGU7XHJcbiAgICAgICAgICAgIHRpdGxlLmNsYXNzTGlzdC5hZGQoXCJtZXRhZGF0YS10aXRsZVwiKTtcclxuICAgICAgICAgICAgZmllbGQuYXBwZW5kQ2hpbGQodGl0bGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaWNvbkNvbnRhaW5lciA9IHRoaXMuY3JlYXRlSWNvbkNvbnRhaW5lcih1cGRhdGUpO1xyXG4gICAgICAgIGNvbnN0IGZpZWxkQ29udGFpbmVyID0gdGhpcy5jcmVhdGVGaWVsZENvbnRhaW5lckNvbnRlbnQodXBkYXRlLCB2YWx1ZSk7XHJcblxyXG4gICAgICAgIGZpZWxkLmFwcGVuZENoaWxkKGljb25Db250YWluZXIpO1xyXG4gICAgICAgIGZpZWxkLmFwcGVuZENoaWxkKGZpZWxkQ29udGFpbmVyKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGZpZWxkO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGNyZWF0ZUZpZWxkQ29udGFpbmVyQ29udGVudCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCB2YWx1ZTogc3RyaW5nKTogSFRNTERpdkVsZW1lbnQge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBmaWVsZENvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwiZmllbGQtY29udGFpbmVyXCIpO1xyXG5cclxuICAgICAgICBjb25zdCBjdXJyZW50RmllbGQgPSB2YWx1ZTtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHRoaXMuY3JlYXRlRmllbGRJbnB1dChjdXJyZW50RmllbGQpO1xyXG4gICAgICAgIGNvbnN0IGxpbmsgPSB0aGlzLmNyZWF0ZUZpZWxkTGluayhjdXJyZW50RmllbGQpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5zdGF0aWMpIHtcclxuICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnRGaWVsZCAmJiB0aGlzLnZhbGlkYXRlKHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuICAgICAgICAgICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmaWVsZENvbnRhaW5lci5hcHBlbmRDaGlsZChsaW5rKTtcclxuICAgICAgICBmaWVsZENvbnRhaW5lci5hcHBlbmRDaGlsZChpbnB1dCk7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5zdGF0aWMpIHtcclxuICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWVsZElucHV0KHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZpZWxkQ29udGFpbmVyO1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGNyZWF0ZUZpZWxkTGluayh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgbGluay50ZXh0Q29udGVudCA9IHZhbHVlID8gYCR7dmFsdWV9ICR7dGhpcy51bml0fWAgOiBcIlwiO1xyXG4gICAgICAgIGxpbmsuY2xhc3NMaXN0LmFkZChcImZpZWxkLWxpbmtcIik7XHJcbiAgICAgICAgbGluay5zdHlsZS5jdXJzb3IgPSB0aGlzLnN0YXRpYyA/IFwiZGVmYXVsdFwiIDogXCJ0ZXh0XCI7XHJcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRpYykge1xyXG4gICAgICAgICAgICBsaW5rLm9uY2xpY2sgPSAoZXZlbnQpID0+IHRoaXMubW9kaWZ5RmllbGQoZXZlbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbGluaztcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSBhc3luYyB1cGRhdGVGaWVsZCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCBpbnB1dDogSFRNTElucHV0RWxlbWVudCwgbGluazogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBsZXQgdmFsdWUgPSBpbnB1dC52YWx1ZTtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgYXdhaXQgdXBkYXRlKHZhbHVlKTtcclxuICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gdmFsdWUgPyBgJHt2YWx1ZX0gJHt0aGlzLnVuaXR9YCA6IFwiXCI7XHJcbiAgICAgICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhd2FpdCB1cGRhdGUoaW5wdXQudmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSBjcmVhdGVGaWVsZElucHV0KHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpbnB1dFwiKTtcclxuICAgICAgICBpbnB1dC50eXBlID0gXCJudW1iZXJcIjtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IHZhbHVlIHx8IFwiXCI7XHJcbiAgICAgICAgaW5wdXQuY2xhc3NMaXN0LmFkZChcImZpZWxkLWlucHV0XCIpO1xyXG4gICAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIH1cclxufSJdLCJ2ZXJzaW9uIjozfQ==