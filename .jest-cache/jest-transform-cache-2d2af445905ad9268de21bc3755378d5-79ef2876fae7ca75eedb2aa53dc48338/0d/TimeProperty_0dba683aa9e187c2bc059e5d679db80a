a3c568ae3019a47b250fcabd20b5f87f
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TimeProperty = void 0;
const flatpickr_1 = __importDefault(require("flatpickr"));
const fr_js_1 = require("flatpickr/dist/l10n/fr.js");
const Property_1 = require("./Property");
class TimeProperty extends Property_1.Property {
    constructor(name, args = { format: "HH:mm" }) {
        super(name, args);
        this.type = "time";
        this.format = args.format || "HH:mm";
    }
    // Affiche le champ temps
    fillDisplay(vault, value, update) {
        const container = document.createElement("div");
        container.classList.add("field-container");
        const link = this.createFieldLink(value);
        const input = this.createFieldTime(value, update, link);
        // Affichage initial
        if (value && this.validate(value)) {
            link.style.display = "block";
            input.style.display = "none";
        }
        else {
            input.style.display = "block";
            link.style.display = "none";
        }
        container.appendChild(link);
        container.appendChild(input);
        return container;
    }
    // Crée un input pour l'heure (hh:mm) avec flatpickr
    createFieldTime(value, update, link) {
        const input = document.createElement("input");
        input.type = "text";
        input.value = value || "";
        input.classList.add("field-input");
        (0, flatpickr_1.default)(input, {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
            defaultDate: value || "",
            locale: fr_js_1.French,
            onChange: async (selectedDates) => {
                const selected = selectedDates[0];
                if (selected) {
                    input.value = this.formatTimeForStorage(selected);
                    await this.updateField(update, input, link);
                }
            },
            onClose: async () => {
                if (!this.validate(input.value))
                    input.value = "";
                await this.updateField(update, input, link);
            }
        });
        return input;
    }
    // Affiche l'heure ou un texte par défaut
    createFieldLink(value) {
        const link = document.createElement("div");
        link.textContent = value ? this.formatTimeForDisplay(value) : "Aucune heure sélectionnée";
        link.classList.add("time-field-link", "field-link");
        link.style.cursor = "pointer";
        link.addEventListener("click", (event) => this.modifyField(event));
        return link;
    }
    // Formate l'heure pour l'affichage : "14:30"
    formatTimeForDisplay(time) {
        if (this.format === "HH:mm") {
            return time || "Aucune heure sélectionnée";
        }
        if (!time)
            return "";
        const parts = time.split(":").map(Number);
        if (parts.length < 2)
            return time;
        const [h, m, s] = [parts[0], parts[1], parts[2] || 0];
        const result = [];
        if (h)
            result.push(`${h}h`);
        if (m)
            result.push(`${m} min`);
        if (s)
            result.push(`${s}s`);
        return result.length ? result.join(" ") : "0 min";
    }
    // Formate l'heure pour le stockage : "HH:mm"
    formatTimeForStorage(date) {
        return date.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit", hour12: false });
    }
    // Validation simple du format "HH:mm"
    validate(value) {
        if (/^\d{2}:\d{2}$/.test(value)) {
            return value;
        }
        return "";
    }
    // Bascule entre input et affichage
    async updateField(update, input, link) {
        let value = this.validate(input.value) ? input.value : "";
        await update(value);
        if (value) {
            input.style.display = "none";
            link.textContent = this.formatTimeForDisplay(value);
            link.style.display = "block";
        }
        else {
            link.textContent = "Aucune heure sélectionnée";
        }
    }
    // Pour afficher l'input à la place du lien
    modifyField(event) {
        const link = event.currentTarget;
        const container = link.parentElement;
        if (!container)
            return;
        const input = container.querySelector("input");
        if (input) {
            link.style.display = "none";
            input.style.display = "block";
            input.focus();
        }
    }
}
exports.TimeProperty = TimeProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFRpbWVQcm9wZXJ0eSAudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsMERBQWtDO0FBQ2xDLHFEQUFtRDtBQUNuRCx5Q0FBc0M7QUFFdEMsTUFBYSxZQUFhLFNBQVEsbUJBQVE7SUFJdEMsWUFBWSxJQUFZLEVBQUUsT0FBMEMsRUFBQyxNQUFNLEVBQUcsT0FBTyxFQUFDO1FBQ2xGLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFKYixTQUFJLEdBQVcsTUFBTSxDQUFDO1FBSzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUM7SUFFekMsQ0FBQztJQUVELHlCQUF5QjtJQUNoQixXQUFXLENBQUMsS0FBVyxFQUFFLEtBQVUsRUFBRSxNQUFxQztRQUMvRSxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hELFNBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFM0MsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFeEQsb0JBQW9CO1FBQ3BCLElBQUksS0FBSyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7WUFDN0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ2pDLENBQUM7YUFBTSxDQUFDO1lBQ0osS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1lBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUNoQyxDQUFDO1FBRUQsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTdCLE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxvREFBb0Q7SUFDcEQsZUFBZSxDQUFDLEtBQWEsRUFBRSxNQUF3QyxFQUFFLElBQWlCO1FBQ3RGLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUMsS0FBSyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUM7UUFDcEIsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQzFCLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRW5DLElBQUEsbUJBQVMsRUFBQyxLQUFLLEVBQUU7WUFDYixVQUFVLEVBQUUsSUFBSTtZQUNoQixVQUFVLEVBQUUsSUFBSTtZQUNoQixVQUFVLEVBQUUsS0FBSztZQUNqQixTQUFTLEVBQUUsSUFBSTtZQUNmLFdBQVcsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN4QixNQUFNLEVBQUUsY0FBTTtZQUNkLFFBQVEsRUFBRSxLQUFLLEVBQUUsYUFBcUIsRUFBRSxFQUFFO2dCQUN0QyxNQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLElBQUksUUFBUSxFQUFFLENBQUM7b0JBQ1gsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQ2xELE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNoRCxDQUFDO1lBQ0wsQ0FBQztZQUNELE9BQU8sRUFBRSxLQUFLLElBQUksRUFBRTtnQkFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztvQkFBRSxLQUFLLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztnQkFDbEQsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDaEQsQ0FBQztTQUNKLENBQUMsQ0FBQztRQUVILE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRCx5Q0FBeUM7SUFDaEMsZUFBZSxDQUFDLEtBQWE7UUFDbEMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQywyQkFBMkIsQ0FBQztRQUMxRixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDOUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ25FLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCw2Q0FBNkM7SUFDN0Msb0JBQW9CLENBQUMsSUFBWTtRQUM3QixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDMUIsT0FBTyxJQUFJLElBQUksMkJBQTJCLENBQUM7UUFDL0MsQ0FBQztRQUNELElBQUksQ0FBQyxJQUFJO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFDckIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDMUMsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUM7WUFBRSxPQUFPLElBQUksQ0FBQztRQUNsQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUM7WUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUM7WUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUM7WUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1QixPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUN0RCxDQUFDO0lBRUQsNkNBQTZDO0lBQzdDLG9CQUFvQixDQUFDLElBQVU7UUFDM0IsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ25HLENBQUM7SUFFRCxzQ0FBc0M7SUFDN0IsUUFBUSxDQUFDLEtBQWE7UUFDM0IsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFDLENBQUM7WUFDN0IsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQztRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELG1DQUFtQztJQUMxQixLQUFLLENBQUMsV0FBVyxDQUFDLE1BQXdDLEVBQUUsS0FBdUIsRUFBRSxJQUFpQjtRQUMzRyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzFELE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BCLElBQUksS0FBSyxFQUFFLENBQUM7WUFDUixLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7WUFDN0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDcEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ2pDLENBQUM7YUFBTSxDQUFDO1lBQ0osSUFBSSxDQUFDLFdBQVcsR0FBRywyQkFBMkIsQ0FBQztRQUNuRCxDQUFDO0lBQ0wsQ0FBQztJQUVELDJDQUEyQztJQUNsQyxXQUFXLENBQUMsS0FBWTtRQUM3QixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsYUFBNEIsQ0FBQztRQUNoRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxTQUFTO1lBQUUsT0FBTztRQUN2QixNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9DLElBQUksS0FBSyxFQUFFLENBQUM7WUFDUixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7WUFDNUIsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1lBQzlCLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNsQixDQUFDO0lBQ0wsQ0FBQztDQUNKO0FBL0hELG9DQStIQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGxlb2R1XFxEb2N1bWVudHNcXDEgLSBQcm9cXFRlc3QgcGx1Z2luIG9ic2lkaWFuXFwub2JzaWRpYW5cXHBsdWdpbnNcXG9ic2lkaWFuLUNSTVxcZHluYW1pYy1maWVsZHNcXHNyY1xccHJvcGVydGllc1xcVGltZVByb3BlcnR5IC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmxhdHBpY2tyIGZyb20gXCJmbGF0cGlja3JcIjtcclxuaW1wb3J0IHsgRnJlbmNoIH0gZnJvbSBcImZsYXRwaWNrci9kaXN0L2wxMG4vZnIuanNcIjtcclxuaW1wb3J0IHsgUHJvcGVydHkgfSBmcm9tIFwiLi9Qcm9wZXJ0eVwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFRpbWVQcm9wZXJ0eSBleHRlbmRzIFByb3BlcnR5IHtcclxuICAgIG92ZXJyaWRlIHR5cGU6IHN0cmluZyA9IFwidGltZVwiO1xyXG4gICAgcHJpdmF0ZSBmb3JtYXQ6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIGFyZ3MgOiB7Zm9ybWF0Pzogc3RyaW5nLCBpY29uPyA6IHN0cmluZ309IHtmb3JtYXQgOiBcIkhIOm1tXCJ9KSB7XHJcbiAgICAgICAgc3VwZXIobmFtZSwgYXJncyk7XHJcbiAgICAgICAgdGhpcy5mb3JtYXQgPSBhcmdzLmZvcm1hdCB8fCBcIkhIOm1tXCI7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIEFmZmljaGUgbGUgY2hhbXAgdGVtcHNcclxuICAgIG92ZXJyaWRlIGZpbGxEaXNwbGF5KHZhdWx0IDogYW55LCB2YWx1ZTogYW55LCB1cGRhdGU6ICh2YWx1ZTogYW55KSA9PiBQcm9taXNlPHZvaWQ+KSB7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZChcImZpZWxkLWNvbnRhaW5lclwiKTtcclxuXHJcbiAgICAgICAgY29uc3QgbGluayA9IHRoaXMuY3JlYXRlRmllbGRMaW5rKHZhbHVlKTtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHRoaXMuY3JlYXRlRmllbGRUaW1lKHZhbHVlLCB1cGRhdGUsIGxpbmspO1xyXG5cclxuICAgICAgICAvLyBBZmZpY2hhZ2UgaW5pdGlhbFxyXG4gICAgICAgIGlmICh2YWx1ZSAmJiB0aGlzLnZhbGlkYXRlKHZhbHVlKSkge1xyXG4gICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgICAgICAgIGlucHV0LnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChsaW5rKTtcclxuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaW5wdXQpO1xyXG5cclxuICAgICAgICByZXR1cm4gY29udGFpbmVyO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENyw6llIHVuIGlucHV0IHBvdXIgbCdoZXVyZSAoaGg6bW0pIGF2ZWMgZmxhdHBpY2tyXHJcbiAgICBjcmVhdGVGaWVsZFRpbWUodmFsdWU6IHN0cmluZywgdXBkYXRlOiAodmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiwgbGluazogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpbnB1dFwiKTtcclxuICAgICAgICBpbnB1dC50eXBlID0gXCJ0ZXh0XCI7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZSB8fCBcIlwiO1xyXG4gICAgICAgIGlucHV0LmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1pbnB1dFwiKTtcclxuXHJcbiAgICAgICAgZmxhdHBpY2tyKGlucHV0LCB7XHJcbiAgICAgICAgICAgIGVuYWJsZVRpbWU6IHRydWUsXHJcbiAgICAgICAgICAgIG5vQ2FsZW5kYXI6IHRydWUsXHJcbiAgICAgICAgICAgIGRhdGVGb3JtYXQ6IFwiSDppXCIsXHJcbiAgICAgICAgICAgIHRpbWVfMjRocjogdHJ1ZSxcclxuICAgICAgICAgICAgZGVmYXVsdERhdGU6IHZhbHVlIHx8IFwiXCIsXHJcbiAgICAgICAgICAgIGxvY2FsZTogRnJlbmNoLFxyXG4gICAgICAgICAgICBvbkNoYW5nZTogYXN5bmMgKHNlbGVjdGVkRGF0ZXM6IERhdGVbXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSBzZWxlY3RlZERhdGVzWzBdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB0aGlzLmZvcm1hdFRpbWVGb3JTdG9yYWdlKHNlbGVjdGVkKTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpZWxkKHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBvbkNsb3NlOiBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGUoaW5wdXQudmFsdWUpKSBpbnB1dC52YWx1ZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpZWxkKHVwZGF0ZSwgaW5wdXQsIGxpbmspO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBBZmZpY2hlIGwnaGV1cmUgb3UgdW4gdGV4dGUgcGFyIGTDqWZhdXRcclxuICAgIG92ZXJyaWRlIGNyZWF0ZUZpZWxkTGluayh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgbGluay50ZXh0Q29udGVudCA9IHZhbHVlID8gdGhpcy5mb3JtYXRUaW1lRm9yRGlzcGxheSh2YWx1ZSkgOiBcIkF1Y3VuZSBoZXVyZSBzw6lsZWN0aW9ubsOpZVwiO1xyXG4gICAgICAgIGxpbmsuY2xhc3NMaXN0LmFkZChcInRpbWUtZmllbGQtbGlua1wiLCBcImZpZWxkLWxpbmtcIik7XHJcbiAgICAgICAgbGluay5zdHlsZS5jdXJzb3IgPSBcInBvaW50ZXJcIjtcclxuICAgICAgICBsaW5rLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoZXZlbnQpID0+IHRoaXMubW9kaWZ5RmllbGQoZXZlbnQpKTtcclxuICAgICAgICByZXR1cm4gbGluaztcclxuICAgIH1cclxuXHJcbiAgICAvLyBGb3JtYXRlIGwnaGV1cmUgcG91ciBsJ2FmZmljaGFnZSA6IFwiMTQ6MzBcIlxyXG4gICAgZm9ybWF0VGltZUZvckRpc3BsYXkodGltZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAodGhpcy5mb3JtYXQgPT09IFwiSEg6bW1cIikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGltZSB8fCBcIkF1Y3VuZSBoZXVyZSBzw6lsZWN0aW9ubsOpZVwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRpbWUpIHJldHVybiBcIlwiO1xyXG4gICAgICAgIGNvbnN0IHBhcnRzID0gdGltZS5zcGxpdChcIjpcIikubWFwKE51bWJlcik7XHJcbiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA8IDIpIHJldHVybiB0aW1lO1xyXG4gICAgICAgIGNvbnN0IFtoLCBtLCBzXSA9IFtwYXJ0c1swXSwgcGFydHNbMV0sIHBhcnRzWzJdIHx8IDBdO1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgIGlmIChoKSByZXN1bHQucHVzaChgJHtofWhgKTtcclxuICAgICAgICBpZiAobSkgcmVzdWx0LnB1c2goYCR7bX0gbWluYCk7XHJcbiAgICAgICAgaWYgKHMpIHJlc3VsdC5wdXNoKGAke3N9c2ApO1xyXG4gICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID8gcmVzdWx0LmpvaW4oXCIgXCIpIDogXCIwIG1pblwiO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEZvcm1hdGUgbCdoZXVyZSBwb3VyIGxlIHN0b2NrYWdlIDogXCJISDptbVwiXHJcbiAgICBmb3JtYXRUaW1lRm9yU3RvcmFnZShkYXRlOiBEYXRlKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gZGF0ZS50b0xvY2FsZVRpbWVTdHJpbmcoXCJmci1GUlwiLCB7IGhvdXI6IFwiMi1kaWdpdFwiLCBtaW51dGU6IFwiMi1kaWdpdFwiLCBob3VyMTI6IGZhbHNlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFZhbGlkYXRpb24gc2ltcGxlIGR1IGZvcm1hdCBcIkhIOm1tXCJcclxuICAgIG92ZXJyaWRlIHZhbGlkYXRlKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGlmKCAvXlxcZHsyfTpcXGR7Mn0kLy50ZXN0KHZhbHVlKSl7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQmFzY3VsZSBlbnRyZSBpbnB1dCBldCBhZmZpY2hhZ2VcclxuICAgIG92ZXJyaWRlIGFzeW5jIHVwZGF0ZUZpZWxkKHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIGlucHV0OiBIVE1MSW5wdXRFbGVtZW50LCBsaW5rOiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IHRoaXMudmFsaWRhdGUoaW5wdXQudmFsdWUpID8gaW5wdXQudmFsdWUgOiBcIlwiO1xyXG4gICAgICAgIGF3YWl0IHVwZGF0ZSh2YWx1ZSk7XHJcbiAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlucHV0LnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICAgICAgICAgICAgbGluay50ZXh0Q29udGVudCA9IHRoaXMuZm9ybWF0VGltZUZvckRpc3BsYXkodmFsdWUpO1xyXG4gICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGluay50ZXh0Q29udGVudCA9IFwiQXVjdW5lIGhldXJlIHPDqWxlY3Rpb25uw6llXCI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFBvdXIgYWZmaWNoZXIgbCdpbnB1dCDDoCBsYSBwbGFjZSBkdSBsaWVuXHJcbiAgICBvdmVycmlkZSBtb2RpZnlGaWVsZChldmVudDogRXZlbnQpIHtcclxuICAgICAgICBjb25zdCBsaW5rID0gZXZlbnQuY3VycmVudFRhcmdldCBhcyBIVE1MRWxlbWVudDtcclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSBsaW5rLnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgICAgaWYgKCFjb250YWluZXIpIHJldHVybjtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKFwiaW5wdXRcIik7XHJcbiAgICAgICAgaWYgKGlucHV0KSB7XHJcbiAgICAgICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG4gICAgICAgICAgICBpbnB1dC5mb2N1cygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=