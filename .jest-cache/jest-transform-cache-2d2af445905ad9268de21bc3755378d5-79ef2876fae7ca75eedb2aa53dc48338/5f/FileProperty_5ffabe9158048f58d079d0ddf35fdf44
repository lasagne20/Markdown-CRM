c64e2989fda3200f25723655bf65cb35
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileProperty = void 0;
const Utils_1 = require("../vault/Utils");
const LinkProperty_1 = require("./LinkProperty");
class FileProperty extends LinkProperty_1.LinkProperty {
    // Used for property with a single file
    constructor(name, vault, classes, args = {}) {
        super(name, vault, args);
        this.type = "file";
        this.classes = classes;
    }
    getClasses() {
        return this.classes;
    }
    // Used by the ClasseProperty to get the parent value
    getParentValue(values) {
        return values; // Enlève les [[ et ]]
    }
    getPretty(value) {
        return this.vault.readLinkFile(value);
    }
    getClasse(file) {
        let link = this.read(file);
        if (link) {
            let classe = this.vault.getFromLink(link);
            if (classe) {
                return classe;
            }
        }
        return undefined;
    }
    validate(value) {
        // Expression régulière pour détecter les liens Obsidian au format [[...]]
        const regex = /\[\[([^\]]+)\]\]/;
        const match = value.match(regex);
        if (match && match[1]) {
            return `[[${match[1]}]]`;
        }
        return "";
    }
    getLink(value, vault) {
        if (vault) {
            this.vault = vault;
        }
        const vaultName = this.vault.app.vault.getName();
        const filePath = this.vault.readLinkFile(value, true);
        // If readLinkFile returned a path and the file exists in the vault, use it.
        if (filePath && this.vault.app.vault.getAbstractFileByPath(filePath)) {
            return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(filePath)}`;
        }
        // Fallback: extract the name only from the link
        const nameOnly = this.vault.readLinkFile(value);
        return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(nameOnly)}`;
    }
    createIconContainer(update) {
        const iconContainer = document.createElement("div");
        iconContainer.classList.add("icon-container");
        const icon = document.createElement("div");
        (0, Utils_1.setIcon)(icon, this.icon);
        iconContainer.appendChild(icon);
        if (!this.static) {
            icon.style.cursor = "pointer";
            iconContainer.addEventListener("click", async (event) => await this.handleIconClick(update, event));
        }
        return iconContainer;
    }
    // Fonction pour gérer le clic sur l'icône
    async handleIconClick(update, event) {
        let selectedFileObj = await (0, Utils_1.selectFile)(this.vault, this.classes, { hint: "Choisissez un fichier " + this.getClasses().join(" ou ") });
        if (selectedFileObj) {
            const selectedFile = selectedFileObj.getLink();
            await update(selectedFile);
            const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
            if (link) {
                link.textContent = selectedFile.slice(2, -2);
            }
        }
    }
    // Fonction pour gérer le clic sur l'icône
    async modifyField(event) {
        const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
        let currentField = link.textContent;
        if (!currentField) {
            return;
        }
        event.preventDefault();
        const classe = this.vault.getFromLink(currentField);
        if (classe) {
            const leaf = this.vault.app.workspace.getLeaf();
            await leaf.openFile(classe.file);
        }
        else {
            console.error(`Le fichier ${currentField}.md n'existe pas`); // TODO: Use Notice when available
        }
    }
    // Fonction pour créer le conteneur principal pour l'field
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        const currentField = this.getPretty(value);
        const link = document.createElement("a");
        link.href = this.getLink(value);
        link.textContent = currentField || "";
        link.classList.add("field-link");
        link.style.display = "block";
        fieldContainer.appendChild(link);
        return fieldContainer;
    }
}
exports.FileProperty = FileProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXEZpbGVQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQSwwQ0FBcUQ7QUFDckQsaURBQThDO0FBSzlDLE1BQWEsWUFBYSxTQUFRLDJCQUFZO0lBSTFDLHVDQUF1QztJQUN2QyxZQUFZLElBQWEsRUFBRSxLQUFZLEVBQUUsT0FBaUIsRUFBRSxJQUFJLEdBQUUsRUFBRTtRQUNsRSxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUhYLFNBQUksR0FBWSxNQUFNLENBQUM7UUFJckMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDekIsQ0FBQztJQUVELFVBQVU7UUFDUixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUE7SUFDckIsQ0FBQztJQUVELHFEQUFxRDtJQUNyRCxjQUFjLENBQUMsTUFBWTtRQUN6QixPQUFPLE1BQU0sQ0FBQyxDQUFDLHNCQUFzQjtJQUN2QyxDQUFDO0lBRVEsU0FBUyxDQUFDLEtBQWE7UUFDOUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0lBRUQsU0FBUyxDQUFDLElBQVc7UUFDbkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQixJQUFJLElBQUksRUFBRSxDQUFDO1lBQ1QsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDWCxPQUFPLE1BQU0sQ0FBQztZQUNoQixDQUFDO1FBQ0gsQ0FBQztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFUSxR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QUMsQ0FBQztRQUNoRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxXQUFXLEdBQUcsWUFBWSxJQUFJLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDNUIsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVqQyxPQUFPLGNBQWMsQ0FBQztJQUMxQixDQUFDO0NBRUo7QUF4SEQsb0NBd0hDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFxwcm9wZXJ0aWVzXFxGaWxlUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmlsZSB9IGZyb20gXCIuLi92YXVsdC9GaWxlXCI7XHJcbmltcG9ydCB7IFByb3BlcnR5IH0gZnJvbSBcIi4vUHJvcGVydHlcIjtcclxuaW1wb3J0IHsgQ2xhc3NlIH0gZnJvbSBcIi4uL3ZhdWx0L0NsYXNzZVwiO1xyXG5pbXBvcnQgeyBzZXRJY29uLCBzZWxlY3RGaWxlIH0gZnJvbSBcIi4uL3ZhdWx0L1V0aWxzXCI7XHJcbmltcG9ydCB7IExpbmtQcm9wZXJ0eSB9IGZyb20gXCIuL0xpbmtQcm9wZXJ0eVwiO1xyXG5pbXBvcnQgeyB2YWwgfSBmcm9tIFwiY2hlZXJpby9kaXN0L2NvbW1vbmpzL2FwaS9hdHRyaWJ1dGVzXCI7XHJcbmltcG9ydCB7IFZhdWx0IH0gZnJvbSBcIi4uL3ZhdWx0L1ZhdWx0XCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIEZpbGVQcm9wZXJ0eSBleHRlbmRzIExpbmtQcm9wZXJ0eXtcclxuXHJcbiAgICBwdWJsaWMgY2xhc3NlcyA6IHN0cmluZ1tdO1xyXG4gICAgcHVibGljIG92ZXJyaWRlIHR5cGUgOiBzdHJpbmcgPSBcImZpbGVcIjtcclxuICAgIC8vIFVzZWQgZm9yIHByb3BlcnR5IHdpdGggYSBzaW5nbGUgZmlsZVxyXG4gICAgY29uc3RydWN0b3IobmFtZSA6IHN0cmluZywgdmF1bHQ6IFZhdWx0LCBjbGFzc2VzOiBzdHJpbmdbXSwgYXJncz0ge30pe1xyXG4gICAgICBzdXBlcihuYW1lLCB2YXVsdCwgYXJncyk7XHJcbiAgICAgIHRoaXMuY2xhc3NlcyA9IGNsYXNzZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q2xhc3NlcygpIDogc3RyaW5nW10ge1xyXG4gICAgICByZXR1cm4gdGhpcy5jbGFzc2VzXHJcbiAgICB9XHJcblxyXG4gICAgLy8gVXNlZCBieSB0aGUgQ2xhc3NlUHJvcGVydHkgdG8gZ2V0IHRoZSBwYXJlbnQgdmFsdWVcclxuICAgIGdldFBhcmVudFZhbHVlKHZhbHVlcyA6IGFueSl7XHJcbiAgICAgIHJldHVybiB2YWx1ZXM7IC8vIEVubMOodmUgbGVzIFtbIGV0IF1dXHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgZ2V0UHJldHR5KHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgcmV0dXJuIHRoaXMudmF1bHQucmVhZExpbmtGaWxlKHZhbHVlKVxyXG4gICAgfVxyXG5cclxuICAgIGdldENsYXNzZShmaWxlIDogRmlsZSk6IENsYXNzZSB8IHVuZGVmaW5lZHtcclxuICAgICAgbGV0IGxpbmsgPSB0aGlzLnJlYWQoZmlsZSk7XHJcbiAgICAgIGlmIChsaW5rKSB7XHJcbiAgICAgICAgbGV0IGNsYXNzZSA9IHRoaXMudmF1bHQuZ2V0RnJvbUxpbmsobGluayk7XHJcbiAgICAgICAgaWYgKGNsYXNzZSkge1xyXG4gICAgICAgICAgcmV0dXJuIGNsYXNzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSB2YWxpZGF0ZSh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgLy8gRXhwcmVzc2lvbiByw6lndWxpw6hyZSBwb3VyIGTDqXRlY3RlciBsZXMgbGllbnMgT2JzaWRpYW4gYXUgZm9ybWF0IFtbLi4uXV1cclxuICAgICAgY29uc3QgcmVnZXggPSAvXFxbXFxbKFteXFxdXSspXFxdXFxdLztcclxuICAgICAgY29uc3QgbWF0Y2ggPSB2YWx1ZS5tYXRjaChyZWdleCk7XHJcbiAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xyXG4gICAgICAgICAgcmV0dXJuIGBbWyR7bWF0Y2hbMV19XV1gO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBcIlwiO1xyXG4gICB9XHJcblxyXG4gICBvdmVycmlkZSBnZXRMaW5rKHZhbHVlOiBzdHJpbmcsIHZhdWx0PyA6IGFueSk6IHN0cmluZyB7XHJcbiAgICBpZiAodmF1bHQpIHtcclxuICAgICAgdGhpcy52YXVsdCA9IHZhdWx0O1xyXG4gICAgfVxyXG4gICAgY29uc3QgdmF1bHROYW1lID0gdGhpcy52YXVsdC5hcHAudmF1bHQuZ2V0TmFtZSgpOyBcclxuICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy52YXVsdC5yZWFkTGlua0ZpbGUodmFsdWUsIHRydWUpO1xyXG5cclxuICAgIC8vIElmIHJlYWRMaW5rRmlsZSByZXR1cm5lZCBhIHBhdGggYW5kIHRoZSBmaWxlIGV4aXN0cyBpbiB0aGUgdmF1bHQsIHVzZSBpdC5cclxuICAgIGlmIChmaWxlUGF0aCAmJiB0aGlzLnZhdWx0LmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpKSB7XHJcbiAgICAgIHJldHVybiBgb2JzaWRpYW46Ly9vcGVuP3ZhdWx0PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHZhdWx0TmFtZSl9JmZpbGU9JHtlbmNvZGVVUklDb21wb25lbnQoZmlsZVBhdGgpfWA7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRmFsbGJhY2s6IGV4dHJhY3QgdGhlIG5hbWUgb25seSBmcm9tIHRoZSBsaW5rXHJcbiAgICBjb25zdCBuYW1lT25seSA9IHRoaXMudmF1bHQucmVhZExpbmtGaWxlKHZhbHVlKTtcclxuICAgIHJldHVybiBgb2JzaWRpYW46Ly9vcGVuP3ZhdWx0PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHZhdWx0TmFtZSl9JmZpbGU9JHtlbmNvZGVVUklDb21wb25lbnQobmFtZU9ubHkpfWA7XHJcbiAgIH1cclxuICBcclxuICAgb3ZlcnJpZGUgY3JlYXRlSWNvbkNvbnRhaW5lcih1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+KSB7XHJcbiAgICBjb25zdCBpY29uQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgIGljb25Db250YWluZXIuY2xhc3NMaXN0LmFkZChcImljb24tY29udGFpbmVyXCIpO1xyXG5cclxuICAgIGNvbnN0IGljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgc2V0SWNvbihpY29uLCB0aGlzLmljb24pO1xyXG4gICAgaWNvbkNvbnRhaW5lci5hcHBlbmRDaGlsZChpY29uKTtcclxuXHJcbiAgICBpZiAoIXRoaXMuc3RhdGljKSB7XHJcbiAgICAgIGljb24uc3R5bGUuY3Vyc29yID0gXCJwb2ludGVyXCI7XHJcbiAgICAgIGljb25Db250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGFzeW5jIChldmVudCkgPT4gYXdhaXQgdGhpcy5oYW5kbGVJY29uQ2xpY2sodXBkYXRlLCBldmVudCkpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICByZXR1cm4gaWNvbkNvbnRhaW5lcjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGb25jdGlvbiBwb3VyIGfDqXJlciBsZSBjbGljIHN1ciBsJ2ljw7RuZVxyXG4gICAgYXN5bmMgaGFuZGxlSWNvbkNsaWNrKHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIGV2ZW50OiBFdmVudCkge1xyXG4gICAgICAgIGxldCBzZWxlY3RlZEZpbGVPYmogPSBhd2FpdCBzZWxlY3RGaWxlKHRoaXMudmF1bHQsIHRoaXMuY2xhc3Nlcywge2hpbnQ6XCJDaG9pc2lzc2V6IHVuIGZpY2hpZXIgXCIgKyB0aGlzLmdldENsYXNzZXMoKS5qb2luKFwiIG91IFwiKX0pO1xyXG4gICAgICAgIGlmIChzZWxlY3RlZEZpbGVPYmope1xyXG4gICAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWxlID0gc2VsZWN0ZWRGaWxlT2JqLmdldExpbmsoKTtcclxuICAgICAgICAgIGF3YWl0IHVwZGF0ZShzZWxlY3RlZEZpbGUpXHJcbiAgICAgICAgICBjb25zdCBsaW5rID0gKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuY2xvc2VzdCgnLm1ldGFkYXRhLWZpZWxkJyk/LnF1ZXJ5U2VsZWN0b3IoJy5maWVsZC1saW5rJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmIChsaW5rKSB7XHJcbiAgICAgICAgICAgICAgbGluay50ZXh0Q29udGVudCA9IHNlbGVjdGVkRmlsZS5zbGljZSgyLCAtMik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9uY3Rpb24gcG91ciBnw6lyZXIgbGUgY2xpYyBzdXIgbCdpY8O0bmVcclxuICAgIG92ZXJyaWRlIGFzeW5jIG1vZGlmeUZpZWxkKGV2ZW50OiBFdmVudCkge1xyXG4gICAgICBjb25zdCBsaW5rID0gKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuY2xvc2VzdCgnLm1ldGFkYXRhLWZpZWxkJyk/LnF1ZXJ5U2VsZWN0b3IoJy5maWVsZC1saW5rJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgIGxldCBjdXJyZW50RmllbGQgPSBsaW5rLnRleHRDb250ZW50XHJcbiAgICAgIGlmICghY3VycmVudEZpZWxkKXtyZXR1cm59XHJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgXHJcbiAgICAgIGNvbnN0IGNsYXNzZSA9IHRoaXMudmF1bHQuZ2V0RnJvbUxpbmsoY3VycmVudEZpZWxkKTtcclxuICAgICAgaWYgKGNsYXNzZSkge1xyXG4gICAgICAgICAgY29uc3QgbGVhZiA9IHRoaXMudmF1bHQuYXBwLndvcmtzcGFjZS5nZXRMZWFmKCk7XHJcbiAgICAgICAgICBhd2FpdCBsZWFmLm9wZW5GaWxlKGNsYXNzZS5maWxlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBMZSBmaWNoaWVyICR7Y3VycmVudEZpZWxkfS5tZCBuJ2V4aXN0ZSBwYXNgKSAvLyBUT0RPOiBVc2UgTm90aWNlIHdoZW4gYXZhaWxhYmxlXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIEZvbmN0aW9uIHBvdXIgY3LDqWVyIGxlIGNvbnRlbmV1ciBwcmluY2lwYWwgcG91ciBsJ2ZpZWxkXHJcbiAgICBvdmVycmlkZSBjcmVhdGVGaWVsZENvbnRhaW5lckNvbnRlbnQodXBkYXRlOiAodmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiwgdmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBmaWVsZENvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwiZmllbGQtY29udGFpbmVyXCIpO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGaWVsZCA9IHRoaXMuZ2V0UHJldHR5KHZhbHVlKTtcclxuICAgICAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIik7XHJcbiAgICAgICAgbGluay5ocmVmID0gdGhpcy5nZXRMaW5rKHZhbHVlKTtcclxuICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gY3VycmVudEZpZWxkIHx8IFwiXCI7XHJcbiAgICAgICAgbGluay5jbGFzc0xpc3QuYWRkKFwiZmllbGQtbGlua1wiKTtcclxuICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCJcclxuICAgICAgICBmaWVsZENvbnRhaW5lci5hcHBlbmRDaGlsZChsaW5rKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGZpZWxkQ29udGFpbmVyO1xyXG4gICAgfVxyXG5cclxufSJdLCJ2ZXJzaW9uIjozfQ==