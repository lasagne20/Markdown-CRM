d73aaa92717045a75a374a353332765d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileProperty = void 0;
const LinkProperty_1 = require("./LinkProperty");
class FileProperty extends LinkProperty_1.LinkProperty {
    // Used for property with a single file
    constructor(name, vault, classes, args = {}) {
        super(name, vault, args);
        this.type = "file";
        this.classes = classes;
    }
    getClasses() {
        return this.classes;
    }
    getPretty(value) {
        return this.vault.readLinkFile(value);
    }
    async getClasse(file) {
        let link = await this.read(file);
        if (link) {
            let classe = await this.vault.getFromLink(link);
            if (classe) {
                return classe;
            }
        }
        return undefined;
    }
    validate(value) {
        // Expression régulière pour détecter les liens Obsidian au format [[...]]
        const regex = /\[\[([^\]]+)\]\]/;
        const match = value.match(regex);
        if (match && match[1]) {
            return `[[${match[1]}]]`;
        }
        return "";
    }
    getLink(value, vault) {
        if (vault) {
            this.vault = vault;
        }
        const vaultName = this.vault.getName();
        const filePath = this.vault.readLinkFile(value, true);
        // If readLinkFile returned a path and the file exists in the vault, use it.
        if (filePath) {
            return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(filePath)}`;
        }
        // Fallback: extract the name only from the link
        const nameOnly = this.vault.readLinkFile(value);
        return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(nameOnly)}`;
    }
    createIconContainer(update) {
        const iconContainer = document.createElement("div");
        iconContainer.classList.add("icon-container");
        const icon = document.createElement("div");
        this.vault.app.setIcon(icon, this.icon);
        iconContainer.appendChild(icon);
        if (!this.static) {
            icon.style.cursor = "pointer";
            iconContainer.addEventListener("click", async (event) => await this.handleIconClick(update, event));
        }
        return iconContainer;
    }
    // Fonction pour gérer le clic sur l'icône
    async handleIconClick(update, event) {
        let selectedFileObj = await this.vault.app.selectFile(this.vault, this.classes, { hint: "Choisissez un fichier " + this.getClasses().join(" ou ") });
        if (selectedFileObj) {
            const selectedFile = selectedFileObj.getLink();
            await update(selectedFile);
            const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
            if (link) {
                link.textContent = selectedFile.slice(2, -2);
            }
        }
    }
    // Fonction pour gérer le clic sur l'icône
    async modifyField(event) {
        const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
        let currentField = link.textContent;
        if (!currentField) {
            return;
        }
        event.preventDefault();
        const classe = await this.vault.getFromLink(currentField);
        if (classe) {
            let path = classe.getPath();
            if (path) {
                await this.vault.app.open(path);
            }
        }
        else {
            console.error(`Le fichier ${currentField}.md n'existe pas`); // TODO: Use Notice when available
        }
    }
    // Fonction pour créer le conteneur principal pour l'field
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        const currentField = this.getPretty(value);
        const link = document.createElement("a");
        link.href = this.getLink(value);
        link.textContent = currentField || "";
        link.classList.add("field-link");
        link.style.display = "block";
        fieldContainer.appendChild(link);
        return fieldContainer;
    }
}
exports.FileProperty = FileProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXEZpbGVQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQSxpREFBOEM7QUFLOUMsTUFBYSxZQUFhLFNBQVEsMkJBQVk7SUFJMUMsdUNBQXVDO0lBQ3ZDLFlBQVksSUFBYSxFQUFFLEtBQVksRUFBRSxPQUFpQixFQUFFLElBQUksR0FBRSxFQUFFO1FBQ2xFLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSFgsU0FBSSxHQUFZLE1BQU0sQ0FBQztRQUlyQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUN6QixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQTtJQUNyQixDQUFDO0lBRVEsU0FBUyxDQUFDLEtBQWE7UUFDOUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFXO1FBQ3pCLElBQUksSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ1QsSUFBSSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoRCxJQUFJLE1BQU0sRUFBRSxDQUFDO2dCQUNYLE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUM7UUFDSCxDQUFDO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVRLFFBQVEsQ0FBQyxLQUFhO1FBQzdCLDBFQUEwRTtRQUMxRSxNQUFNLEtBQUssR0FBRyxrQkFBa0IsQ0FBQztRQUNqQyxNQUFN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USxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxZQUFZLElBQUksRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtRQUM1QixjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWpDLE9BQU8sY0FBYyxDQUFDO0lBQzFCLENBQUM7Q0FFSjtBQXJIRCxvQ0FxSEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXEZpbGVQcm9wZXJ0eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGaWxlIH0gZnJvbSBcIi4uL3ZhdWx0L0ZpbGVcIjtcclxuaW1wb3J0IHsgUHJvcGVydHkgfSBmcm9tIFwiLi9Qcm9wZXJ0eVwiO1xyXG5pbXBvcnQgeyBDbGFzc2UgfSBmcm9tIFwiLi4vdmF1bHQvQ2xhc3NlXCI7XHJcbmltcG9ydCB7IExpbmtQcm9wZXJ0eSB9IGZyb20gXCIuL0xpbmtQcm9wZXJ0eVwiO1xyXG5pbXBvcnQgeyB2YWwgfSBmcm9tIFwiY2hlZXJpby9kaXN0L2NvbW1vbmpzL2FwaS9hdHRyaWJ1dGVzXCI7XHJcbmltcG9ydCB7IFZhdWx0IH0gZnJvbSBcIi4uL3ZhdWx0L1ZhdWx0XCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIEZpbGVQcm9wZXJ0eSBleHRlbmRzIExpbmtQcm9wZXJ0eXtcclxuXHJcbiAgICBwdWJsaWMgY2xhc3NlcyA6IHN0cmluZ1tdO1xyXG4gICAgcHVibGljIG92ZXJyaWRlIHR5cGUgOiBzdHJpbmcgPSBcImZpbGVcIjtcclxuICAgIC8vIFVzZWQgZm9yIHByb3BlcnR5IHdpdGggYSBzaW5nbGUgZmlsZVxyXG4gICAgY29uc3RydWN0b3IobmFtZSA6IHN0cmluZywgdmF1bHQ6IFZhdWx0LCBjbGFzc2VzOiBzdHJpbmdbXSwgYXJncz0ge30pe1xyXG4gICAgICBzdXBlcihuYW1lLCB2YXVsdCwgYXJncyk7XHJcbiAgICAgIHRoaXMuY2xhc3NlcyA9IGNsYXNzZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q2xhc3NlcygpIDogc3RyaW5nW10ge1xyXG4gICAgICByZXR1cm4gdGhpcy5jbGFzc2VzXHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgZ2V0UHJldHR5KHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgcmV0dXJuIHRoaXMudmF1bHQucmVhZExpbmtGaWxlKHZhbHVlKVxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGdldENsYXNzZShmaWxlIDogRmlsZSk6IFByb21pc2U8Q2xhc3NlIHwgdW5kZWZpbmVkPntcclxuICAgICAgbGV0IGxpbmsgPSBhd2FpdCB0aGlzLnJlYWQoZmlsZSk7XHJcbiAgICAgIGlmIChsaW5rKSB7XHJcbiAgICAgICAgbGV0IGNsYXNzZSA9IGF3YWl0IHRoaXMudmF1bHQuZ2V0RnJvbUxpbmsobGluayk7XHJcbiAgICAgICAgaWYgKGNsYXNzZSkge1xyXG4gICAgICAgICAgcmV0dXJuIGNsYXNzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSB2YWxpZGF0ZSh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgLy8gRXhwcmVzc2lvbiByw6lndWxpw6hyZSBwb3VyIGTDqXRlY3RlciBsZXMgbGllbnMgT2JzaWRpYW4gYXUgZm9ybWF0IFtbLi4uXV1cclxuICAgICAgY29uc3QgcmVnZXggPSAvXFxbXFxbKFteXFxdXSspXFxdXFxdLztcclxuICAgICAgY29uc3QgbWF0Y2ggPSB2YWx1ZS5tYXRjaChyZWdleCk7XHJcbiAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xyXG4gICAgICAgICAgcmV0dXJuIGBbWyR7bWF0Y2hbMV19XV1gO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBcIlwiO1xyXG4gICB9XHJcblxyXG4gICBvdmVycmlkZSBnZXRMaW5rKHZhbHVlOiBzdHJpbmcsIHZhdWx0PyA6IGFueSk6IHN0cmluZyB7XHJcbiAgICBpZiAodmF1bHQpIHtcclxuICAgICAgdGhpcy52YXVsdCA9IHZhdWx0O1xyXG4gICAgfVxyXG4gICAgY29uc3QgdmF1bHROYW1lID0gdGhpcy52YXVsdC5nZXROYW1lKCk7IFxyXG4gICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLnZhdWx0LnJlYWRMaW5rRmlsZSh2YWx1ZSwgdHJ1ZSk7XHJcblxyXG4gICAgLy8gSWYgcmVhZExpbmtGaWxlIHJldHVybmVkIGEgcGF0aCBhbmQgdGhlIGZpbGUgZXhpc3RzIGluIHRoZSB2YXVsdCwgdXNlIGl0LlxyXG4gICAgaWYgKGZpbGVQYXRoKSB7XHJcbiAgICAgIHJldHVybiBgb2JzaWRpYW46Ly9vcGVuP3ZhdWx0PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHZhdWx0TmFtZSl9JmZpbGU9JHtlbmNvZGVVUklDb21wb25lbnQoZmlsZVBhdGgpfWA7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRmFsbGJhY2s6IGV4dHJhY3QgdGhlIG5hbWUgb25seSBmcm9tIHRoZSBsaW5rXHJcbiAgICBjb25zdCBuYW1lT25seSA9IHRoaXMudmF1bHQucmVhZExpbmtGaWxlKHZhbHVlKTtcclxuICAgIHJldHVybiBgb2JzaWRpYW46Ly9vcGVuP3ZhdWx0PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHZhdWx0TmFtZSl9JmZpbGU9JHtlbmNvZGVVUklDb21wb25lbnQobmFtZU9ubHkpfWA7XHJcbiAgIH1cclxuICBcclxuICAgb3ZlcnJpZGUgY3JlYXRlSWNvbkNvbnRhaW5lcih1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+KSB7XHJcbiAgICBjb25zdCBpY29uQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgIGljb25Db250YWluZXIuY2xhc3NMaXN0LmFkZChcImljb24tY29udGFpbmVyXCIpO1xyXG5cclxuICAgIGNvbnN0IGljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgdGhpcy52YXVsdC5hcHAuc2V0SWNvbihpY29uLCB0aGlzLmljb24pO1xyXG4gICAgaWNvbkNvbnRhaW5lci5hcHBlbmRDaGlsZChpY29uKTtcclxuXHJcbiAgICBpZiAoIXRoaXMuc3RhdGljKSB7XHJcbiAgICAgIGljb24uc3R5bGUuY3Vyc29yID0gXCJwb2ludGVyXCI7XHJcbiAgICAgIGljb25Db250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGFzeW5jIChldmVudCkgPT4gYXdhaXQgdGhpcy5oYW5kbGVJY29uQ2xpY2sodXBkYXRlLCBldmVudCkpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICByZXR1cm4gaWNvbkNvbnRhaW5lcjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGb25jdGlvbiBwb3VyIGfDqXJlciBsZSBjbGljIHN1ciBsJ2ljw7RuZVxyXG4gICAgYXN5bmMgaGFuZGxlSWNvbkNsaWNrKHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIGV2ZW50OiBFdmVudCkge1xyXG4gICAgICAgIGxldCBzZWxlY3RlZEZpbGVPYmogPSBhd2FpdCB0aGlzLnZhdWx0LmFwcC5zZWxlY3RGaWxlKHRoaXMudmF1bHQsIHRoaXMuY2xhc3Nlcywge2hpbnQ6XCJDaG9pc2lzc2V6IHVuIGZpY2hpZXIgXCIgKyB0aGlzLmdldENsYXNzZXMoKS5qb2luKFwiIG91IFwiKX0pO1xyXG4gICAgICAgIGlmIChzZWxlY3RlZEZpbGVPYmope1xyXG4gICAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWxlID0gc2VsZWN0ZWRGaWxlT2JqLmdldExpbmsoKTtcclxuICAgICAgICAgIGF3YWl0IHVwZGF0ZShzZWxlY3RlZEZpbGUpXHJcbiAgICAgICAgICBjb25zdCBsaW5rID0gKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuY2xvc2VzdCgnLm1ldGFkYXRhLWZpZWxkJyk/LnF1ZXJ5U2VsZWN0b3IoJy5maWVsZC1saW5rJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmIChsaW5rKSB7XHJcbiAgICAgICAgICAgICAgbGluay50ZXh0Q29udGVudCA9IHNlbGVjdGVkRmlsZS5zbGljZSgyLCAtMik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9uY3Rpb24gcG91ciBnw6lyZXIgbGUgY2xpYyBzdXIgbCdpY8O0bmVcclxuICAgIG92ZXJyaWRlIGFzeW5jIG1vZGlmeUZpZWxkKGV2ZW50OiBFdmVudCkge1xyXG4gICAgICBjb25zdCBsaW5rID0gKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCkuY2xvc2VzdCgnLm1ldGFkYXRhLWZpZWxkJyk/LnF1ZXJ5U2VsZWN0b3IoJy5maWVsZC1saW5rJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgIGxldCBjdXJyZW50RmllbGQgPSBsaW5rLnRleHRDb250ZW50XHJcbiAgICAgIGlmICghY3VycmVudEZpZWxkKXtyZXR1cm59XHJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgXHJcbiAgICAgIGNvbnN0IGNsYXNzZSA9IGF3YWl0IHRoaXMudmF1bHQuZ2V0RnJvbUxpbmsoY3VycmVudEZpZWxkKTtcclxuICAgICAgaWYgKGNsYXNzZSkge1xyXG4gICAgICAgIGxldCBwYXRoID0gY2xhc3NlLmdldFBhdGgoKVxyXG4gICAgICAgIGlmIChwYXRoKXtcclxuICAgICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC5vcGVuKHBhdGgpO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihgTGUgZmljaGllciAke2N1cnJlbnRGaWVsZH0ubWQgbidleGlzdGUgcGFzYCkgLy8gVE9ETzogVXNlIE5vdGljZSB3aGVuIGF2YWlsYWJsZVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyBGb25jdGlvbiBwb3VyIGNyw6llciBsZSBjb250ZW5ldXIgcHJpbmNpcGFsIHBvdXIgbCdmaWVsZFxyXG4gICAgb3ZlcnJpZGUgY3JlYXRlRmllbGRDb250YWluZXJDb250ZW50KHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBmaWVsZENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgZmllbGRDb250YWluZXIuY2xhc3NMaXN0LmFkZChcImZpZWxkLWNvbnRhaW5lclwiKTtcclxuICAgICAgICBjb25zdCBjdXJyZW50RmllbGQgPSB0aGlzLmdldFByZXR0eSh2YWx1ZSk7XHJcbiAgICAgICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhXCIpO1xyXG4gICAgICAgIGxpbmsuaHJlZiA9IHRoaXMuZ2V0TGluayh2YWx1ZSk7XHJcbiAgICAgICAgbGluay50ZXh0Q29udGVudCA9IGN1cnJlbnRGaWVsZCB8fCBcIlwiO1xyXG4gICAgICAgIGxpbmsuY2xhc3NMaXN0LmFkZChcImZpZWxkLWxpbmtcIik7XHJcbiAgICAgICAgbGluay5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiXHJcbiAgICAgICAgZmllbGRDb250YWluZXIuYXBwZW5kQ2hpbGQobGluayk7XHJcblxyXG4gICAgICAgIHJldHVybiBmaWVsZENvbnRhaW5lcjtcclxuICAgIH1cclxuXHJcbn0iXSwidmVyc2lvbiI6M30=