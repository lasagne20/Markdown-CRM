2aa9ea618c259359e3d6d70a0e5980b9
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileProperty = void 0;
const LinkProperty_1 = require("./LinkProperty");
class FileProperty extends LinkProperty_1.LinkProperty {
    // Used for property with a single file
    constructor(name, vault, classes, args = {}) {
        super(name, vault, args);
        this.type = "file";
        this.classes = classes;
    }
    getClasses() {
        return this.classes;
    }
    getPretty(value) {
        return this.vault.readLinkFile(value);
    }
    async getClasse(file) {
        let link = this.read(file);
        if (link) {
            let classe = await this.vault.getFromLink(link);
            if (classe) {
                return classe;
            }
        }
        return undefined;
    }
    validate(value) {
        // Expression régulière pour détecter les liens Obsidian au format [[...]]
        const regex = /\[\[([^\]]+)\]\]/;
        const match = value.match(regex);
        if (match && match[1]) {
            return `[[${match[1]}]]`;
        }
        return "";
    }
    getLink(value, vault) {
        if (vault) {
            this.vault = vault;
        }
        const vaultName = this.vault.getName();
        const filePath = this.vault.readLinkFile(value, true);
        // If readLinkFile returned a path and the file exists in the vault, use it.
        if (filePath) {
            return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(filePath)}`;
        }
        // Fallback: extract the name only from the link
        const nameOnly = this.vault.readLinkFile(value);
        return `obsidian://open?vault=${encodeURIComponent(vaultName)}&file=${encodeURIComponent(nameOnly)}`;
    }
    createIconContainer(update) {
        const iconContainer = document.createElement("div");
        iconContainer.classList.add("icon-container");
        const icon = document.createElement("div");
        this.vault.app.setIcon(icon, this.icon);
        iconContainer.appendChild(icon);
        if (!this.static) {
            icon.style.cursor = "pointer";
            iconContainer.addEventListener("click", async (event) => await this.handleIconClick(update, event));
        }
        return iconContainer;
    }
    // Fonction pour gérer le clic sur l'icône
    async handleIconClick(update, event) {
        let selectedFileObj = await this.vault.app.selectFile(this.vault, this.classes, { hint: "Choisissez un fichier " + this.getClasses().join(" ou ") });
        if (selectedFileObj) {
            const selectedFile = selectedFileObj.getLink();
            await update(selectedFile);
            const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
            if (link) {
                link.textContent = selectedFile.slice(2, -2);
            }
        }
    }
    // Fonction pour gérer le clic sur l'icône
    async modifyField(event) {
        const link = event.target.closest('.metadata-field')?.querySelector('.field-link');
        let currentField = link.textContent;
        if (!currentField) {
            return;
        }
        event.preventDefault();
        const classe = await this.vault.getFromLink(currentField);
        if (classe) {
            let path = classe.getPath();
            if (path) {
                await this.vault.app.open(path);
            }
        }
        else {
            console.error(`Le fichier ${currentField}.md n'existe pas`); // TODO: Use Notice when available
        }
    }
    // Fonction pour créer le conteneur principal pour l'field
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        const currentField = this.getPretty(value);
        const link = document.createElement("a");
        link.href = this.getLink(value);
        link.textContent = currentField || "";
        link.classList.add("field-link");
        link.style.display = "block";
        fieldContainer.appendChild(link);
        return fieldContainer;
    }
}
exports.FileProperty = FileProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXEZpbGVQcm9wZXJ0eS50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQSxpREFBOEM7QUFLOUMsTUFBYSxZQUFhLFNBQVEsMkJBQVk7SUFJMUMsdUNBQXVDO0lBQ3ZDLFlBQVksSUFBYSxFQUFFLEtBQVksRUFBRSxPQUFpQixFQUFFLElBQUksR0FBRSxFQUFFO1FBQ2xFLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSFgsU0FBSSxHQUFZLE1BQU0sQ0FBQztRQUlyQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUN6QixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQTtJQUNyQixDQUFDO0lBRVEsU0FBUyxDQUFDLEtBQWE7UUFDOUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFXO1FBQ3pCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0IsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUNULElBQUksTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEQsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDWCxPQUFPLE1BQU0sQ0FBQztZQUNoQixDQUFDO1FBQ0gsQ0FBQztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFUSxRQUFRLENBQUMsS0FBYTtRQUM3QiwwRUFBMEU7UUFDMUUsTUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUM7UUFDakMsTUFBTSxLQUFL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QyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxXQUFXLEdBQUcsWUFBWSxJQUFJLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDNUIsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVqQyxPQUFPLGNBQWMsQ0FBQztJQUMxQixDQUFDO0NBRUo7QUFySEQsb0NBcUhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFxwcm9wZXJ0aWVzXFxGaWxlUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmlsZSB9IGZyb20gXCIuLi92YXVsdC9GaWxlXCI7XHJcbmltcG9ydCB7IFByb3BlcnR5IH0gZnJvbSBcIi4vUHJvcGVydHlcIjtcclxuaW1wb3J0IHsgQ2xhc3NlIH0gZnJvbSBcIi4uL3ZhdWx0L0NsYXNzZVwiO1xyXG5pbXBvcnQgeyBMaW5rUHJvcGVydHkgfSBmcm9tIFwiLi9MaW5rUHJvcGVydHlcIjtcclxuaW1wb3J0IHsgdmFsIH0gZnJvbSBcImNoZWVyaW8vZGlzdC9jb21tb25qcy9hcGkvYXR0cmlidXRlc1wiO1xyXG5pbXBvcnQgeyBWYXVsdCB9IGZyb20gXCIuLi92YXVsdC9WYXVsdFwiO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBGaWxlUHJvcGVydHkgZXh0ZW5kcyBMaW5rUHJvcGVydHl7XHJcblxyXG4gICAgcHVibGljIGNsYXNzZXMgOiBzdHJpbmdbXTtcclxuICAgIHB1YmxpYyBvdmVycmlkZSB0eXBlIDogc3RyaW5nID0gXCJmaWxlXCI7XHJcbiAgICAvLyBVc2VkIGZvciBwcm9wZXJ0eSB3aXRoIGEgc2luZ2xlIGZpbGVcclxuICAgIGNvbnN0cnVjdG9yKG5hbWUgOiBzdHJpbmcsIHZhdWx0OiBWYXVsdCwgY2xhc3Nlczogc3RyaW5nW10sIGFyZ3M9IHt9KXtcclxuICAgICAgc3VwZXIobmFtZSwgdmF1bHQsIGFyZ3MpO1xyXG4gICAgICB0aGlzLmNsYXNzZXMgPSBjbGFzc2VzO1xyXG4gICAgfVxyXG5cclxuICAgIGdldENsYXNzZXMoKSA6IHN0cmluZ1tdIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY2xhc3Nlc1xyXG4gICAgfVxyXG5cclxuICAgIG92ZXJyaWRlIGdldFByZXR0eSh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnZhdWx0LnJlYWRMaW5rRmlsZSh2YWx1ZSlcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRDbGFzc2UoZmlsZSA6IEZpbGUpOiBQcm9taXNlPENsYXNzZSB8IHVuZGVmaW5lZD57XHJcbiAgICAgIGxldCBsaW5rID0gdGhpcy5yZWFkKGZpbGUpO1xyXG4gICAgICBpZiAobGluaykge1xyXG4gICAgICAgIGxldCBjbGFzc2UgPSBhd2FpdCB0aGlzLnZhdWx0LmdldEZyb21MaW5rKGxpbmspO1xyXG4gICAgICAgIGlmIChjbGFzc2UpIHtcclxuICAgICAgICAgIHJldHVybiBjbGFzc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgdmFsaWRhdGUodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgIC8vIEV4cHJlc3Npb24gcsOpZ3VsacOocmUgcG91ciBkw6l0ZWN0ZXIgbGVzIGxpZW5zIE9ic2lkaWFuIGF1IGZvcm1hdCBbWy4uLl1dXHJcbiAgICAgIGNvbnN0IHJlZ2V4ID0gL1xcW1xcWyhbXlxcXV0rKVxcXVxcXS87XHJcbiAgICAgIGNvbnN0IG1hdGNoID0gdmFsdWUubWF0Y2gocmVnZXgpO1xyXG4gICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMV0pIHtcclxuICAgICAgICAgIHJldHVybiBgW1ske21hdGNoWzFdfV1dYDtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gXCJcIjtcclxuICAgfVxyXG5cclxuICAgb3ZlcnJpZGUgZ2V0TGluayh2YWx1ZTogc3RyaW5nLCB2YXVsdD8gOiBhbnkpOiBzdHJpbmcge1xyXG4gICAgaWYgKHZhdWx0KSB7XHJcbiAgICAgIHRoaXMudmF1bHQgPSB2YXVsdDtcclxuICAgIH1cclxuICAgIGNvbnN0IHZhdWx0TmFtZSA9IHRoaXMudmF1bHQuZ2V0TmFtZSgpOyBcclxuICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy52YXVsdC5yZWFkTGlua0ZpbGUodmFsdWUsIHRydWUpO1xyXG5cclxuICAgIC8vIElmIHJlYWRMaW5rRmlsZSByZXR1cm5lZCBhIHBhdGggYW5kIHRoZSBmaWxlIGV4aXN0cyBpbiB0aGUgdmF1bHQsIHVzZSBpdC5cclxuICAgIGlmIChmaWxlUGF0aCkge1xyXG4gICAgICByZXR1cm4gYG9ic2lkaWFuOi8vb3Blbj92YXVsdD0ke2VuY29kZVVSSUNvbXBvbmVudCh2YXVsdE5hbWUpfSZmaWxlPSR7ZW5jb2RlVVJJQ29tcG9uZW50KGZpbGVQYXRoKX1gO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEZhbGxiYWNrOiBleHRyYWN0IHRoZSBuYW1lIG9ubHkgZnJvbSB0aGUgbGlua1xyXG4gICAgY29uc3QgbmFtZU9ubHkgPSB0aGlzLnZhdWx0LnJlYWRMaW5rRmlsZSh2YWx1ZSk7XHJcbiAgICByZXR1cm4gYG9ic2lkaWFuOi8vb3Blbj92YXVsdD0ke2VuY29kZVVSSUNvbXBvbmVudCh2YXVsdE5hbWUpfSZmaWxlPSR7ZW5jb2RlVVJJQ29tcG9uZW50KG5hbWVPbmx5KX1gO1xyXG4gICB9XHJcbiAgXHJcbiAgIG92ZXJyaWRlIGNyZWF0ZUljb25Db250YWluZXIodXBkYXRlOiAodmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPikge1xyXG4gICAgY29uc3QgaWNvbkNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBpY29uQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJpY29uLWNvbnRhaW5lclwiKTtcclxuXHJcbiAgICBjb25zdCBpY29uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgIHRoaXMudmF1bHQuYXBwLnNldEljb24oaWNvbiwgdGhpcy5pY29uKTtcclxuICAgIGljb25Db250YWluZXIuYXBwZW5kQ2hpbGQoaWNvbik7XHJcblxyXG4gICAgaWYgKCF0aGlzLnN0YXRpYykge1xyXG4gICAgICBpY29uLnN0eWxlLmN1cnNvciA9IFwicG9pbnRlclwiO1xyXG4gICAgICBpY29uQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBhc3luYyAoZXZlbnQpID0+IGF3YWl0IHRoaXMuaGFuZGxlSWNvbkNsaWNrKHVwZGF0ZSwgZXZlbnQpKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIGljb25Db250YWluZXI7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9uY3Rpb24gcG91ciBnw6lyZXIgbGUgY2xpYyBzdXIgbCdpY8O0bmVcclxuICAgIGFzeW5jIGhhbmRsZUljb25DbGljayh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCBldmVudDogRXZlbnQpIHtcclxuICAgICAgICBsZXQgc2VsZWN0ZWRGaWxlT2JqID0gYXdhaXQgdGhpcy52YXVsdC5hcHAuc2VsZWN0RmlsZSh0aGlzLnZhdWx0LCB0aGlzLmNsYXNzZXMsIHtoaW50OlwiQ2hvaXNpc3NleiB1biBmaWNoaWVyIFwiICsgdGhpcy5nZXRDbGFzc2VzKCkuam9pbihcIiBvdSBcIil9KTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWRGaWxlT2JqKXtcclxuICAgICAgICAgIGNvbnN0IHNlbGVjdGVkRmlsZSA9IHNlbGVjdGVkRmlsZU9iai5nZXRMaW5rKCk7XHJcbiAgICAgICAgICBhd2FpdCB1cGRhdGUoc2VsZWN0ZWRGaWxlKVxyXG4gICAgICAgICAgY29uc3QgbGluayA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmNsb3Nlc3QoJy5tZXRhZGF0YS1maWVsZCcpPy5xdWVyeVNlbGVjdG9yKCcuZmllbGQtbGluaycpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgICAgICAgICBpZiAobGluaykge1xyXG4gICAgICAgICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSBzZWxlY3RlZEZpbGUuc2xpY2UoMiwgLTIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEZvbmN0aW9uIHBvdXIgZ8OpcmVyIGxlIGNsaWMgc3VyIGwnaWPDtG5lXHJcbiAgICBvdmVycmlkZSBhc3luYyBtb2RpZnlGaWVsZChldmVudDogRXZlbnQpIHtcclxuICAgICAgY29uc3QgbGluayA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmNsb3Nlc3QoJy5tZXRhZGF0YS1maWVsZCcpPy5xdWVyeVNlbGVjdG9yKCcuZmllbGQtbGluaycpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgICBsZXQgY3VycmVudEZpZWxkID0gbGluay50ZXh0Q29udGVudFxyXG4gICAgICBpZiAoIWN1cnJlbnRGaWVsZCl7cmV0dXJufVxyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgIFxyXG4gICAgICBjb25zdCBjbGFzc2UgPSBhd2FpdCB0aGlzLnZhdWx0LmdldEZyb21MaW5rKGN1cnJlbnRGaWVsZCk7XHJcbiAgICAgIGlmIChjbGFzc2UpIHtcclxuICAgICAgICBsZXQgcGF0aCA9IGNsYXNzZS5nZXRQYXRoKClcclxuICAgICAgICBpZiAocGF0aCl7XHJcbiAgICAgICAgICAgYXdhaXQgdGhpcy52YXVsdC5hcHAub3BlbihwYXRoKTtcclxuICAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYExlIGZpY2hpZXIgJHtjdXJyZW50RmllbGR9Lm1kIG4nZXhpc3RlIHBhc2ApIC8vIFRPRE86IFVzZSBOb3RpY2Ugd2hlbiBhdmFpbGFibGVcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gRm9uY3Rpb24gcG91ciBjcsOpZXIgbGUgY29udGVuZXVyIHByaW5jaXBhbCBwb3VyIGwnZmllbGRcclxuICAgIG92ZXJyaWRlIGNyZWF0ZUZpZWxkQ29udGFpbmVyQ29udGVudCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCB2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgZmllbGRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1jb250YWluZXJcIik7XHJcbiAgICAgICAgY29uc3QgY3VycmVudEZpZWxkID0gdGhpcy5nZXRQcmV0dHkodmFsdWUpO1xyXG4gICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYVwiKTtcclxuICAgICAgICBsaW5rLmhyZWYgPSB0aGlzLmdldExpbmsodmFsdWUpO1xyXG4gICAgICAgIGxpbmsudGV4dENvbnRlbnQgPSBjdXJyZW50RmllbGQgfHwgXCJcIjtcclxuICAgICAgICBsaW5rLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1saW5rXCIpO1xyXG4gICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIlxyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmFwcGVuZENoaWxkKGxpbmspO1xyXG5cclxuICAgICAgICByZXR1cm4gZmllbGRDb250YWluZXI7XHJcbiAgICB9XHJcblxyXG59Il0sInZlcnNpb24iOjN9