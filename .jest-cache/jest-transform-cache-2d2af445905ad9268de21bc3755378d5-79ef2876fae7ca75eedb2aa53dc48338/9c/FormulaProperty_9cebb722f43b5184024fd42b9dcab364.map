{"file":"C:\\Users\\leodu\\Documents\\1 - Pro\\Test plugin obsidian\\.obsidian\\plugins\\obsidian-CRM\\dynamic-fields\\src\\properties\\FormulaProperty.ts","mappings":";;;AACA,iDAA8C;AAE9C,MAAa,eAAgB,SAAQ,2BAAY;IAM7C,YAAY,IAAa,EAAE,OAAe,EAAE,OAA2D,EAAC,IAAI,EAAE,EAAE,EAAE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAC;QACzI,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QAJN,SAAI,GAAY,SAAS,CAAC;QACnC,UAAK,GAAa,KAAK,CAAC;QAI3B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,IAAI,KAAK,CAAC;IACrC,CAAC;IAEQ,QAAQ,CAAC,KAAa;QAC3B,OAAO,KAAK,CAAC;IACjB,CAAC;IAEQ,IAAI,CAAC,IAAU;QACpB,mCAAmC;QACnC,MAAM,iBAAiB,GAAG,IAAI,CAAC,gBAAgB,EAAE,IAAI,EAAE,CAAC;QACxD,4CAA4C;QAC5C,MAAM,aAAa,GAAwB,EAAE,CAAC;QAE9C,KAAK,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,iBAAiB,CAAC,EAAE,CAAC;YAC1D,IAAI,GAAG,KAAK,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC,2CAA2C;gBAChE,aAAa,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC;YACpD,CAAC;QACL,CAAC;QAED,IAAI,CAAC;YACD,MAAM,mBAAmB,GAAG,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC,CAAC,GAAwB,EAAE,GAAG,EAAE,EAAE;gBAC5F,MAAM,YAAY,GAAW,GAAG,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC;gBACrD,GAAG,CAAC,YAAY,CAAC,GAAG,aAAa,CAAC,GAAG,CAAC,CAAC;gBACvC,OAAO,GAAG,CAAC;YACf,CAAC,EAAE,EAAyB,CAAC,CAAC;YAE9B,MAAM,cAAc,GAChB;yCACyB,IAAI,CAAC,SAAS,CAAC,mBAAmB,CAAC;oCACxC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC;8BACzB,MAAM,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC;sBACnD,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,SAAS,GAAG,IAAI,CAAC,OAAO;iBACpE,CAAC;YAEN,MAAM,eAAe,GAAG,IAAI,QAAQ,CAAC,OAAO,EAAE,MAAM,EAAE,cAAc,CAAC,CAAC;YACtE,IAAI,KAAK,GAAG,eAAe,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;YAC9C,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;gBACb,IAAI,YAAY,GAAG,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACpD,IAAI,YAAY,KAAK,KAAK,EAAC,CAAC;oBACxB,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;gBAC1C,CAAC;YACL,CAAC;YACD,OAAO,KAAK,CAAC;QACjB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACb,IAAI,KAAK,YAAY,cAAc,EAAC,CAAC;gBACjC,OAAO,CAAC,KAAK,CAAC,kBAAkB,GAAG,IAAI,CAAC,OAAO,GAAG,MAAM;sBAClD,KAAK;sBACL,6CAA6C,EAAE,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;YAChG,CAAC;iBACI,CAAC;gBACF,OAAO,CAAC,KAAK,CAAC,kBAAkB,GAAG,IAAI,CAAC,OAAO,GAAG,MAAM,GAAG,KAAK,CAAC,CAAC;YACtE,CAAC;YACD,OAAO,IAAI,CAAC;QAChB,CAAC;IACL,CAAC;IACQ,SAAS,CAAC,KAAa;QAC5B,IAAI,CAAC,KAAK;YAAE,OAAO,KAAK,CAAC;QACzB,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;YAC5B,OAAO,CAAC,KAAK,CAAC,wBAAwB,EAAE,KAAK,CAAC,CAAC;YAC/C,OAAO,KAAK,CAAC;QACjB,CAAC;QAED,uBAAuB;QACvB,MAAM,SAAS,GAAG,qBAAqB,CAAC,CAAC,uBAAuB;QAChE,IAAI,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;YACxB,MAAM,UAAU,GAAG,IAAI,IAAI,CAAC,KAAK,CAAC,CAAC;YACnC,OAAO,UAAU,CAAC,kBAAkB,CAAC,OAAO,EAAE;gBAC1C,GAAG,EAAE,SAAS;gBACd,KAAK,EAAE,MAAM;gBACb,IAAI,EAAE,SAAS;aAClB,CAAC,CAAC;QAEP,CAAC;QACD,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,IAAI,MAAM,CAAC,SAAS,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC;YAC3D,OAAO,MAAM,CAAC,KAAK,CAAC,CAAC,cAAc,CAAC,OAAO,EAAC,EAAE,qBAAqB,EAAE,CAAC,EAAE,qBAAqB,EAAE,CAAC,EAAE,CAAC,CAAC;QACxG,CAAC;QAGD,OAAO,KAAK,CAAC,OAAO,CAAC,cAAc,EAAE,EAAE,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;IAEjF,CAAC;IAEQ,OAAO,CAAC,KAAa;QAC1B,IAAI,CAAC,KAAK;YAAE,OAAO,KAAK,CAAC;QAEzB,yBAAyB;QACzB,MAAM,UAAU,GAAG,kDAAkD,CAAC;QACtE,IAAI,UAAU,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;YACzB,OAAO,UAAU,KAAK,EAAE,CAAC;QAC7B,CAAC;QAED,yCAAyC;QACzC,MAAM,iBAAiB,GAAG,kBAAkB,CAAC;QAC7C,IAAI,CAAC;YACD,MAAM,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;YAC7C,IAAI,KAAK,IAAI,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC;gBACpB,OAAO,yBAAyB,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,OAAO,EAAE,SAAS,kBAAkB,CAAC,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;YAC5I,CAAC;YAED,4BAA4B;YAC5B,MAAM,QAAQ,GAAG,wEAAwE,CAAC;YAC1F,IAAI,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;gBACvB,OAAO,KAAK,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,UAAU,KAAK,EAAE,CAAC;YAChE,CAAC;QACL,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACb,OAAO,CAAC,KAAK,CAAC,0BAA0B,KAAK,GAAG,EAAE,KAAK,CAAC,CAAC;QAC7D,CAAC;QAED,OAAO,KAAK,CAAC;IACjB,CAAC;CAEJ;AAxHD,0CAwHC","names":[],"sources":["C:\\Users\\leodu\\Documents\\1 - Pro\\Test plugin obsidian\\.obsidian\\plugins\\obsidian-CRM\\dynamic-fields\\src\\properties\\FormulaProperty.ts"],"sourcesContent":["import { File } from '../vault/File';\r\nimport { LinkProperty } from './LinkProperty';\r\n\r\nexport class FormulaProperty extends LinkProperty {\r\n\r\n    public formula : string;\r\n    public override type : string = \"formula\";\r\n    public write : boolean = false;\r\n\r\n    constructor(name : string, formula: string, args : {icon: string, static?: boolean, write?: boolean} = {icon: \"\", static: true, write: false}) {\r\n        super(name, args);\r\n        this.formula = formula;\r\n        this.write = args.write ?? false;\r\n    }\r\n\r\n    override validate(value: string): string {\r\n        return value;\r\n    }\r\n\r\n    override read(file: File) : any {\r\n        // Get all properties from the file\r\n        const allFileProperties = file.getAllProperties() || {};\r\n        // Convert properties to their actual values\r\n        const allProperties: Record<string, any> = {};\r\n        \r\n        for (const [key, prop] of Object.entries(allFileProperties)) {\r\n            if (key !== this.name) { // Exclude self to avoid circular reference\r\n                allProperties[key] = file.getMetadataValue(key);\r\n            }\r\n        }\r\n        \r\n        try {\r\n            const sanitizedProperties = Object.keys(allProperties).reduce((acc: Record<string, any>, key) => {\r\n                const sanitizedKey: string = key.replace(/\\s+/g, \"\");\r\n                acc[sanitizedKey] = allProperties[key];\r\n                return acc;\r\n            }, {} as Record<string, any>);\r\n\r\n            const formulaContent = \r\n                `\r\n                    const properties = ${JSON.stringify(sanitizedProperties)};\r\n                    const name = \"${file.getName(false)}\";\r\n                    const { ${Object.keys(sanitizedProperties).join(\", \")} } = properties;\r\n                    ${this.formula.includes(\"return\") ? \"\" : \"return \"}${this.formula};\r\n                `;\r\n\r\n            const formulaFunction = new Function(\"vault\", \"file\", formulaContent);\r\n            let value = formulaFunction(file.vault, file);\r\n            if (this.write) {\r\n                let currentValue = file.getMetadataValue(this.name);\r\n                if (currentValue !== value){\r\n                    file.updateMetadata(this.name, value);\r\n                } \r\n            }\r\n            return value;\r\n        } catch (error) {\r\n            if (error instanceof ReferenceError){\r\n                console.error(\"Formula error : \" + this.formula + \"\\n\\n\"\r\n                    + error \r\n                    + \"\\n\\nThis is all the properties available : \", Object.keys(allProperties).join(\", \"));\r\n            }\r\n            else {\r\n                console.error(\"Formula error : \" + this.formula + \"\\n\\n\" + error);\r\n            }\r\n            return null;\r\n        }\r\n    }\r\n    override getPretty(value: string) {\r\n        if (!value) return value;\r\n        if (typeof value !== \"string\") {\r\n            console.error(\"Value is not a string:\", value);\r\n            return value;\r\n        }\r\n\r\n        // Check if it's a date\r\n        const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/; // Matches \"YYYY-MM-DD\"\r\n        if (dateRegex.test(value)) {\r\n            const parsedDate = new Date(value);\r\n            return parsedDate.toLocaleDateString(\"fr-FR\", {\r\n                day: \"numeric\",\r\n                month: \"long\",\r\n                year: \"numeric\"\r\n            });\r\n\r\n        }\r\n        if (!isNaN(Number(value)) && Number.isInteger(Number(value))) {\r\n            return Number(value).toLocaleString(\"fr-FR\",{ minimumFractionDigits: 2, maximumFractionDigits: 2 });\r\n        }\r\n\r\n        \r\n        return value.replace(/^https?:\\/\\//, \"\").replace(\"[[\", \"\").replace(\"]]\", \"\");\r\n\r\n    }\r\n\r\n    override getLink(value: string): string {\r\n        if (!value) return value;\r\n\r\n        // Check if it's an email\r\n        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\r\n        if (emailRegex.test(value)) {\r\n            return `mailto:${value}`;\r\n        }\r\n\r\n        // Check if it's an Obsidian link [[...]]\r\n        const obsidianLinkRegex = /\\[\\[([^\\]]+)\\]\\]/;\r\n        try {\r\n            const match = value.match(obsidianLinkRegex);\r\n            if (match && match[1]) {\r\n                return `obsidian://open?vault=${this.vault.app.vault.getName()}&file=${encodeURIComponent(this.vault.readLinkFile(match[1], true)[1])}`;\r\n            }\r\n\r\n            // Check if it's a valid URL\r\n            const urlRegex = /^(https?:\\/\\/)?([a-zA-Z0-9_-]+\\.)+[a-zA-Z]{2,6}(\\/[a-zA-Z0-9_-]+)*\\/?$/;\r\n            if (urlRegex.test(value)) {\r\n                return value.startsWith(\"http\") ? value : `http://${value}`;\r\n            }\r\n        } catch (error) {\r\n            console.error(`Error parsing link for ${value}:`, error);\r\n        }\r\n\r\n        return value;\r\n    }\r\n\r\n}"],"version":3}