100d543825c96e246802b6e1c5b55844
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Classe = void 0;
class Classe {
    constructor(vault, file, data) {
        this.vault = vault;
        this.properties = [];
        this.name = '';
        this.icon = '';
        this.data = null;
        this.displayConfig = {};
        if (file) {
            this.setFile(file);
        }
        if (data) {
            this.data = data;
        }
    }
    getName() {
        return this.name;
    }
    // Property management
    addProperty(property) {
        this.properties.push(property);
    }
    getProperty(name) {
        return this.properties.find(p => p.name === name);
    }
    getProperties() {
        return [...this.properties];
    }
    // File operations
    setFile(file) {
        this.file = file;
    }
    getFile() {
        return this.file;
    }
    getPath() {
        return this.file?.getPath();
    }
    async update() {
        if (!this.file)
            return;
        // Update metadata
        await this.updateAllPropertiesMetadata();
    }
    async validate() {
        // Validate all properties
        for (const property of this.properties) {
            const value = await this.getPropertyValue(property.name);
            if (!property.validate(value)) {
                return false;
            }
        }
        return true;
    }
    // Content generation helpers
    async generateFrontMatter() {
        const metadata = await this.getMetadata();
        const lines = ['---'];
        // Add class-specific metadata
        if (this.name)
            metadata.type = this.name;
        if (this.icon)
            metadata.icon = this.icon;
        // Add property values
        for (const property of this.properties) {
            const value = await this.getPropertyValue(property.name);
            if (value !== undefined && value !== '') {
                metadata[property.name] = value;
            }
        }
        // Convert to YAML
        for (const [key, value] of Object.entries(metadata)) {
            if (Array.isArray(value)) {
                lines.push(`${key}:`);
                value.forEach(item => lines.push(`  - ${item}`));
            }
            else if (typeof value === 'object' && value !== null) {
                lines.push(`${key}:`);
                for (const [subKey, subValue] of Object.entries(value)) {
                    lines.push(`  ${subKey}: ${subValue}`);
                }
            }
            else {
                lines.push(`${key}: ${value}`);
            }
        }
        lines.push('---\n');
        return lines.join('\n');
    }
    async generateTemplateContent() {
        if (!this.template)
            return '';
        try {
            return await this.vault.app.getTemplateContent(this.template);
        }
        catch (error) {
            console.warn(`Template ${this.template} not found`);
            return '';
        }
    }
    // Metadata operations
    async getMetadata() {
        if (!this.file)
            return {};
        return await this.vault.app.getMetadata(this.file);
    }
    async updateMetadata(metadata) {
        if (!this.file)
            return;
        await this.vault.app.updateMetadata(this.file, metadata);
    }
    async getPropertyValue(propertyName) {
        const metadata = await this.getMetadata();
        return metadata[propertyName];
    }
    async setPropertyValue(propertyName, value) {
        const metadata = await this.getMetadata();
        metadata[propertyName] = value;
        await this.updateMetadata(metadata);
    }
    async updateAllPropertiesMetadata() {
        const metadata = await this.getMetadata();
        let hasChanges = false;
        for (const property of this.properties) {
            const currentValue = metadata[property.name];
            const validatedValue = property.validate(currentValue);
            if (validatedValue !== currentValue) {
                metadata[property.name] = validatedValue;
                hasChanges = true;
            }
        }
        if (hasChanges) {
            await this.updateMetadata(metadata);
        }
    }
    // Display methods
    async getDisplay() {
        const container = this.vault.app.createDiv('classe-display');
        // Add class header
        const header = this.vault.app.createDiv('classe-header');
        header.textContent = this.getName();
        if (this.icon) {
            this.vault.app.setIcon(header, this.icon);
        }
        container.appendChild(header);
        console.log('Adding properties to display for class: ' + this.getName());
        console.log('Number of properties: ' + this.properties.length);
        // Add properties
        for (const property of this.properties) {
            if (this.file) {
                const propertyDisplay = await property.getDisplay(this.file);
                container.appendChild(propertyDisplay);
            }
        }
        return container;
    }
    // Factory method for creating instances
    static create(vault) {
        throw new Error('Must implement create method in subclass');
    }
    // Utility methods
    sanitizeFileName(name) {
        return name.replace(/[<>:"/\\|?*]/g, '-').trim();
    }
    async ensureFolder(folderPath) {
        try {
            await this.vault.app.createFolder(folderPath);
        }
        catch (error) {
            // Folder might already exist, which is fine
        }
    }
    // Lifecycle hooks
    async onCreate() {
        // Override in subclasses for post-creation logic
    }
    async onUpdate() {
        // Override in subclasses for post-update logic
    }
    async onDelete() {
        // Override in subclasses for pre-deletion logic
    }
}
exports.Classe = Classe;
Classe.Properties = {};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHZhdWx0XFxDbGFzc2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBTUEsTUFBYSxNQUFNO0lBVWYsWUFBc0IsS0FBWSxFQUFFLElBQWEsRUFBRSxJQUFhO1FBQTFDLFVBQUssR0FBTCxLQUFLLENBQU87UUFSeEIsZUFBVSxHQUFlLEVBQUUsQ0FBQztRQUUvQixTQUFJLEdBQVcsRUFBRSxDQUFDO1FBQ2xCLFNBQUksR0FBVyxFQUFFLENBQUM7UUFFbEIsU0FBSSxHQUFpQixJQUFJLENBQUM7UUFDMUIsa0JBQWEsR0FBUyxFQUFFLENBQUM7UUFHNUIsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUNQLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkIsQ0FBQztRQUNELElBQUksSUFBSSxFQUFFLENBQUM7WUFDUCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNyQixDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUE7SUFDbEIsQ0FBQztJQUVELHNCQUFzQjtJQUN0QixXQUFXLENBQUMsUUFBa0I7UUFDMUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELFdBQVcsQ0FBQyxJQUFZO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxhQUFhO1FBQ1QsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxrQkFBa0I7SUFDbEIsT0FBTyxDQUFDLElBQVU7UUFD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LFVBQVUsQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsNENBQTRDO1FBQ2hELENBQUM7SUFDTCxDQUFDO0lBRUQsa0JBQWtCO0lBQ2xCLEtBQUssQ0FBQyxRQUFRO1FBQ1YsaURBQWlEO0lBQ3JELENBQUM7SUFFRCxLQUFLLENBQUMsUUFBUTtRQUNWLCtDQUErQztJQUNuRCxDQUFDO0lBRUQsS0FBSyxDQUFDLFFBQVE7UUFDVixnREFBZ0Q7SUFDcEQsQ0FBQzs7QUFuTkwsd0JBb05DO0FBbk5vQixpQkFBVSxHQUFnQyxFQUFFLEFBQWxDLENBQW1DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcbGVvZHVcXERvY3VtZW50c1xcMSAtIFByb1xcVGVzdCBwbHVnaW4gb2JzaWRpYW5cXC5vYnNpZGlhblxccGx1Z2luc1xcb2JzaWRpYW4tQ1JNXFxkeW5hbWljLWZpZWxkc1xcc3JjXFx2YXVsdFxcQ2xhc3NlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElGaWxlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9JQXBwJztcclxuaW1wb3J0IHsgVmF1bHQgfSBmcm9tICcuL1ZhdWx0JztcclxuaW1wb3J0IHsgUHJvcGVydHkgfSBmcm9tICcuLi9wcm9wZXJ0aWVzL1Byb3BlcnR5JztcclxuaW1wb3J0IHsgRmlsZSB9IGZyb20gJy4vRmlsZSc7XHJcbmltcG9ydCB7IERhdGEgfSBmcm9tICcuL0RhdGEnO1xyXG5cclxuZXhwb3J0IGNsYXNzIENsYXNzZSB7XHJcbiAgICBwcm90ZWN0ZWQgc3RhdGljIFByb3BlcnRpZXM6IHsgW2tleTogc3RyaW5nXTogUHJvcGVydHkgfSA9IHt9O1xyXG4gICAgcHJvdGVjdGVkIHByb3BlcnRpZXM6IFByb3BlcnR5W10gPSBbXTtcclxuICAgIHByb3RlY3RlZCBmaWxlPzogRmlsZTtcclxuICAgIHB1YmxpYyBuYW1lOiBzdHJpbmcgPSAnJztcclxuICAgIHB1YmxpYyBpY29uOiBzdHJpbmcgPSAnJztcclxuICAgIHB1YmxpYyB0ZW1wbGF0ZT86IHN0cmluZztcclxuICAgIHB1YmxpYyBkYXRhIDogRGF0YSB8IG51bGwgPSBudWxsO1xyXG4gICAgcHVibGljIGRpc3BsYXlDb25maWcgOiBhbnkgPSB7fTtcclxuICAgIFxyXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIHZhdWx0OiBWYXVsdCwgZmlsZSA/IDogRmlsZSwgZGF0YSA/IDogRGF0YSkge1xyXG4gICAgICAgIGlmIChmaWxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RmlsZShmaWxlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhID0gZGF0YTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TmFtZSgpOiBzdHJpbmd7IFxyXG4gICAgICByZXR1cm4gdGhpcy5uYW1lXHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFByb3BlcnR5IG1hbmFnZW1lbnRcclxuICAgIGFkZFByb3BlcnR5KHByb3BlcnR5OiBQcm9wZXJ0eSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMucHJvcGVydGllcy5wdXNoKHByb3BlcnR5KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZ2V0UHJvcGVydHkobmFtZTogc3RyaW5nKTogUHJvcGVydHkgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnByb3BlcnRpZXMuZmluZChwID0+IHAubmFtZSA9PT0gbmFtZSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGdldFByb3BlcnRpZXMoKTogUHJvcGVydHlbXSB7XHJcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLnByb3BlcnRpZXNdO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBGaWxlIG9wZXJhdGlvbnNcclxuICAgIHNldEZpbGUoZmlsZTogRmlsZSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZmlsZSA9IGZpbGU7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGdldEZpbGUoKTogRmlsZSB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQYXRoKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZT8uZ2V0UGF0aCgpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyB1cGRhdGUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmZpbGUpIHJldHVybjtcclxuICAgICAgICBcclxuICAgICAgICAvLyBVcGRhdGUgbWV0YWRhdGFcclxuICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUFsbFByb3BlcnRpZXNNZXRhZGF0YSgpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyB2YWxpZGF0ZSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgICAgICAvLyBWYWxpZGF0ZSBhbGwgcHJvcGVydGllc1xyXG4gICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgdGhpcy5wcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5nZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5Lm5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoIXByb3BlcnR5LnZhbGlkYXRlKHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBcclxuICAgIC8vIENvbnRlbnQgZ2VuZXJhdGlvbiBoZWxwZXJzXHJcbiAgICBwcm90ZWN0ZWQgYXN5bmMgZ2VuZXJhdGVGcm9udE1hdHRlcigpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgdGhpcy5nZXRNZXRhZGF0YSgpO1xyXG4gICAgICAgIGNvbnN0IGxpbmVzID0gWyctLS0nXTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBBZGQgY2xhc3Mtc3BlY2lmaWMgbWV0YWRhdGFcclxuICAgICAgICBpZiAodGhpcy5uYW1lKSBtZXRhZGF0YS50eXBlID0gdGhpcy5uYW1lO1xyXG4gICAgICAgIGlmICh0aGlzLmljb24pIG1ldGFkYXRhLmljb24gPSB0aGlzLmljb247XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQWRkIHByb3BlcnR5IHZhbHVlc1xyXG4gICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgdGhpcy5wcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5nZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5Lm5hbWUpO1xyXG4gICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gJycpIHtcclxuICAgICAgICAgICAgICAgIG1ldGFkYXRhW3Byb3BlcnR5Lm5hbWVdID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQ29udmVydCB0byBZQU1MXHJcbiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMobWV0YWRhdGEpKSB7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtrZXl9OmApO1xyXG4gICAgICAgICAgICAgICAgdmFsdWUuZm9yRWFjaChpdGVtID0+IGxpbmVzLnB1c2goYCAgLSAke2l0ZW19YCkpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCR7a2V5fTpgKTtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgW3N1YktleSwgc3ViVmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCAgJHtzdWJLZXl9OiAke3N1YlZhbHVlfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtrZXl9OiAke3ZhbHVlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGxpbmVzLnB1c2goJy0tLVxcbicpO1xyXG4gICAgICAgIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJvdGVjdGVkIGFzeW5jIGdlbmVyYXRlVGVtcGxhdGVDb250ZW50KCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRlbXBsYXRlKSByZXR1cm4gJyc7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudmF1bHQuYXBwLmdldFRlbXBsYXRlQ29udGVudCh0aGlzLnRlbXBsYXRlKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFRlbXBsYXRlICR7dGhpcy50ZW1wbGF0ZX0gbm90IGZvdW5kYCk7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIE1ldGFkYXRhIG9wZXJhdGlvbnNcclxuICAgIGFzeW5jIGdldE1ldGFkYXRhKCk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgYW55Pj4ge1xyXG4gICAgICAgIGlmICghdGhpcy5maWxlKSByZXR1cm4ge307XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudmF1bHQuYXBwLmdldE1ldGFkYXRhKHRoaXMuZmlsZSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGFzeW5jIHVwZGF0ZU1ldGFkYXRhKG1ldGFkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmZpbGUpIHJldHVybjtcclxuICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC51cGRhdGVNZXRhZGF0YSh0aGlzLmZpbGUsIG1ldGFkYXRhKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgYXN5bmMgZ2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCB0aGlzLmdldE1ldGFkYXRhKCk7XHJcbiAgICAgICAgcmV0dXJuIG1ldGFkYXRhW3Byb3BlcnR5TmFtZV07XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGFzeW5jIHNldFByb3BlcnR5VmFsdWUocHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHRoaXMuZ2V0TWV0YWRhdGEoKTtcclxuICAgICAgICBtZXRhZGF0YVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7XHJcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVNZXRhZGF0YShtZXRhZGF0YSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHByaXZhdGUgYXN5bmMgdXBkYXRlQWxsUHJvcGVydGllc01ldGFkYXRhKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgdGhpcy5nZXRNZXRhZGF0YSgpO1xyXG4gICAgICAgIGxldCBoYXNDaGFuZ2VzID0gZmFsc2U7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiB0aGlzLnByb3BlcnRpZXMpIHtcclxuICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbHVlID0gbWV0YWRhdGFbcHJvcGVydHkubmFtZV07XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRlZFZhbHVlID0gcHJvcGVydHkudmFsaWRhdGUoY3VycmVudFZhbHVlKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmICh2YWxpZGF0ZWRWYWx1ZSAhPT0gY3VycmVudFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBtZXRhZGF0YVtwcm9wZXJ0eS5uYW1lXSA9IHZhbGlkYXRlZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgaGFzQ2hhbmdlcyA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKGhhc0NoYW5nZXMpIHtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVNZXRhZGF0YShtZXRhZGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBEaXNwbGF5IG1ldGhvZHNcclxuICAgIGFzeW5jIGdldERpc3BsYXkoKTogUHJvbWlzZTxIVE1MRWxlbWVudD4ge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMudmF1bHQuYXBwLmNyZWF0ZURpdignY2xhc3NlLWRpc3BsYXknKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBBZGQgY2xhc3MgaGVhZGVyXHJcbiAgICAgICAgY29uc3QgaGVhZGVyID0gdGhpcy52YXVsdC5hcHAuY3JlYXRlRGl2KCdjbGFzc2UtaGVhZGVyJyk7XHJcbiAgICAgICAgaGVhZGVyLnRleHRDb250ZW50ID0gdGhpcy5nZXROYW1lKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuaWNvbikge1xyXG4gICAgICAgICAgICB0aGlzLnZhdWx0LmFwcC5zZXRJY29uKGhlYWRlciwgdGhpcy5pY29uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGhlYWRlcik7XHJcblxyXG4gICAgICAgIGNvbnNvbGUubG9nKCdBZGRpbmcgcHJvcGVydGllcyB0byBkaXNwbGF5IGZvciBjbGFzczogJyArIHRoaXMuZ2V0TmFtZSgpKTtcclxuICAgICAgICBjb25zb2xlLmxvZygnTnVtYmVyIG9mIHByb3BlcnRpZXM6ICcgKyB0aGlzLnByb3BlcnRpZXMubGVuZ3RoKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBBZGQgcHJvcGVydGllc1xyXG4gICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgdGhpcy5wcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpbGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5RGlzcGxheSA9IGF3YWl0IHByb3BlcnR5LmdldERpc3BsYXkodGhpcy5maWxlKTtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChwcm9wZXJ0eURpc3BsYXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBjb250YWluZXI7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBpbnN0YW5jZXNcclxuICAgIHN0YXRpYyBjcmVhdGUodmF1bHQ6IFZhdWx0KTogQ2xhc3NlIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgaW1wbGVtZW50IGNyZWF0ZSBtZXRob2QgaW4gc3ViY2xhc3MnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gVXRpbGl0eSBtZXRob2RzXHJcbiAgICBwcm90ZWN0ZWQgc2FuaXRpemVGaWxlTmFtZShuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UoL1s8PjpcIi9cXFxcfD8qXS9nLCAnLScpLnRyaW0oKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJvdGVjdGVkIGFzeW5jIGVuc3VyZUZvbGRlcihmb2xkZXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnZhdWx0LmFwcC5jcmVhdGVGb2xkZXIoZm9sZGVyUGF0aCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgLy8gRm9sZGVyIG1pZ2h0IGFscmVhZHkgZXhpc3QsIHdoaWNoIGlzIGZpbmVcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIExpZmVjeWNsZSBob29rc1xyXG4gICAgYXN5bmMgb25DcmVhdGUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgLy8gT3ZlcnJpZGUgaW4gc3ViY2xhc3NlcyBmb3IgcG9zdC1jcmVhdGlvbiBsb2dpY1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyBvblVwZGF0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICAvLyBPdmVycmlkZSBpbiBzdWJjbGFzc2VzIGZvciBwb3N0LXVwZGF0ZSBsb2dpY1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhc3luYyBvbkRlbGV0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICAvLyBPdmVycmlkZSBpbiBzdWJjbGFzc2VzIGZvciBwcmUtZGVsZXRpb24gbG9naWNcclxuICAgIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=