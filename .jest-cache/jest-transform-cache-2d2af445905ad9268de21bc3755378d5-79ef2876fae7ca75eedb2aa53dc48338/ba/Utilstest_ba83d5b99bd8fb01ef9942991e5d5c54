a8fbfcbdaa6db6bd095831bd00b03324
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Utils_1 = require("../../src/vault/Utils");
// Create a simple mock app with jest functions
const createMockApp = () => ({
    getFile: jest.fn(),
    getMetadata: jest.fn(),
});
describe('Utils', () => {
    let mockApp;
    beforeEach(() => {
        jest.clearAllMocks();
        jest.useFakeTimers();
        mockApp = createMockApp();
    });
    afterEach(() => {
        jest.useRealTimers();
    });
    describe('waitForFileMetaDataUpdate', () => {
        const mockFile = {
            name: 'test.md',
            path: 'test/test.md',
            basename: 'test',
            extension: 'md'
        };
        it('should execute callback immediately when metadata key exists', async () => {
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata.mockResolvedValue({ testKey: 'testValue' });
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            const promise = (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test/test.md', 'testKey', mockCallback);
            // Fast-forward timers to complete the function
            await jest.runAllTimersAsync();
            await promise;
            expect(mockApp.getFile).toHaveBeenCalledWith('test/test.md');
            expect(mockApp.getMetadata).toHaveBeenCalledWith(mockFile);
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should wait and retry when metadata key does not exist initially', async () => {
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata
                .mockResolvedValueOnce({ otherKey: 'otherValue' })
                .mockResolvedValueOnce({ otherKey: 'otherValue' })
                .mockResolvedValueOnce({ testKey: 'testValue', otherKey: 'otherValue' });
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            const promise = (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test/test.md', 'testKey', mockCallback);
            await jest.runAllTimersAsync();
            await promise;
            expect(mockApp.getFile).toHaveBeenCalledTimes(3);
            expect(mockApp.getMetadata).toHaveBeenCalledTimes(3);
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should execute callback after max attempts even if key not found', async () => {
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata.mockResolvedValue({ otherKey: 'otherValue' });
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            const promise = (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test/test.md', 'testKey', mockCallback);
            await jest.runAllTimersAsync();
            await promise;
            expect(mockApp.getFile).toHaveBeenCalledTimes(50);
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should execute callback when file not found', async () => {
            mockApp.getFile.mockResolvedValue(null);
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            const promise = (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'nonexistent.md', 'testKey', mockCallback);
            await jest.runAllTimersAsync();
            await promise;
            expect(mockApp.getFile).toHaveBeenCalledTimes(50);
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should execute callback when metadata is null', async () => {
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata.mockResolvedValue(null);
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            const promise = (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test/test.md', 'testKey', mockCallback);
            await jest.runAllTimersAsync();
            await promise;
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should handle callback errors', async () => {
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata.mockResolvedValue({ testKey: 'testValue' });
            const mockCallback = jest.fn().mockRejectedValue(new Error('Callback error'));
            const promise = (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test/test.md', 'testKey', mockCallback);
            await jest.runAllTimersAsync();
            await expect(promise).rejects.toThrow('Callback error');
        });
        it('should handle app.getFile errors', async () => {
            mockApp.getFile.mockRejectedValue(new Error('File access error'));
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            const promise = (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test/test.md', 'testKey', mockCallback);
            await jest.runAllTimersAsync();
            await promise;
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should work with different key types', async () => {
            mockApp.getFile.mockResolvedValue(mockFile);
            const testCases = [
                { key: 'stringKey', metadata: { stringKey: 'value' } },
                { key: 'numberKey', metadata: { numberKey: 42 } },
                { key: 'booleanKey', metadata: { booleanKey: false } },
                { key: 'nullKey', metadata: { nullKey: null } }
            ];
            for (const testCase of testCases) {
                mockApp.getMetadata.mockResolvedValue(testCase.metadata);
                const mockCallback = jest.fn().mockResolvedValue(undefined);
                await (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test/test.md', testCase.key, mockCallback);
                expect(mockCallback).toHaveBeenCalled();
                mockCallback.mockClear();
            }
        });
    });
    describe('waitForMetaDataCacheUpdate', () => {
        it('should execute callback after short delay', async () => {
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            const promise = (0, Utils_1.waitForMetaDataCacheUpdate)(mockApp, mockCallback);
            jest.advanceTimersByTime(100);
            await Promise.resolve();
            await promise;
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should handle callback errors', async () => {
            const mockCallback = jest.fn().mockRejectedValue(new Error('Cache callback error'));
            const promise = (0, Utils_1.waitForMetaDataCacheUpdate)(mockApp, mockCallback);
            jest.advanceTimersByTime(100);
            await Promise.resolve();
            await expect(promise).rejects.toThrow('Cache callback error');
        });
        it('should work with multiple concurrent calls', async () => {
            const mockCallback1 = jest.fn().mockResolvedValue('result1');
            const mockCallback2 = jest.fn().mockResolvedValue('result2');
            const promises = [
                (0, Utils_1.waitForMetaDataCacheUpdate)(mockApp, mockCallback1),
                (0, Utils_1.waitForMetaDataCacheUpdate)(mockApp, mockCallback2)
            ];
            jest.advanceTimersByTime(100);
            await Promise.resolve();
            await Promise.all(promises);
            expect(mockCallback1).toHaveBeenCalled();
            expect(mockCallback2).toHaveBeenCalled();
        });
    });
    describe('Edge cases', () => {
        it('should handle long file paths', async () => {
            const longPath = 'a/'.repeat(100) + 'file.md';
            const mockFile = { name: 'file.md', path: longPath, basename: 'file', extension: 'md' };
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata.mockResolvedValue({ testKey: 'value' });
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            await (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, longPath, 'testKey', mockCallback);
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should handle special characters', async () => {
            const specialPath = 'folder/test@#$%^&*().md';
            const mockFile = { name: 'test@#$%^&*().md', path: specialPath, basename: 'test@#$%^&*()', extension: 'md' };
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata.mockResolvedValue({ testKey: 'value' });
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            await (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, specialPath, 'testKey', mockCallback);
            expect(mockCallback).toHaveBeenCalled();
        });
        it('should handle empty string as key', async () => {
            const mockFile = { name: 'test.md', path: 'test.md', basename: 'test', extension: 'md' };
            mockApp.getFile.mockResolvedValue(mockFile);
            mockApp.getMetadata.mockResolvedValue({ '': 'emptyKeyValue' });
            const mockCallback = jest.fn().mockResolvedValue(undefined);
            await (0, Utils_1.waitForFileMetaDataUpdate)(mockApp, 'test.md', '', mockCallback);
            expect(mockCallback).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxfX3Rlc3RzX19cXHZhdWx0XFxVdGlscy50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsaURBQThGO0FBRTlGLCtDQUErQztBQUMvQyxNQUFNLGFBQWEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3pCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2xCLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQ3pCLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO0lBQ25CLElBQUksT0FBeUMsQ0FBQztJQUU5QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ1osSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixPQUFPLEdBQUcsYUFBYSxFQUFFLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ1gsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLDJCQUEyQixFQUFFLEdBQUcsRUFBRTtRQUN2QyxNQUFNLFFBQVEsR0FBRztZQUNiLElBQUksRUFBRSxTQUFTO1lBQ2YsSUFBSSxFQUFFLGNBQWM7WUFDcEIsUUFBUSxFQUFFLE1BQU07WUFDaEIsU0FBUyxFQUFFLElBQUk7U0FDbEIsQ0FBQztRQUVGLEVBQUUsQ0FBQyw4REFBOEQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMxRSxPQUFPLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzVDLE9BQU8sQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFF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UCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGxlb2R1XFxEb2N1bWVudHNcXDEgLSBQcm9cXFRlc3QgcGx1Z2luIG9ic2lkaWFuXFwub2JzaWRpYW5cXHBsdWdpbnNcXG9ic2lkaWFuLUNSTVxcZHluYW1pYy1maWVsZHNcXF9fdGVzdHNfX1xcdmF1bHRcXFV0aWxzLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd2FpdEZvckZpbGVNZXRhRGF0YVVwZGF0ZSwgd2FpdEZvck1ldGFEYXRhQ2FjaGVVcGRhdGUgfSBmcm9tICcuLi8uLi9zcmMvdmF1bHQvVXRpbHMnO1xyXG5cclxuLy8gQ3JlYXRlIGEgc2ltcGxlIG1vY2sgYXBwIHdpdGggamVzdCBmdW5jdGlvbnNcclxuY29uc3QgY3JlYXRlTW9ja0FwcCA9ICgpID0+ICh7XHJcbiAgICBnZXRGaWxlOiBqZXN0LmZuKCksXHJcbiAgICBnZXRNZXRhZGF0YTogamVzdC5mbigpLFxyXG59KTtcclxuXHJcbmRlc2NyaWJlKCdVdGlscycsICgpID0+IHtcclxuICAgIGxldCBtb2NrQXBwOiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVNb2NrQXBwPjtcclxuXHJcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAgICAgICBqZXN0LnVzZUZha2VUaW1lcnMoKTtcclxuICAgICAgICBtb2NrQXBwID0gY3JlYXRlTW9ja0FwcCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgICAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCd3YWl0Rm9yRmlsZU1ldGFEYXRhVXBkYXRlJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1vY2tGaWxlID0ge1xyXG4gICAgICAgICAgICBuYW1lOiAndGVzdC5tZCcsXHJcbiAgICAgICAgICAgIHBhdGg6ICd0ZXN0L3Rlc3QubWQnLFxyXG4gICAgICAgICAgICBiYXNlbmFtZTogJ3Rlc3QnLFxyXG4gICAgICAgICAgICBleHRlbnNpb246ICdtZCdcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgY2FsbGJhY2sgaW1tZWRpYXRlbHkgd2hlbiBtZXRhZGF0YSBrZXkgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBtb2NrQXBwLmdldEZpbGUubW9ja1Jlc29sdmVkVmFsdWUobW9ja0ZpbGUpO1xyXG4gICAgICAgICAgICBtb2NrQXBwLmdldE1ldGFkYXRhLm1vY2tSZXNvbHZlZFZhbHVlKHsgdGVzdEtleTogJ3Rlc3RWYWx1ZScgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBtb2NrQ2FsbGJhY2sgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHByb21pc2UgPSB3YWl0Rm9yRmlsZU1ldGFEYXRhVXBkYXRlKG1vY2tBcHAgYXMgYW55LCAndGVzdC90ZXN0Lm1kJywgJ3Rlc3RLZXknLCBtb2NrQ2FsbGJhY2spO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gRmFzdC1mb3J3YXJkIHRpbWVycyB0byBjb21wbGV0ZSB0aGUgZnVuY3Rpb25cclxuICAgICAgICAgICAgYXdhaXQgamVzdC5ydW5BbGxUaW1lcnNBc3luYygpO1xyXG4gICAgICAgICAgICBhd2FpdCBwcm9taXNlO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tBcHAuZ2V0RmlsZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3Rlc3QvdGVzdC5tZCcpO1xyXG4gICAgICAgICAgICBleHBlY3QobW9ja0FwcC5nZXRNZXRhZGF0YSkudG9IYXZlQmVlbkNhbGxlZFdpdGgobW9ja0ZpbGUpO1xyXG4gICAgICAgICAgICBleHBlY3QobW9ja0NhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgd2FpdCBhbmQgcmV0cnkgd2hlbiBtZXRhZGF0YSBrZXkgZG9lcyBub3QgZXhpc3QgaW5pdGlhbGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBtb2NrQXBwLmdldEZpbGUubW9ja1Jlc29sdmVkVmFsdWUobW9ja0ZpbGUpO1xyXG4gICAgICAgICAgICBtb2NrQXBwLmdldE1ldGFkYXRhXHJcbiAgICAgICAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHsgb3RoZXJLZXk6ICdvdGhlclZhbHVlJyB9KVxyXG4gICAgICAgICAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IG90aGVyS2V5OiAnb3RoZXJWYWx1ZScgfSlcclxuICAgICAgICAgICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoeyB0ZXN0S2V5OiAndGVzdFZhbHVlJywgb3RoZXJLZXk6ICdvdGhlclZhbHVlJyB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tDYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHdhaXRGb3JGaWxlTWV0YURhdGFVcGRhdGUobW9ja0FwcCBhcyBhbnksICd0ZXN0L3Rlc3QubWQnLCAndGVzdEtleScsIG1vY2tDYWxsYmFjayk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhd2FpdCBqZXN0LnJ1bkFsbFRpbWVyc0FzeW5jKCk7XHJcbiAgICAgICAgICAgIGF3YWl0IHByb21pc2U7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QobW9ja0FwcC5nZXRGaWxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQXBwLmdldE1ldGFkYXRhKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQ2FsbGJhY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIGNhbGxiYWNrIGFmdGVyIG1heCBhdHRlbXB0cyBldmVuIGlmIGtleSBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIG1vY2tBcHAuZ2V0RmlsZS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrRmlsZSk7XHJcbiAgICAgICAgICAgIG1vY2tBcHAuZ2V0TWV0YWRhdGEubW9ja1Jlc29sdmVkVmFsdWUoeyBvdGhlcktleTogJ290aGVyVmFsdWUnIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgbW9ja0NhbGxiYWNrID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwcm9taXNlID0gd2FpdEZvckZpbGVNZXRhRGF0YVVwZGF0ZShtb2NrQXBwIGFzIGFueSwgJ3Rlc3QvdGVzdC5tZCcsICd0ZXN0S2V5JywgbW9ja0NhbGxiYWNrKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGF3YWl0IGplc3QucnVuQWxsVGltZXJzQXN5bmMoKTtcclxuICAgICAgICAgICAgYXdhaXQgcHJvbWlzZTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQXBwLmdldEZpbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcyg1MCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQ2FsbGJhY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIGNhbGxiYWNrIHdoZW4gZmlsZSBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIG1vY2tBcHAuZ2V0RmlsZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tDYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHdhaXRGb3JGaWxlTWV0YURhdGFVcGRhdGUobW9ja0FwcCBhcyBhbnksICdub25leGlzdGVudC5tZCcsICd0ZXN0S2V5JywgbW9ja0NhbGxiYWNrKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGF3YWl0IGplc3QucnVuQWxsVGltZXJzQXN5bmMoKTtcclxuICAgICAgICAgICAgYXdhaXQgcHJvbWlzZTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQXBwLmdldEZpbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcyg1MCk7XHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQ2FsbGJhY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIGNhbGxiYWNrIHdoZW4gbWV0YWRhdGEgaXMgbnVsbCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgbW9ja0FwcC5nZXRGaWxlLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tGaWxlKTtcclxuICAgICAgICAgICAgbW9ja0FwcC5nZXRNZXRhZGF0YS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tDYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHdhaXRGb3JGaWxlTWV0YURhdGFVcGRhdGUobW9ja0FwcCBhcyBhbnksICd0ZXN0L3Rlc3QubWQnLCAndGVzdEtleScsIG1vY2tDYWxsYmFjayk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhd2FpdCBqZXN0LnJ1bkFsbFRpbWVyc0FzeW5jKCk7XHJcbiAgICAgICAgICAgIGF3YWl0IHByb21pc2U7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QobW9ja0NhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIGNhbGxiYWNrIGVycm9ycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgbW9ja0FwcC5nZXRGaWxlLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tGaWxlKTtcclxuICAgICAgICAgICAgbW9ja0FwcC5nZXRNZXRhZGF0YS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IHRlc3RLZXk6ICd0ZXN0VmFsdWUnIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgbW9ja0NhbGxiYWNrID0gamVzdC5mbigpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignQ2FsbGJhY2sgZXJyb3InKSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwcm9taXNlID0gd2FpdEZvckZpbGVNZXRhRGF0YVVwZGF0ZShtb2NrQXBwIGFzIGFueSwgJ3Rlc3QvdGVzdC5tZCcsICd0ZXN0S2V5JywgbW9ja0NhbGxiYWNrKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGF3YWl0IGplc3QucnVuQWxsVGltZXJzQXN5bmMoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGF3YWl0IGV4cGVjdChwcm9taXNlKS5yZWplY3RzLnRvVGhyb3coJ0NhbGxiYWNrIGVycm9yJyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIGFwcC5nZXRGaWxlIGVycm9ycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgbW9ja0FwcC5nZXRGaWxlLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignRmlsZSBhY2Nlc3MgZXJyb3InKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBtb2NrQ2FsbGJhY2sgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHByb21pc2UgPSB3YWl0Rm9yRmlsZU1ldGFEYXRhVXBkYXRlKG1vY2tBcHAgYXMgYW55LCAndGVzdC90ZXN0Lm1kJywgJ3Rlc3RLZXknLCBtb2NrQ2FsbGJhY2spO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYXdhaXQgamVzdC5ydW5BbGxUaW1lcnNBc3luYygpO1xyXG4gICAgICAgICAgICBhd2FpdCBwcm9taXNlO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tDYWxsYmFjaykudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIHdvcmsgd2l0aCBkaWZmZXJlbnQga2V5IHR5cGVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBtb2NrQXBwLmdldEZpbGUubW9ja1Jlc29sdmVkVmFsdWUobW9ja0ZpbGUpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgdGVzdENhc2VzID0gW1xyXG4gICAgICAgICAgICAgICAgeyBrZXk6ICdzdHJpbmdLZXknLCBtZXRhZGF0YTogeyBzdHJpbmdLZXk6ICd2YWx1ZScgfSB9LFxyXG4gICAgICAgICAgICAgICAgeyBrZXk6ICdudW1iZXJLZXknLCBtZXRhZGF0YTogeyBudW1iZXJLZXk6IDQyIH0gfSxcclxuICAgICAgICAgICAgICAgIHsga2V5OiAnYm9vbGVhbktleScsIG1ldGFkYXRhOiB7IGJvb2xlYW5LZXk6IGZhbHNlIH0gfSxcclxuICAgICAgICAgICAgICAgIHsga2V5OiAnbnVsbEtleScsIG1ldGFkYXRhOiB7IG51bGxLZXk6IG51bGwgfSB9XHJcbiAgICAgICAgICAgIF07XHJcblxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRlc3RDYXNlIG9mIHRlc3RDYXNlcykge1xyXG4gICAgICAgICAgICAgICAgbW9ja0FwcC5nZXRNZXRhZGF0YS5tb2NrUmVzb2x2ZWRWYWx1ZSh0ZXN0Q2FzZS5tZXRhZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtb2NrQ2FsbGJhY2sgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuXHJcbiAgICAgICAgICAgICAgICBhd2FpdCB3YWl0Rm9yRmlsZU1ldGFEYXRhVXBkYXRlKG1vY2tBcHAgYXMgYW55LCAndGVzdC90ZXN0Lm1kJywgdGVzdENhc2Uua2V5LCBtb2NrQ2FsbGJhY2spO1xyXG5cclxuICAgICAgICAgICAgICAgIGV4cGVjdChtb2NrQ2FsbGJhY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICAgICAgICAgIG1vY2tDYWxsYmFjay5tb2NrQ2xlYXIoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ3dhaXRGb3JNZXRhRGF0YUNhY2hlVXBkYXRlJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBjYWxsYmFjayBhZnRlciBzaG9ydCBkZWxheScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbW9ja0NhbGxiYWNrID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwcm9taXNlID0gd2FpdEZvck1ldGFEYXRhQ2FjaGVVcGRhdGUobW9ja0FwcCBhcyBhbnksIG1vY2tDYWxsYmFjayk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBqZXN0LmFkdmFuY2VUaW1lcnNCeVRpbWUoMTAwKTtcclxuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhd2FpdCBwcm9taXNlO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tDYWxsYmFjaykudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBjYWxsYmFjayBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tDYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0NhY2hlIGNhbGxiYWNrIGVycm9yJykpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHdhaXRGb3JNZXRhRGF0YUNhY2hlVXBkYXRlKG1vY2tBcHAgYXMgYW55LCBtb2NrQ2FsbGJhY2spO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgamVzdC5hZHZhbmNlVGltZXJzQnlUaW1lKDEwMCk7XHJcbiAgICAgICAgICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpO1xyXG5cclxuICAgICAgICAgICAgYXdhaXQgZXhwZWN0KHByb21pc2UpLnJlamVjdHMudG9UaHJvdygnQ2FjaGUgY2FsbGJhY2sgZXJyb3InKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGggbXVsdGlwbGUgY29uY3VycmVudCBjYWxscycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbW9ja0NhbGxiYWNrMSA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgncmVzdWx0MScpO1xyXG4gICAgICAgICAgICBjb25zdCBtb2NrQ2FsbGJhY2syID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKCdyZXN1bHQyJyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtcclxuICAgICAgICAgICAgICAgIHdhaXRGb3JNZXRhRGF0YUNhY2hlVXBkYXRlKG1vY2tBcHAgYXMgYW55LCBtb2NrQ2FsbGJhY2sxKSxcclxuICAgICAgICAgICAgICAgIHdhaXRGb3JNZXRhRGF0YUNhY2hlVXBkYXRlKG1vY2tBcHAgYXMgYW55LCBtb2NrQ2FsbGJhY2syKVxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgamVzdC5hZHZhbmNlVGltZXJzQnlUaW1lKDEwMCk7XHJcbiAgICAgICAgICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSgpO1xyXG5cclxuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tDYWxsYmFjazEpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tDYWxsYmFjazIpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdFZGdlIGNhc2VzJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIGxvbmcgZmlsZSBwYXRocycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbG9uZ1BhdGggPSAnYS8nLnJlcGVhdCgxMDApICsgJ2ZpbGUubWQnO1xyXG4gICAgICAgICAgICBjb25zdCBtb2NrRmlsZSA9IHsgbmFtZTogJ2ZpbGUubWQnLCBwYXRoOiBsb25nUGF0aCwgYmFzZW5hbWU6ICdmaWxlJywgZXh0ZW5zaW9uOiAnbWQnIH07XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBtb2NrQXBwLmdldEZpbGUubW9ja1Jlc29sdmVkVmFsdWUobW9ja0ZpbGUpO1xyXG4gICAgICAgICAgICBtb2NrQXBwLmdldE1ldGFkYXRhLm1vY2tSZXNvbHZlZFZhbHVlKHsgdGVzdEtleTogJ3ZhbHVlJyB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tDYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgICAgICAgYXdhaXQgd2FpdEZvckZpbGVNZXRhRGF0YVVwZGF0ZShtb2NrQXBwIGFzIGFueSwgbG9uZ1BhdGgsICd0ZXN0S2V5JywgbW9ja0NhbGxiYWNrKTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChtb2NrQ2FsbGJhY2spLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3BlY2lhbCBjaGFyYWN0ZXJzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzcGVjaWFsUGF0aCA9ICdmb2xkZXIvdGVzdEAjJCVeJiooKS5tZCc7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vY2tGaWxlID0geyBuYW1lOiAndGVzdEAjJCVeJiooKS5tZCcsIHBhdGg6IHNwZWNpYWxQYXRoLCBiYXNlbmFtZTogJ3Rlc3RAIyQlXiYqKCknLCBleHRlbnNpb246ICdtZCcgfTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIG1vY2tBcHAuZ2V0RmlsZS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrRmlsZSk7XHJcbiAgICAgICAgICAgIG1vY2tBcHAuZ2V0TWV0YWRhdGEubW9ja1Jlc29sdmVkVmFsdWUoeyB0ZXN0S2V5OiAndmFsdWUnIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgbW9ja0NhbGxiYWNrID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICAgICAgICBhd2FpdCB3YWl0Rm9yRmlsZU1ldGFEYXRhVXBkYXRlKG1vY2tBcHAgYXMgYW55LCBzcGVjaWFsUGF0aCwgJ3Rlc3RLZXknLCBtb2NrQ2FsbGJhY2spO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tDYWxsYmFjaykudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBlbXB0eSBzdHJpbmcgYXMga2V5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtb2NrRmlsZSA9IHsgbmFtZTogJ3Rlc3QubWQnLCBwYXRoOiAndGVzdC5tZCcsIGJhc2VuYW1lOiAndGVzdCcsIGV4dGVuc2lvbjogJ21kJyB9O1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbW9ja0FwcC5nZXRGaWxlLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tGaWxlKTtcclxuICAgICAgICAgICAgbW9ja0FwcC5nZXRNZXRhZGF0YS5tb2NrUmVzb2x2ZWRWYWx1ZSh7ICcnOiAnZW1wdHlLZXlWYWx1ZScgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBtb2NrQ2FsbGJhY2sgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuXHJcbiAgICAgICAgICAgIGF3YWl0IHdhaXRGb3JGaWxlTWV0YURhdGFVcGRhdGUobW9ja0FwcCBhcyBhbnksICd0ZXN0Lm1kJywgJycsIG1vY2tDYWxsYmFjayk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QobW9ja0NhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7Il0sInZlcnNpb24iOjN9