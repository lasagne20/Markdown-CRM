6ce733ce2e322711e8d0c85da317d8a9
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RangeDateProperty = void 0;
const flatpickr_1 = __importDefault(require("flatpickr"));
require("flatpickr/dist/l10n/fr.js");
const DateProperty_1 = require("./DateProperty");
class RangeDateProperty extends DateProperty_1.DateProperty {
    constructor(name, args = {}) {
        super(name, [], args);
        this.type = "dateRange";
    }
    createFieldDate(value, update, link) {
        const input = document.createElement("input");
        input.type = "text";
        input.value = value || ""; // Formaté en "YYYY-MM-DD" pour le stockage
        input.classList.add("field-input");
        (0, flatpickr_1.default)(input, {
            dateFormat: "Y-m-d", // Stocker en "YYYY-MM-DD"
            defaultDate: value || "",
            locale: "fr", // Utilisation de la langue française pour l'affichage
            mode: "range", // Permet de sélectionner une plage de dates
            onChange: async (selectedDates) => {
                if (selectedDates.length === 2) {
                    const startDate = selectedDates[0];
                    const endDate = selectedDates[1];
                    if (startDate && endDate) {
                        // Met à jour la valeur de l'input avec le format "YYYY-MM-DD to YYYY-MM-DD"
                        if (startDate.getTime() === endDate.getTime()) {
                            input.value = this.formatDateForStorage(startDate);
                        }
                        else {
                            input.value = `${this.formatDateForStorage(startDate)} to ${this.formatDateForStorage(endDate)}`;
                        }
                        await this.updateField(update, input, link);
                    }
                }
            },
            onClose: async () => await this.updateField(update, input, link)
        });
        return input;
    }
    // Crée un lien qui affiche la plage de dates (au format "26 février 2025 au 28 février 2025")
    createFieldLink(value) {
        const link = document.createElement("div");
        link.textContent = value ? this.formatDateRangeForDisplay(value) : "Aucune date sélectionnée";
        link.classList.add("date-field-link");
        link.classList.add("field-link");
        link.style.cursor = "pointer";
        link.addEventListener("click", (event) => this.modifyField(event));
        return link;
    }
    // Formate la plage de dates pour l'affichage : "26 février 2025" ou "26 février 2025 au 28 février 2025"
    formatDateRangeForDisplay(dateRange) {
        const [startDate, endDate] = dateRange.split(" to ");
        const formattedStartDate = new Date(startDate).toLocaleDateString("fr-FR", {
            weekday: "long",
            day: "numeric",
            month: "long",
            year: "numeric"
        });
        if (!endDate) {
            return `${formattedStartDate}`;
        }
        const formattedEndDate = new Date(endDate).toLocaleDateString("fr-FR", {
            weekday: "long",
            day: "numeric",
            month: "long",
            year: "numeric"
        });
        return `${formattedStartDate} au ${formattedEndDate}`;
    }
    // Crée un conteneur pour afficher la plage de dates et la sélection rapide
    createFieldContainerContent(update, value) {
        const fieldContainer = document.createElement("div");
        fieldContainer.classList.add("field-container");
        fieldContainer.classList.add("metadata-field");
        const currentField = value;
        const link = this.createFieldLink(currentField);
        const input = this.createFieldDate(currentField, update, link);
        // Affichage initial : Si la plage de dates existe, afficher le lien
        if (currentField && this.validate(value)) {
            link.style.display = "block";
            input.style.display = "none";
        }
        else {
            input.style.display = "block";
            link.style.display = "none";
        }
        fieldContainer.appendChild(link);
        fieldContainer.appendChild(input);
        return fieldContainer;
    }
    // Met à jour la valeur de la plage de dates et bascule l'affichage entre le lien et l'input
    async updateField(update, input, link) {
        let value = this.validate(input.value);
        if (value) {
            await update(value); // Met à jour avec la plage de dates au format "YYYY-MM-DD to YYYY-MM-DD"
            input.style.display = "none";
            link.textContent = this.formatDateRangeForDisplay(value); // Affichage avec le mois en lettres
            link.style.display = "block";
        }
        else {
            await update(input.value);
        }
    }
    // Valide la plage de dates au format "YYYY-MM-DD to YYYY-MM-DD"
    validate(value) {
        const dateRangeRegex = /^\d{4}-\d{2}-\d{2}( to \d{4}-\d{2}-\d{2})?$/;
        return dateRangeRegex.test(value) ? value : "";
    }
    // Fonction pour extraire la première date d'une chaîne et la convertir en objet Date
    static extractFirstDate(dateStr) {
        // Regex pour trouver la première date (ex: "26 janvier 2025")
        const moisMap = {
            "janvier": 0, "fevrier": 1, "mars": 2, "avril": 3, "mai": 4, "juin": 5,
            "juillet": 6, "aout": 7, "septembre": 8, "octobre": 9, "novembre": 10, "décembre": 11
        };
        const regex = /(\d{1,2}) (\w+) (\d{4})/;
        const normalizedDateStr = dateStr.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Remove accents
        const match = normalizedDateStr.match(regex);
        if (match) {
            const [, day, month, year] = match;
            const moisIndex = moisMap[month.toLowerCase()];
            if (moisIndex !== undefined) {
                return new Date(parseInt(year), moisIndex, parseInt(day));
            }
        }
        return null;
    }
    ;
}
exports.RangeDateProperty = RangeDateProperty;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxsZW9kdVxcRG9jdW1lbnRzXFwxIC0gUHJvXFxUZXN0IHBsdWdpbiBvYnNpZGlhblxcLm9ic2lkaWFuXFxwbHVnaW5zXFxvYnNpZGlhbi1DUk1cXGR5bmFtaWMtZmllbGRzXFxzcmNcXHByb3BlcnRpZXNcXFJhbmdlRGF0ZVByb3BlcnR5LnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDBEQUFrQztBQUNsQyxxQ0FBbUM7QUFDbkMsaURBQThDO0FBRzlDLE1BQWEsaUJBQWtCLFNBQVEsMkJBQVk7SUFHL0MsWUFBWSxJQUFZLEVBQUUsSUFBSSxHQUFHLEVBQUU7UUFDL0IsS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFGVixTQUFJLEdBQVksV0FBVyxDQUFDO0lBRzVDLENBQUM7SUFFUSxlQUFlLENBQUMsS0FBYSxFQUFFLE1BQXdDLEVBQUUsSUFBb0I7UUFDbEcsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QyxLQUFLLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQztRQUNwQixLQUFLLENBQUMsS0FBSyxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBRSwyQ0FBMkM7UUFDdkUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFbkMsSUFBQSxtQkFBUyxFQUFDLEtBQUssRUFBRTtZQUNiLFVBQVUsRUFBRSxPQUFPLEVBQUcsMEJBQTBCO1lBQ2hELFdBQVcsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN4QixNQUFNLEVBQUUsSUFBSSxFQUFHLHNEQUFzRDtZQUNyRSxJQUFJLEVBQUUsT0FBTyxFQUFHLDRDQUE0QztZQUM1RCxRQUFRLEVBQUUsS0FBSyxFQUFFLGFBQXFCLEVBQUUsRUFBRTtnQkFDdEMsSUFBSSxhQUFhLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO29CQUM3QixNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFD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QUM7UUFFN0MsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUNSLE1BQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ25DLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUUvQyxJQUFJLFNBQVMsS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDOUIsT0FBTyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFELENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDWixDQUFDO0lBQUEsQ0FBQztDQUNMO0FBeklELDhDQXlJQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGxlb2R1XFxEb2N1bWVudHNcXDEgLSBQcm9cXFRlc3QgcGx1Z2luIG9ic2lkaWFuXFwub2JzaWRpYW5cXHBsdWdpbnNcXG9ic2lkaWFuLUNSTVxcZHluYW1pYy1maWVsZHNcXHNyY1xccHJvcGVydGllc1xcUmFuZ2VEYXRlUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZsYXRwaWNrciBmcm9tIFwiZmxhdHBpY2tyXCI7XHJcbmltcG9ydCBcImZsYXRwaWNrci9kaXN0L2wxMG4vZnIuanNcIjtcclxuaW1wb3J0IHsgRGF0ZVByb3BlcnR5IH0gZnJvbSBcIi4vRGF0ZVByb3BlcnR5XCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFJhbmdlRGF0ZVByb3BlcnR5IGV4dGVuZHMgRGF0ZVByb3BlcnR5IHtcclxuXHJcbiAgICBwdWJsaWMgb3ZlcnJpZGUgdHlwZSA6IHN0cmluZyA9IFwiZGF0ZVJhbmdlXCI7XHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIGFyZ3MgPSB7fSkge1xyXG4gICAgICAgIHN1cGVyKG5hbWUsIFtdLCBhcmdzKTtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSBjcmVhdGVGaWVsZERhdGUodmFsdWU6IHN0cmluZywgdXBkYXRlOiAodmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPiwgbGluazogSFRNTERpdkVsZW1lbnQpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpbnB1dFwiKTtcclxuICAgICAgICBpbnB1dC50eXBlID0gXCJ0ZXh0XCI7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZSB8fCBcIlwiOyAgLy8gRm9ybWF0w6kgZW4gXCJZWVlZLU1NLUREXCIgcG91ciBsZSBzdG9ja2FnZVxyXG4gICAgICAgIGlucHV0LmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1pbnB1dFwiKTtcclxuICAgIFxyXG4gICAgICAgIGZsYXRwaWNrcihpbnB1dCwge1xyXG4gICAgICAgICAgICBkYXRlRm9ybWF0OiBcIlktbS1kXCIsICAvLyBTdG9ja2VyIGVuIFwiWVlZWS1NTS1ERFwiXHJcbiAgICAgICAgICAgIGRlZmF1bHREYXRlOiB2YWx1ZSB8fCBcIlwiLFxyXG4gICAgICAgICAgICBsb2NhbGU6IFwiZnJcIiwgIC8vIFV0aWxpc2F0aW9uIGRlIGxhIGxhbmd1ZSBmcmFuw6dhaXNlIHBvdXIgbCdhZmZpY2hhZ2VcclxuICAgICAgICAgICAgbW9kZTogXCJyYW5nZVwiLCAgLy8gUGVybWV0IGRlIHPDqWxlY3Rpb25uZXIgdW5lIHBsYWdlIGRlIGRhdGVzXHJcbiAgICAgICAgICAgIG9uQ2hhbmdlOiBhc3luYyAoc2VsZWN0ZWREYXRlczogRGF0ZVtdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWREYXRlcy5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydERhdGUgPSBzZWxlY3RlZERhdGVzWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZERhdGUgPSBzZWxlY3RlZERhdGVzWzFdO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydERhdGUgJiYgZW5kRGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBNZXQgw6Agam91ciBsYSB2YWxldXIgZGUgbCdpbnB1dCBhdmVjIGxlIGZvcm1hdCBcIllZWVktTU0tREQgdG8gWVlZWS1NTS1ERFwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFydERhdGUuZ2V0VGltZSgpID09PSBlbmREYXRlLmdldFRpbWUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB0aGlzLmZvcm1hdERhdGVGb3JTdG9yYWdlKHN0YXJ0RGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IGAke3RoaXMuZm9ybWF0RGF0ZUZvclN0b3JhZ2Uoc3RhcnREYXRlKX0gdG8gJHt0aGlzLmZvcm1hdERhdGVGb3JTdG9yYWdlKGVuZERhdGUpfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVGaWVsZCh1cGRhdGUsIGlucHV0LCBsaW5rKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIG9uQ2xvc2U6IGFzeW5jICgpID0+IGF3YWl0IHRoaXMudXBkYXRlRmllbGQodXBkYXRlLCBpbnB1dCwgbGluaylcclxuICAgICAgICB9KTtcclxuICAgIFxyXG4gICAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIH1cclxuICAgIC8vIENyw6llIHVuIGxpZW4gcXVpIGFmZmljaGUgbGEgcGxhZ2UgZGUgZGF0ZXMgKGF1IGZvcm1hdCBcIjI2IGbDqXZyaWVyIDIwMjUgYXUgMjggZsOpdnJpZXIgMjAyNVwiKVxyXG4gICAgb3ZlcnJpZGUgY3JlYXRlRmllbGRMaW5rKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gdmFsdWUgPyB0aGlzLmZvcm1hdERhdGVSYW5nZUZvckRpc3BsYXkodmFsdWUpIDogXCJBdWN1bmUgZGF0ZSBzw6lsZWN0aW9ubsOpZVwiO1xyXG4gICAgICAgIGxpbmsuY2xhc3NMaXN0LmFkZChcImRhdGUtZmllbGQtbGlua1wiKTtcclxuICAgICAgICBsaW5rLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1saW5rXCIpO1xyXG4gICAgICAgIGxpbmsuc3R5bGUuY3Vyc29yID0gXCJwb2ludGVyXCI7XHJcbiAgICAgICAgbGluay5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKGV2ZW50KSA9PiB0aGlzLm1vZGlmeUZpZWxkKGV2ZW50KSk7XHJcbiAgICAgICAgcmV0dXJuIGxpbms7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9ybWF0ZSBsYSBwbGFnZSBkZSBkYXRlcyBwb3VyIGwnYWZmaWNoYWdlIDogXCIyNiBmw6l2cmllciAyMDI1XCIgb3UgXCIyNiBmw6l2cmllciAyMDI1IGF1IDI4IGbDqXZyaWVyIDIwMjVcIlxyXG4gICAgZm9ybWF0RGF0ZVJhbmdlRm9yRGlzcGxheShkYXRlUmFuZ2U6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgW3N0YXJ0RGF0ZSwgZW5kRGF0ZV0gPSBkYXRlUmFuZ2Uuc3BsaXQoXCIgdG8gXCIpO1xyXG4gICAgICAgIGNvbnN0IGZvcm1hdHRlZFN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHN0YXJ0RGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKFwiZnItRlJcIiwgeyBcclxuICAgICAgICAgICAgd2Vla2RheTogXCJsb25nXCIsXHJcbiAgICAgICAgICAgIGRheTogXCJudW1lcmljXCIsIFxyXG4gICAgICAgICAgICBtb250aDogXCJsb25nXCIsIFxyXG4gICAgICAgICAgICB5ZWFyOiBcIm51bWVyaWNcIiBcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoIWVuZERhdGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGAke2Zvcm1hdHRlZFN0YXJ0RGF0ZX1gO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBmb3JtYXR0ZWRFbmREYXRlID0gbmV3IERhdGUoZW5kRGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKFwiZnItRlJcIiwgeyBcclxuICAgICAgICAgICAgd2Vla2RheTogXCJsb25nXCIsXHJcbiAgICAgICAgICAgIGRheTogXCJudW1lcmljXCIsIFxyXG4gICAgICAgICAgICBtb250aDogXCJsb25nXCIsIFxyXG4gICAgICAgICAgICB5ZWFyOiBcIm51bWVyaWNcIiBcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gYCR7Zm9ybWF0dGVkU3RhcnREYXRlfSBhdSAke2Zvcm1hdHRlZEVuZERhdGV9YDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDcsOpZSB1biBjb250ZW5ldXIgcG91ciBhZmZpY2hlciBsYSBwbGFnZSBkZSBkYXRlcyBldCBsYSBzw6lsZWN0aW9uIHJhcGlkZVxyXG4gICAgb3ZlcnJpZGUgY3JlYXRlRmllbGRDb250YWluZXJDb250ZW50KHVwZGF0ZTogKHZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sIHZhbHVlOiBzdHJpbmcpOiBIVE1MRGl2RWxlbWVudCB7XHJcbiAgICAgICAgY29uc3QgZmllbGRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgIGZpZWxkQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJmaWVsZC1jb250YWluZXJcIik7XHJcbiAgICAgICAgZmllbGRDb250YWluZXIuY2xhc3NMaXN0LmFkZChcIm1ldGFkYXRhLWZpZWxkXCIpO1xyXG5cclxuICAgICAgICBjb25zdCBjdXJyZW50RmllbGQgPSB2YWx1ZTtcclxuICAgICAgICBjb25zdCBsaW5rID0gdGhpcy5jcmVhdGVGaWVsZExpbmsoY3VycmVudEZpZWxkKTtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHRoaXMuY3JlYXRlRmllbGREYXRlKGN1cnJlbnRGaWVsZCwgdXBkYXRlLCBsaW5rKTtcclxuXHJcbiAgICAgICAgLy8gQWZmaWNoYWdlIGluaXRpYWwgOiBTaSBsYSBwbGFnZSBkZSBkYXRlcyBleGlzdGUsIGFmZmljaGVyIGxlIGxpZW5cclxuICAgICAgICBpZiAoY3VycmVudEZpZWxkICYmIHRoaXMudmFsaWRhdGUodmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlucHV0LnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgICAgICAgIGxpbmsuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZmllbGRDb250YWluZXIuYXBwZW5kQ2hpbGQobGluayk7XHJcbiAgICAgICAgZmllbGRDb250YWluZXIuYXBwZW5kQ2hpbGQoaW5wdXQpO1xyXG5cclxuICAgICAgICByZXR1cm4gZmllbGRDb250YWluZXI7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTWV0IMOgIGpvdXIgbGEgdmFsZXVyIGRlIGxhIHBsYWdlIGRlIGRhdGVzIGV0IGJhc2N1bGUgbCdhZmZpY2hhZ2UgZW50cmUgbGUgbGllbiBldCBsJ2lucHV0XHJcbiAgICBvdmVycmlkZSBhc3luYyB1cGRhdGVGaWVsZCh1cGRhdGU6ICh2YWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+LCBpbnB1dDogSFRNTElucHV0RWxlbWVudCwgbGluazogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnZhbGlkYXRlKGlucHV0LnZhbHVlKTtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgYXdhaXQgdXBkYXRlKHZhbHVlKTsgIC8vIE1ldCDDoCBqb3VyIGF2ZWMgbGEgcGxhZ2UgZGUgZGF0ZXMgYXUgZm9ybWF0IFwiWVlZWS1NTS1ERCB0byBZWVlZLU1NLUREXCJcclxuICAgICAgICAgICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgICAgICBsaW5rLnRleHRDb250ZW50ID0gdGhpcy5mb3JtYXREYXRlUmFuZ2VGb3JEaXNwbGF5KHZhbHVlKTsgIC8vIEFmZmljaGFnZSBhdmVjIGxlIG1vaXMgZW4gbGV0dHJlc1xyXG4gICAgICAgICAgICBsaW5rLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYXdhaXQgdXBkYXRlKGlucHV0LnZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVmFsaWRlIGxhIHBsYWdlIGRlIGRhdGVzIGF1IGZvcm1hdCBcIllZWVktTU0tREQgdG8gWVlZWS1NTS1ERFwiXHJcbiAgICBvdmVycmlkZSB2YWxpZGF0ZSh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCBkYXRlUmFuZ2VSZWdleCA9IC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0oIHRvIFxcZHs0fS1cXGR7Mn0tXFxkezJ9KT8kLztcclxuICAgICAgICByZXR1cm4gZGF0ZVJhbmdlUmVnZXgudGVzdCh2YWx1ZSkgPyB2YWx1ZSA6IFwiXCI7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8vIEZvbmN0aW9uIHBvdXIgZXh0cmFpcmUgbGEgcHJlbWnDqHJlIGRhdGUgZCd1bmUgY2hhw65uZSBldCBsYSBjb252ZXJ0aXIgZW4gb2JqZXQgRGF0ZVxyXG4gICAgcHVibGljIHN0YXRpYyBleHRyYWN0Rmlyc3REYXRlIChkYXRlU3RyOiBzdHJpbmcpOiBEYXRlIHwgbnVsbCB7XHJcbiAgICAvLyBSZWdleCBwb3VyIHRyb3V2ZXIgbGEgcHJlbWnDqHJlIGRhdGUgKGV4OiBcIjI2IGphbnZpZXIgMjAyNVwiKVxyXG4gICAgY29uc3QgbW9pc01hcDogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSA9IHtcclxuICAgICAgICBcImphbnZpZXJcIjogMCwgXCJmZXZyaWVyXCI6IDEsIFwibWFyc1wiOiAyLCBcImF2cmlsXCI6IDMsIFwibWFpXCI6IDQsIFwianVpblwiOiA1LFxyXG4gICAgICAgIFwianVpbGxldFwiOiA2LCBcImFvdXRcIjogNywgXCJzZXB0ZW1icmVcIjogOCwgXCJvY3RvYnJlXCI6IDksIFwibm92ZW1icmVcIjogMTAsIFwiZMOpY2VtYnJlXCI6IDExXHJcbiAgICAgIH07XHJcbiAgICBjb25zdCByZWdleCA9IC8oXFxkezEsMn0pIChcXHcrKSAoXFxkezR9KS87XHJcbiAgICBjb25zdCBub3JtYWxpemVkRGF0ZVN0ciA9IGRhdGVTdHIubm9ybWFsaXplKFwiTkZEXCIpLnJlcGxhY2UoL1tcXHUwMzAwLVxcdTAzNmZdL2csIFwiXCIpOyAvLyBSZW1vdmUgYWNjZW50c1xyXG4gICAgY29uc3QgbWF0Y2ggPSBub3JtYWxpemVkRGF0ZVN0ci5tYXRjaChyZWdleCk7XHJcbiAgICBcclxuICAgIGlmIChtYXRjaCkge1xyXG4gICAgICAgIGNvbnN0IFssIGRheSwgbW9udGgsIHllYXJdID0gbWF0Y2g7XHJcbiAgICAgICAgY29uc3QgbW9pc0luZGV4ID0gbW9pc01hcFttb250aC50b0xvd2VyQ2FzZSgpXTtcclxuICAgIFxyXG4gICAgICAgIGlmIChtb2lzSW5kZXggIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHJldHVybiBuZXcgRGF0ZShwYXJzZUludCh5ZWFyKSwgbW9pc0luZGV4LCBwYXJzZUludChkYXkpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBudWxsO1xyXG4gICAgfTtcclxufVxyXG4iXSwidmVyc2lvbiI6M30=